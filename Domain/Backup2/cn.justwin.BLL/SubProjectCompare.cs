namespace cn.justwin.BLL
{
    using cn.justwin.DAL;
    using System;
    using System.Data;
    using System.Data.SqlClient;
    using System.Text;

    public class SubProjectCompare
    {
        private static string GetCondition(string code, string name)
        {
            StringBuilder builder = new StringBuilder();
            if (!string.IsNullOrEmpty(code))
            {
                builder.Append(string.Format(" AND TaskCode LIKE '%{0}%' ", code)).AppendLine();
            }
            if (!string.IsNullOrEmpty(name))
            {
                builder.Append(string.Format(" AND TaskName LIKE '%{0}%' ", name)).AppendLine();
            }
            return builder.ToString();
        }

        public static int GetCount(string prjId, string code, string name)
        {
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n                --DECLARE @PrjId nvarchar(50)\r\n                --set @PrjId='a25fdb14-8841-4193-9017-80d1da6c6e10'\r\n\t\t\t\tSELECT COUNT(*) FROM \r\n\t\t\t\t(\r\n\t\t\t\t\t--原预算\r\n\t\t\t\t\tSELECT task.TaskId,TaskCode,TaskName,OrderNumber,PrjId FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n\t\t\t\t\t\tBud_Task budTask\r\n\t\t\t\t\t\tJOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t\t\t\tAND budTask.PrjId=@PrjId AND TaskType=''\r\n\t\t\t\t\t) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n\t\t\t\t\tGROUP BY task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity\r\n\t\t\t\t\tUNION\r\n\t\t\t\t\t--清单外的预算变更\r\n\t\t\t\t\tSELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n\t\t\t\t\tPrjId FROM Bud_Modify modify\r\n\t\t\t\t\tJOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t\t\t\t) Task WHERE 1=1 ");
            builder.Append(GetCondition(code, name)).AppendLine();
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static DataTable GetDiffReport(string prjId, int pageSize, int pageIndex, string code, string name, string isWBSRelevance)
        {
            if (pageSize == 0)
            {
                pageSize = GetCount(prjId, code, name);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            string cmdText = string.Empty;
            if (isWBSRelevance == "1")
            {
                cmdText = string.Format("\r\n                --DECLARE @PrjId nvarchar(100),@PageSize int,\r\n                --@PageIndex int,@Query nvarchar(200)\r\n                --SET @PrjId = 'a25fdb14-8841-4193-9017-80d1da6c6e10'\r\n                --SET @PageSize = 15\r\n                --SET @PageIndex = 1;\r\n                WITH ctePlan AS \r\n                ( \r\n\t                --总预算\r\n\t                SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,\r\n\t                (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n\t                (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) PlanTotal,\r\n\t                ISNULL((budTaskInfo.Total+ISNULL(ModifyInfo.Total,0))/\r\n\t                NULLIF(budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0),0),0) UnitPrice FROM \r\n\t                (\r\n\t\t                --原预算\r\n\t\t                SELECT task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity,\r\n\t\t                ISNULL(SUM(ResourceQuantity*ResourcePrice),0) Total FROM\r\n\t\t                (\r\n\t\t\t                SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n\t\t\t                Bud_Task budTask\r\n\t\t\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t                AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t\t                ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n\t\t                GROUP BY task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity\r\n\t\t                UNION\r\n\t\t                --清单外的预算变更\r\n\t\t                SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n\t\t                PrjId,Quantity,Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) budTaskInfo\r\n\t                LEFT JOIN\r\n\t                (\r\n\t\t                --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t\t                GROUP BY TaskId,PrjId\r\n\t                ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n\t                where TaskCode like '%'+@TaskCode+'%' and TaskName like '%'+@TaskName+'%'\r\n                ), cteActual AS \r\n                ( \r\n                    --实际成本\r\n                    SELECT a.TaskId, SUM(AccountingQuantity) AS ActualQty, SUM(ActualTotal) AS ActualTotal, \r\n                        SUM(ActualTotal) / NULLIF(SUM(AccountingQuantity), 0) AS UnitPrice --实际单价\r\n                    FROM \r\n                    (\r\n                        SELECT  ct.TaskId,ct.AccountingQuantity, \r\n                            ((SELECT SUM(AccountingQuantity * UnitPrice) FROM Bud_ConsTaskRes WHERE ConsTaskId = ct.ConsTaskId)) ActualTotal\r\n                        FROM Bud_ConsTask AS ct \r\n                        INNER JOIN Bud_ConsReport AS cr ON ct.ConsReportId = cr.ConsReportId\r\n                        WHERE cr.FlowState=1\r\n                    ) AS a\r\n                    GROUP BY TaskId \r\n                ), cteMonthActual AS \r\n                ( \r\n                    --本月实际成本\r\n                    SELECT a.TaskId, SUM(AccountingQuantity) AS ActualMonthQty, SUM(ActualTotal) AS ActualMonthTotal,\r\n                        SUM(ActualTotal) / NULLIF(SUM(AccountingQuantity), 0) AS UnitPrice --本月实际价格\r\n                    FROM \r\n                    (\r\n                        SELECT  ct.TaskId,ct.AccountingQuantity, \r\n                            ((SELECT SUM(AccountingQuantity * UnitPrice) FROM Bud_ConsTaskRes WHERE ConsTaskId = ct.ConsTaskId)) ActualTotal\r\n                        FROM Bud_ConsTask AS ct \r\n                        INNER JOIN Bud_ConsReport AS cr ON ct.ConsReportId = cr.ConsReportId\r\n                        WHERE CONVERT(varchar(6),cr.InputDate, 112) = CONVERT(varchar(6), GETDATE(), 112)\r\n                            AND cr.FlowState=1\r\n                    ) AS a \r\n                    GROUP BY TaskId \r\n                ),cteMonthBud AS\r\n                (\r\n                      --当月预算\r\n                    SELECT task.TaskId,OrderNumber,Quantity MonthBudQuantity,\r\n\t                ISNULL(SUM(ResourceQuantity*ResourcePrice),0) MonthBudTotal,\r\n\t                ISNULL(ISNULL(SUM(ResourceQuantity*ResourcePrice),0)/NULLIF(Quantity,0),0) MonthBudUnitPrice  FROM\r\n                    (\r\n                        SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n                        Bud_Task budTask\r\n                        JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        AND budTask.PrjId=@PrjId AND TaskType='M' \r\n\t\t                AND SUBSTRING(TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))=\r\n\t\t\t\t\t\tDateName(Year,GetDate())+DateName(Month,GetDate())\r\n                    ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n                    GROUP BY task.TaskId,OrderNumber,Quantity\r\n                )\r\n                SELECT TOP(@PageSize) * FROM \r\n                (\r\n\t\t\t\t\tSELECT CONVERT(varchar(6),ROW_NUMBER() OVER(ORDER BY ctePlan.OrderNumber)) AS No,\r\n\t\t\t\t\tctePlan.TaskId,ctePlan.OrderNumber, ctePlan.TaskCode, ctePlan.TaskName,\r\n                    ISNULL(MonthBudTotal, 0) AS PlanMonthTotal,-- 本月目标成本\r\n                    ISNULL(MonthBudQuantity, 0) AS ActualMonthQty, --本月预算量\r\n                    ISNULL(cteMonthActual.ActualMonthTotal, 0) AS ActualMonthTotal, -- 本月实际成本\r\n                    ISNULL(cteMonthActual.ActualMonthQty, 0) AS PlanMonthQty, -- 本月实际量\r\n                    ISNULL(MonthBudQuantity,0)-ISNULL(cteMonthActual.ActualMonthQty,0) MonthDiffQty, --量差\r\n                    ISNULL(ISNULL(MonthBudUnitPrice,0) - ISNULL(cteMonthActual.UnitPrice,0), 0) AS MonthDiffPrice, --价差\r\n                    ISNULL(ctePlan.PlanTotal, 0) AS PlanTotal, --计划成本(目标成本)\r\n                    ISNULL(ctePlan.Quantity, 0) AS Quantity, --计划量（预算量）\r\n                    ISNULL(ctePlan.UnitPrice, 0) AS UnitPrice, --预算价\r\n                    ISNULL(cteActual.ActualTotal, 0) AS ActualTotal, --实际成本\r\n                    ISNULL(cteActual.ActualQty, 0) AS ActualQty, --实际完成量\r\n                    ISNULL(cteActual.UnitPrice, 0) AS ActualPrice, --实际价\r\n                    ISNULL(ISNULL(ctePlan.Quantity, 0) - ISNULL(cteActual.ActualQty, 0), 0) AS DiffQuantity, --量差\r\n                    ISNULL(ISNULL(ctePlan.UnitPrice, 0) - ISNULL(cteActual.UnitPrice, 0), 0) AS DiffPrice, --价差\r\n                    ISNULL(ISNULL(ctePlan.PlanTotal, 0) - ISNULL(cteActual.ActualTotal, 0), 0) AS DiffTotal --降低额（成本差额）\r\n                    FROM ctePlan \r\n\t                LEFT JOIN cteMonthBud ON ctePlan.OrderNumber = cteMonthBud.OrderNumber\r\n                    LEFT JOIN cteActual ON ctePlan.TaskId = cteActual.TaskId\r\n                    LEFT JOIN cteMonthActual ON ctePlan.TaskId = cteMonthActual.TaskId\r\n                ) AS b \r\n                WHERE No > @PageSize * (@PageIndex - 1)\r\n                ORDER BY CONVERT(int, No) ", new object[0]);
            }
            else
            {
                cmdText = string.Format("\r\n                --DECLARE @PrjId nvarchar(100),@PageSize int,\r\n                --@PageIndex int,@Query nvarchar(200)\r\n                --SET @PrjId = 'a25fdb14-8841-4193-9017-80d1da6c6e10'\r\n                --SET @PageSize = 15\r\n                --SET @PageIndex = 1;\r\n                WITH ctePlan AS \r\n                ( \r\n\t                --总预算\r\n\t                SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,\r\n\t                (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n\t                (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) PlanTotal,\r\n\t                ISNULL((budTaskInfo.Total+ISNULL(ModifyInfo.Total,0))/\r\n\t                NULLIF(budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0),0),0) UnitPrice,TaskType FROM \r\n\t                (\r\n\t\t                --原预算\r\n\t\t                SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity,ISNULL(Total,0) Total,\r\n\t\t                TaskType FROM Bud_Task budTask\r\n\t\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t                AND budTask.PrjId=@PrjId\r\n\t\t                UNION\r\n\t\t                --清单外的预算变更\r\n\t\t                SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n\t\t                PrjId,Quantity,Total,'' TaskType FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) budTaskInfo\r\n\t                LEFT JOIN\r\n\t                (\r\n\t\t                --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,Quantity,Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t                ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n\t                where TaskCode like '%'+@TaskCode+'%' and TaskName like '%'+@TaskName+'%'\r\n                ), cteActual AS \r\n                ( \r\n \t                --施工报量\r\n\t                SELECT TaskId,AccTotalQuantity ActualQty,(AccTotalQuantity*unitPrice) ActualTotal,UnitPrice FROM \r\n\t                (\r\n\t\t                SELECT ConsInfo.TaskId,AccTotalQuantity,ISNULL(PlanTotal/NULLIF(Quantity,0),0) unitPrice FROM \r\n\t\t                (\r\n\t\t\t                SELECT TaskId,SUM(AccountingQuantity) AccTotalQuantity FROM Bud_ConsReport consReport \r\n\t\t\t                LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId\r\n\t\t\t                WHERE PrjId=@PrjId AND FlowState=1 GROUP BY TaskId\r\n\t\t                )ConsInfo LEFT JOIN ctePlan ON ConsInfo.TaskId=ctePlan.TaskId\r\n\t                ) Con\r\n                ), cteMonthActual AS \r\n                ( \r\n \t                --本月施工报量\r\n\t                SELECT TaskId,AccTotalQuantity ActualMonthQty,(AccTotalQuantity*unitPrice) ActualMonthTotal,UnitPrice FROM \r\n\t                (\r\n\t\t                SELECT ConsInfo.TaskId,AccTotalQuantity,ISNULL(PlanTotal/NULLIF(Quantity,0),0) unitPrice FROM \r\n\t\t                (\r\n\t\t\t                SELECT TaskId,SUM(AccountingQuantity) AccTotalQuantity FROM Bud_ConsReport consReport \r\n\t\t\t                LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId\r\n\t\t\t                WHERE PrjId=@PrjId AND FlowState=1  AND DateDiff(mm,consReport.InputDate,GetDate())=0  \r\n\t\t\t                GROUP BY TaskId\r\n\t\t                )ConsInfo LEFT JOIN ctePlan ON ConsInfo.TaskId=ctePlan.TaskId\r\n\t                ) Con\r\n                ),cteMonthBud AS\r\n                (\r\n\t                --本月预算\r\n\t                SELECT budTask.TaskId,OrderNumber,Quantity MonthBudQuantity,ISNULL(Total,0) MonthBudTotal,\r\n\t                ISNULL(ISNULL(Total,0)/NULLIF(Quantity,0),0) MonthBudUnitPrice FROM \r\n\t                Bud_Task budTask\r\n\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t                AND budTask.PrjId=@PrjId  AND TaskType='M' \r\n\t                AND SUBSTRING(TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))=\r\n\t\t\t\t\tDateName(Year,GetDate())+DateName(Month,GetDate())\r\n                )\r\n                SELECT TOP(@PageSize) * FROM \r\n                (\r\n\t\t\t\t\tSELECT CONVERT(varchar(6),ROW_NUMBER() OVER(ORDER BY ctePlan.OrderNumber)) AS No,\r\n\t\t\t\t\tctePlan.TaskId,ctePlan.OrderNumber, ctePlan.TaskCode, ctePlan.TaskName,\r\n                    ISNULL(MonthBudTotal, 0) AS PlanMonthTotal,-- 本月目标成本\r\n                    ISNULL(MonthBudQuantity, 0) AS ActualMonthQty, --本月预算量\r\n                    ISNULL(cteMonthActual.ActualMonthTotal, 0) AS ActualMonthTotal, -- 本月实际成本\r\n                    ISNULL(cteMonthActual.ActualMonthQty, 0) AS PlanMonthQty, -- 本月实际量\r\n                    ISNULL(MonthBudQuantity,0)-ISNULL(cteMonthActual.ActualMonthQty,0) MonthDiffQty, --量差\r\n                    ISNULL(ISNULL(MonthBudUnitPrice,0) - ISNULL(cteMonthActual.UnitPrice,0), 0) AS MonthDiffPrice, --价差\r\n                    ISNULL(ctePlan.PlanTotal, 0) AS PlanTotal, --计划成本(目标成本)\r\n                    ISNULL(ctePlan.Quantity, 0) AS Quantity, --计划量（预算量）\r\n                    ISNULL(ctePlan.UnitPrice, 0) AS UnitPrice, --预算价\r\n                    ISNULL(cteActual.ActualTotal, 0) AS ActualTotal, --实际成本\r\n                    ISNULL(cteActual.ActualQty, 0) AS ActualQty, --实际完成量\r\n                    ISNULL(cteActual.UnitPrice, 0) AS ActualPrice, --实际价\r\n                    ISNULL(ISNULL(ctePlan.Quantity, 0) - ISNULL(cteActual.ActualQty, 0), 0) AS DiffQuantity, --量差\r\n                    ISNULL(ISNULL(ctePlan.UnitPrice, 0) - ISNULL(cteActual.UnitPrice, 0), 0) AS DiffPrice, --价差\r\n                    ISNULL(ISNULL(ctePlan.PlanTotal, 0) - ISNULL(cteActual.ActualTotal, 0), 0) AS DiffTotal --降低额（成本差额）\r\n                    FROM ctePlan \r\n\t                LEFT JOIN cteMonthBud ON ctePlan.OrderNumber = cteMonthBud.OrderNumber\r\n                    LEFT JOIN cteActual ON ctePlan.TaskId = cteActual.TaskId\r\n                    LEFT JOIN cteMonthActual ON ctePlan.TaskId = cteMonthActual.TaskId\r\n\t                WHERE TaskType=''\r\n                ) AS b \r\n                WHERE No > @PageSize * (@PageIndex - 1)\r\n                ORDER BY CONVERT(int, No) ", new object[0]);
            }
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@TaskCode", code), new SqlParameter("@TaskName", name) };
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, commandParameters);
        }

        public static DataTable GetReport(string prjId, int pageSize, int pageIndex, string code, string name, string isWBSRelevance)
        {
            if (pageSize == 0)
            {
                pageSize = GetCount(prjId, code, name);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            string cmdText = string.Empty;
            if (isWBSRelevance == "1")
            {
                cmdText = string.Format("\r\n                --DECLARE @PrjId nvarchar(100),@PageSize int,\r\n                --@PageIndex int,@Query nvarchar(200)\r\n                --SET @PrjId = 'a25fdb14-8841-4193-9017-80d1da6c6e10'\r\n                --SET @PageSize = 50\r\n                --SET @PageIndex = 1;\r\n                WITH ctePlan AS \r\n                ( \r\n\t                --总预算\r\n\t                SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,\r\n\t                (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n\t                (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) PlanTotal FROM \r\n\t                (\r\n\t\t                --原预算\r\n\t\t                SELECT task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity,\r\n\t\t                ISNULL(SUM(ResourceQuantity*ResourcePrice),0) Total FROM\r\n\t\t                (\r\n\t\t\t                SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n\t\t\t                Bud_Task budTask\r\n\t\t\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t                AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t\t                ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n\t\t                GROUP BY task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity\r\n\t\t                UNION\r\n\t\t                --清单外的预算变更\r\n\t\t                SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n\t\t                PrjId,Quantity,Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) budTaskInfo\r\n\t                LEFT JOIN\r\n\t                (\r\n\t\t                --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t\t                GROUP BY TaskId,PrjId\r\n\t                ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n\t                where TaskCode like '%'+@TaskCode+'%' and TaskName like '%'+@TaskName+'%'\r\n                ),cteMonthBud AS\r\n                (\r\n                      --当月预算\r\n                    SELECT task.TaskId,OrderNumber,Quantity MonthQuantity,\r\n                    ISNULL(SUM(ResourceQuantity*ResourcePrice),0) MonthBudTotal FROM\r\n                    (\r\n                        SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n                        Bud_Task budTask\r\n                        JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        AND budTask.PrjId=@PrjId AND TaskType='M' \r\n\t\t                AND SUBSTRING(TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))=DateName(Year,GetDate())+DateName(Month,GetDate())\r\n                    ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n                    GROUP BY task.TaskId,OrderNumber,Quantity\r\n                ), cteActual AS \r\n                ( \r\n                    --实际成本\r\n                    SELECT a.TaskId, SUM(AccountingQuantity) AS ActualQty, SUM(ActualTotal) AS ActualTotal\r\n                    FROM \r\n                    (\r\n                        SELECT  ct.TaskId,ct.AccountingQuantity, \r\n                            ((SELECT SUM(AccountingQuantity * UnitPrice) FROM Bud_ConsTaskRes WHERE ConsTaskId = ct.ConsTaskId)) ActualTotal\r\n                        FROM Bud_ConsTask AS ct \r\n                        INNER JOIN Bud_ConsReport AS cr ON ct.ConsReportId = cr.ConsReportId\r\n                        WHERE cr.FlowState=1\r\n                    ) AS a\r\n                    GROUP BY TaskId \r\n                ), cteMonthActual AS \r\n                ( \r\n                    --本月实际成本\r\n                    SELECT a.TaskId, SUM(AccountingQuantity) AS ActualMonthQty, SUM(ActualTotal) AS ActualMonthTotal\r\n                    FROM \r\n                    (\r\n                        SELECT  ct.TaskId,ct.AccountingQuantity, \r\n                            ((SELECT SUM(AccountingQuantity * UnitPrice) FROM Bud_ConsTaskRes WHERE ConsTaskId = ct.ConsTaskId)) ActualTotal\r\n                        FROM Bud_ConsTask AS ct \r\n                        INNER JOIN Bud_ConsReport AS cr ON ct.ConsReportId = cr.ConsReportId\r\n                        WHERE CONVERT(varchar(6),cr.InputDate, 112) = CONVERT(varchar(6), GETDATE(), 112)\r\n                            AND cr.FlowState=1\r\n                    ) AS a\r\n                    GROUP BY TaskId \r\n                )\r\n                SELECT TOP(@PageSize) * FROM \r\n                (\r\n                    SELECT CONVERT(varchar(6),ROW_NUMBER() OVER(ORDER BY ctePlan.OrderNumber)) AS No,ctePlan.TaskId,ctePlan.OrderNumber, ctePlan.TaskCode, ctePlan.TaskName,\r\n                        ISNULL(MonthBudTotal, 0) AS PlanMonthTotal,--本月计划成本\r\n                        ISNULL(cteMonthActual.ActualMonthTotal, 0) AS ActualMonthTotal, -- 本月实际成本\r\n                        ISNULL(cteMonthActual.ActualMonthQty, 0) AS ActualMonthQty, -- 本月完成量\r\n                        ISNULL(ISNULL(MonthBudTotal,0) - ISNULL(cteMonthActual.ActualMonthTotal,0),0) AS MonthDiffTotal, --本月降低额\r\n                        ISNULL((ISNULL(MonthBudTotal,0) - ISNULL(cteMonthActual.ActualMonthTotal,0))/\r\n                        NULLIF(ISNULL(MonthBudTotal,0),0),0) AS MonthDiffRate, --本月降低率\r\n                        ISNULL(ctePlan.Quantity, 0) AS Quantity, --计划量\r\n                        ISNULL(ctePlan.PlanTotal, 0) AS PlanTotal,--计划成本\r\n                        ISNULL(cteActual.ActualQty, 0) AS ActualQty, --/实际完成量\r\n                        ISNULL(cteActual.ActualTotal, 0) AS ActualTotal, --实际成本\r\n                        ISNULL(ISNULL(ctePlan.PlanTotal,0) - ISNULL(cteActual.ActualTotal,0), 0) AS DiffTotal, --降低额\r\n                        ISNULL((ISNULL(ctePlan.PlanTotal,0) - ISNULL(cteActual.ActualTotal,0)) / NULLIF(ctePlan.PlanTotal, 0), 0) AS DiffRate --降低率\r\n                    FROM ctePlan \r\n\t                LEFT JOIN cteMonthBud ON ctePlan.OrderNumber = cteMonthBud.OrderNumber\r\n                    LEFT JOIN cteActual ON ctePlan.TaskId = cteActual.TaskId\r\n                    LEFT JOIN cteMonthActual ON ctePlan.TaskId = cteMonthActual.TaskId\r\n                    WHERE 1 = 1 \r\n                ) AS b \r\n                WHERE No > @PageSize * (@PageIndex - 1)\r\n                ORDER BY CONVERT(int,No) ", new object[0]);
            }
            else
            {
                cmdText = string.Format("\r\n                --DECLARE @PrjId nvarchar(100),@PageSize int,\r\n                --@PageIndex int,@Query nvarchar(200)\r\n                --SET @PrjId = 'a25fdb14-8841-4193-9017-80d1da6c6e10'\r\n                --SET @PageSize = 50\r\n                --SET @PageIndex = 1;\r\n                WITH ctePlan AS \r\n                ( \r\n\t                --总预算\r\n\t                SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,\r\n\t                (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n\t                (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) PlanTotal,TaskType FROM \r\n\t                (\r\n\t\t                --原预算\r\n\t\t                SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity,ISNULL(Total,0) Total,\r\n\t\t                TaskType FROM Bud_Task budTask\r\n\t\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t                AND budTask.PrjId=@PrjId\r\n\t\t                UNION\r\n\t\t                --清单外的预算变更\r\n\t\t                SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n\t\t                PrjId,Quantity,Total,'' TaskType FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) budTaskInfo\r\n\t                LEFT JOIN\r\n\t                (\r\n\t\t                --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,Quantity,Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t                ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n\t                where TaskCode like '%'+@TaskCode+'%' and TaskName like '%'+@TaskName+'%'\r\n                ),cteMonthBud AS\r\n                (\r\n\t                --本月预算\r\n\t                SELECT budTask.TaskId,OrderNumber,Quantity MonthQuantity,ISNULL(Total,0) MonthBudTotal FROM \r\n\t                Bud_Task budTask\r\n\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t                AND budTask.PrjId=@PrjId  AND TaskType='M' \r\n\t                AND SUBSTRING(TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))=DateName(Year,GetDate())+DateName(Month,GetDate())\r\n                ), cteActual AS \r\n                ( \r\n\t                --施工报量\r\n\t                SELECT TaskId,AccTotalQuantity ActualQty, (AccTotalQuantity*unitPrice) ActualTotal FROM \r\n\t                (\r\n\t\t                SELECT ConsInfo.TaskId,AccTotalQuantity,ISNULL(PlanTotal/NULLIF(Quantity,0),0) unitPrice FROM \r\n\t\t                (\r\n\t\t\t                SELECT TaskId,SUM(AccountingQuantity) AccTotalQuantity FROM Bud_ConsReport consReport \r\n\t\t\t                LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId\r\n\t\t\t                WHERE PrjId=@PrjId AND FlowState=1 GROUP BY TaskId\r\n\t\t                )ConsInfo LEFT JOIN ctePlan ON ConsInfo.TaskId=ctePlan.TaskId\r\n\t                ) Con\r\n                ), cteMonthActual AS \r\n                ( \r\n \t                --本月施工报量\r\n\t                SELECT TaskId,AccTotalQuantity ActualMonthQty,(AccTotalQuantity*unitPrice) ActualMonthTotal FROM \r\n\t                (\r\n\t\t                SELECT ConsInfo.TaskId,AccTotalQuantity,ISNULL(PlanTotal/NULLIF(Quantity,0),0) unitPrice FROM \r\n\t\t                (\r\n\t\t\t                SELECT TaskId,SUM(AccountingQuantity) AccTotalQuantity FROM Bud_ConsReport consReport \r\n\t\t\t                LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId\r\n\t\t\t                WHERE PrjId=@PrjId AND FlowState=1  AND DateDiff(mm,consReport.InputDate,GetDate())=0  \r\n\t\t\t                GROUP BY TaskId\r\n\t\t                )ConsInfo LEFT JOIN ctePlan ON ConsInfo.TaskId=ctePlan.TaskId\r\n\t                ) Con\r\n                )\r\n                SELECT TOP(@PageSize) * FROM \r\n                (\r\n\t                SELECT CONVERT(varchar(6),ROW_NUMBER() OVER(ORDER BY ctePlan.OrderNumber)) AS No,ctePlan.TaskId,ctePlan.OrderNumber, ctePlan.TaskCode, ctePlan.TaskName,\r\n\t                ISNULL(MonthBudTotal, 0) AS PlanMonthTotal,--本月计划成本\r\n\t                ISNULL(cteMonthActual.ActualMonthTotal, 0) AS ActualMonthTotal, -- 本月实际成本\r\n\t                ISNULL(cteMonthActual.ActualMonthQty, 0) AS ActualMonthQty, -- 本月完成量\r\n\t                ISNULL(ISNULL(MonthBudTotal,0) - ISNULL(cteMonthActual.ActualMonthTotal,0),0) AS MonthDiffTotal, --本月降低额\r\n\t                ISNULL((ISNULL(MonthBudTotal,0) - ISNULL(cteMonthActual.ActualMonthTotal,0))/\r\n\t                NULLIF(ISNULL(MonthBudTotal,0),0),0) AS MonthDiffRate, --本月降低率\r\n\t                ISNULL(ctePlan.Quantity, 0) AS Quantity, --计划量\r\n\t                ISNULL(ctePlan.PlanTotal, 0) AS PlanTotal,--计划成本\r\n\t                ISNULL(cteActual.ActualQty, 0) AS ActualQty, --/实际完成量\r\n\t                ISNULL(cteActual.ActualTotal, 0) AS ActualTotal, --实际成本\r\n\t                ISNULL(ISNULL(ctePlan.PlanTotal,0) - ISNULL(cteActual.ActualTotal,0), 0) AS DiffTotal, --降低额\r\n\t                ISNULL((ISNULL(ctePlan.PlanTotal,0) - ISNULL(cteActual.ActualTotal,0)) / NULLIF(ctePlan.PlanTotal, 0), 0) AS DiffRate --降低率\r\n\t                FROM ctePlan \r\n\t                LEFT JOIN cteMonthBud ON ctePlan.OrderNumber = cteMonthBud.OrderNumber\r\n\t                LEFT JOIN cteActual ON ctePlan.TaskId = cteActual.TaskId\r\n\t                LEFT JOIN cteMonthActual ON ctePlan.TaskId = cteMonthActual.TaskId\r\n\t                WHERE TaskType=''\r\n                ) AS b \r\n                WHERE No > @PageSize * (@PageIndex - 1)\r\n                ORDER BY CONVERT(int,No) ", new object[0]);
            }
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@TaskCode", code), new SqlParameter("@TaskName", name) };
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, commandParameters);
        }
    }
}

