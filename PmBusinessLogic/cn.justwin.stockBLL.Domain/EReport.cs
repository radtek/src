namespace cn.justwin.stockBLL.Domain
{
    using cn.justwin.DAL;
    using cn.justwin.Domain;
    using cn.justwin.Web;
    using System;
    using System.Data;
    using System.Data.SqlClient;
    using System.Text;

    public class EReport
    {
        private static decimal[] GetAccountSumTotal(string prjId)
        {
            decimal[] numArray = new decimal[3];
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.Append("SELECT RES.ResourceType,CONVERT(DECIMAL(18,3),ISNULL(SUM(TaskRes.Total),0)) AS Total FROM Res_Resource AS RES RIGHT JOIN ");
            builder.AppendLine();
            builder.Append("(SELECT SUM(ISNULL(UnitPrice*AccountingQuantity,0)) AS Total,ResourceId FROM Bud_ConsTaskRes WHERE ConsTaskId IN");
            builder.AppendLine();
            builder.Append("(SELECT ConsTaskId FROM dbo.Bud_ConsTask WHERE ConsReportId IN ");
            builder.AppendLine();
            builder.AppendFormat("(SELECT ConsReportId FROM dbo.Bud_ConsReport WHERE  State='1' AND  PrjId='{0}'))", prjId);
            builder.AppendLine();
            builder.Append("GROUP BY ResourceId)AS TaskRes ON RES.ResourceId=TaskRes.ResourceId GROUP BY RES.ResourceType");
            foreach (DataRow row in SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString()).Rows)
            {
                string firstResourceType = Resource.GetFirstResourceType(row["ResourceType"].ToString());
                if (firstResourceType == "人工")
                {
                    numArray[0] += Convert.ToDecimal(row["Total"]);
                }
                else if (firstResourceType == "材料")
                {
                    numArray[1] += Convert.ToDecimal(row["Total"]);
                }
                else
                {
                    numArray[2] += Convert.ToDecimal(row["Total"]);
                }
            }
            return numArray;
        }

        public static DataTable GetBudAnalysis(string prjCode, string prjName, string startDate, string endDate, string userCode, string isWBSRelevance)
        {
            string format = string.Empty;
            string str2 = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH ConBud AS\r\n                            (\r\n                            --合同预算\r\n\t                        SELECT M.PrjGuid,M.PrjCode,M.PrjName,(SUM(ISNULL(M.ContractPrice,0.0)) +SUM(M.MMM)) AS Tender FROM \r\n\t                        (\r\n\t                        SELECT T.*,SUM(ISNULL(MF.ChangePrice,0.0)) AS MMM FROM \r\n\t                        (\r\n\t                        SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,Con.StartDate,Con.ContractID,Con.ContractPrice\r\n\t                        FROM  PT_PrjInfo  PT\r\n                            LEFT JOIN PT_PrjInfo_ZTB_Detail PTZ\r\n                            ON PT.PrjGuid =cast(PTZ.PrjGuid as nvarchar(64))  \r\n\t                        LEFT JOIN Con_Incomet_Contract Con\r\n\t                        ON Con.Project=PT.PrjGuid\r\n\t                        WHERE  PT.PrjState<>17 AND PTZ.SetUpFlowState=1\r\n\t                        ) T \r\n\t                        LEFT JOIN Con_Incomet_Modify MF \r\n\t                        ON T.ContractID=MF.ContractID\r\n\t                        GROUP BY  T.PrjGuid,T.PrjCode,T.PrjName,T.StartDate,T.ContractID,T.ContractPrice\r\n\t                        ) M\r\n\t                        GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName\r\n   \r\n                            ),\r\n                            Bud AS\r\n                            (\r\n                            --直接成本预算\r\n\t                        SELECT M.PrjGuid,M.PrjCode,M.PrjName,M.Total1+ISNULL(SUM(MF.Total2),0.0)AS Target FROM \r\n                            (\r\n                            SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,ISNULL(SUM(T.ResourcePrice*T.ResourceQuantity),0.0) AS Total1\r\n                            FROM  PT_PrjInfo  PT\t\r\n                            LEFT JOIN PT_PrjInfo_ZTB_Detail PTZ\r\n                            ON PT.PrjGuid =cast(PTZ.PrjGuid as nvarchar(64))                   \r\n                            LEFT JOIN \r\n                            (\r\n                            SELECT BTS.* FROM Bud_TaskResource BTS \r\n                            LEFT JOIN Bud_Task BT\r\n                            ON BTS.TaskId=BT.TaskId\r\n                            WHERE BT.TaskType=''\r\n                            ) T\r\n                            ON PT.PrjGuid=cast(T.PrjGuid as nvarchar(64))\r\n                            WHERE  PT.PrjState<>17 AND PTZ.SetUpFlowState=1                        \r\n                            GROUP BY PT.PrjGuid,PT.PrjCode,PT.PrjName\r\n                            ) M\r\n                            LEFT JOIN Bud_ModifyTask MF\r\n                            ON M.PrjGuid=cast(MF.prjId2 as nvarchar(64))\r\n                            GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName,M.Total1\r\n                            ),\r\n                            IndeBud AS\r\n                            (\r\n                            --间接成本预算\r\n                            SELECT SUM(ISNULL(AccountAmount,0.0)) AS IndirBud,cast(ProjectId as nvarchar(64)) AS ProjectId FROM Bud_IndirectBudget \r\n                            WHERE LEN(CBSCode)>6 AND State=2 AND LEN(ProjectId)>20\r\n                            GROUP BY ProjectId\r\n                            ),\r\n                            DeTask AS\r\n                            (\r\n                            --直接成本\r\n                           SELECT M.prjId,SUM(TTT) AS Reality FROM\r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT T.prjId,SUM(BTR.Quantity*BTR.UnitPrice) TTT FROM \r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT BRT.PrjId,BCT.ConsTaskId FROM Bud_ConsReport BRT\r\n\t\t\t\t\t\t\tJOIN Bud_ConsTask BCT\r\n\t\t\t\t\t\t\tON BRT.ConsReportId=BCT.ConsReportId\r\n                            WHERE BRT.FlowState=1 \r\n\t\t\t\t\t\t\t) T\r\n\t\t\t\t\t\t\tJOIN  Bud_ConsTaskRes BTR ON \r\n\t\t\t\t\t\t\tT.ConsTaskId=BTR.ConsTaskId\r\n\t\t\t\t\t\t\tGROUP BY T.prjId,BTR.Quantity,BTR.UnitPrice\r\n\t\t\t\t\t\t\t) M\r\n\t\t\t\t\t\t\tGROUP BY M.prjId\r\n                            ),\r\n                            IndeTask AS\r\n                            (\r\n                            --间接成本\r\n                            SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS IndirAcc FROM Bud_IndirectDiaryCost C\r\n                            JOIN Bud_IndirectDiaryDetails D\r\n                            ON C.InDiaryId=D.InDiaryId\r\n                            WHERE LEN(ProjectId)>20  AND C.FlowState=1\r\n                            GROUP BY C.ProjectId\r\n                            ),\r\n                            RESULT AS\r\n                            (\r\n                            SELECT DISTINCT ConBud.*,Bud.Target,ISNULL(IndeBud.IndirBud,0.0)AS IndirBud,ISNULL(DeTask.Reality,0.0)AS Reality \r\n                            ,ISNULL(IndeTask.IndirAcc,0.0) AS IndirAcc,\r\n                            Convert(Nvarchar(30), cast(ISNULL((ISNULL(Reality,0)+ISNULL(IndirAcc,0))/ NULLIF(ISNULL(Bud.Target,0)+ISNULL(IndirBud,0),0),0)*100 as decimal(20,2)))+'%' PercentCompleted   \r\n                            FROM ConBud\r\n                            LEFT JOIN  Bud\r\n                            ON ConBud.PrjGuid=Bud.PrjGuid\r\n                            LEFT JOIN  IndeBud\r\n                            ON ConBud.PrjGuid=IndeBud.ProjectId\r\n                            LEFT JOIN  DeTask\r\n                            ON ConBud.PrjGuid=DeTask.PrjId\r\n                            LEFT JOIN  IndeTask\r\n                            ON ConBud.PrjGuid=IndeTask.ProjectId\r\n                            )\r\n                           SELECT RESULT.*,PT_PrjInfo.StartDate FROM RESULT \r\n                           LEFT JOIN PT_PrjInfo\r\n                           ON RESULT.PrjGuid=PT_PrjInfo.PrjGuid\r\n                           WHERE 1=1 {0}\r\n                           ORDER BY PT_PrjInfo.StartDate DESC";
                if (!string.IsNullOrEmpty(prjCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + prjCode + "%'";
                }
                if (!string.IsNullOrEmpty(prjName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + prjName + "%'";
                }
                if (!string.IsNullOrEmpty(startDate))
                {
                    str2 = str2 + " AND PT_PrjInfo.StartDate >'" + startDate + "'";
                }
                if (!string.IsNullOrEmpty(endDate))
                {
                    str2 = str2 + " AND PT_PrjInfo.StartDate >'" + endDate + "'";
                }
                format = string.Format(format, str2);
            }
            else
            {
                format = "WITH ConBud AS\r\n                            (\r\n                            --合同预算\r\n                            SELECT M.PrjGuid,M.PrjCode,M.PrjName,(SUM(ISNULL(M.ContractPrice,0.0)) +SUM(M.MMM)) AS Tender FROM \r\n                            (\r\n                            SELECT T.*,SUM(ISNULL(MF.ChangePrice,0.0)) AS MMM FROM \r\n                            (\r\n                            SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,Con.StartDate,Con.ContractID,Con.ContractPrice\r\n                            FROM  PT_PrjInfo  PT\r\n                            LEFT JOIN PT_PrjInfo_ZTB_Detail PTZ\r\n                            ON PT.PrjGuid =cast(PTZ.PrjGuid as nvarchar(64))   \r\n                            LEFT JOIN Con_Incomet_Contract Con\r\n                            ON Con.Project=PT.PrjGuid\r\n                            WHERE  PT.PrjState<>17 AND PTZ.SetUpFlowState=1\r\n                            ) T \r\n                            LEFT JOIN Con_Incomet_Modify MF \r\n                            ON T.ContractID=MF.ContractID\r\n                            GROUP BY  T.PrjGuid,T.PrjCode,T.PrjName,T.StartDate,T.ContractID,T.ContractPrice\r\n                            ) M\r\n                            GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName\r\n                            ),\r\n                            Bud AS\r\n                            (\r\n                            --直接成本预算\r\n                               SELECT SUM(ISNULL(Total2,0.0))AS Target,PrjId FROM Bud_Task  WHERE LEN(OrderNumber)=3\r\n                               GROUP BY PrjId\r\n                            ),\r\n                            IndeBud AS\r\n                            (\r\n                            --间接成本预算\r\n                            SELECT SUM(ISNULL(AccountAmount,0.0)) AS IndirBud,cast(ProjectId as nvarchar(64)) AS ProjectId FROM Bud_IndirectBudget \r\n                            WHERE LEN(CBSCode)>6 AND State=2 AND LEN(ProjectId)>20\r\n                            GROUP BY ProjectId\r\n                            ),\r\n                            DeTask AS\r\n                            (\r\n                            --直接成本\r\n                            SELECT T.PrjId,SUM(T.Reality)AS Reality FROM \r\n                            (\r\n                            SELECT cast(RET.PrjId as nvarchar(64)) AS PrjId,SUM(ISNULL(CTK.CompleteQuantity,0.0))* (ISNULL(BTK.Total2,0.0)/NULLIF(BTK.Quantity,0.0)) AS Reality FROM Bud_ConsReport RET\r\n                            JOIN Bud_ConsTask CTK\r\n                            ON RET.ConsReportId=CTK.ConsReportId\r\n                            JOIN Bud_Task BTK\r\n                            ON CTK.TaskId=BTK.TaskId\r\n                            GROUP BY RET.PrjId,BTK.Total2,BTK.Quantity\r\n                            WHERE BRT.FlowState=1 \r\n                            ) T\r\n                            GROUP BY  T.PrjId\r\n                            ),\r\n                            IndeTask AS\r\n                            (\r\n                            --间接成本\r\n                            SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS IndirAcc FROM Bud_IndirectDiaryCost C\r\n                            JOIN Bud_IndirectDiaryDetails D\r\n                            ON C.InDiaryId=D.InDiaryId\r\n                            WHERE LEN(ProjectId)>20  AND C.FlowState=1\r\n                            GROUP BY C.ProjectId\r\n                            ),\r\n                            RESULT AS\r\n                            (\r\n                            SELECT DISTINCT ConBud.*,Bud.Target,ISNULL(IndeBud.IndirBud,0.0)AS IndirBud,ISNULL(DeTask.Reality,0.0)AS Reality \r\n                            ,ISNULL(IndeTask.IndirAcc,0.0) AS IndirAcc,\r\n                            Convert(Nvarchar(30), cast(ISNULL((ISNULL(Reality,0)+ISNULL(IndirAcc,0))/ NULLIF(ISNULL(Bud.Target,0)+ISNULL(IndirBud,0),0),0)*100 as decimal(20,2)))+'%' PercentCompleted   \r\n                            FROM ConBud\r\n                            LEFT JOIN  Bud\r\n                            ON ConBud.PrjGuid=Bud.PrjId\r\n                            LEFT JOIN  IndeBud\r\n                            ON ConBud.PrjGuid=IndeBud.ProjectId\r\n                            LEFT JOIN  DeTask\r\n                            ON ConBud.PrjGuid=DeTask.PrjId\r\n                            LEFT JOIN  IndeTask\r\n                            ON ConBud.PrjGuid=IndeTask.ProjectId\r\n                            )\r\n                           SELECT RESULT.*,PT_PrjInfo.StartDate FROM RESULT \r\n                           LEFT JOIN PT_PrjInfo\r\n                           ON RESULT.PrjGuid=PT_PrjInfo.PrjGuid\r\n                           WHERE 1=1 {0}\r\n                           ORDER BY PT_PrjInfo.StartDate DESC";
                if (!string.IsNullOrEmpty(prjCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + prjCode + "%'";
                }
                if (!string.IsNullOrEmpty(prjName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + prjName + "%'";
                }
                if (!string.IsNullOrEmpty(startDate))
                {
                    str2 = str2 + " AND PT_PrjInfo.StartDate >'" + startDate + "'";
                }
                if (!string.IsNullOrEmpty(endDate))
                {
                    str2 = str2 + " AND PT_PrjInfo.StartDate >'" + endDate + "'";
                }
                format = string.Format(format, str2);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetBudAnalysisDetail(string prjId, string taskCode, string taskName, string isWBSRelevance)
        {
            string str = string.Empty;
            string format = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH ConBud AS\r\n                            (\r\n                            --合同预算\r\n                            SELECT OrderNumber,TaskName,TaskCode,ISNULL(Total,0.0)AS TenderTotal,\r\n                            ISNULL(Total,0.0)/NULLIF(Quantity,0.0) AS TenderPrice\r\n                            FROM Bud_ContractTask WHERE PrjId='{0}' AND TaskType=''\r\n                            ),\r\n                            Bud AS \r\n                            (\r\n                            --目标成本\r\n                            SELECT T.TaskName,T.TaskCode,T.TaskId,T.OrderNumber,T.TaskType,\r\n                            SUM(ISNULL(BMT.Total2,0.0))+ T.TargetTotal AS TargetTotal,\r\n                            ISNULL(ISNULL((SUM(ISNULL(BMT.Total2,0.0))+ T.TargetTotal),0.0)/NULLIF(ISNULL(T.Quantity,0.0),0.0),0.0) AS TargetPrice\r\n                            FROM(\r\n                            SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BT.OrderNumber,BT.PrjId,BT.Quantity,BT.TaskType,\r\n                            ISNULL(SUM(BTS.ResourcePrice*BTS.ResourceQuantity),0.0) AS TargetTotal\r\n                            FROM Bud_Task BT\r\n                            LEFT JOIN Bud_TaskResource BTS \r\n                            ON BT.TaskId=BTS.TaskId\r\n                            GROUP BY BT.TaskName,BT.TaskCode,BT.Quantity,BT.TaskId,BT.OrderNumber,BT.PrjId,BT.Quantity,BT.TaskType\r\n                            ) T\r\n                            LEFT JOIN Bud_ModifyTask BMT\r\n                            ON T.TaskId=BMT.TaskId\r\n                            WHERE T.PrjId='{0}'AND T.TaskType=''\r\n                            GROUP BY T.TaskName,T.TaskCode,T.Quantity,T.TaskId,T.OrderNumber,T.TargetTotal,T.TaskType\r\n                            --ORDER BY T.OrderNumber\r\n                            ),\r\n                            DeBud AS\r\n                            (\r\n                            --实际成本\r\n                            SELECT M.OrderNumber, M.TaskName,M.TaskCode,SUM(ISNULL(M.Quantity,0.0)*ISNULL(M.UnitPrice,0.0)) AS RealityTotal\r\n                            FROM \r\n                            (\r\n                            SELECT T.OrderNumber,T.TaskName,T.TaskCode,--SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,\r\n                            ISNULL(BTR.Quantity,0.0)AS Quantity ,ISNULL(BTR.UnitPrice,0.0) AS UnitPrice,T.CompleteQuantity\r\n                            FROM\r\n                            (\r\n                            SELECT  BCT.ConsReportId,BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                            LEFT JOIN Bud_ConsTask BCT\r\n                            ON BT.TaskId=BCT.TaskId\r\n                            WHERE BT.PrjId='{0}'\r\n                            GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                            ) T \r\n                            LEFT JOIN Bud_ConsTaskRes BTR\r\n                            ON T.ConsTaskId=BTR.ConsTaskId\r\n                            LEFT JOIN Bud_ConsReport BRT\r\n                            ON T.ConsReportId=BRT.ConsReportId\r\n                            WHERE FlowState=1\r\n                            ) M\r\n                            --WHERE M.TaskCode='020102001001'\r\n                            GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber\r\n                            ),DeQty AS\r\n                            (\r\n                            SELECT ISNULL(SUM(CompleteQuantity),0.0)AS CompleteQuantity ,T.TaskCode,T.OrderNumber  FROM\r\n                            (\r\n                            SELECT BT.OrderNumber,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                            LEFT JOIN Bud_ConsTask BCT\r\n                            ON BT.TaskId=BCT.TaskId\r\n                            WHERE BT.PrjId='{0}'\r\n                            GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity, BT.OrderNumber\r\n                            ) T\r\n                            GROUP BY T.TaskCode,T.OrderNumber \r\n                            )\r\n                            SELECT DISTINCT Bud.*,ISNULL(ConBud.TenderTotal,0.0) AS TenderTotal,\r\n                            ISNULL(ConBud.TenderPrice,0.0) AS TenderPrice,\r\n                            ISNULL(DeBud.RealityTotal,0.0) AS RealityTotal,\r\n                            ISNULL(ISNULL(DeBud.RealityTotal,0.0)/NULLIF(DeQty.CompleteQuantity,0.0),0.0) AS RealityPrice\r\n                            FROM Bud\r\n                            LEFT JOIN ConBud\r\n                            ON Bud.TaskCode=ConBud.TaskCode AND Bud.OrderNumber=ConBud.OrderNumber\r\n                            LEFT JOIN DeBud\r\n                            ON Bud.TaskCode=DeBud.TaskCode AND Bud.OrderNumber=DeBud.OrderNumber\r\n                            LEFT JOIN DeQty\r\n                            ON Bud.TaskCode=DeQty.TaskCode AND Bud.OrderNumber=DeQty.OrderNumber                \r\n                            WHERE 1=1 {1}\r\n                            ORDER BY Bud.OrderNumber";
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str = str + " AND Bud.TaskCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str = str + " AND Bud.TaskName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, prjId, str);
            }
            else
            {
                format = "WITH ConBud AS\r\n                            (\r\n                            --合同预算\r\n                            SELECT TaskName,TaskCode,ISNULL(Total,0.0)AS TenderTotal,\r\n                            ISNULL(Total,0.0)/NULLIF(Quantity,0.0) AS TenderPrice\r\n                            FROM Bud_ContractTask WHERE PrjId='{0}'\r\n                            ),\r\n                            Bud AS \r\n                            (\r\n                            --目标成本\r\n                            SELECT BT.TaskName,BT.TaskCode,BT.TaskId ,BT.OrderNumber,ISNULL(BT.Total2,0.0) AS TargetTotal,\r\n                            ISNULL(BT.Total2,0.0)/NULLIF(BT.Quantity,0.0) AS TargetPrice\r\n                            FROM Bud_Task BT\r\n                            WHERE BT.PrjId='{0}'\r\n                            ),\r\n                            DeBud AS\r\n                            (\r\n                            --实际成本\r\n                            SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity ,\r\n                            ISNULL(SUM(BCT.CompleteQuantity),0.0)*ISNULL(BT.Total2,0.0)/NULLIF(BT.Quantity,0.0) AS RealityTotal,\r\n                            ISNULL(BT.Total2,0.0)/NULLIF(BT.Quantity,0.0) AS RealityPrice\r\n                            FROM Bud_Task BT\r\n                            LEFT JOIN Bud_ConsTask BCT\r\n                            ON BT.TaskId=BCT.TaskId\r\n                            WHERE BT.PrjId='{0}'\r\n                            GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.Total2,BT.Quantity\r\n                            )\r\n                            SELECT Bud.*,ISNULL(ConBud.TenderTotal,0.0) AS TenderTotal,\r\n                            ISNULL(ConBud.TenderPrice,0.0) AS TenderPrice,\r\n                            ISNULL(DeBud.RealityTotal,0.0) AS RealityTotal,\r\n                            ISNULL(DeBud.RealityPrice,0.0) AS RealityPrice\r\n                            FROM Bud\r\n                            LEFT JOIN ConBud\r\n                            ON Bud.TaskName=ConBud.TaskName\r\n                            LEFT JOIN DeBud\r\n                            ON Bud.TaskName=DeBud.TaskName";
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str = str + " AND Bud.TaskCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str = str + " AND Bud.TaskName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, prjId, str);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetBudgetAnalysis(string prjCode, string prjName, string startDate, string endDate, string userCode, string isWBSRelevance)
        {
            string str = ConfigHelper.Get("IsIncomeContractApprove");
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            if (isWBSRelevance == "0")
            {
                builder.Append("\r\n                SELECT PART1.PrjGuid,PrjCode,PrjName,StartDate,EndDate,Tender,\r\n                ISNULL(IndirBud,0) AS IndirBud,ISNULL(IndirAcc,0) AS IndirAcc,\r\n                CONVERT(DECIMAL(18,3),ISNULL(Target,0)) AS Target,\r\n                CONVERT(DECIMAL(18,3),ISNULL(Reality,0)) AS Reality,\r\n                Convert(Nvarchar(30), cast(ISNULL((ISNULL(Reality,0)+ISNULL(IndirAcc,0))/ NULLIF(ISNULL(Target,0)+ISNULL(IndirBud,0),0),0)*100 as decimal(20,2)))+'%' PercentCompleted   \r\n                FROM \r\n                (\r\n                    SELECT * FROM\r\n                    (\r\n                        SELECT PrjGuid,PrjCode,PrjName,StartDate,EndDate,(SumContractPrice + ISNULL(SumChangePrice,0)) AS TENDER FROM\r\n                        (\r\n                            --统计收入合同金额\r\n                            SELECT PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate,\r\n\t\t\t                SUM(ISNULL(ContractPrice,0)) AS SumContractPrice FROM PT_PrjInfo AS PRJ ");
                if (str == "0")
                {
                    builder.AppendFormat(" \r\n                                LEFT JOIN (SELECT * FROM Con_Incomet_Contract WHERE ConState!=4)AS INCON ON PRJ.PrjGuid=INCON.Project\r\n                                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n                                WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{1}',Podepom)>0)  \r\n\t\t\t                    AND PrjCode LIKE '%{2}%' AND PrjName LIKE '%{3}%' AND SetUpFlowState=1 AND PrjState<>17 ", new object[] { userCode, userCode, prjCode, prjName });
                }
                else
                {
                    builder.AppendFormat(" \r\n                                LEFT JOIN (SELECT * FROM Con_Incomet_Contract WHERE ConState!=4  AND FlowState=1)AS INCON ON PRJ.PrjGuid=INCON.Project\r\n                                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n                                WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{1}',Podepom)>0)  \r\n\t\t\t                    AND PrjCode LIKE '%{2}%' AND PrjName LIKE '%{3}%' AND SetUpFlowState=1 AND PrjState<>17 ", new object[] { userCode, userCode, prjCode, prjName });
                }
                if (string.IsNullOrEmpty(startDate) && !string.IsNullOrEmpty(endDate))
                {
                    builder.AppendFormat(" AND PRJ.StartDate <='{0}'", endDate);
                }
                else if (!string.IsNullOrEmpty(startDate) && string.IsNullOrEmpty(endDate))
                {
                    builder.AppendFormat("AND PRJ.StartDate>='{0}'", startDate);
                }
                else if (!string.IsNullOrEmpty(startDate) && !string.IsNullOrEmpty(endDate))
                {
                    builder.AppendFormat("AND( PRJ.StartDate>='{0}' AND PRJ.StartDate <='{1}')", startDate, endDate);
                }
                builder.Append("\r\n                            GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n                        ) AS CONPRICE\r\n                        LEFT JOIN (\r\n                            --统计项目的变更合同金额\r\n                            SELECT Project,SUM(ISNULL(ChangePrice,0)) AS SumChangePrice FROM Con_Incomet_Contract AS INCON \r\n                            LEFT JOIN Con_Incomet_Modify AS INMOD ON INCON.ContractID=INMOD.ContractID\r\n                            WHERE ConState!=4 AND FlowState=1 GROUP BY Project\r\n                        )AS CHANGEPRICE ON CONPRICE.PrjGuid=CHANGEPRICE.Project\r\n                    ) AS TENDER \r\n                    LEFT JOIN \r\n                    (\r\n\t\t                SELECT ProjectId,SUM(ISNULL(AccountAmount,0)) AS INDIRBUD FROM Bud_IndirectBudget \r\n\t\t                WHERE LEN(CBSCode)>6 AND State='2' GROUP BY ProjectId\r\n                    )AS INDIR ON CONVERT(NVARCHAR(50),TENDER.PrjGuid)=INDIR.ProjectId\r\n                    LEFT JOIN\r\n                    (\r\n\t\t                SELECT ProjectId AS ProjectId2,SUM(Amount) AS IndirAcc FROM Bud_IndirectDiaryCost AS Diary\r\n\t\t                LEFT JOIN  Bud_IndirectDiaryDetails AS DiaryDetails ON Diary.InDiaryId=DiaryDetails.InDiaryId\r\n\t\t                WHERE FlowState='1'  AND CostType = 'P' AND CBSCode IS NOT NULL AND CBSCode <>'' GROUP BY ProjectId\r\n                    )AS DIARYS ON TENDER.PrjGuid=DIARYS.ProjectId2\r\n                )AS PART1 \r\n                LEFT JOIN \r\n                (\r\n\t                SELECT * FROM \r\n\t                (\r\n\t\t                SELECT PrjGuid,SUM(BudTotal) Target FROM\r\n\t\t                (\r\n\t\t\t                SELECT BudInfo.PrjId PrjGuid,BudInfo.TaskId,(Total+ISNUll(ModifyAmount,0)) BudTotal FROM \r\n\t\t\t                (\r\n\t\t\t\t                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,Version FROM Bud_Task AS BudTask\r\n\t\t\t\t                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t\t                AND BudTask.Version=vGetCurBudVersion.CurVersion \r\n\t\t\t\t                WHERE len(OrderNumber)=3 AND TaskType=''\r\n\t\t\t                ) BudInfo \r\n\t\t\t                LEFT JOIN \r\n\t\t\t                (\r\n\t\t\t\t                --预算变更\r\n\t\t\t\t                SELECT PrjId,SUM(Total) ModifyAmount,modifyTask.TaskId FROM Bud_Modify modify\r\n\t\t\t\t                INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t\t\t                WHERE FlowState=1 AND ModifyType=1 Group By PrjId,modifyTask.TaskId  \r\n\t\t\t                ) modifyInfo ON BudInfo.TaskId=modifyInfo.TaskId\r\n\t\t                ) Bud GROUP BY PrjGuid\r\n\t                ) AS TARGET \r\n\t                LEFT JOIN \r\n\t                (\r\n\t\t                --施工报量的工程量*目标成本的综合单价\r\n\t\t                SELECT ConsRep.PrjId,SUM(ISNULL(AccountingQuantity,0)*ISNULL(UnitPrice,0)) AS Reality \r\n\t\t                FROM Bud_ConsTask AS ConsTask\r\n\t\t                LEFT JOIN Bud_ConsReport AS ConsRep ON ConsTask.ConsReportId=ConsRep.ConsReportId\r\n\t\t                LEFT JOIN \r\n\t\t                (\r\n\t\t\t                --预算\r\n\t\t\t                SELECT PrjId,TaskId,ISNULL(Total/NULLIF(Quantity,0),0) UnitPrice FROM \r\n\t\t\t                (\r\n\t\t\t\t                SELECT budInfo.PrjId,budInfo.TaskId,(budInfo.Total+ISNULL(modifyInfo.Total,0)) Total,\r\n\t\t\t\t                (budInfo.Quantity+ISNULL(modifyInfo.Quantity,0)) Quantity FROM \r\n\t\t\t\t                (\r\n\t\t\t\t\t                --完整的预算\r\n\t\t\t\t\t                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,ISNULL(Quantity,0) Quantity\r\n\t\t\t\t\t                FROM Bud_Task AS BudTask \r\n\t\t\t\t\t                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t\t\t                AND BudTask.Version=vGetCurBudVersion.CurVersion\r\n\t\t\t\t\t                UNION\r\n\t\t\t\t\t                SELECT PrjId,ModifyTaskId TaskId,Total,Quantity FROM Bud_Modify modify\r\n\t\t\t\t\t                JOIN Bud_ModifyTask modifyTask ON modify.modifyId=modifyTask.modifyId\r\n\t\t\t\t\t                WHERE flowState=1 AND ModifyType=0 \r\n\t\t\t\t                ) budInfo\r\n\t\t\t\t                LEFT JOIN \r\n\t\t\t\t                (\r\n\t\t\t                        --清单内的预算变更\r\n\t\t\t                        SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t\t                        JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t\t                        WHERE FlowState=1 AND ModifyType=1\r\n\t\t\t                        GROUP BY TaskId,PrjId\r\n\t\t\t\t                ) modifyInfo ON budInfo.TaskId=modifyInfo.TaskId\r\n\t\t\t                ) Bud \r\n\t\t                ) AS BudTask ON ConsTask.TaskId=BudTask.TaskId\r\n\t\t                WHERE flowState=1 GROUP BY ConsRep.PrjId\r\n\t                ) AS REALITY ON TARGET.PrjGuid=REALITY.PrjId\r\n                )AS PART2 ON PART1.PrjGuid=PART2.PrjGuid ORDER BY StartDate DESC ");
            }
            else
            {
                builder.Append("\r\n                SELECT Part1.PrjGuid,PrjCode,PrjName,StartDate,EndDate,Tender,\r\n                ISNULL(IndirBud,0) AS IndirBud,ISNULL(IndirAcc,0) AS IndirAcc,\r\n                CONVERT(DECIMAL(18,3),ISNULL(Target,0)) AS Target,\r\n                CONVERT(DECIMAL(18,3),ISNULL(Reality,0)) AS Reality,\r\n                Convert(Nvarchar(30), cast(ISNULL((ISNULL(Reality,0)+ISNULL(IndirAcc,0))/ NULLIF(ISNULL(Target,0)+ISNULL(IndirBud,0),0),0)*100 as decimal(20,2)))+'%' PercentCompleted    \r\n                FROM \r\n                (\r\n                    SELECT * FROM\r\n                    (\r\n                        SELECT PrjGuid,PrjCode,PrjName,StartDate,EndDate,(SumContractPrice + ISNULL(SumChangePrice,0)) AS Tender FROM\r\n                        (\r\n                            --统计收入合同金额\r\n                            SELECT PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate,\r\n\t\t\t                SUM(ISNULL(ContractPrice,0)) AS SumContractPrice FROM PT_PrjInfo AS PRJ  ");
                if (str == "0")
                {
                    builder.AppendFormat(" \r\n                                LEFT JOIN (SELECT * FROM Con_Incomet_Contract WHERE ConState!=4)AS INCON ON PRJ.PrjGuid=INCON.Project\r\n                                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n                                WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{1}',Podepom)>0)  \r\n\t\t\t                    AND PrjCode LIKE '%{2}%' AND PrjName LIKE '%{3}%' AND SetUpFlowState=1 AND PrjState<>17 ", new object[] { userCode, userCode, prjCode, prjName });
                }
                else
                {
                    builder.AppendFormat(" \r\n                                LEFT JOIN (SELECT * FROM Con_Incomet_Contract WHERE ConState!=4  AND FlowState=1)AS INCON ON PRJ.PrjGuid=INCON.Project\r\n                                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n                                WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{1}',Podepom)>0)  \r\n\t\t\t                    AND PrjCode LIKE '%{2}%' AND PrjName LIKE '%{3}%' AND SetUpFlowState=1 AND PrjState<>17 ", new object[] { userCode, userCode, prjCode, prjName });
                }
                if (string.IsNullOrEmpty(startDate) && !string.IsNullOrEmpty(endDate))
                {
                    builder.AppendFormat(" AND PRJ.StartDate <='{0}'", endDate);
                }
                else if (!string.IsNullOrEmpty(startDate) && string.IsNullOrEmpty(endDate))
                {
                    builder.AppendFormat("AND PRJ.StartDate>='{0}'", startDate);
                }
                else if (!string.IsNullOrEmpty(startDate) && !string.IsNullOrEmpty(endDate))
                {
                    builder.AppendFormat("AND( PRJ.StartDate>='{0}' AND PRJ.StartDate <='{1}')", startDate, endDate);
                }
                builder.Append(" GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n                        ) AS ConPrice\r\n                        LEFT JOIN (\r\n                            --统计项目的变更合同金额\r\n                            SELECT Project,SUM(ISNULL(ChangePrice,0)) AS SumChangePrice FROM Con_Incomet_Contract AS INCON \r\n                            LEFT JOIN Con_Incomet_Modify AS INMOD ON INCON.ContractID=INMOD.ContractID\r\n                            WHERE ConState!=4 AND FlowState=1 GROUP BY Project\r\n                        )AS ChangePrice ON ConPrice.PrjGuid=ChangePrice.Project\r\n                    ) AS Tender \r\n                    LEFT JOIN \r\n                    (\r\n\t\t                --间接成本预算(间接成本预算发生费用)\r\n                        SELECT ProjectId,SUM(ISNULL(AccountAmount,0)) AS IndirBud FROM Bud_IndirectBudget \r\n                        WHERE LEN(CBSCode)>6 AND State='2' GROUP BY ProjectId\r\n                    )AS Indir ON CONVERT(NVARCHAR(50),Tender.PrjGuid)=Indir.ProjectId\r\n                    LEFT JOIN\r\n                    (\r\n\t\t                --间接成本日记账(间接成本实际发生费用)\r\n                        SELECT ProjectId AS ProjectId2,SUM(Amount) AS IndirAcc FROM Bud_IndirectDiaryCost AS Diary\r\n                        LEFT JOIN  Bud_IndirectDiaryDetails AS DiaryDetails ON Diary.InDiaryId=DiaryDetails.InDiaryId\r\n                        WHERE FlowState='1'  AND CostType = 'P' AND CBSCode IS NOT NULL AND CBSCode <>'' GROUP BY ProjectId\r\n                    )AS Diarys ON Tender.PrjGuid=Diarys.ProjectId2\r\n                )AS Part1 \r\n                LEFT JOIN \r\n                (\r\n                    SELECT PrjGuid,(Target+ISNULL(ModifyAmount,0)) Target,Reality  FROM (\r\n\t\t                --原预算\r\n\t\t                SELECT Task.PrjId AS PrjGuid,\r\n\t\t                SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) AS Target \r\n\t\t                FROM Bud_Task AS Task \r\n\t\t                INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t                LEFT JOIN Bud_TaskResource AS TaskRES ON Task.TaskId =TaskRES.TaskId\r\n\t\t                WHERE TaskType=''\r\n\t\t                GROUP BY Task.PrjId\r\n\t                )AS Target \r\n\t                LEFT JOIN \r\n\t                (\r\n\t\t                --预算变更\r\n\t\t                SELECT PrjId,SUM(ResourceQuantity*ResourcePrice) ModifyAmount FROM Bud_Modify modify\r\n\t\t                INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                INNER JOIN Bud_ModifyTaskRes modifyTaskRes ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId\r\n\t\t                WHERE FlowState=1 Group By PrjId\t\t\t\r\n\t                ) ModifyAmount ON Target.PrjGuid=ModifyAmount.PrjId\r\n                    LEFT JOIN (\r\n\t\t                --施工报量\r\n\t\t                SELECT PrjId,SUM(ISNULL(CONSRES.AccountingQuantity,0)*ISNULL(CONSRES.UnitPrice,0)) AS Reality \r\n\t\t                FROM Bud_ConsTaskRes AS CONSRES\r\n\t\t                LEFT JOIN  Bud_ConsTask AS CONSTask ON  CONSRES.ConsTaskId=CONSTask.ConsTaskId\r\n\t\t                LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTask.ConsReportId=CONSREP.ConsReportId\r\n\t\t                WHERE FlowState=1 GROUP BY PrjId\r\n\t                ) AS Reality ON Target.PrjGuid=Reality.PrjId\r\n                )AS Part2 ON Part1.PrjGuid=Part2.PrjGuid ORDER BY StartDate DESC\r\n                ");
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString());
        }

        public static DataTable GetBudgetDetail(string prjId, string taskCode, string taskName, string isWBSRelevance)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            if (string.IsNullOrEmpty(prjId))
            {
                return null;
            }
            if (isWBSRelevance == "1")
            {
                builder.AppendFormat("\r\n                --DECLARE @PrjId nvarchar(50),@Version int \r\n                --set @PrjId='a25fdb14-8841-4193-9017-80d1da6c6e10';\r\n                WITH Task AS\r\n                (\r\n\t                --总预算\r\n\t                SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,budTaskInfo.PrjId,\r\n\t                (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n\t                (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) TargetTotal FROM \r\n\t                (\r\n\t\t                --原预算\r\n\t\t                SELECT task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity,\r\n\t\t                ISNULL(SUM(ResourceQuantity*ResourcePrice),0) Total FROM\r\n\t\t                (\r\n\t\t\t                SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n\t\t\t                Bud_Task budTask\r\n\t\t\t                JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t                AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t\t                ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n\t\t                GROUP BY task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity\r\n\t\t                UNION\r\n\t\t                --清单外的预算变更\r\n\t\t                SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n\t\t                PrjId,Quantity,Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) budTaskInfo\r\n\t                LEFT JOIN\r\n\t                (\r\n                        --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t\t                GROUP BY TaskId,PrjId\r\n\t                ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n                ),Conts AS\r\n                (\r\n\t                --中标预算\r\n\t                SELECT (ConBudTask.ContTotal+ISNULL(ModifyTask.ContTotal,0)) ContTotal,TenderPrice,OrderNumber FROM \r\n\t                (\r\n\t\t                --原中标预算\r\n\t\t                SELECT TaskId,Total AS ContTotal,UnitPrice AS TenderPrice,OrderNumber FROM Bud_ContractTask \r\n\t\t                INNER JOIN Bud_ContractTaskAudit ON Bud_ContractTask.PrjId=Bud_ContractTaskAudit.PrjId \r\n\t\t                WHERE Bud_ContractTask.PrjId=@PrjId AND FlowState=1 AND TaskType=''\r\n\t\t                UNION\r\n\t\t                --清单外的中标预算变更\r\n\t\t                SELECT TaskId,Total ContTotal,UnitPrice TenderPrice, OrderNumber FROM Bud_ConModify modify\r\n\t\t                JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) ConBudTask\r\n\t                LEFT JOIN \r\n\t                (\r\n\t\t                --清单内的中标预算变更\r\n\t\t                SELECT Total ContTotal,TaskId FROM Bud_ConModify modify\r\n\t\t                JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t                ) ModifyTask ON ConBudTask.TaskId=ModifyTask.TaskId\r\n                ),Account AS\r\n                (\r\n\t                --实际成本总价\r\n\t                SELECT ConsTask.TaskId,AccTotalQuantity,\r\n\t                Sum(UnitPrice*ConsTaskRes.AccountingQuantity) AS RealityTotal\r\n\t                FROM Bud_ConsTaskRes AS ConsTaskRes\r\n\t                RIGHT JOIN\r\n\t                (\r\n\t\t                SELECT ConsTaskId,AccountingQuantity,TaskId FROM Bud_ConsTask WHERE ConsReportId \r\n\t\t                IN(SELECT ConsReportId FROM Bud_ConsReport WHERE PrjId=@PrjId AND FlowState=1)\r\n\t\t                AND TaskId IN(SELECT TaskId FROM TASK)\r\n\t                ) AS ConsTask ON ConsTaskRes.ConsTaskId=ConsTask.ConsTaskId \r\n\t                LEFT JOIN (\r\n\t                 SELECT TaskId,SUM(ISNULL(AccountingQuantity,0)) AS AccTotalQuantity FROM Bud_ConsTask GROUP BY TaskId\r\n\t                ) AS TCOMQuantity ON ConsTask.TaskId=TCOMQuantity.TaskId\r\n\t                GROUP BY ConsTask.TaskId,AccTotalQuantity\r\n                )\r\n                SELECT TaskId,TaskCode,TaskName,Totals.OrderNumber,RealityTotal,RealityPrice,TargetTotal,TargetPrice,\r\n                ISNULL(TenderPrice,0) AS TenderPrice,ISNULL(CONTTotal,0) AS TenderTotal \r\n                FROM\r\n                (\r\n                    SELECT Task.TaskId,Task.TaskCode,Task.TaskName,Task.Quantity,Task.OrderNumber,\r\n                    CONVERT(DECIMAL(18,3),ISNULL(RealityTotal,0))AS RealityTotal,\r\n                    CASE AccTotalQuantity WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(18,3),ISNULL(RealityTotal/AccTotalQuantity,0)) END AS RealityPrice, \r\n                    CONVERT(DECIMAL(18,3),ISNULL(TargetTotal,0))AS TargetTotal,\r\n                    CASE Task.Quantity WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(18,3),ISNULL(TargetTotal/Task.Quantity,0)) END AS TargetPrice\r\n                    FROM Task LEFT JOIN Account ON Task.TaskId=Account.TaskId\r\n                ) AS Totals \r\n                LEFT JOIN Conts ON Totals.OrderNumber=Conts.OrderNumber \r\n                WHERE TaskCode LIKE '%{0}%' AND TaskName LIKE '%{1}%'\r\n                ORDER BY Totals.OrderNumber \r\n                ", taskCode, taskName);
            }
            else
            {
                builder.AppendFormat("\r\n                --DECLARE @PrjId nvarchar(50),@Version int \r\n                --set @PrjId='a25fdb14-8841-4193-9017-80d1da6c6e10';\r\n                WITH Task AS\r\n                (\r\n                    --总预算\r\n                    SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,budTaskInfo.PrjId,\r\n                    (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n                    (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) TargetTotal,TaskType FROM \r\n                    (\r\n                        --原预算\r\n                        SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity,ISNULL(Total,0) Total,TaskType FROM \r\n                        Bud_Task budTask\r\n                        JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        AND budTask.PrjId=@PrjId\r\n                        UNION\r\n                        --清单外的预算变更\r\n                        SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n                        PrjId,Quantity,Total,'' TaskType FROM Bud_Modify modify\r\n                        JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n                    ) budTaskInfo\r\n                    LEFT JOIN\r\n                    (\r\n                        --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t\t                GROUP BY TaskId,PrjId\r\n                    ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n                ),Conts AS\r\n                (\r\n\t                --中标预算\r\n\t                SELECT (ConBudTask.ContTotal+ISNULL(ModifyTask.ContTotal,0)) ContTotal,TenderPrice,OrderNumber FROM \r\n\t                (\r\n\t\t                --原中标预算\r\n\t\t                SELECT TaskId,Total AS ContTotal,UnitPrice AS TenderPrice,OrderNumber FROM Bud_ContractTask \r\n\t\t                INNER JOIN Bud_ContractTaskAudit ON Bud_ContractTask.PrjId=Bud_ContractTaskAudit.PrjId \r\n\t\t                WHERE Bud_ContractTask.PrjId=@PrjId AND FlowState=1 AND TaskType=''\r\n\t\t                UNION\r\n\t\t                --清单外的中标预算变更\r\n\t\t                SELECT TaskId,Total ContTotal,UnitPrice TenderPrice, OrderNumber FROM Bud_ConModify modify\r\n\t\t                JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n\t                ) ConBudTask\r\n\t                LEFT JOIN \r\n\t                (\r\n\t\t                --清单内的中标预算变更\r\n\t\t                SELECT Total ContTotal,TaskId FROM Bud_ConModify modify\r\n\t\t                JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t                ) ModifyTask ON ConBudTask.TaskId=ModifyTask.TaskId\r\n                ),Account AS\r\n                (\r\n\t                --施工报量\r\n\t                SELECT TaskId,AccTotalQuantity, (AccTotalQuantity*unitPrice) RealityTotal FROM \r\n\t                (\r\n\t\t                SELECT ConsInfo.TaskId,AccTotalQuantity,ISNULL(TargetTotal/NULLIF(Quantity,0),0) unitPrice FROM \r\n\t\t                (\r\n\t\t\t                SELECT TaskId,SUM(AccountingQuantity) AccTotalQuantity FROM Bud_ConsReport consReport \r\n\t\t\t                LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId\r\n\t\t\t                WHERE PrjId=@PrjId AND FlowState=1 GROUP BY TaskId\r\n\t\t                )ConsInfo LEFT JOIN Task ON ConsInfo.TaskId=Task.TaskId\r\n\t                ) Con\r\n                )\r\n                SELECT TaskId,TaskCode,TaskName,Totals.OrderNumber,RealityTotal,RealityPrice,TargetTotal,TargetPrice,\r\n                ISNULL(TenderPrice,0) AS TenderPrice,ISNULL(CONTTotal,0) AS TenderTotal \r\n                FROM\r\n                (\r\n                    SELECT TASK.TaskId,TASK.TaskCode,TASK.TaskName,TASK.Quantity,TASK.OrderNumber,\r\n                    CONVERT(DECIMAL(18,3),ISNULL(RealityTotal,0))AS RealityTotal,\r\n                    CASE AccTotalQuantity WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(18,3),ISNULL(RealityTotal/AccTotalQuantity,0)) END AS RealityPrice, \r\n                    CONVERT(DECIMAL(18,3),ISNULL(TargetTotal,0))AS TargetTotal,\r\n                    CASE TASK.Quantity WHEN 0 THEN 0 ELSE CONVERT(DECIMAL(18,3),ISNULL(TargetTotal/TASK.Quantity,0)) END AS TargetPrice\r\n                    FROM Task\r\n                    LEFT JOIN Account ON Task.TaskId=Account.TaskId WHERE TaskType=''\r\n                ) AS Totals \r\n                LEFT JOIN  Conts\r\n                ON Totals.OrderNumber=Conts.OrderNumber WHERE TaskCode LIKE '%{0}%' AND TaskName LIKE '%{1}%'\r\n                ORDER BY Totals.OrderNumber\r\n                ", taskCode, taskName);
            }
            SqlParameter parameter = new SqlParameter("@prjId", prjId);
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), new SqlParameter[] { parameter });
        }

        public static DataTable GetBudGetOutPut(string prjId, int pageSize, int pageIndex)
        {
            int num = pageSize * (pageIndex - 1);
            int num2 = pageSize * pageIndex;
            string str = string.Empty;
            if ((pageSize == 0) && (pageIndex == 0))
            {
                str = string.Empty;
            }
            else
            {
                str = string.Concat(new object[] { " WHERE No >", num, " AND No <= ", num2 });
            }
            string format = "WITH Task AS\r\n                            (\r\n                            --目标成本\r\n                            SELECT TaskId,OrderNumber,TaskCode,TaskName,Unit,Quantity,Total2 AS BudTotal,FeatureDescription FROM Bud_Task\r\n                            WHERE PrjId='{0}' AND TaskType=''\r\n                            ),Code AS\r\n                            (\r\n                            SELECT ROW_NUMBER() OVER(ORDER BY cl.CodeId) AS CodeNo, cl.CodeId, cl.CodeName \r\n                            FROM XPM_Basic_CodeList AS cl\r\n                            INNER JOIN XPM_Basic_CodeType AS ct ON cl.TypeId = ct.TypeId\r\n                            WHERE ct.SignCode = 'taskType' AND cl.IsValid = '1'\r\n                            ),ConTask AS\r\n                            (\r\n                            --合同预算\r\n                            SELECT TaskId,OrderNumber,TaskCode,TaskName,Unit,Quantity,Total FROM Bud_ContractTask\r\n                            WHERE PrjId='{0}' AND TaskType=''\r\n                            ),RESULT AS\r\n                            (\r\n                            SELECT ROW_NUMBER() OVER(ORDER BY Task.OrderNumber) AS No,Task.*,Code.CodeName AS TypeName,ISNULL(ConTask.Total,0.0) AS ConTotal,                 \r\n                            ISNULL(ISNULL(ConTask.Total,0.0)/NULLIF(ISNULL(ConTask.Quantity,0.0),0.0),0.0) AS ConUnitPrice,\r\n                            ISNULL(ConTask.Total,0.0)-Task.BudTotal AS Profit,\r\n                            ABS(ISNULL(ConTask.Total,0.0)-Task.BudTotal) /NULLIF(Task.Quantity,0.0) AS BudUnitPrice,\r\n                            Convert(Nvarchar(30), cast(ISNULL(ABS(ISNULL(ConTask.Total,0.0)-Task.BudTotal)/NULLIF(ISNULL(ConTask.Total,0.0) ,0),0)*100 as decimal(20,2)))+'%' ProfitRate \r\n                            FROM Task\r\n                            LEFT JOIN  ConTask\r\n                            ON Task.TaskName=ConTask.TaskName AND Task.OrderNumber=ConTask.OrderNumber\r\n                            LEFT JOIN Code \r\n                            ON LEN(Task.OrderNumber) / 3 = CASE (SELECT COUNT(*) FROM Code) WHEN 0 THEN 1 ELSE Code.CodeNo END\r\n                            )\r\n                            SELECT * FROM  RESULT {1}";
            format = string.Format(format, prjId, str);
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetBudTaskCost(string prjCode, string prjName, string userCode, string isWBSRelevance)
        {
            string format = string.Empty;
            string str2 = string.Empty;
            DateTime now = DateTime.Now;
            int month = now.Month;
            int year = now.Year;
            if (isWBSRelevance == "1")
            {
                format = "WITH Mbud AS\r\n                        (\r\n                        --月直接成本预算\r\n                        SELECT SUM(ISNULL(TT.Bud,0.0)) AS MonthRealitybud,TT.prjId FROM\r\n                        (\r\n                        SELECT SUM(ISNULL(M.CompleteQuantity,0.0)/NULLIF(M.Quantity,0.0)*ISNULL(M.Total2,0.0))AS Bud,M.prjId FROM\r\n                        (\r\n                        SELECT CompleteQuantity,T.prjId,BT.Quantity,T.TaskId,BT.Total2 FROM\r\n                        (\r\n                        SELECT BCT.CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE  BRT.FlowState=1 AND MONTH(BRT.InputDate)={0} AND YEAR(BRT.InputDate)={1} --查询条件\r\n                        ) T\r\n                        LEFT JOIN Bud_Task BT\r\n                        ON BT.TaskId=T.TaskId\r\n                        )M\r\n                        GROUP BY M.prjId,M.CompleteQuantity,M.Quantity,M.Total2\r\n                        ) TT\r\n                        GROUP BY TT.prjId\r\n                        ),\r\n                        MIndeBud AS\r\n                        (\r\n                        --间接成本月度预算\r\n                        SELECT SUM(Amount) Monthbud,ProjectId FROM \r\n                        (\r\n                        SELECT monthBudget.*,indirectBudget.ProjectId FROM Bud_IndirectMonthBudget AS monthBudget\r\n                        INNER JOIN Bud_IndirectBudget AS indirectBudget ON monthBudget.IndirectBudget=indirectBudget.Id\r\n                        WHERE monthBudget.Year={1} AND monthBudget.Month={0}\r\n                        ) AS MonthIndirectBud GROUP BY ProjectId\r\n                        ),\r\n                        MDeTask AS\r\n                        (\r\n                        --月度直接成本\r\n                        SELECT M.prjId,SUM(TTT) AS MonthReality FROM\r\n                        (\r\n                        SELECT T.prjId,SUM(BTR.Quantity*BTR.UnitPrice) TTT FROM \r\n                        (\r\n                        SELECT BRT.PrjId,BCT.ConsTaskId FROM Bud_ConsReport BRT\r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={0} AND YEAR(BRT.InputDate)={1} --查询条件\r\n                        ) T\r\n                        JOIN  Bud_ConsTaskRes BTR ON \r\n                        T.ConsTaskId=BTR.ConsTaskId\r\n                        GROUP BY T.prjId,BTR.Quantity,BTR.UnitPrice\r\n                        ) M\r\n                        GROUP BY M.prjId\r\n                        ),\r\n                        MIndeTask AS\r\n                        (\r\n                        --月度间接成本\r\n                        SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS Monthacc FROM Bud_IndirectDiaryCost C\r\n                        JOIN Bud_IndirectDiaryDetails D\r\n                        ON C.InDiaryId=D.InDiaryId\r\n                        WHERE LEN(ProjectId)>20 AND C.FlowState=1 AND MONTH(C.InputDate)={0} AND YEAR(C.InputDate)={1}\r\n                        GROUP BY C.ProjectId\r\n                        ),\r\n                        Bud AS\r\n                        (\r\n                        --累计直接成本预算\r\n                        SELECT M.PrjGuid,M.PrjCode,M.PrjName,M.Total1+ISNULL(SUM(MF.Total2),0.0)AS Target FROM \r\n                        (\r\n                        SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,ISNULL(SUM(T.ResourcePrice*T.ResourceQuantity),0.0) AS Total1\r\n                        FROM  PT_PrjInfo  PT\t\r\n                        LEFT JOIN PT_PrjInfo_ZTB_Detail PTZ\r\n                        ON PT.PrjGuid =cast(PTZ.PrjGuid as nvarchar(64))                   \r\n                        LEFT JOIN \r\n                        (\r\n                        SELECT BTS.* FROM Bud_TaskResource BTS \r\n                        LEFT JOIN Bud_Task BT\r\n                        ON BTS.TaskId=BT.TaskId\r\n                        WHERE BT.TaskType=''\r\n                        ) T\r\n                        ON PT.PrjGuid=cast(T.PrjGuid as nvarchar(64))\r\n                        WHERE  PT.PrjState<>17 AND PTZ.SetUpFlowState=1                        \r\n                        GROUP BY PT.PrjGuid,PT.PrjCode,PT.PrjName\r\n                        ) M\r\n                        LEFT JOIN Bud_ModifyTask MF\r\n                        ON M.PrjGuid=cast(MF.prjId2 as nvarchar(64))\r\n                        GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName,M.Total1\r\n                        ),\r\n                        IndeBud AS\r\n                        (\r\n                        --累计间接成本预算\r\n                        SELECT SUM(ISNULL(AccountAmount,0.0)) AS IndirBud,cast(ProjectId as nvarchar(64)) AS ProjectId FROM Bud_IndirectBudget \r\n                        WHERE LEN(CBSCode)>6 AND State=2 AND LEN(ProjectId)>20\r\n                        GROUP BY ProjectId\r\n                        ),\r\n                        DeTask AS\r\n                        (\r\n                        --直接成本\r\n                        SELECT M.prjId,SUM(TTT) AS Reality FROM\r\n                        (\r\n                        SELECT T.prjId,SUM(BTR.Quantity*BTR.UnitPrice) TTT FROM \r\n                        (\r\n                        SELECT BRT.PrjId,BCT.ConsTaskId FROM Bud_ConsReport BRT\r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1\r\n                        ) T\r\n                        JOIN  Bud_ConsTaskRes BTR ON \r\n                        T.ConsTaskId=BTR.ConsTaskId\r\n                        GROUP BY T.prjId,BTR.Quantity,BTR.UnitPrice\r\n                        ) M\r\n                        GROUP BY M.prjId\r\n                        ),\r\n                        IndeTask AS\r\n                        (\r\n                        --间接成本\r\n                        SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS IndirAcc FROM Bud_IndirectDiaryCost C\r\n                        JOIN Bud_IndirectDiaryDetails D\r\n                        ON C.InDiaryId=D.InDiaryId\r\n                        WHERE LEN(ProjectId)>20 AND C.FlowState=1\r\n                        GROUP BY C.ProjectId\r\n                        ),\r\n                        RESULT AS\r\n                        (\r\n                        SELECT Bud.*,ISNULL(Mbud.MonthRealitybud,0.0)AS MonthRealitybud,\r\n                        ISNULL(MIndeBud.Monthbud,0.0)AS Monthbud,\r\n                        ISNULL(MDeTask.MonthReality,0.0) AS MonthReality,\r\n                        ISNULL(MIndeTask.Monthacc,0.0)AS Monthacc,\r\n                        ISNULL(IndeBud.IndirBud,0.0)AS IndirBud,\r\n                        ISNULL(DeTask.Reality,0.0)AS Reality,\r\n                        ISNULL(IndeTask.IndirAcc,0.0)AS IndirAcc,\r\n                        ISNULL(ISNULL(IndeBud.IndirBud,0)+ISNULL(Bud.Target,0)-ISNULL(IndeTask.IndirAcc,0)-ISNULL(DeTask.Reality,0),0.000) AS Chazhi,\r\n                        ISNULL(ISNULL(MIndeBud.MonthBud,0)+ISNULL(Mbud.MonthRealitybud,0)-ISNULL(MIndeTask.MonthAcc,0)-ISNULL(MDeTask.MonthReality,0),0.000) AS MonthChazhi,\r\n                        CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(IndirBud,0)+ISNULL(Target,0)-ISNULL(IndirAcc,0)\r\n                        -ISNULL(Reality,0))/nullif(ISNULL(IndirBud,0)+ISNULL(Target,0),0)*100),0.000))+'%' as Bilu,\r\n                        CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(MonthBud,0)+ISNULL(MonthRealitybud,0)-\r\n                        ISNULL(MonthAcc,0)-ISNULL(MonthReality,0))/nullif(ISNULL(MonthBud,0)\r\n                        +ISNULL(MonthRealitybud,0),0)*100),0.000))+'%' as MonthBilu  \r\n                        FROM Bud\r\n                        LEFT JOIN Mbud\r\n                        ON Bud.PrjGuid=Mbud.prjId\r\n                        LEFT JOIN MIndeBud\r\n                        ON Bud.PrjGuid=MIndeBud.ProjectId\r\n                        LEFT JOIN MDeTask\r\n                        ON Bud.PrjGuid=MDeTask.prjId\r\n                        LEFT JOIN MIndeTask\r\n                        ON Bud.PrjGuid=MIndeTask.ProjectId\r\n                        LEFT JOIN IndeBud\r\n                        ON Bud.PrjGuid=IndeBud.ProjectId\r\n                        LEFT JOIN DeTask\r\n                        ON Bud.PrjGuid=DeTask.prjId\r\n                        LEFT JOIN IndeTask\r\n                        ON Bud.PrjGuid=IndeTask.ProjectId\r\n                        )\r\n                        SELECT RESULT.*,PT_PrjInfo.StartDate FROM  RESULT\r\n                        LEFT JOIN PT_PrjInfo\r\n                        ON RESULT.PrjGuid=PT_PrjInfo.PrjGuid                        \r\n                        WHERE 1=1 {2}\r\n                        ORDER BY PT_PrjInfo.StartDate DESC";
                if (!string.IsNullOrEmpty(prjCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + prjCode + "%'";
                }
                if (!string.IsNullOrEmpty(prjName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + prjName + "%'";
                }
                format = string.Format(format, month, year, str2);
            }
            else
            {
                format = "WITH Mbud AS\r\n                        (\r\n                        --月直接成本预算\r\n                        SELECT SUM(ISNULL(TT.Bud,0.0)) AS MonthRealitybud,TT.prjId FROM\r\n                        (\r\n                        SELECT SUM(ISNULL(M.CompleteQuantity,0.0)/NULLIF(M.Quantity,0.0)*ISNULL(M.Total2,0.0))AS Bud,M.prjId FROM\r\n                        (\r\n                        SELECT CompleteQuantity,T.prjId,BT.Quantity,T.TaskId,BT.Total2 FROM\r\n                        (\r\n                        SELECT BCT.CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={0} AND YEAR(BRT.InputDate)={1} --查询条件\r\n                        ) T\r\n                        LEFT JOIN Bud_Task BT\r\n                        ON BT.TaskId=T.TaskId\r\n                        )M\r\n                        GROUP BY M.prjId,M.CompleteQuantity,M.Quantity,M.Total2\r\n                        ) TT\r\n                        GROUP BY TT.prjId\r\n                        ),\r\n                        MIndeBud AS\r\n                        (\r\n                        --间接成本月度预算\r\n                        SELECT SUM(Amount) Monthbud,ProjectId FROM \r\n                        (\r\n                        SELECT monthBudget.*,indirectBudget.ProjectId FROM Bud_IndirectMonthBudget AS monthBudget\r\n                        INNER JOIN Bud_IndirectBudget AS indirectBudget ON monthBudget.IndirectBudget=indirectBudget.Id\r\n                        WHERE monthBudget.Year={1} AND monthBudget.Month={0}\r\n                        ) AS MonthIndirectBud GROUP BY ProjectId\r\n                        ),\r\n                        MDeTask AS\r\n                        (\r\n                        --月度直接成本            \r\n                        SELECT T.PrjId,SUM(T.Reality)AS MonthReality FROM \r\n                        (\r\n                        SELECT cast(RET.PrjId as nvarchar(64)) AS PrjId,SUM(ISNULL(CTK.CompleteQuantity,0.0))* (ISNULL(BTK.Total2,0.0)/NULLIF(BTK.Quantity,0.0)) AS Reality FROM Bud_ConsReport RET\r\n                        JOIN Bud_ConsTask CTK\r\n                        ON RET.ConsReportId=CTK.ConsReportId\r\n                        JOIN Bud_Task BTK\r\n                        ON CTK.TaskId=BTK.TaskId\r\n                        WHERE BET.FlowState=1 AND MONTH(RET.InputDate)={0} AND YEAR(RET.InputDate)={1}\r\n                        GROUP BY RET.PrjId,BTK.Total2,BTK.Quantity\r\n                        ) T\r\n                        GROUP BY  T.PrjId\r\n                        ),\r\n                        MIndeTask AS\r\n                        (\r\n                        --月度间接成本\r\n                        SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS Monthacc FROM Bud_IndirectDiaryCost C\r\n                        JOIN Bud_IndirectDiaryDetails D\r\n                        ON C.InDiaryId=D.InDiaryId\r\n                        WHERE LEN(ProjectId)>20 AND C.FlowState=1 AND MONTH(C.InputDate)={0} AND YEAR(C.InputDate)={1}\r\n                        GROUP BY C.ProjectId\r\n                        ),\r\n                        Bud AS\r\n                        (\r\n                        --累计直接成本预算\r\n                        SELECT M.PrjGuid,M.PrjCode,M.PrjName, SUM(ISNULL(M.Total2,0.0)) AS Target FROM \r\n                        (\r\n                        SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,Con.StartDate,Con.ContractID,MF.Total2\r\n                        FROM  PT_PrjInfo  PT\r\n                        LEFT JOIN Con_Payout_Contract Con\r\n                        ON cast(Con.PrjGuid as nvarchar(64))=PT.PrjGuid\r\n                        LEFT JOIN Bud_ModifyTask MF \r\n                        ON PT.PrjGuid=cast(MF.prjId2 as nvarchar(64))\r\n                        WHERE  PT.PrjState<>17 \r\n                        ) M\r\n                        GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName\r\n                        ),\r\n                        IndeBud AS\r\n                        (\r\n                        --累计间接成本预算\r\n                        SELECT SUM(ISNULL(AccountAmount,0.0)) AS IndirBud,cast(ProjectId as nvarchar(64)) AS ProjectId FROM Bud_IndirectBudget \r\n                        WHERE LEN(CBSCode)>6 AND State=2 AND LEN(ProjectId)>20\r\n                        GROUP BY ProjectId\r\n                        ),\r\n                        DeTask AS\r\n                        (\r\n                       --直接成本\r\n                        SELECT T.PrjId,SUM(T.Reality)AS Reality FROM \r\n                        (\r\n                        SELECT cast(RET.PrjId as nvarchar(64)) AS PrjId,SUM(ISNULL(CTK.CompleteQuantity,0.0))* (ISNULL(BTK.Total2,0.0)/NULLIF(BTK.Quantity,0.0)) AS Reality FROM Bud_ConsReport RET\r\n                        JOIN Bud_ConsTask CTK\r\n                        ON RET.ConsReportId=CTK.ConsReportId\r\n                        JOIN Bud_Task BTK\r\n                        ON CTK.TaskId=BTK.TaskId\r\n                        WHERE BRT.FlowState=1\r\n                        GROUP BY RET.PrjId,BTK.Total2,BTK.Quantity\r\n                        ) T\r\n                        GROUP BY  T.PrjId\r\n                        ),\r\n                        IndeTask AS\r\n                        (\r\n                        --间接成本\r\n                        SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS IndirAcc FROM Bud_IndirectDiaryCost C\r\n                        JOIN Bud_IndirectDiaryDetails D\r\n                        ON C.InDiaryId=D.InDiaryId\r\n                        WHERE LEN(ProjectId)>20 AND C.FlowState=1\r\n                        GROUP BY C.ProjectId\r\n                        ),\r\n                        RESULT AS\r\n                        (\r\n                        SELECT Bud.*,ISNULL(Mbud.MonthRealitybud,0.0)AS MonthRealitybud,\r\n                        ISNULL(MIndeBud.Monthbud,0.0)AS Monthbud,\r\n                        ISNULL(MDeTask.MonthReality,0.0) AS MonthReality,\r\n                        ISNULL(MIndeTask.Monthacc,0.0)AS Monthacc,\r\n                        ISNULL(IndeBud.IndirBud,0.0)AS IndirBud,\r\n                        ISNULL(DeTask.Reality,0.0)AS Reality,\r\n                        ISNULL(IndeTask.IndirAcc,0.0)AS IndirAcc,\r\n                        ISNULL(ISNULL(IndeBud.IndirBud,0)+ISNULL(Bud.Target,0)-ISNULL(IndeTask.IndirAcc,0)-ISNULL(DeTask.Reality,0),0.000) AS Chazhi,\r\n                        ISNULL(ISNULL(MIndeBud.MonthBud,0)+ISNULL(Mbud.MonthRealitybud,0)-ISNULL(MIndeTask.MonthAcc,0)-ISNULL(MDeTask.MonthReality,0),0.000) AS MonthChazhi,\r\n                        CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(IndirBud,0)+ISNULL(Target,0)-ISNULL(IndirAcc,0)\r\n                        -ISNULL(Reality,0))/nullif(ISNULL(IndirBud,0)+ISNULL(Target,0),0)*100),0.000))+'%' as Bilu,\r\n                        CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(MonthBud,0)+ISNULL(MonthRealitybud,0)-\r\n                        ISNULL(MonthAcc,0)-ISNULL(MonthReality,0))/nullif(ISNULL(MonthBud,0)\r\n                        +ISNULL(MonthRealitybud,0),0)*100),0.000))+'%' as MonthBilu  \r\n                        FROM Bud\r\n                        LEFT JOIN Mbud\r\n                        ON Bud.PrjGuid=Mbud.prjId\r\n                        LEFT JOIN MIndeBud\r\n                        ON Bud.PrjGuid=MIndeBud.ProjectId\r\n                        LEFT JOIN MDeTask\r\n                        ON Bud.PrjGuid=MDeTask.prjId\r\n                        LEFT JOIN MIndeTask\r\n                        ON Bud.PrjGuid=MIndeTask.ProjectId\r\n                        LEFT JOIN IndeBud\r\n                        ON Bud.PrjGuid=IndeBud.ProjectId\r\n                        LEFT JOIN DeTask\r\n                        ON Bud.PrjGuid=DeTask.prjId\r\n                        LEFT JOIN IndeTask\r\n                        ON Bud.PrjGuid=IndeTask.ProjectId\r\n                        )\r\n                        SELECT RESULT.*,PT_PrjInfo.StartDate FROM  RESULT\r\n                        LEFT JOIN PT_PrjInfo\r\n                        ON RESULT.PrjGuid=PT_PrjInfo.PrjGuid                        \r\n                        WHERE 1=1 {2}\r\n                        ORDER BY PT_PrjInfo.StartDate DESC";
                if (!string.IsNullOrEmpty(prjCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + prjCode + "%'";
                }
                if (!string.IsNullOrEmpty(prjName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + prjName + "%'";
                }
                format = string.Format(format, month, year, str2);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetCompletedMonthlyReport(string taskId, DateTime date, string isWBSRelevance)
        {
            int month = date.Month;
            int year = date.Year;
            string format = string.Empty;
            string str2 = string.Empty;
            string cmdText = "SELECT * FROM Bud_Task WHERE ParentId='" + taskId + "'";
            if (SqlHelper.ExecuteQuery(CommandType.Text, cmdText).Rows.Count > 0)
            {
                str2 = "WHERE BT.ParentId='" + taskId + "'";
            }
            else
            {
                str2 = "WHERE BT.TaskId='" + taskId + "'";
            }
            if (isWBSRelevance == "1")
            {
                format = "WITH Task AS\r\n                        (\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BT.OrderNumber,BT.Unit,BT.Quantity,\r\n                        SUM(ISNULL(BMT.Total2,0.0))+ BT.TargetTotal AS Sum,\r\n                        ISNULL(ISNULL((SUM(ISNULL(BMT.Total2,0.0))+ BT.TargetTotal),0.0)/NULLIF(ISNULL(BT.Quantity,0.0),0.0),0.0) AS UnitPrice\r\n                        FROM(\r\n                        SELECT T.TaskName,T.TaskCode,T.TaskId,T.OrderNumber,T.PrjId,T.Quantity,T.ParentId,T.Unit,\r\n                        ISNULL(SUM(BTS.ResourcePrice*BTS.ResourceQuantity),0.0) AS TargetTotal\r\n                        FROM Bud_Task T\r\n                        LEFT JOIN Bud_TaskResource BTS \r\n                        ON T.TaskId=BTS.TaskId\r\n                        GROUP BY T.TaskName,T.TaskCode,T.Quantity,T.TaskId,T.OrderNumber,T.PrjId,T.Quantity,T.ParentId,T.Unit\r\n                        ) BT\r\n                        LEFT JOIN Bud_ModifyTask BMT\r\n                        ON BT.TaskId=BMT.TaskId\r\n                        {0}\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.Quantity,BT.TaskId,BT.OrderNumber,BT.TargetTotal,BT.Unit\r\n                        ),LastAmount AS\r\n                        (\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS preSum,SUM(ISNULL(M.CompleteQuantity,0.0))AS preQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        {0}\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)<{1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),Amount AS\r\n                        (\r\n                        --本月末完成金额,数量\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS curSum,SUM(ISNULL(M.CompleteQuantity,0.0))AS curQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                         {0}\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY Task.OrderNumber)) AS Num,Task.*,\r\n                        ISNULL(LastAmount.preSum,0.0)AS preSum,\r\n                        ISNULL(LastAmount.preQuantity,0.0)AS preQuantity,\r\n                        ISNULL(Amount.curSum,0.0)AS curSum,\r\n                        ISNULL(Amount.curQuantity,0.0) AS  curQuantity,\r\n                        ISNULL(LastAmount.preSum,0.0)+ISNULL(Amount.curSum,0.0) AS curEndSum,\r\n                        ISNULL(LastAmount.preQuantity,0.0)+ISNULL(Amount.curQuantity,0.0) AS curEndQuantity\r\n                        FROM Task\r\n                        LEFT JOIN  LastAmount\r\n                        ON Task.TaskId=LastAmount.TaskId\r\n                        LEFT JOIN  Amount\r\n                        ON Task.TaskId=Amount.TaskId\r\n                        )\r\n                        SELECT * FROM  RESULT";
                format = string.Format(format, str2, month, year);
            }
            else
            {
                format = "WITH Task AS\r\n                        (\r\n                        SELECT ISNULL(Quantity,0.0)AS Quantity,TaskId,TaskName,TaskCode,Unit,\r\n                        ISNULL(Total2,0.0)AS Sum,OrderNumber, \r\n                        Total2/NULLIF(Quantity,0.0) AS UnitPrice\r\n                        FROM Bud_Task BT\r\n                        {0}\r\n                        ),LastAmount AS\r\n                        (\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS preSum,SUM(ISNULL(M.CompleteQuantity,0.0))AS preQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        {0}\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)<{1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),Amount AS\r\n                        (\r\n                        --本月末完成金额,数量\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS curSum,SUM(ISNULL(M.CompleteQuantity,0.0))AS curQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                         {0}\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY Task.OrderNumber)) AS Num,Task.*,\r\n                        ISNULL(LastAmount.preSum,0.0)AS preSum,\r\n                        ISNULL(LastAmount.preQuantity,0.0)AS preQuantity,\r\n                        ISNULL(Amount.curSum,0.0)AS curSum,\r\n                        ISNULL(Amount.curQuantity,0.0) AS  curQuantity,\r\n                        ISNULL(LastAmount.preSum,0.0)+ISNULL(Amount.curSum,0.0) AS curEndSum,\r\n                        ISNULL(LastAmount.preQuantity,0.0)+ISNULL(Amount.curQuantity,0.0) AS curEndQuantity\r\n                        FROM Task\r\n                        LEFT JOIN  LastAmount\r\n                        ON Task.TaskId=LastAmount.TaskId\r\n                        LEFT JOIN  Amount\r\n                        ON Task.TaskId=Amount.TaskId\r\n                        )\r\n                        SELECT * FROM  RESULT";
                format = string.Format(format, str2, month, year);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetCostAnalysis(string name, string code)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.Append("SELECT PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,");
            builder.AppendLine();
            builder.Append("ISNULL(SUM(ContractMoney),0) AS Contract,");
            builder.AppendLine();
            builder.Append("ISNULL(BUD.BudgetAmount,0) AS Budget,");
            builder.AppendLine();
            builder.Append("ISNULL(BUD.AccountAmount,0) AS Account");
            builder.AppendLine();
            builder.Append("FROM PT_PrjInfo AS PRJ ");
            builder.AppendLine();
            builder.Append("LEFT JOIN Con_Payout_Contract AS CON ON PRJ.PrjGuid=CON.PrjGuid");
            builder.AppendLine();
            builder.Append("LEFT JOIN (SELECT ProjectId,SUM(BudgetAmount) AS BudgetAmount,SUM(AccountAmount) AS AccountAmount ");
            builder.AppendLine();
            builder.Append("FROM Bud_IndirectBudget WHERE State='2' GROUP BY ProjectId) AS BUD ON PRJ.PrjGuid=BUD.ProjectId");
            builder.AppendLine();
            builder.AppendFormat("WHERE PRJ.i_ChildNum='0' AND PrjCode LIKE '%{0}%' AND PrjName LIKE '%{1}%'  GROUP BY PRJ.PrjGuid,PRJ.PrjCode,PRJ.PrjName,PRJ.StartDate,BUD.BudgetAmount,BUD.AccountAmount", code, name);
            builder.AppendLine();
            builder.Append("ORDER BY PRJ.StartDate DESC");
            table = SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString());
            if (table.Columns.Count > 0)
            {
                for (int i = 0; i < 6; i++)
                {
                    DataColumn column = new DataColumn();
                    switch (i)
                    {
                        case 0:
                            column.ColumnName = "budgetRen";
                            break;

                        case 1:
                            column.ColumnName = "budgetCai";
                            break;

                        case 2:
                            column.ColumnName = "budgetJi";
                            break;

                        case 3:
                            column.ColumnName = "AccountRen";
                            break;

                        case 4:
                            column.ColumnName = "AccountCai";
                            break;

                        default:
                            column.ColumnName = "AccountJi";
                            break;
                    }
                    column.DataType = typeof(decimal);
                    table.Columns.Add(column);
                }
            }
            return table;
        }

        public static DataTable GetDetail(string prjId, string taskCode, string taskName, string IsWBSRelevance)
        {
            string cmdText = "";
            SqlParameter parameter = new SqlParameter("@prjId", prjId);
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, new SqlParameter[] { parameter });
        }

        public static DataTable GetDiffReport(string prjId, int pageSize, int pageIndex, string taskCode, string taskName, string isWBSRelevance)
        {
            int num = pageSize * (pageIndex - 1);
            int num2 = pageSize * pageIndex;
            int month = DateTime.Now.Month;
            int year = DateTime.Now.Year;
            string str = string.Empty;
            string str2 = string.Empty;
            string format = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH budTask AS\r\n                        (\r\n                        --目标成本 --预算量 --预算价\r\n                        SELECT T.TaskName,T.TaskCode,T.TaskId,T.OrderNumber,T.Quantity,\r\n                        SUM(ISNULL(BMT.Total2,0.0))+ T.TargetTotal AS PlanTotal,\r\n                        ISNULL((SUM(ISNULL(BMT.Total2,0.0))+ T.TargetTotal)/NULLIF(T.Quantity,0.0),0.0) AS  UnitPrice\r\n                        FROM(\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BT.OrderNumber,BT.PrjId,BT.Quantity,\r\n                        ISNULL(SUM(BTS.ResourcePrice*BTS.ResourceQuantity),0.0) AS TargetTotal\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN Bud_TaskResource BTS \r\n                        ON BT.TaskId=BTS.TaskId\r\n                        WHERE TaskType=''\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.Quantity,BT.TaskId,BT.OrderNumber,BT.PrjId,BT.Quantity\r\n                        ) T\r\n                        LEFT JOIN Bud_ModifyTask BMT\r\n                        ON T.TaskId=BMT.TaskId\r\n                        WHERE T.PrjId='{0}'\r\n                        GROUP BY T.TaskName,T.TaskCode,T.TaskId,T.OrderNumber,T.TargetTotal,T.Quantity                       \r\n                        ),DbudTask AS\r\n                        (\r\n                        --实际成本 \r\n                        SELECT M.OrderNumber, M.TaskName,M.TaskCode,M.TaskId,SUM(ISNULL(M.Quantity,0.0)*ISNULL(M.UnitPrice,0.0)) AS ActualTotal\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId,\r\n                        ISNULL(BTR.Quantity,0.0)AS Quantity ,ISNULL(BTR.UnitPrice,0.0) AS UnitPrice,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT  BCT.ConsReportId,BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE FlowState=1\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),DbudQty AS\r\n                        (\r\n                        --实际量\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId,SUM(ISNULL(T.CompleteQuantity,0.0)) AS ActualQty FROM\r\n                        (\r\n                        SELECT BCT.ConsReportId,BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE FlowState=1\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId\r\n                        ),MbudTask AS\r\n                        (\r\n                        --月目标成本 预算量\r\n                        SELECT  BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,ISNULL(CT.CompleteQuantity,0.0) AS PlanMonthQty,\r\n                        ISNULL(ISNULL(CT.CompleteQuantity,0.0)/NULLIF(BT.Quantity,0.0)*BT.Total2,0.0)  AS PlanMonthTotal\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT SUM(ISNULL(BCT.CompleteQuantity,0.0))AS CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        GROUP BY BRT.prjId,BCT.TaskId\r\n                        ) CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        ),MdbudTask AS\r\n                        (\r\n                        --月实际成本\r\n                        SELECT BCT.TaskName,BCT.TaskCode,BCT.TaskId,\r\n                        BCT.PrjId,BCT.OrderNumber,ISNULL(SUM(BCS.Quantity*BCS.UnitPrice),0.0) AS ActualMonthTotal FROM\r\n                        (SELECT BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,CT.ConsTaskId\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT BRT.prjId,BCT.TaskId,BCT.ConsTaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        )CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        ) BCT\r\n                        LEFT JOIN  Bud_ConsTaskRes BCS\r\n                        ON BCT.ConsTaskId=BCS.ConsTaskId\r\n                        WHERE BCT.PrjId='{0}'\r\n                        GROUP BY BCT.TaskName,BCT.TaskCode,\r\n                        BCT.PrjId,BCT.OrderNumber,BCT.TaskId\r\n                        ),MdbudQty AS\r\n                        (\r\n                        --月实际量\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId,SUM(ISNULL(T.CompleteQuantity,0.0)) AS ActualMonthQty  FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.CompleteQuantity,BCT.ConsReportId FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T\r\n                        LEFT JOIN Bud_ConsReport BRT \r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)=6 AND YEAR(BRT.InputDate)=2014 --查询条件\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT CONVERT(VARCHAR(6),ROW_NUMBER() OVER(ORDER BY budTask.OrderNumber)) AS NUM,budTask.*,DbudTask.ActualTotal,\r\n                        DbudQty.ActualQty,MbudTask.PlanMonthTotal,MbudTask.PlanMonthQty,MdbudTask.ActualMonthTotal,MdbudQty.ActualMonthQty,\r\n                        MbudTask.PlanMonthQty-MdbudQty.ActualMonthQty AS MonthDiffQty,\r\n                        (ISNULL(MbudTask.PlanMonthTotal/NULLIF(MbudTask.PlanMonthQty,0.0),0.0)\r\n                        -ISNULL(MdbudTask.ActualMonthTotal/NULLIF(MdbudQty.ActualMonthQty,0.0),0.0)) AS MonthDiffPrice,\r\n                        ISNULL(DbudTask.ActualTotal/NULLIF(DbudQty.ActualQty,0.0),0.0) AS ActualPrice,\r\n                        budTask.Quantity-DbudQty.ActualQty AS DiffQuantity,\r\n                        budTask.UnitPrice-ISNULL(DbudTask.ActualTotal/NULLIF(DbudQty.ActualQty,0.0),0.0) AS DiffPrice,\r\n                        budTask.PlanTotal-DbudTask.ActualTotal AS DiffTotal\r\n                        FROM budTask\r\n                        LEFT JOIN DbudTask \r\n                        ON budTask.TaskId=DbudTask.TaskId\r\n                        LEFT JOIN DbudQty\r\n                        ON budTask.TaskId=DbudQty.TaskId\r\n                        LEFT JOIN MbudTask\r\n                        ON budTask.TaskId=MbudTask.TaskId\r\n                        LEFT JOIN MdbudTask\r\n                        ON budTask.TaskId=MdbudTask.TaskId\r\n                        LEFT JOIN MdbudQty\r\n                        ON budTask.TaskId=MdbudQty.TaskId\r\n                        WHERE 1=1 {3}\r\n                        )SELECT * FROM RESULT WHERE 1=1 {4}\r\n                        ";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " AND NUM >", num, " AND NUM <= ", num2 });
                }
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str2 = str2 + " AND RESULT.TaskCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str2 = str2 + " AND RESULT.TaskName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, new object[] { prjId, month, year, str2, str });
            }
            else
            {
                format = "WITH budTask AS\r\n                        (\r\n                        --目标成本 --预算量 --预算价\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.PrjId,BT.OrderNumber,BT.TaskId,BT.Quantity,\r\n                        ISNULL(BT.Total2/NULLIF(BT.Quantity,0.0),0.0) AS UnitPrice,\r\n                        SUM(ISNULL(BTK.Total2,0.0))+ISNULL(SUM(BTS.ResourcePrice*BTS.ResourceQuantity),0.0) AS PlanTotal FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ModifyTask BTK\r\n                        ON BT.TaskId=BTK.TaskId\r\n                        LEFT JOIN Bud_TaskResource BTS \r\n                        ON BT.TaskId=BTS.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.PrjId,BT.OrderNumber,BT.TaskId,BT.Quantity,BT.Total2\r\n                        ),DbudTask AS\r\n                        (\r\n                        --实际成本 \r\n                        SELECT T.TaskId,T.OrderNumber,T.TaskName,T.TaskCode,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS ActualTotal\r\n                        FROM \r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        GROUP BY  T.TaskName,T.TaskCode,T.CompleteQuantity,T.OrderNumber,T.TaskId\r\n                        ),DbudQty AS\r\n                        (\r\n                        --实际量\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId,SUM(ISNULL(T.CompleteQuantity,0.0)) AS ActualQty FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber\r\n                        ) T\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId\r\n                        ),MbudTask AS\r\n                        (\r\n                        --月目标成本 预算量\r\n                        SELECT  BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,ISNULL(CT.CompleteQuantity,0.0) AS PlanMonthQty,\r\n                        ISNULL(ISNULL(CT.CompleteQuantity,0.0)/NULLIF(BT.Quantity,0.0)*BT.Total2,0.0)  AS PlanMonthTotal\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT SUM(ISNULL(BCT.CompleteQuantity,0.0))AS CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        GROUP BY BRT.prjId,BCT.TaskId\r\n                        ) CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        ),MdbudTask AS\r\n                        (\r\n                        --月实际成本\r\n                        SELECT BCT.TaskName,BCT.TaskCode,BCT.TaskId,\r\n                        BCT.PrjId,BCT.OrderNumber,ISNULL(SUM(BCS.Quantity*BCS.UnitPrice),0.0) AS ActualMonthTotal FROM\r\n                        (SELECT BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,CT.ConsTaskId\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT BRT.prjId,BCT.TaskId,BCT.ConsTaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        )CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        ) BCT\r\n                        LEFT JOIN  Bud_ConsTaskRes BCS\r\n                        ON BCT.ConsTaskId=BCS.ConsTaskId\r\n                        WHERE BCT.PrjId='{0}'\r\n                        GROUP BY BCT.TaskName,BCT.TaskCode,\r\n                        BCT.PrjId,BCT.OrderNumber,BCT.TaskId\r\n                        ),MdbudQty AS\r\n                        (\r\n                        --月实际量\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId,SUM(ISNULL(T.CompleteQuantity,0.0)) AS ActualMonthQty  FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.CompleteQuantity,BCT.ConsReportId FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T\r\n                        LEFT JOIN Bud_ConsReport BRT \r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)=6 AND YEAR(BRT.InputDate)=2014 --查询条件\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT CONVERT(VARCHAR(6),ROW_NUMBER() OVER(ORDER BY budTask.OrderNumber)) AS NUM,budTask.*,DbudTask.ActualTotal,\r\n                        DbudQty.ActualQty,MbudTask.PlanMonthTotal,MbudTask.PlanMonthQty,MdbudTask.ActualMonthTotal,MdbudQty.ActualMonthQty,\r\n                        MbudTask.PlanMonthQty-MdbudQty.ActualMonthQty AS MonthDiffQty,\r\n                        (ISNULL(MbudTask.PlanMonthTotal/NULLIF(MbudTask.PlanMonthQty,0.0),0.0)\r\n                        -ISNULL(MdbudTask.ActualMonthTotal/NULLIF(MdbudQty.ActualMonthQty,0.0),0.0)) AS MonthDiffPrice,\r\n                        ISNULL(DbudTask.ActualTotal/NULLIF(DbudQty.ActualQty,0.0),0.0) AS ActualPrice,\r\n                        budTask.Quantity-DbudQty.ActualQty AS DiffQuantity,\r\n                        budTask.UnitPrice-ISNULL(DbudTask.ActualTotal/NULLIF(DbudQty.ActualQty,0.0),0.0) AS DiffPrice,\r\n                        budTask.PlanTotal-DbudTask.ActualTotal AS DiffTotal\r\n                        FROM budTask\r\n                        LEFT JOIN DbudTask \r\n                        ON budTask.TaskId=DbudTask.TaskId\r\n                        LEFT JOIN DbudQty\r\n                        ON budTask.TaskId=DbudQty.TaskId\r\n                        LEFT JOIN MbudTask\r\n                        ON budTask.TaskId=MbudTask.TaskId\r\n                        LEFT JOIN MdbudTask\r\n                        ON budTask.TaskId=MdbudTask.TaskId\r\n                        LEFT JOIN MdbudQty\r\n                        ON budTask.TaskId=MdbudQty.TaskId\r\n                        WHERE 1=1 {3}\r\n                        )SELECT * FROM RESULT WHERE 1=1 {4}";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " AND NUM >", num, " AND NUM <= ", num2 });
                }
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str2 = str2 + " AND RESULT.TaskCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str2 = str2 + " AND RESULT.TaskName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, new object[] { prjId, month, year, str2, str });
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetEvenAnalysis(string prjCode, string prjName, int pageSize, int pageIndex, string userCode, string isWBSRelevance)
        {
            int num = pageSize * (pageIndex - 1);
            int num2 = pageSize * pageIndex;
            string str = string.Empty;
            string str2 = string.Empty;
            string format = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH ConBud AS\r\n                            (\r\n                            --合同预算\r\n                            SELECT M.PrjGuid,M.PrjCode,M.PrjName,(SUM(ISNULL(M.ContractPrice,0.0)) +SUM(M.MMM)) AS ContractBud FROM \r\n                            (\r\n                            SELECT T.*,SUM(ISNULL(MF.ChangePrice,0.0)) AS MMM FROM \r\n                            (\r\n                            SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,Con.StartDate,Con.ContractID,Con.ContractPrice\r\n                            FROM  PT_PrjInfo  PT\r\n                            LEFT JOIN PT_PrjInfo_ZTB_Detail PTZ\r\n                            ON PT.PrjGuid =cast(PTZ.PrjGuid as nvarchar(64))  \r\n                            LEFT JOIN Con_Incomet_Contract Con\r\n                            ON Con.Project=PT.PrjGuid\r\n                            WHERE  PT.PrjState<>17 AND PTZ.SetUpFlowState=1\r\n                            ) T \r\n                            LEFT JOIN Con_Incomet_Modify MF \r\n                            ON T.ContractID=MF.ContractID\r\n                            GROUP BY  T.PrjGuid,T.PrjCode,T.PrjName,T.StartDate,T.ContractID,T.ContractPrice\r\n                            ) M\r\n                            GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName\r\n                            ),\r\n                             DeTask AS\r\n                            (\r\n                            --直接成本\r\n                            SELECT M.prjId,SUM(TTT) AS DirectCost FROM\r\n                            (\r\n                            SELECT T.prjId,SUM(BTR.Quantity*BTR.UnitPrice) TTT FROM \r\n                            (\r\n                            SELECT BRT.PrjId,BCT.ConsTaskId FROM Bud_ConsReport BRT\r\n                            JOIN Bud_ConsTask BCT\r\n                            ON BRT.ConsReportId=BCT.ConsReportId\r\n                            WHERE BRT.FlowState=1\r\n                            ) T\r\n                            JOIN  Bud_ConsTaskRes BTR ON \r\n                            T.ConsTaskId=BTR.ConsTaskId\r\n                            GROUP BY T.prjId,BTR.Quantity,BTR.UnitPrice\r\n                            ) M\r\n                            GROUP BY M.prjId\r\n                            ),\r\n                            IndeTask AS\r\n                            (\r\n                            --间接成本\r\n                            SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS IndirectCost FROM Bud_IndirectDiaryCost C\r\n                            JOIN Bud_IndirectDiaryDetails D\r\n                            ON C.InDiaryId=D.InDiaryId\r\n                            WHERE LEN(ProjectId)>20 AND C.FlowState=1\r\n                            GROUP BY C.ProjectId  \r\n                            ),RESULT AS\r\n                            (\r\n                            SELECT DISTINCT ConBud.*,ISNULL(DeTask.DirectCost,0.0)AS DirectCost \r\n                            ,ISNULL(IndeTask.IndirectCost,0.0) AS IndirectCost,\r\n                            (ConBud.ContractBud-ISNULL(DeTask.DirectCost,0.0)-ISNULL(IndeTask.IndirectCost,0.0)) AS GainLoss,  \r\n                            Convert(Nvarchar(30), cast(ISNULL((ISNULL(ConBud.ContractBud,0)-(ISNULL(DeTask.DirectCost,0.0)+ISNULL(IndirectCost,0)))/NULLIF(ISNULL(ContractBud,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss FROM ConBud\r\n                            LEFT JOIN  DeTask\r\n                            ON ConBud.PrjGuid=DeTask.PrjId\r\n                            LEFT JOIN  IndeTask\r\n                            ON ConBud.PrjGuid=IndeTask.ProjectId\r\n                            ),RESEND AS\r\n                            (\r\n                            SELECT ROW_NUMBER() OVER(ORDER BY PT_PrjInfo.StartDate DESC) AS No, RESULT.*,PT_PrjInfo.StartDate FROM RESULT \r\n                            LEFT JOIN PT_PrjInfo\r\n                            ON RESULT.PrjGuid=PT_PrjInfo.PrjGuid \r\n                            WHERE 1=1 {0}\r\n                            )\r\n                            SELECT * FROM  RESEND  {1}";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " WHERE No >", num, " AND No <= ", num2 });
                }
                if (!string.IsNullOrEmpty(prjCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + prjCode + "%'";
                }
                if (!string.IsNullOrEmpty(prjName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + prjName + "%'";
                }
                format = string.Format(format, str2, str);
            }
            else
            {
                format = "WITH ConBud AS\r\n                            (\r\n                            --合同预算\r\n                            SELECT M.PrjGuid,M.PrjCode,M.PrjName,(SUM(ISNULL(M.ContractPrice,0.0)) +SUM(M.MMM)) AS ContractBud FROM \r\n                            (\r\n                            SELECT T.*,SUM(ISNULL(MF.ChangePrice,0.0)) AS MMM FROM \r\n                            (\r\n                            SELECT PT.PrjGuid,PT.PrjCode,PT.PrjName,Con.StartDate,Con.ContractID,Con.ContractPrice\r\n                            FROM  PT_PrjInfo  PT\r\n                            LEFT JOIN PT_PrjInfo_ZTB_Detail PTZ\r\n                            ON PT.PrjGuid =cast(PTZ.PrjGuid as nvarchar(64))  \r\n                            LEFT JOIN Con_Incomet_Contract Con\r\n                            ON Con.Project=PT.PrjGuid\r\n                            WHERE  PT.PrjState<>17 AND PTZ.SetUpFlowState=1\r\n                            ) T \r\n                            LEFT JOIN Con_Incomet_Modify MF \r\n                            ON T.ContractID=MF.ContractID\r\n                            GROUP BY  T.PrjGuid,T.PrjCode,T.PrjName,T.StartDate,T.ContractID,T.ContractPrice\r\n                            ) M\r\n                            GROUP BY  M.PrjGuid,M.PrjCode,M.PrjName\r\n                            ),\r\n                             DeTask AS\r\n                            (\r\n                            --直接成本\r\n                            SELECT T.PrjId,SUM(T.Reality)AS DirectCost FROM \r\n                            (\r\n                            SELECT cast(RET.PrjId as nvarchar(64)) AS PrjId,SUM(ISNULL(CTK.CompleteQuantity,0.0))* (ISNULL(BTK.Total2,0.0)/NULLIF(BTK.Quantity,0.0)) AS Reality FROM Bud_ConsReport RET\r\n                            JOIN Bud_ConsTask CTK\r\n                            ON RET.ConsReportId=CTK.ConsReportId\r\n                            JOIN Bud_Task BTK\r\n                            ON CTK.TaskId=BTK.TaskId\r\n                            WHERE BET.FlowState=1\r\n                            GROUP BY RET.PrjId,BTK.Total2,BTK.Quantity\r\n                            ) T\r\n                            GROUP BY  T.PrjId\r\n                            ),\r\n                            IndeTask AS\r\n                            (\r\n                            --间接成本\r\n                            SELECT cast(C.ProjectId as nvarchar(64)) AS ProjectId,SUM(Amount)AS IndirectCost FROM Bud_IndirectDiaryCost C\r\n                            JOIN Bud_IndirectDiaryDetails D\r\n                            ON C.InDiaryId=D.InDiaryId\r\n                            WHERE LEN(ProjectId)>20 AND C.FlowState=1\r\n                            GROUP BY C.ProjectId \r\n                            ),RESULT AS\r\n                            (\r\n                            SELECT DISTINCT ConBud.*,ISNULL(DeTask.DirectCost,0.0)AS DirectCost \r\n                            ,ISNULL(IndeTask.IndirectCost,0.0) AS IndirectCost,\r\n                            (ConBud.ContractBud-ISNULL(DeTask.DirectCost,0.0)) AS GainLoss,  \r\n                            Convert(Nvarchar(30), cast(ISNULL((ISNULL(ConBud.ContractBud,0)-(ISNULL(DeTask.DirectCost,0.0)+ISNULL(IndirectCost,0)))/NULLIF(ISNULL(ContractBud,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss FROM ConBud\r\n                            LEFT JOIN  DeTask\r\n                            ON ConBud.PrjGuid=DeTask.PrjId\r\n                            LEFT JOIN  IndeTask\r\n                            ON ConBud.PrjGuid=IndeTask.ProjectId\r\n                            ),RESEND AS\r\n                            (\r\n                            SELECT ROW_NUMBER() OVER(ORDER BY PT_PrjInfo.StartDate DESC) AS No, RESULT.*,PT_PrjInfo.StartDate FROM RESULT \r\n                            LEFT JOIN PT_PrjInfo\r\n                            ON RESULT.PrjGuid=PT_PrjInfo.PrjGuid \r\n                            WHERE 1=1 {0}\r\n                            )\r\n                            SELECT * FROM  RESEND {1}";
                if (!string.IsNullOrEmpty(prjCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + prjCode + "%'";
                }
                if (!string.IsNullOrEmpty(prjName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + prjName + "%'";
                }
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " WHERE No >", num, " AND No <= ", num2 });
                }
                format = string.Format(format, str2, str);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetEvenAnalysisDetail(string taskCode, string taskName, string prjId, int pageSize, int pageIndex, string isWBSRelevance)
        {
            int num = pageSize * (pageIndex - 1);
            int num2 = pageSize * pageIndex;
            string str = string.Empty;
            string str2 = string.Empty;
            string format = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH ConBud AS\r\n                        (\r\n                        --合同预算\r\n                        SELECT OrderNumber,TaskName,TaskCode,ISNULL(Total,0.0)AS ContractCost\r\n                        FROM Bud_ContractTask WHERE PrjId='{0}' AND TaskType=''\r\n                        ),\r\n                        DeBud AS\r\n                        (\r\n                        --实际成本\r\n                        SELECT M.OrderNumber, M.TaskName,M.TaskCode,SUM(ISNULL(M.Quantity,0.0)*ISNULL(M.UnitPrice,0.0)) AS ConstructCost\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,\r\n                        ISNULL(BTR.Quantity,0.0)AS Quantity ,ISNULL(BTR.UnitPrice,0.0) AS UnitPrice,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT  BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN \r\n                        (SELECT ConsTaskId,CompleteQuantity,TaskId FROM Bud_ConsTask BT\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON BT.ConsReportId=BRT.ConsReportId\r\n                        WHERE  FlowState=1\r\n                        ) BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId          \r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT CONVERT(VARCHAR(6),ROW_NUMBER() OVER(ORDER BY DeBud.OrderNumber)) AS No, DeBud.*,ISNULL(ConBud.ContractCost,0.0) AS ContractCost,\r\n                        (ISNULL(ConBud.ContractCost,0.0)-ISNULL(DeBud.ConstructCost,0.0)) AS GainLoss,\r\n                        Convert(Nvarchar(30), cast(ISNULL((ISNULL(ConBud.ContractCost,0)-(ISNULL(DeBud.ConstructCost,0.0)))/NULLIF(ISNULL(ConBud.ContractCost,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss \r\n                        FROM DeBud\r\n                        LEFT JOIN ConBud\r\n                        ON DeBud.TaskName=ConBud.TaskName AND DeBud.OrderNumber=ConBud.OrderNumber\r\n                        WHERE 1=1 {1}\r\n                        )\r\n                        SELECT * FROM  RESULT\r\n                        WHERE 1=1 {2}\r\n                        ";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " AND No >", num, " AND No <= ", num2 });
                }
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str2 = str2 + " AND DeBud.PrjCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str2 = str2 + " AND DeBud.PrjName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, prjId, str2, str);
            }
            else
            {
                format = "WITH ConBud AS\r\n                        (\r\n                        --合同预算\r\n                        SELECT TaskName,TaskCode,ISNULL(Total,0.0)AS ContractCost\r\n                        FROM Bud_ContractTask WHERE PrjId='{0}'\r\n                        ),\r\n                        DeBud AS\r\n                        (\r\n                        --实际成本\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity ,\r\n                        ISNULL(SUM(BCT.CompleteQuantity),0.0)*ISNULL(BT.Total2,0.0)/NULLIF(BT.Quantity,0.0) AS ConstructCost,\r\n                        ISNULL(BT.Total2,0.0)/NULLIF(BT.Quantity,0.0) AS RealityPrice\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.Total2,BT.Quantity,BT.OrderNumber\r\n                        )\r\n                        ,RESULT AS\r\n                        (\r\n                        SELECT ROW_NUMBER() OVER(ORDER BY DeBud.OrderNumber) AS No, DeBud.*,ISNULL(ConBud.ContractCost,0.0) AS ContractCost,\r\n                        (ISNULL(ConBud.ContractCost,0.0)-ISNULL(DeBud.ConstructCost,0.0)) AS GainLoss,\r\n                        Convert(Nvarchar(30), cast(ISNULL((ISNULL(ConBud.ContractCost,0)-(ISNULL(DeBud.ConstructCost,0.0)))/NULLIF(ISNULL(ConBud.ContractCost,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss \r\n                        FROM DeBud\r\n                        LEFT JOIN ConBud\r\n                        ON DeBud.TaskName=ConBud.TaskName\r\n                        WHERE 1=1 {1}\r\n                        )\r\n                        SELECT * FROM  RESULT\r\n                        WHERE 1=1 {2}";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " AND No >", num, " AND No <= ", num2 });
                }
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str2 = str2 + " AND RESULT.PrjCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str2 = str2 + " AND RESULT.PrjName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, prjId, str2, str);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetIndirectCostDetails(string prjId, string cbsCode, string indirectName, string issuedBy, string startDay, string endDay)
        {
            new DataTable();
            StringBuilder builder = new StringBuilder();
            if (!string.IsNullOrEmpty(prjId))
            {
                builder.AppendFormat(" AND IDC.ProjectId = '{0}'", prjId);
            }
            if (!string.IsNullOrEmpty(cbsCode))
            {
                builder.AppendFormat(" AND IDD.CBSCode = '{0}'", cbsCode);
            }
            if (!string.IsNullOrEmpty(indirectName))
            {
                builder.AppendFormat(" AND IDD.Name LIKE '%{0}%'", indirectName);
            }
            if (!string.IsNullOrEmpty(issuedBy))
            {
                builder.AppendFormat(" AND IDC.IssuedBy LIKE '%{0}%'", issuedBy);
            }
            if (!string.IsNullOrEmpty(startDay) && !string.IsNullOrEmpty(endDay))
            {
                builder.AppendFormat(" AND IDC.InputDate BETWEEN '{0}' AND '{1}'", startDay, endDay);
            }
            else if (!string.IsNullOrEmpty(startDay))
            {
                builder.AppendFormat(" AND IDC.InputDate >= '{0}'", startDay);
            }
            else if (!string.IsNullOrEmpty(endDay))
            {
                builder.AppendFormat(" AND IDC.InputDate <= '{0}'", endDay);
            }
            StringBuilder builder2 = new StringBuilder();
            builder2.Append("SELECT Row_Number() OVER (ORDER BY IDC.InputDate DESC) as Num,\r\n                                   IDD.Name AS CostName,IDC.IssuedBy,IDC.InputUser,IDC.DepartMent,IDC.InputDate,IDD.Amount,IDD.Note\r\n                            FROM Bud_IndirectDiaryDetails AS IDD LEFT JOIN Bud_IndirectDiaryCost AS IDC ON IDD.InDiaryId = IDC.InDiaryId\r\n                            WHERE IDC.FlowState = '1'" + builder.ToString() + "ORDER BY IDC.InputDate DESC");
            return SqlHelper.ExecuteQuery(CommandType.Text, builder2.ToString());
        }

        public static DataTable GetIndirectCosts(string prjId, string cbsCode, string cbsName)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat("\r\n                --DECLARE @PrjId NVARCHAR(50)\r\n                --SET @PrjId='AA764360-3F22-45FE-A94E-0205879CF153';\r\n                SELECT  '' Id,CBSList.CBSCode,Name AS CBSName ,ISNULL(TotalTarget,0) AS TotalTarget\r\n                ,ISNULL(MonthTarget,0) AS MonthTarget,ISNULL(TotalReality,0) AS TotalReality\r\n                ,ISNULL(MonthReality,0) AS MonthReality\r\n                FROM \r\n                (\r\n\t                select CBSCode from Bud_IndirectBudget\r\n\t                WHERE ProjectId=@PrjId AND State='2'\r\n\t                UNION\r\n\t                SELECT DISTINCT CBSCode FROM Bud_IndirectDiaryCost IndirectDiaryCost\r\n\t                INNER JOIN Bud_IndirectDiaryDetails IndirectDiaryDetails \r\n\t                ON IndirectDiaryCost.InDiaryId=IndirectDiaryDetails.InDiaryId\r\n\t                WHERE ProjectId=@PrjId AND FlowState='1'\r\n                ) CBSList \r\n                LEFT JOIN Bud_CostAccounting ON CBSList.CBSCode=Bud_CostAccounting.CBSCode\r\n                LEFT JOIN \r\n                (\r\n\t                SELECT CBSCode,ISNULL(AccountAmount,0) AS TotalTarget,\r\n\t                MonthTarget=(\r\n\t\t\t\t                SELECT ISNULL(Amount,0) FROM Bud_IndirectMonthBudget\r\n\t\t\t\t                WHERE IndirectBudget=Bud_IndirectBudget.Id AND Year=YEAR(GETDATE()) AND MONTH=MONTH(GETDATE())\r\n\t\t\t\t                )\r\n\t                FROM Bud_IndirectBudget \r\n\t                WHERE ProjectId=@PrjId AND LEN(CBSCode)>6 AND State='2'\r\n                ) AS Target ON CBSList.CBSCode=Target.CBSCode\r\n                LEFT JOIN \r\n                (\r\n\t                SELECT CBSCode,SUM(ISNULL(Amount,0)) AS MonthReality\r\n\t                FROM Bud_IndirectDiaryCost \r\n\t                LEFT JOIN Bud_IndirectDiaryDetails ON Bud_IndirectDiaryCost.InDiaryId=Bud_IndirectDiaryDetails.InDiaryId\r\n\t                WHERE ProjectId=@PrjId AND FlowState='1' AND YEAR(InputDate)=YEAR(GETDATE()) AND MONTH(InputDate)=MONTH(GETDATE())\r\n\t                GROUP BY CBSCode\r\n                ) AS Reality ON CBSList.CBSCode=Reality.CBSCode\r\n                LEFT JOIN \r\n                (\r\n\t                SELECT CBSCode,SUM(ISNULL(Amount,0)) TotalReality FROM Bud_IndirectDiaryDetails AS T1\r\n\t                WHERE InDiaryId IN( SELECT InDiaryId FROM Bud_IndirectDiaryCost \r\n\t                WHERE ProjectId=@PrjId AND FlowState='1')\r\n\t                GROUP BY T1.CBSCode\r\n                ) TotalRealityInfo ON CBSList.CBSCode=TotalRealityInfo.CBSCode\r\n                WHERE LEN(CBSList.CBSCode)>6\r\n                --查询条件\r\n                AND Name LIKE '%{0}%' AND CBSList.CBSCode LIKE '%{1}%'\r\n                ORDER BY CBSList.CBSCode ASC", cbsName, cbsCode);
            SqlParameter parameter = new SqlParameter("@PrjId", prjId);
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), new SqlParameter[] { parameter });
        }

        public static DataTable GetIndirectOrgCosts(string depment, string userName, DateTime inputDate)
        {
            StringBuilder builder = new StringBuilder();
            if (!string.IsNullOrEmpty(depment))
            {
                builder.AppendFormat(" AND Dep.V_BMMC LIKE '%{0}%'", depment);
            }
            if (!string.IsNullOrEmpty(userName))
            {
                builder.AppendFormat(" AND OrgCost.IssuedBy LIKE '%{0}%'", userName);
            }
            DataTable table = new DataTable();
            string cmdText = string.Format("With OrgInfo AS( --预报销和核销金额统计\r\n                SELECT Dep.i_bmdm, Dep.V_BMMC, OrgDetails.CBSCode,\r\n                       CostAccount.Name AS CBSName,OrgCost.IssuedBy,OrgCost.InssuedByCode,OrgCost.InputDate,\r\n                       SUM(Amount)AS SumAmount,SUM(AuditAmount)AS SumAuditAmount\r\n                FROM Bud_IndirectDiaryDetails AS OrgDetails LEFT JOIN Bud_IndirectDiaryCost AS OrgCost ON OrgDetails.InDiaryId = OrgCost.InDiaryId\r\n                     LEFT JOIN PT_yhmc AS Staff ON OrgCost.InssuedByCode = Staff.v_yhdm\r\n                     LEFT JOIN PT_d_bm AS Dep ON Staff.i_bmdm = Dep.i_bmdm\r\n                     JOIN Bud_CostAccounting AS CostAccount ON CostAccount.CBSCode=OrgDetails.CBSCode\r\n                WHERE OrgCost.FlowState = 1 AND Dep.i_bmdm is not null {0}\r\n                GROUP BY Dep.i_bmdm,Dep.V_BMMC,OrgDetails.CBSCode,CostAccount.Name,OrgCost.IssuedBy,OrgCost.InssuedByCode,OrgCost.InputDate\r\n                ), YearItemOrgInfo AS( --年度项目合计\r\n                SELECT V_BMMC,i_bmdm,IssuedBy,InssuedByCode,CBSCode,CBSName,\r\n                       SUM(SumAmount) AS SumItemYearAmount,SUM(SumAuditAmount) AS SumItemYearAuditAmount\r\n                FROM OrgInfo WHERE DATEPART(year,InputDate)= {1} GROUP BY V_BMMC,i_bmdm,IssuedBy,InssuedByCode,CBSCode,CBSName\r\n                ), YearTotalOrgInfo AS( --年度总合计\r\n                SELECT i_bmdm,SUM(SumItemYearAmount) AS SumYearAmount,SUM(SumItemYearAuditAmount) AS SumYearAuditAmount\r\n                FROM YearItemOrgInfo GROUP BY i_bmdm\r\n                ), MonthItemOrgInfo AS( --月度项目合计\r\n                SELECT i_bmdm,InssuedByCode,CBSCode,\r\n                       Sum(SumAmount)AS SumItemMonthAmount,SUM(SumAuditAmount)AS SumItemMonthAuditAmount\r\n                FROM OrgInfo WHERE DATEPART(year,InputDate) = {1} AND DATEPART(month,InputDate) = {2}\r\n                GROUP BY i_bmdm,InssuedByCode,CBSCode\r\n                ), MonthTotalOrgInfo AS( --月度总合计\r\n                SELECT i_bmdm, Sum(SumItemMonthAmount) AS SumMonthAmount, Sum(SumItemMonthAuditAmount) AS SumMonthAuditAmount\r\n                FROM MonthItemOrgInfo GROUP BY i_bmdm)\r\n                SELECT ROW_NUMBER() OVER(ORDER BY YearItem.V_BMMC,YearItem.IssuedBy,Duty.DutyName DESC) AS Num,\r\n                       YearItem.V_BMMC,YearItem.CBSCode,YearItem.CBSName,YearItem.IssuedBy,YearItem.InssuedByCode,Duty.DutyName,\r\n                       '{1}' AS Yeardate,YearItem.SumItemYearAmount, YearItem.SumItemYearAuditAmount,YearTotal.SumYearAmount,YearTotal.SumYearAuditAmount,\r\n                       '{3}' AS YearMonthDate,MonthItem.SumItemMonthAmount,MonthItem.SumItemMonthAuditAmount,MonthTotal.SumMonthAmount,MonthTotal.SumMonthAuditAmount\r\n                FROM YearItemOrgInfo AS YearItem LEFT JOIN YearTotalOrgInfo AS YearTotal ON YearItem.i_bmdm = YearTotal.i_bmdm\r\n                     LEFT JOIN MonthItemOrgInfo AS MonthItem ON YearItem.i_bmdm = MonthItem.i_bmdm AND YearItem.CBSCode = MonthItem.CBSCode AND YearItem.InssuedByCode = MonthItem.InssuedByCode\r\n                     LEFT JOIN MonthTotalOrgInfo AS MonthTotal ON MonthItem.i_bmdm = MonthTotal.i_bmdm\r\n                     LEFT JOIN PT_yhmc AS Staff ON YearItem.InssuedByCode = Staff.v_yhdm\r\n                     LEFT JOIN PT_DUTY AS Duty ON Staff.I_DUTYID = Duty.I_DUTYID\r\n                ORDER BY YearItem.V_BMMC,YearItem.IssuedBy,Duty.DutyName DESC", new object[] { builder, inputDate.Year, inputDate.Month, inputDate.ToString("yyyy-MM") });
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, null);
        }

        public static DataTable GetJixieAnalysis(string prjId, string machineName)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.AppendLine("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50);\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001003';\r\n            select Jixie.ResourceId,ResourceName,ResourceCode,MonthTotalBud,MonthTotalAcc,Monthchazhi,\r\n            CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),ISNULL(Monthchazhi,0)/nullif((isnull(MonthTotalBud,0)),0)*100),0.00))+'%' as Monthbilu,\r\n            TotalBud,TotalAcc,Chazhi,\r\n            CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),ISNULL(Chazhi,0)/nullif((isnull(TotalBud,0)),0)*100),0.00))+'%' as Bilu from \r\n            (\r\n\t            select ResourceId,SUM(CONVERT(DECIMAL(18,3),TotalAcc)) AS TotalAcc,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthTotalAcc)) AS MonthTotalAcc,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthTotalBud)) AS MonthTotalBud,\r\n\t            SUM(CONVERT(DECIMAL(18,3),TotalBud)) AS TotalBud,\r\n\t            SUM(CONVERT(DECIMAL(18,3),TotalBud))-SUM(CONVERT(DECIMAL(18,3),TotalAcc)) as Chazhi,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthTotalBud))-SUM(CONVERT(DECIMAL(18,3),MonthTotalAcc)) as Monthchazhi\r\n\t            FROM (\r\n\t\t            --施工报量\r\n\t\t            SELECT ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS TotalAcc,'0'as MonthTotalAcc,'0'as MonthTotalBud,\r\n\t\t            '0' as TotalBud FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t            GROUP BY ResourceId\r\n\t\t            union\r\n\t\t            --本月施工报量\r\n\t\t            SELECT ResourceId,'0' as TotalAcc,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS MonthTotalAcc,\r\n\t\t            '0'as MonthTotalBud,'0' as TotalBud FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,InputDate,GetDate())=0\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t            GROUP BY ResourceId\r\n\t\t            union\t\r\n\t\t            --本月预算\r\n\t\t            SELECT ResourceId,'0' as TotalAcc,'0' as MonthTotalAcc,SUM(Target) MonthTotalBud,'0' as TotalBud FROM \r\n\t\t            (\r\n\t\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t            ) MonBudRes GROUP BY ResourceId \r\n\t\t            union\r\n\t\t            --全部预算\r\n\t\t            SELECT ResourceId,'0' as TotalAcc,'0' as MonthTotalAcc,'0'as MonthTotalBud,SUM(Target) AS TotalBud FROM \r\n\t\t            (\r\n\t\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t\t            WHERE TaskType='' AND Task.PrjId=@prjId\r\n\t\t\t            UNION\r\n\t\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t\t            INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t\t            WHERE FlowState=1 AND PrjId=@prjId \r\n\t\t            ) BudRes \r\n\t\t            WHERE dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t            GROUP BY ResourceId \r\n\t            ) as Total  \r\n\t            group by ResourceId \r\n            ) AS Jixie\r\n            left join (\r\n                select ResourceId,ResourceName,ResourceCode from Res_Resource \r\n            ) as Res on Res.ResourceId=Jixie.ResourceId ");
            builder.AppendLine();
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@prjId", prjId), new SqlParameter("@CBSCode", ConfigHelper.Get("MachineCBSCode")) };
            if (!string.IsNullOrEmpty(machineName))
            {
                builder.AppendFormat(" where ResourceName like '%{0}%' ", machineName);
                builder.AppendLine();
            }
            builder.Append("order by ResourceCode");
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static DataTable GetJixieChayi(string prjId, string machineName)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50);\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001003';\r\n            select Jixie.ResourceId,ResourceName,ResourceCode,MonthTotalBud,MonthTotalAcc,\r\n            Monthchazhi,MonthJiacha,TotalBud,TotalAcc,Chazhi,Jiacha,QuantityChazhi from(\r\n\t            select ResourceId,SUM(CONVERT(DECIMAL(18,3),TotalAcc)) AS TotalAcc,SUM(CONVERT(DECIMAL(18,3),AccPrice)) AS AccPrice,\r\n\t            SUM(CONVERT(DECIMAL(18,3),TotalBud)) AS TotalBud,SUM(CONVERT(DECIMAL(18,3),BudPrice)) AS BudPrice,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthTotalAcc)) AS MonthTotalAcc,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthAccPrice)) AS MonthAccPrice,SUM(CONVERT(DECIMAL(18,3),MonthTotalBud)) AS MonthTotalBud,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthBudPrice)) AS MonthBudPrice,\r\n\t            SUM(CONVERT(DECIMAL(18,3),BudQuantity))-SUM(CONVERT(DECIMAL(18,3),AccQuantity)) as QuantityChazhi,\r\n\t            SUM(CONVERT(DECIMAL(18,3),TotalBud))-SUM(CONVERT(DECIMAL(18,3),TotalAcc)) as Chazhi,\r\n\t            SUM(CONVERT(DECIMAL(18,3),BudPrice))-SUM(CONVERT(DECIMAL(18,3),AccPrice)) as Jiacha,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthTotalBud))-SUM(CONVERT(DECIMAL(18,3),MonthTotalAcc)) as Monthchazhi,\r\n\t            SUM(CONVERT(DECIMAL(18,3),MonthBudPrice))-SUM(CONVERT(DECIMAL(18,3),MonthAccPrice)) as MonthJiacha FROM (\r\n\t\t            --TotalAcc累计数的实际成本\r\n\t\t            select ResourceId, TotalAcc, AccPrice,'0' AS TotalBud,'0' AS BudPrice,\r\n\t\t            '0' AS MonthTotalAcc,'0' AS MonthAccPrice,'0' AS MonthTotalBud,'0' AS MonthBudPrice,\r\n\t\t            AccQuantity,'0' as BudQuantity from(\r\n\t\t\t            select ResourceId,ISNULL(CONVERT(DECIMAL(18,3),sum(TotalAcc)),0.000) TotalAcc,\r\n\t\t\t            ISNULL(CONVERT(DECIMAL(18,3),sum(TotalAcc)/NULLIF(sum(AccountingQuantity),0)),0.000) as AccPrice , \r\n\t\t\t            ISNULL(CONVERT(DECIMAL(18,3),SUM(AccountingQuantity)),0.000) as AccQuantity from (\r\n\t\t\t\t            SELECT ResourceId,UnitPrice,CONSTASKRES.AccountingQuantity,\r\n\t\t\t\t            UnitPrice*CONSTASKRES.AccountingQuantity as TotalAcc FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t\t\t\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t\t\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t\t\t            WHERE PrjId=@prjId AND FlowState=1\r\n\t\t\t\t            GROUP BY ResourceId,UnitPrice,CONSTASKRES.AccountingQuantity\r\n\t\t\t            ) as Acc \r\n\t\t\t            WHERE dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t\t            group by ResourceId\r\n\t\t            ) as Total \r\n\t\t            union\r\n\t\t            --MonthTotalAcc本月数的实际成本\r\n\t\t            select ResourceId,'0' AS TotalAcc,'0' AS AccPrice,'0' AS TotalBud,'0' AS BudPrice, \r\n\t\t            MonthTotalAcc, MonthAccPrice ,'0' AS MonthTotalBud,'0' AS MonthBudPrice,'0' as AccQuantity,'0' as BudQuantity from\r\n\t\t            (\r\n\t\t\t            select ResourceId,ISNULL(CONVERT(DECIMAL(18,3),sum(TotalAcc)),0.000) MonthTotalAcc,\r\n\t\t\t            ISNULL(CONVERT(DECIMAL(18,3),sum(TotalAcc)/NULLIF(sum(AccountingQuantity),0)),0.000) as MonthAccPrice from \r\n\t\t\t            (\r\n\t\t\t\t            SELECT ResourceId,UnitPrice,CONSTASKRES.AccountingQuantity,\r\n\t\t\t\t            UnitPrice*CONSTASKRES.AccountingQuantity as TotalAcc \r\n\t\t\t\t            FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t\t\t\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t\t\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t\t\t            WHERE PrjId=@prjId AND FlowState=1  and DateDiff(mm,InputDate,GetDate())=0\r\n\t\t\t\t            GROUP BY ResourceId,UnitPrice,CONSTASKRES.AccountingQuantity\r\n\t\t\t            ) as Acc \r\n\t\t\t            WHERE dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t\t            group by ResourceId\r\n\t\t            ) as Total \r\n\t\t            union\r\n\t\t            --MonthTotalBud本月数的目标成本\r\n\t\t            select ResourceId ,'0' AS TotalAcc,'0' AS AccPrice,'0' AS TotalBud,'0' AS BudPrice,\r\n\t\t            '0' AS MonthTotalAcc,'0' AS MonthAccPrice,\r\n\t\t            MonthTotalBud,MonthBudPrice,'0' as AccQuantity,'0' as BudQuantity from (\r\n\t\t\t            SELECT ResourceId,MonthTotalBud,ISNULL(MonthTotalBud/NULLIF(Quantity,0),0) MonthBudPrice FROM\r\n\t\t\t            (\r\n\t\t\t\t            SELECT ResourceId,SUM(Target) MonthTotalBud,SUM(Quantity) Quantity\r\n\t\t\t\t            FROM (\r\n\t\t\t\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t\t\t\t            ISNULL(ResourceQuantity,0) Quantity\tFROM Bud_TaskResource TaskRes \r\n\t\t\t\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t\t\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t\t\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t\t\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t\t\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t\t\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t\t\t            ) MonBudRes \r\n\t\t\t\t            GROUP BY ResourceId \r\n\t\t\t            ) MonthBud\r\n\t\t            ) as DD \r\n\t\t            union\r\n\t\t            --TotalBud累计数的目标成本\r\n\t\t            select ResourceId,'0' AS TotalAcc,'0' AS AccPrice, TotalBud, BudPrice,\r\n\t\t            '0' AS MonthTotalAcc,'0' AS MonthAccPrice,'0' AS MonthTotalBud,\r\n\t\t            '0' AS MonthBudPrice,'0' as AccQuantity,BudQuantity from \r\n\t\t            (\r\n\t\t\t            select ResourceId,ISNULL(CONVERT(DECIMAL(18,3),sum(TotalBud)),0.000) TotalBud,\r\n\t\t\t            ISNULL(CONVERT(DECIMAL(18,3),sum(TotalBud)/NULLIF(sum(ResourceQuantity),0)),0.000) as BudPrice,\r\n\t\t\t            ISNULL(CONVERT(DECIMAL(18,3),SUM(ResourceQuantity)),0.000) as BudQuantity from \r\n\t\t\t            (\r\n\t\t\t\t            SELECT ResourceQuantity,ResourcePrice,ResourceId,\r\n\t\t\t\t            ResourcePrice*ResourceQuantity as TotalBud FROM Bud_TaskResource as TaskRes\r\n\t\t\t\t            left join Bud_Task as Task on TaskRes.TaskId=Task.TaskId  \r\n\t\t\t\t            where PrjId=@prjId and Version=\r\n\t\t\t\t            (\r\n\t\t\t\t\t            SELECT TOP 1 Version FROM Bud_TaskChange WHERE PrjId=@prjId AND FlowState=1 ORDER BY Version DESC\r\n\t\t\t\t            )\r\n\t\t\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t\t\t            group by ResourceId,ResourceQuantity,ResourcePrice\r\n\t\t\t            ) as Total group by ResourceId \r\n\t\t            ) as Total \r\n\t            ) as Zong  group by ResourceId \r\n            ) AS Jixie\r\n            left join (\r\n            select ResourceId,ResourceName,ResourceCode from Res_Resource \r\n            ) as Res on Res.ResourceId=Jixie.ResourceId", new object[0]);
            builder.AppendLine();
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@prjId", prjId), new SqlParameter("@CBSCode", ConfigHelper.Get("MachineCBSCode")) };
            if (!string.IsNullOrEmpty(machineName))
            {
                builder.AppendFormat(" where ResourceName like '%{0}%'", machineName);
                builder.AppendLine();
            }
            builder.Append("order by ResourceCode");
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static DataTable GetMaterials(string prjId, string resourceCode, string resourceName)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@attribute NVARCHAR(50);\r\n            --SET @prjId='28750EE8-088C-4C77-9C75-9C6C4DC86734';\r\n            --SET @attribute='FF747819-77DE-4670-A4F5-8FED9A509A71';\r\n            WITH cteBudTask AS\r\n            (\r\n\t            --全部预算\r\n\t            SELECT ResourceId,SUM(Target) AS BudCost,SUM(ResourceQuantity) BudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId AND Attribute=@attribute\r\n\t\t            UNION\r\n\t\t            SELECT modifyTaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount, \r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t            INNER JOIN Res_Resource Res ON modifyTaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND Attribute=@attribute\r\n\t            ) BudTaskRes \r\n\t            GROUP BY ResourceId \r\n            ),cteMonthBud AS\r\n            (\r\n\t            --本月预算\r\n\t            SELECT ResourceId,SUM(Target) AS CurrentBudCost,SUM(ResourceQuantity) CurrentBudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\t\t\r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND Attribute=@attribute\r\n\t            ) MonthBudTaskRes GROUP BY ResourceId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS ConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) ConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t            AND Attribute=@attribute\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            ),cteMonthCons AS\r\n            (\r\n \t            --本月施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS CurrentConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) CurrentConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,CONSREP.InputDate,GetDate())=0\r\n\t            AND Attribute=@attribute \r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            )\r\n            select ResourceId,ResourceCode,ResourceName,Specification,TechnicalParameter,\r\n            ModelNumber,Brand,Convert(decimal(18,3),CurrentBudCost) MonthTotalBud,Convert(decimal(18,3),CurrentConsCost) MonthTotalAcc,\r\n            Convert(decimal(18,3),(CurrentBudCost-CurrentConsCost)) Monthchazhi, \r\n            Convert(Nvarchar(30),Cast(ISNULL((CurrentBudCost-CurrentConsCost)/NULLIF(CurrentBudCost,0),0)*100 as decimal(20,2)))+'%'  \r\n            Monthbilu,Convert(decimal(18,3),BudCost) TotalBud,Convert(decimal(18,3),ConsCost) TotalAcc,\r\n            Convert(decimal(18,3),(BudCost-ConsCost)) Chazhi, \r\n            Convert(Nvarchar(30),Cast(ISNULL((BudCost-ConsCost)/NULLIF(BudCost,0),0)*100 as decimal(20,2)))+'%' Bilu \r\n            from  \r\n            ( \r\n\t            SELECT resIds.ResourceId,ResourceCode,ResourceName,Specification,TechnicalParameter,\r\n\t            ModelNumber,Brand,ISNULL(CurrentBudCost,0) CurrentBudCost,ISNULL(CurrentBudQuantity,0) CurrentBudQuantity,\r\n\t            ISNULL(CurrentConsCost,0) CurrentConsCost, ISNULL(CurrentConsQuantity,0) CurrentConsQuantity,\r\n\t            ISNULL(BudQuantity,0) BudQuantity,ISNULL(BudCost,0) BudCost,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t            ISNULL(ConsCost,0) ConsCost FROM\r\n\t            (\r\n\t\t            SELECT ResourceId FROM cteBudTask\r\n\t\t            UNION\r\n\t\t            SELECT ResourceId FROM cteCons\r\n\t            ) resIds \r\n\t            INNER JOIN Res_Resource res ON resIds.ResourceId=res.ResourceId\r\n\t            LEFT JOIN cteMonthBud ON resIds.ResourceId=cteMonthBud.ResourceId\r\n\t            LEFT JOIN cteMonthCons ON resIds.ResourceId=cteMonthCons.ResourceId\r\n\t            LEFT JOIN cteBudTask ON resIds.ResourceId=cteBudTask.ResourceId\r\n\t            LEFT JOIN cteCons ON resIds.ResourceId=cteCons.ResourceId\r\n\t            WHERE ResourceCode like '%'+@ResourceCode+'%' and ResourceName like  '%'+@ResourceName+'%'   \r\n            ) dt ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@prjId", prjId), new SqlParameter("@attribute", ConfigHelper.Get("MinorStuff")), new SqlParameter("@ResourceCode", resourceCode), new SqlParameter("@ResourceName", resourceName) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static DataTable GetOrganizationCosts(string orgId, string cbsCode, string cbsName)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat("\r\n            --DECLARE @OrgId NVARCHAR(50)\r\n            --SET @OrgId='1';\r\n            SELECT  '' Id,CBSList.CBSCode,Name AS CBSName,ISNULL(TotalTarget,0) AS TotalTarget\r\n            ,ISNULL(MonthTarget,0) AS MonthTarget,ISNULL(TotalReality,0) AS TotalReality\r\n            ,ISNULL(MonthReality,0) AS MonthReality\r\n            FROM \r\n            (\r\n\t            SELECT CBSCode FROM Bud_OrganizationBudget\r\n\t            WHERE OrganizationBudgetId=@OrgId AND State='2'\r\n\t            UNION\r\n\t            SELECT DISTINCT CBSCode FROM Bud_OrgDiaryCost OrgDiaryCost\r\n\t            INNER JOIN Bud_OrgDiaryDetails OrgDiaryDetails \r\n\t            ON OrgDiaryCost.OrgDiaryId=OrgDiaryDetails.OrgDiaryId\r\n\t            WHERE OrgId=@OrgId AND FlowState='1'\r\n            ) CBSList \r\n            LEFT JOIN Bud_CostAccounting ON CBSList.CBSCode=Bud_CostAccounting.CBSCode\r\n            LEFT JOIN \r\n            (\r\n\t            SELECT CBSCode,ISNULL(AccountingAmount,0) AS TotalTarget,\r\n\t            MonthTarget=(\r\n\t\t\t\t            SELECT ISNULL(Amount,0) FROM Bud_OrganizationMonthBudget\r\n\t\t\t\t            WHERE OrganizationBudget=Bud_OrganizationBudget.Id AND Year=YEAR(GETDATE()) AND MONTH=MONTH(GETDATE())\r\n\t\t\t\t            )\r\n\t            FROM Bud_OrganizationBudget \r\n\t            WHERE OrganizationBudgetId=@OrgId AND LEN(CBSCode)>6 AND State='2'\r\n            ) AS Target ON CBSList.CBSCode=Target.CBSCode\r\n            LEFT JOIN \r\n            (\r\n\t            SELECT CBSCode,SUM(ISNULL(Amount,0)) AS MonthReality\r\n\t            ,TotalReality=\r\n\t\t            (\r\n\t\t             SELECT SUM(ISNULL(Amount,0)) FROM Bud_OrgDiaryDetails AS T1\r\n\t\t              WHERE OrgDiaryId IN( SELECT OrgDiaryId FROM Bud_OrgDiaryCost WHERE OrgId=@OrgId AND FlowState='1')\r\n\t\t              AND T1.CBSCode=Bud_OrgDiaryDetails.CBSCode\r\n\t\t              GROUP BY T1.CBSCode\r\n\t\t            )\r\n\t            FROM Bud_OrgDiaryCost \r\n\t            LEFT JOIN Bud_OrgDiaryDetails ON Bud_OrgDiaryCost.OrgDiaryId=Bud_OrgDiaryDetails.OrgDiaryId\r\n\t            WHERE OrgId=@OrgId AND FlowState='1' AND YEAR(Bud_OrgDiaryCost.InputDate)=YEAR(GETDATE()) AND MONTH(Bud_OrgDiaryCost.InputDate)=MONTH(GETDATE())\r\n\t            GROUP BY CBSCode\r\n            ) AS Reality ON CBSList.CBSCode=Reality.CBSCode\r\n            WHERE LEN(CBSList.CBSCode)>6\r\n            --查询条件\r\n            AND Name LIKE '%{0}%' AND CBSList.CBSCode LIKE '%{1}%'\r\n            ORDER BY CBSList.CBSCode ASC", cbsName, cbsCode);
            SqlParameter parameter = new SqlParameter("@OrgId", orgId);
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), new SqlParameter[] { parameter });
        }

        public static DataTable GetPageDataTable(DataTable dtAll, int pageIndex, int pageSize)
        {
            DataTable table = dtAll.Clone();
            int num = (pageIndex - 1) * pageSize;
            for (int i = num; i < dtAll.Rows.Count; i++)
            {
                if (i == (num + pageSize))
                {
                    return table;
                }
                DataRow row = dtAll.Rows[i];
                table.Rows.Add(row.ItemArray);
            }
            return table;
        }

        public static DataTable GetPrjSummary(string prjId, int version, string date, string isWBSRelevance)
        {
            DateTime time = Convert.ToDateTime(date);
            int month = time.Month;
            int year = time.Year;
            string format = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH Task AS\r\n                        (\r\n                        --清单金额\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BT.OrderNumber,\r\n                        SUM(ISNULL(BMT.Total2,0.0))+ISNULL(SUM(BTS.ResourcePrice*BTS.ResourceQuantity),0.0) AS Total\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN Bud_TaskResource BTS \r\n                        ON BT.TaskId=BTS.TaskId\r\n                        LEFT JOIN Bud_ModifyTask BMT\r\n                        ON BT.TaskId=BMT.TaskId\r\n                        WHERE BT.PrjId='{0}' AND TaskType=''\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.Quantity,BT.TaskId,BT.OrderNumber\r\n                        ),LastAmount AS\r\n                        (\r\n                        --上月末完成金额\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS LastMonthConsTotal,SUM(ISNULL(M.CompleteQuantity,0.0))AS CompleteQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}' \r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)<{1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),Amount AS\r\n                        (\r\n                        --本月末完成金额\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS CurrentMonthConsTotal,SUM(ISNULL(M.CompleteQuantity,0.0))AS CompleteQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}' \r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT Task.*,ISNULL(LastAmount.LastMonthConsTotal,0.0)AS LastMonthConsTotal,\r\n                        ISNULL(Amount.CurrentMonthConsTotal,0.0)AS CurrentMonthConsTotal,\r\n                        ISNULL(LastAmount.LastMonthConsTotal,0.0)+ISNULL(Amount.CurrentMonthConsTotal,0.0) AS SumCons\r\n                        FROM Task\r\n                        LEFT JOIN  LastAmount\r\n                        ON Task.TaskId=LastAmount.TaskId\r\n                        LEFT JOIN  Amount\r\n                        ON Task.TaskId=Amount.TaskId\r\n                        )\r\n                        SELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY OrderNumber)) AS Num,*,'1' AS BudLevel FROM RESULT\r\n                        WHERE LEN(OrderNumber)/3=1\r\n                        UNION\r\n                        SELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY OrderNumber)) AS Num,*,'2' AS BudLevel FROM RESULT\r\n                        WHERE LEN(OrderNumber)/3=2\r\n                        ORDER BY OrderNumber";
                format = string.Format(format, prjId, month, year);
            }
            else
            {
                format = "WITH Task AS\r\n                        (\r\n                        --清单金额\r\n                        SELECT TaskName,TaskCode,TaskId,OrderNumber,Total2 AS Total FROM Bud_Task \r\n                        WHERE PrjId='{0}'\r\n                        ORDER BY OrderNumber\r\n                        ),LastAmount AS\r\n                        (\r\n                        --上月末完成金额\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS LastMonthConsTotal,SUM(ISNULL(M.CompleteQuantity,0.0))AS CompleteQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}' \r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)<{1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),Amount AS\r\n                        (\r\n                        --本月末完成金额\r\n                        SELECT M.OrderNumber,M.TaskId,M.TaskName,M.TaskCode,SUM(RealityTotal)AS CurrentMonthConsTotal,SUM(ISNULL(M.CompleteQuantity,0.0))AS CompleteQuantity\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.TaskId,\r\n                        SUM(ISNULL(BTR.Quantity,0.0)*ISNULL(BTR.UnitPrice,0.0)) AS RealityTotal,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.ConsReportId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}' \r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2}\r\n                        GROUP BY T.OrderNumber,T.TaskName,T.TaskCode,T.ConsReportId,T.CompleteQuantity,T.TaskId\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT Task.*,ISNULL(LastAmount.LastMonthConsTotal,0.0)AS LastMonthConsTotal,\r\n                        ISNULL(Amount.CurrentMonthConsTotal,0.0)AS CurrentMonthConsTotal,\r\n                        ISNULL(LastAmount.LastMonthConsTotal,0.0)+ISNULL(Amount.CurrentMonthConsTotal,0.0) AS SumCons\r\n                        FROM Task\r\n                        LEFT JOIN  LastAmount\r\n                        ON Task.TaskId=LastAmount.TaskId\r\n                        LEFT JOIN  Amount\r\n                        ON Task.TaskId=Amount.TaskId\r\n                        )\r\n                        SELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY OrderNumber)) AS Num,*,'1' AS BudLevel FROM RESULT\r\n                        WHERE LEN(OrderNumber)/3=1\r\n                        UNION\r\n                        SELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY OrderNumber)) AS Num,*,'2' AS BudLevel FROM RESULT\r\n                        WHERE LEN(OrderNumber)/3=2\r\n                        ORDER BY OrderNumber";
                format = string.Format(format, prjId, month, year);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetReport(string prjId, int pageSize, int pageIndex, string taskCode, string taskName, string isWBSRelevance)
        {
            int num = pageSize * (pageIndex - 1);
            int num2 = pageSize * pageIndex;
            int month = DateTime.Now.Month;
            int year = DateTime.Now.Year;
            string str = string.Empty;
            string str2 = string.Empty;
            string format = string.Empty;
            if (isWBSRelevance == "1")
            {
                format = "WITH BudTask AS\r\n                        (\r\n                        --目标成本\r\n                        SELECT T.TaskName,T.TaskCode,T.TaskId,T.OrderNumber,\r\n                        SUM(ISNULL(BMT.Total2,0.0))+ T.TargetTotal AS PlanTotal\r\n                        FROM(\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BT.OrderNumber,BT.PrjId,BT.Quantity,\r\n                        ISNULL(SUM(BTS.ResourcePrice*BTS.ResourceQuantity),0.0) AS TargetTotal\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN Bud_TaskResource BTS \r\n                        ON BT.TaskId=BTS.TaskId\r\n                        WHERE BT.TaskType=''\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.Quantity,BT.TaskId,BT.OrderNumber,BT.PrjId,BT.Quantity\r\n                        ) T\r\n                        LEFT JOIN Bud_ModifyTask BMT\r\n                        ON T.TaskId=BMT.TaskId\r\n                        WHERE T.PrjId='{0}'\r\n                        GROUP BY T.TaskName,T.TaskCode,T.TaskId,T.OrderNumber,T.TargetTotal                      \r\n                        ),DeBudTask AS\r\n                        (\r\n                        --实际成本\r\n                        SELECT M.OrderNumber, M.TaskName,M.TaskCode,M.TaskId,SUM(ISNULL(M.Quantity,0.0)*ISNULL(M.UnitPrice,0.0)) AS ConstructCost\r\n                        FROM \r\n                        (\r\n                        SELECT T.OrderNumber,T.TaskName,T.TaskCode,T.TaskId,\r\n                        ISNULL(BTR.Quantity,0.0)AS Quantity ,ISNULL(BTR.UnitPrice,0.0) AS UnitPrice,T.CompleteQuantity\r\n                        FROM\r\n                        (\r\n                        SELECT  BCT.ConsReportId,BT.OrderNumber,BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,SUM(BCT.CompleteQuantity) AS CompleteQuantity FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.OrderNumber,BCT.ConsReportId\r\n                        ) T \r\n                        LEFT JOIN Bud_ConsTaskRes BTR\r\n                        ON T.ConsTaskId=BTR.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport BRT\r\n                        ON T.ConsReportId=BRT.ConsReportId\r\n                        WHERE FlowState=1\r\n                        ) M\r\n                        GROUP BY  M.TaskName,M.TaskCode, M.OrderNumber,M.TaskId\r\n                        ),MbudTask AS\r\n                        (\r\n                        --月目标成本\r\n                        SELECT  BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,\r\n                        ISNULL(ISNULL(CT.CompleteQuantity,0.0)/NULLIF(BT.Quantity,0.0)*BT.Total2,0.0)  AS Total\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT SUM(ISNULL(BCT.CompleteQuantity,0.0))AS CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        GROUP BY BRT.prjId,BCT.TaskId\r\n                        ) CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        ),MdeBudTask AS\r\n                        (\r\n                        --月实际成本\r\n                        SELECT BCT.TaskName,BCT.TaskCode,BCT.TaskId,\r\n                        BCT.PrjId,BCT.OrderNumber,ISNULL(SUM(BCS.Quantity*BCS.UnitPrice),0.0) AS Total FROM\r\n                        (SELECT BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,CT.ConsTaskId\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT BRT.prjId,BCT.TaskId,BCT.ConsTaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        )CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        ) BCT\r\n                        LEFT JOIN  Bud_ConsTaskRes BCS\r\n                        ON BCT.ConsTaskId=BCS.ConsTaskId\r\n                        WHERE BCT.PrjId='{0}'\r\n                        GROUP BY BCT.TaskName,BCT.TaskCode,\r\n                        BCT.PrjId,BCT.OrderNumber,BCT.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT CONVERT(VARCHAR(6),ROW_NUMBER() OVER(ORDER BY BudTask.OrderNumber)) AS NUM, BudTask.* ,DeBudTask.ConstructCost AS ActualTotal,\r\n                        BudTask.PlanTotal-DeBudTask.ConstructCost AS DiffTotal,\r\n                        ISNULL((BudTask.PlanTotal-DeBudTask.ConstructCost)/NULLIF(BudTask.PlanTotal,0.0),0.0) AS DiffRate,\r\n                        MbudTask.Total AS PlanMonthTotal,\r\n                        MdeBudTask.Total AS ActualMonthTotal,\r\n                        MbudTask.Total-MdeBudTask.Total AS MonthDiffTotal,\r\n                        ISNULL((MbudTask.Total-MdeBudTask.Total)/NULLIF(MbudTask.Total,0.0),0.0) AS MonthDiffRate\r\n                        FROM BudTask\r\n                        LEFT JOIN DeBudTask\r\n                        ON BudTask.TaskId=DeBudTask.TaskId\r\n                        LEFT JOIN MbudTask\r\n                        ON BudTask.TaskId=MbudTask.TaskId\r\n                        LEFT JOIN MdeBudTask\r\n                        ON BudTask.TaskId=MdeBudTask.TaskId\r\n                        WHERE 1=1 {3}\r\n                        )\r\n                        SELECT * FROM RESULT WHERE 1=1 {4}\r\n                        ";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " AND NUM >", num, " AND NUM <= ", num2 });
                }
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str2 = str2 + " AND RESULT.TaskCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str2 = str2 + " AND RESULT.TaskName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, new object[] { prjId, month, year, str2, str });
            }
            else
            {
                format = "WITH BudTask AS\r\n                        (\r\n                        --目标成本\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.TaskId ,BT.OrderNumber,ISNULL(BT.Total2,0.0) AS PlanTotal\r\n                        FROM Bud_Task BT\r\n                        WHERE BT.PrjId='{0}'\r\n                        ),DeBudTask AS\r\n                        (\r\n                        --实际成本\r\n                        SELECT T.TaskName,T.TaskCode,T.TaskId,ISNULL(SUM(T.CompleteQuantity),0.0) AS CompleteQuantity,\r\n                        ISNULL(SUM(T.CompleteQuantity),0.0)*ISNULL(T.Total2,0.0)/NULLIF(T.Quantity,0.0) AS ConstructCost\r\n                        FROM\r\n                        (\r\n                        SELECT BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,ISNULL(SUM(BCT.CompleteQuantity),0.0) AS CompleteQuantity ,\r\n                        BT.Total2,BT.Quantity\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN Bud_ConsTask BCT\r\n                        ON BT.TaskId=BCT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        GROUP BY BT.TaskName,BT.TaskCode,BT.TaskId,BCT.ConsTaskId,BCT.CompleteQuantity,BT.Total2,BT.Quantity\r\n                        ) T\r\n                        GROUP BY T.TaskName,T.TaskCode,T.TaskId,T.CompleteQuantity,T.Total2,T.Quantity\r\n                        ),MbudTask AS\r\n                        (\r\n                        --月目标成本\r\n                        SELECT  BT.TaskName,BT.TaskCode,\r\n                        BT.PrjId,BT.OrderNumber,BT.TaskId,\r\n                        ISNULL(ISNULL(CT.CompleteQuantity,0.0)/NULLIF(BT.Quantity,0.0)*BT.Total2,0.0)  AS Total\r\n                        FROM Bud_Task BT\r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT SUM(ISNULL(BCT.CompleteQuantity,0.0))AS CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        GROUP BY BRT.prjId,BCT.TaskId\r\n                        ) CT\r\n                        ON BT.TaskId=CT.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        ),MdeBudTask AS\r\n                        (\r\n                        --月实际成本\r\n                        SELECT SUM(ISNULL(M.CompleteQuantity,0.0)/NULLIF(M.Quantity,0.0)*ISNULL(M.Total2,0.0))AS Total,M.prjId,M.TaskId FROM\r\n                        (\r\n                        SELECT CompleteQuantity,BT.prjId,BT.Quantity,BT.TaskId,BT.Total2 FROM\r\n                        Bud_Task BT \r\n                        LEFT JOIN\r\n                        (\r\n                        SELECT BCT.CompleteQuantity,BRT.prjId,BCT.TaskId FROM  Bud_ConsReport BRT \r\n                        JOIN Bud_ConsTask BCT\r\n                        ON BRT.ConsReportId=BCT.ConsReportId\r\n                        WHERE BRT.FlowState=1 AND MONTH(BRT.InputDate)={1} AND YEAR(BRT.InputDate)={2} --查询条件\r\n                        ) T\r\n                        ON BT.TaskId=T.TaskId\r\n                        WHERE BT.PrjId='{0}'\r\n                        )M\r\n                        GROUP BY M.prjId,M.CompleteQuantity,M.Quantity,M.Total2,M.TaskId\r\n                        ),RESULT AS\r\n                        (\r\n                        SELECT CONVERT(VARCHAR(6),ROW_NUMBER() OVER(ORDER BY BudTask.OrderNumber)) AS NUM, BudTask.* ,DeBudTask.ConstructCost AS ActualTotal,\r\n                        BudTask.PlanTotal-DeBudTask.ConstructCost AS DiffTotal,\r\n                        ISNULL((BudTask.PlanTotal-DeBudTask.ConstructCost)/NULLIF(BudTask.PlanTotal,0.0),0.0) AS DiffRate,\r\n                        MbudTask.Total AS PlanMonthTotal,\r\n                        MdeBudTask.Total AS ActualMonthTotal,\r\n                        MbudTask.Total-MdeBudTask.Total AS MonthDiffTotal,\r\n                        ISNULL((MbudTask.Total-MdeBudTask.Total)/NULLIF(MbudTask.Total,0.0),0.0) AS MonthDiffRate\r\n                        FROM BudTask\r\n                        LEFT JOIN DeBudTask\r\n                        ON BudTask.TaskId=DeBudTask.TaskId\r\n                        LEFT JOIN MbudTask\r\n                        ON BudTask.TaskId=MbudTask.TaskId\r\n                        LEFT JOIN MdeBudTask\r\n                        ON BudTask.TaskId=MdeBudTask.TaskId\r\n                        WHERE 1=1 {3}\r\n                        )\r\n                        SELECT * FROM RESULT WHERE 1=1 {4}\r\n                        ";
                if ((pageSize == 0) && (pageIndex == 0))
                {
                    str = string.Empty;
                }
                else
                {
                    str = string.Concat(new object[] { " AND NUM >", num, " AND NUM <= ", num2 });
                }
                if (!string.IsNullOrEmpty(taskCode))
                {
                    str2 = str2 + " AND RESULT.TaskCode LIKE '%" + taskCode + "%'";
                }
                if (!string.IsNullOrEmpty(taskName))
                {
                    str2 = str2 + " AND RESULT.TaskName LIKE '%" + taskName + "%'";
                }
                format = string.Format(format, new object[] { prjId, month, year, str2, str });
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, format);
        }

        public static DataTable GetTargetCost(string prjCode, string prjName, string userCode, string isWBSRelevance)
        {
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            if (isWBSRelevance == "1")
            {
                builder.Append("\r\n                --DECLARE @UserCode nvarchar(50),@PrjCode NVARCHAR(500),@PrjName NVARCHAR(500)\r\n                --SET @userCode='00000000';\r\n                --SET @PrjCode='';\r\n                --SET @PrjName='';\r\n                WITH ctePrjInfo AS\r\n                (\r\n\t                --项目信息\r\n\t                SELECT PRJ.PrjGuid,PrjCode,PrjName,StartDate FROM PT_PrjInfo AS PRJ  \r\n\t                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n\t                WHERE IsValid=1 AND (CHARINDEX(@UserCode,PrjManager)>0  OR CHARINDEX(@UserCode,Podepom)>0)  \r\n\t                AND PrjCode LIKE '%'+@PrjCode+'%' AND PrjName LIKE '%'+@PrjName+'%' AND SetUpFlowState=1 AND PrjState<>17 \r\n\t                GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n                ),ctePart1 AS\r\n                (\r\n\t                --间接成本\r\n\t                SELECT IndirBud.ProjectId,ISNULL(IndirBud,0.000) IndirBud,ISNULL(IndirAcc,0.000) IndirAcc,\r\n\t                ISNULL(Monthacc,0.000) Monthacc,ISNULL(Monthbud,0.000) Monthbud FROM \r\n\t                (\r\n\t\t                select ProjectId,sum(IndirAcc) IndirAcc,sum(IndirBud) IndirBud,sum(Monthacc) Monthacc\r\n\t\t                from (\r\n\t\t\t                --间接成本日记账\r\n\t\t\t                select  ProjectId,SUM(Amount) IndirAcc,'0' as IndirBud,'0' as Monthacc from \r\n\t\t\t                Bud_IndirectDiaryDetails DiaryDetails \r\n\t\t\t                left join Bud_IndirectDiaryCost DiaryCost on DiaryDetails.InDiaryId=DiaryCost.InDiaryId  \r\n\t\t\t                where FlowState='1' group by ProjectId \r\n\t\t\t                union\r\n\t\t\t                --本月间接成本日记账\r\n\t\t\t                select  ProjectId,'0' as IndirAcc,'0' as IndirBud,SUM(Amount) Monthacc from \r\n\t\t\t                Bud_IndirectDiaryDetails DiaryDetails \r\n\t\t\t                left join Bud_IndirectDiaryCost DiaryCost on DiaryDetails.InDiaryId=DiaryCost.InDiaryId  \r\n\t\t\t                where FlowState='1' AND DateDiff(mm,InputDate,GetDate())=0 group by ProjectId \r\n\t\t\t                union\r\n\t\t\t                --间接成本预算\r\n\t\t\t                select ProjectId,'0' as IndirAcc,SUM(AccountAmount) IndirBud,'0' as Monthacc from \r\n\t\t\t                Bud_IndirectBudget where State='2' and LEN(CBSCode)>6 group by ProjectId\r\n\t\t                ) as Total group by ProjectId\r\n\t                ) AS IndirBud LEFT JOIN \r\n\t                (\r\n\t\t                --间接成本月度预算\r\n\t\t                SELECT SUM(Amount) Monthbud,ProjectId FROM \r\n\t\t                (\r\n\t\t\t                SELECT monthBudget.*,indirectBudget.ProjectId FROM Bud_IndirectMonthBudget AS monthBudget\r\n\t\t\t                INNER JOIN Bud_IndirectBudget AS indirectBudget ON monthBudget.IndirectBudget=indirectBudget.Id\r\n\t\t\t                WHERE YEAR = DATEPART(YY,GetDate()) AND Month= DATEPART(MM,GetDate())\r\n\t\t                ) AS MonthIndirectBud GROUP BY ProjectId\r\n\t                ) AS  MonthIndirBud ON IndirBud.ProjectId=MonthIndirBud.ProjectId\r\n                ),ctePart2 AS\r\n                (\r\n                    SELECT Target.PrjId,(Target+ISNULL(ModifyAmount,0)) Target,ISNULL(Reality,0) Reality,\r\n\t                ISNULL(MonthTarget,0) MonthRealitybud,ISNULL(MonthReality,0) MonthReality FROM (\r\n                        --原预算\r\n                        SELECT Task.PrjId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) AS Target \r\n                        FROM Bud_Task AS Task \r\n                        INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        LEFT JOIN Bud_TaskResource AS TaskRES ON Task.TaskId =TaskRES.TaskId\r\n                        WHERE TaskType=''\r\n                        GROUP BY Task.PrjId\r\n                    )AS Target \r\n                    LEFT JOIN (\r\n                        --预算变更\r\n                        SELECT PrjId,SUM(ResourceQuantity*ResourcePrice) ModifyAmount FROM Bud_Modify modify\r\n                        INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        INNER JOIN Bud_ModifyTaskRes modifyTaskRes ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId\r\n                        WHERE FlowState=1 Group By PrjId\t\t\t\r\n                    ) ModifyAmount ON Target.PrjId=ModifyAmount.PrjId\r\n                    LEFT JOIN (\r\n                        --施工报量\r\n                        SELECT PrjId,SUM(ISNULL(CONSRES.AccountingQuantity,0)*ISNULL(CONSRES.UnitPrice,0)) AS Reality \r\n                        FROM Bud_ConsTaskRes AS CONSRES\r\n                        LEFT JOIN  Bud_ConsTask AS CONSTask ON  CONSRES.ConsTaskId=CONSTask.ConsTaskId\r\n                        LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTask.ConsReportId=CONSREP.ConsReportId\r\n                        WHERE FlowState=1 GROUP BY PrjId\r\n                    ) AS Reality ON Target.PrjId=Reality.PrjId\r\n\t                LEFT JOIN (\r\n\t\t                --月度预算\r\n\t\t                SELECT Task.PrjId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) AS MonthTarget \r\n\t\t                FROM Bud_Task AS Task \r\n\t\t                INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t                LEFT JOIN Bud_TaskResource AS TaskRES ON Task.TaskId =TaskRES.TaskId\r\n\t\t                WHERE TaskType='M' AND SUBSTRING(Task.TaskId, 2, LEN(DateName(Year,GetDate())+DateName(Month,GetDate()))) = \r\n\t\t                DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t                GROUP BY Task.PrjId\r\n\t                ) monthTarget ON Target.PrjId=monthTarget.PrjId\r\n\t                LEFT JOIN (\r\n\t\t                --本月实际完成\r\n\t\t                SELECT PrjId,CONVERT(DECIMAL(18,3),SUM(ISNULL(CONSRES.AccountingQuantity,0)*ISNULL(CONSRES.UnitPrice,0))) AS MonthReality \r\n\t\t                FROM Bud_ConsTaskRes AS CONSRES\r\n\t\t                LEFT JOIN Bud_ConsTask AS CONSTASK ON CONSRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t                LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t                WHERE FlowState=1 AND DateDiff(mm,InputDate,GetDate())=0 \r\n\t\t                GROUP BY PrjId \r\n\t                ) AS monthReality ON Target.PrjId=monthReality.PrjId\r\n                )\t\r\n                SELECT PrjGuid,PrjCode,PrjName,StartDate,\r\n                ISNULL(IndirBud,0) AS IndirBud,ISNULL(IndirAcc,0) AS IndirAcc,CONVERT(DECIMAL(18,3),ISNULL(Target,0)) AS Target,\r\n                CONVERT(DECIMAL(18,3),ISNULL(Reality,0)) AS Reality,ISNULL(Monthacc,0.000) AS Monthacc,ISNULL(Monthbud,0.000) Monthbud,\r\n                ISNULL(MonthReality,0.000) AS MonthReality, ISNULL(MonthRealitybud,0.000) AS MonthRealitybud,\r\n                ISNULL(ISNULL(IndirBud,0)+ISNULL(Target,0)-ISNULL(IndirAcc,0)-ISNULL(Reality,0),0.000) AS Chazhi,\r\n                ISNULL(ISNULL(MonthBud,0)+ISNULL(MonthRealitybud,0)-ISNULL(MonthAcc,0)-ISNULL(MonthReality,0),0.000) AS MonthChazhi,\r\n                CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(IndirBud,0)+ISNULL(Target,0)-ISNULL(IndirAcc,0)\r\n                -ISNULL(Reality,0))/nullif(ISNULL(IndirBud,0)+ISNULL(Target,0),0)*100),0.000))+'%' as Bilu,\r\n                CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(MonthBud,0)+ISNULL(MonthRealitybud,0)-\r\n                ISNULL(MonthAcc,0)-ISNULL(MonthReality,0))/nullif(ISNULL(MonthBud,0)\r\n                +ISNULL(MonthRealitybud,0),0)*100),0.000))+'%' as MonthBilu  \r\n                FROM ctePrjInfo --项目\r\n                LEFT JOIN ctePart1 ON CONVERT(NVARCHAR(50),ctePrjInfo.PrjGuid)=ctePart1.ProjectId\t--间接成本\r\n                LEFT JOIN ctePart2 ON CONVERT(NVARCHAR(50),ctePrjInfo.PrjGuid)=ctePart2.PrjId\t\t--直接成本\r\n                ORDER BY StartDate DESC ");
            }
            else
            {
                builder.Append("\r\n                --DECLARE @UserCode nvarchar(50),@PrjCode NVARCHAR(500),@PrjName NVARCHAR(500)\r\n                --SET @userCode='00000000';\r\n                --SET @PrjCode='';\r\n                --SET @PrjName='';\r\n                WITH ctePrjInfo AS\r\n                (\r\n\t                --项目信息\r\n\t                SELECT PRJ.PrjGuid,PrjCode,PrjName,StartDate FROM PT_PrjInfo AS PRJ  \r\n\t                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n\t                WHERE IsValid=1 AND (CHARINDEX(@UserCode,PrjManager)>0  OR CHARINDEX(@UserCode,Podepom)>0)  \r\n\t                AND PrjCode LIKE '%'+@PrjCode+'%' AND PrjName LIKE '%'+@PrjName+'%' AND SetUpFlowState=1 AND PrjState<>17 \r\n\t                GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n                ),cteAllBudTask AS\r\n                (\r\n                    --全部预算\r\n                    SELECT PrjId,TaskId,ISNULL(Total/NULLIF(Quantity,0),0) UnitPrice FROM \r\n                    (\r\n                        SELECT budInfo.PrjId,budInfo.TaskId,(budInfo.Total+ISNULL(modifyInfo.Total,0)) Total,\r\n                        (budInfo.Quantity+ISNULL(modifyInfo.Quantity,0)) Quantity FROM \r\n                        (\r\n                            --完整的预算\r\n                            SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,ISNULL(Quantity,0) Quantity\r\n                            FROM Bud_Task AS BudTask \r\n                            INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n                            AND BudTask.Version=vGetCurBudVersion.CurVersion \r\n                            UNION\r\n                            SELECT PrjId,ModifyTaskId TaskId,Total,Quantity FROM Bud_Modify modify\r\n                            JOIN Bud_ModifyTask modifyTask ON modify.modifyId=modifyTask.modifyId\r\n                            WHERE flowState=1 AND ModifyType=0 \r\n                        ) budInfo\r\n                        LEFT JOIN \r\n                        (\r\n                            --清单内的预算变更\r\n                            SELECT PrjId,TaskId,Total,Quantity FROM Bud_Modify modify\r\n                            JOIN Bud_ModifyTask modifyTask ON modify.modifyId=modifyTask.modifyId\r\n                            WHERE flowState=1 AND ModifyType=1 \r\n                        ) modifyInfo ON budInfo.TaskId=modifyInfo.TaskId\r\n                    ) Bud \r\n                ),ctePart1 AS\r\n                (\r\n\t                --间接成本\r\n\t                SELECT IndirBud.ProjectId,ISNULL(IndirBud,0.000) IndirBud,ISNULL(IndirAcc,0.000) IndirAcc,\r\n\t                ISNULL(Monthacc,0.000) Monthacc,ISNULL(Monthbud,0.000) Monthbud FROM \r\n\t                (\r\n\t\t                select ProjectId,sum(IndirAcc) IndirAcc,sum(IndirBud) IndirBud,sum(Monthacc) Monthacc\r\n\t\t                from (\r\n\t\t\t                --间接成本日记账\r\n\t\t\t                select  ProjectId,SUM(Amount) IndirAcc,'0' as IndirBud,'0' as Monthacc from \r\n\t\t\t                Bud_IndirectDiaryDetails DiaryDetails \r\n\t\t\t                left join Bud_IndirectDiaryCost DiaryCost on DiaryDetails.InDiaryId=DiaryCost.InDiaryId  \r\n\t\t\t                where FlowState='1' group by ProjectId \r\n\t\t\t                union\r\n\t\t\t                --本月间接成本日记账\r\n\t\t\t                select  ProjectId,'0' as IndirAcc,'0' as IndirBud,SUM(Amount) Monthacc from \r\n\t\t\t                Bud_IndirectDiaryDetails DiaryDetails \r\n\t\t\t                left join Bud_IndirectDiaryCost DiaryCost on DiaryDetails.InDiaryId=DiaryCost.InDiaryId  \r\n\t\t\t                where FlowState='1' AND DateDiff(mm,InputDate,GetDate())=0 group by ProjectId \r\n\t\t\t                union\r\n\t\t\t                --间接成本预算\r\n\t\t\t                select ProjectId,'0' as IndirAcc,SUM(AccountAmount) IndirBud,'0' as Monthacc from \r\n\t\t\t                Bud_IndirectBudget where State='2' and LEN(CBSCode)>6 group by ProjectId\r\n\t\t                ) as Total group by ProjectId\r\n\t                ) AS IndirBud LEFT JOIN \r\n\t                (\r\n\t\t                --间接成本月度预算\r\n\t\t                SELECT SUM(Amount) Monthbud,ProjectId FROM \r\n\t\t                (\r\n\t\t\t                SELECT monthBudget.*,indirectBudget.ProjectId FROM Bud_IndirectMonthBudget AS monthBudget\r\n\t\t\t                INNER JOIN Bud_IndirectBudget AS indirectBudget ON monthBudget.IndirectBudget=indirectBudget.Id\r\n\t\t\t                WHERE YEAR = DATEPART(YY,GetDate()) AND Month= DATEPART(MM,GetDate())\r\n\t\t                ) AS MonthIndirectBud GROUP BY ProjectId\r\n\t                ) AS  MonthIndirBud ON IndirBud.ProjectId=MonthIndirBud.ProjectId\r\n                ),ctePart2 AS\r\n                (\r\n\t                SELECT Target.PrjId,Target,ISNULL(Reality,0) Reality,ISNULL(MonthTarget,0) MonthRealitybud,\r\n\t                ISNULL(MonthReality,0) MonthReality \r\n\t                FROM (\r\n\t\t                SELECT PrjId,SUM(BudTotal) Target FROM\r\n\t\t                (\r\n\t\t\t                SELECT BudInfo.PrjId,BudInfo.TaskId,(Total+ISNUll(ModifyAmount,0)) BudTotal FROM \r\n\t\t\t                (\r\n\t\t\t\t                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,Version FROM Bud_Task AS BudTask\r\n\t\t\t\t                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t\t                AND BudTask.Version=vGetCurBudVersion.CurVersion \r\n\t\t\t\t                WHERE len(OrderNumber)=3 AND TaskType=''\r\n\t\t\t                ) BudInfo \r\n\t\t\t                LEFT JOIN \r\n\t\t\t                (\r\n\t\t\t\t                --预算变更\r\n\t\t\t\t                SELECT PrjId,SUM(Total) ModifyAmount,modifyTask.TaskId FROM Bud_Modify modify\r\n\t\t\t\t                INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t\t\t                WHERE FlowState=1 AND ModifyType=1 Group By PrjId,modifyTask.TaskId  \r\n\t\t\t                ) modifyInfo ON BudInfo.TaskId=modifyInfo.TaskId\r\n\t\t                ) Bud GROUP BY PrjId\r\n\t                ) AS Target \r\n\t                LEFT JOIN \r\n\t                (\r\n\t\t                --总施工报量\r\n\t\t                --施工报量的工程量*目标成本的综合单价\r\n\t\t                SELECT ConsRep.PrjId,SUM(ISNULL(AccountingQuantity,0)*ISNULL(UnitPrice,0)) AS Reality \r\n\t\t                FROM Bud_ConsTask AS ConsTask\r\n\t\t                LEFT JOIN Bud_ConsReport AS ConsRep ON ConsTask.ConsReportId=ConsRep.ConsReportId\r\n\t\t                LEFT JOIN cteAllBudTask ON ConsTask.TaskId=cteAllBudTask.TaskId\r\n\t\t                WHERE flowState=1 GROUP BY ConsRep.PrjId\r\n\t                ) Reality ON Target.PrjId=Reality.PrjId\r\n\t                LEFT JOIN \r\n\t                (\r\n\t\t                --月度预算\r\n\t\t                SELECT PrjId,SUM(Total) MonthTarget FROM\r\n\t\t                (\r\n\t\t\t                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,Version FROM Bud_Task AS BudTask\r\n\t\t\t                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t                AND BudTask.Version=vGetCurBudVersion.CurVersion \r\n\t\t\t                WHERE len(OrderNumber)=3 AND TaskType='M' \r\n\t\t\t                AND SUBSTRING(BudTask.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate()))) \r\n\t\t\t                = DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t                ) monthBud GROUP BY PrjId\r\n\t                ) MonthTarget ON Target.PrjId=MonthTarget.PrjId\r\n\t                LEFT JOIN\r\n\t                (\r\n \t\t                --本月施工报量\r\n\t\t                --施工报量的工程量*目标成本的综合单价\r\n\t\t                SELECT ConsRep.PrjId,SUM(ISNULL(AccountingQuantity,0)*ISNULL(UnitPrice,0)) AS MonthReality \r\n\t\t                FROM Bud_ConsTask AS ConsTask\r\n\t\t                LEFT JOIN Bud_ConsReport AS ConsRep ON ConsTask.ConsReportId=ConsRep.ConsReportId\r\n\t\t                LEFT JOIN cteAllBudTask ON ConsTask.TaskId=cteAllBudTask.TaskId\r\n\t\t                WHERE flowState=1  AND DateDiff(mm,InputDate,GetDate())=0 GROUP BY ConsRep.PrjId \r\n\t                ) monthReality ON Target.PrjId=monthReality.PrjId\r\n                )\r\n                SELECT PrjGuid,PrjCode,PrjName,StartDate,\r\n                ISNULL(IndirBud,0) AS IndirBud,ISNULL(IndirAcc,0) AS IndirAcc,CONVERT(DECIMAL(18,3),ISNULL(Target,0)) AS Target,\r\n                CONVERT(DECIMAL(18,3),ISNULL(Reality,0)) AS Reality,ISNULL(Monthacc,0.000) AS Monthacc,ISNULL(Monthbud,0.000) Monthbud,\r\n                ISNULL(MonthReality,0.000) AS MonthReality, ISNULL(MonthRealitybud,0.000) AS MonthRealitybud,\r\n                ISNULL(ISNULL(IndirBud,0)+ISNULL(Target,0)-ISNULL(IndirAcc,0)-ISNULL(Reality,0),0.000) AS Chazhi,\r\n                ISNULL(ISNULL(MonthBud,0)+ISNULL(MonthRealitybud,0)-ISNULL(MonthAcc,0)-ISNULL(MonthReality,0),0.000) AS MonthChazhi,\r\n                CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(IndirBud,0)+ISNULL(Target,0)-ISNULL(IndirAcc,0)\r\n                -ISNULL(Reality,0))/nullif(ISNULL(IndirBud,0)+ISNULL(Target,0),0)*100),0.000))+'%' as Bilu,\r\n                CONVERT(VARCHAR(20),ISNULL(CONVERT(DECIMAL(18,2),(ISNULL(MonthBud,0)+ISNULL(MonthRealitybud,0)-\r\n                ISNULL(MonthAcc,0)-ISNULL(MonthReality,0))/nullif(ISNULL(MonthBud,0)\r\n                +ISNULL(MonthRealitybud,0),0)*100),0.000))+'%' as MonthBilu  \r\n                FROM ctePrjInfo --项目\r\n                LEFT JOIN ctePart1 ON CONVERT(NVARCHAR(50),ctePrjInfo.PrjGuid)=ctePart1.ProjectId\t--间接成本\r\n                LEFT JOIN ctePart2 ON CONVERT(NVARCHAR(50),ctePrjInfo.PrjGuid)=ctePart2.PrjId\t\t--直接成本\r\n                ORDER BY StartDate DESC ");
            }
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@UserCode", userCode), new SqlParameter("@PrjCode", prjCode), new SqlParameter("@PrjName", prjName) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static DataTable GetTargetCostDetail(string PrjId, string code, string name)
        {
            DataTable table = new DataTable();
            table = SqlHelper.ExecuteQuery(CommandType.Text, "select CBSCode,[Name] from Bud_CostAccounting where [Type]='D' and LEN(CBSCode)>6");
            DataTable table2 = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50)\r\n            --SET @prjId='a25fdb14-8841-4193-9017-80d1da6c6e10';\r\n            WITH DIR AS (\r\n\t            select ResourceId,ISNULL(CONVERT(DECIMAL(18,3),sum(MonthBud)),0.000) as MonthBud,\r\n\t            ISNULL(CONVERT(DECIMAL(18,3),sum(MonthAcc)),0.000) as MonthAcc,\r\n\t            ISNULL(CONVERT(DECIMAL(18,3),sum(Bud)),0.000) as Bud,\r\n\t            ISNULL(CONVERT(DECIMAL(18,3),sum(Acc)),0.000) as Acc from \r\n\t            (\r\n\t\t            --施工报量\r\n\t\t            SELECT ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS Acc,'0'as MonthAcc,'0'as MonthBud,\r\n\t\t            '0' as Bud FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t            WHERE PrjId=@prjId AND FlowState=1\r\n\t\t            GROUP BY ResourceId\r\n\t\t            union\r\n\t\t            --本月施工报量\r\n\t\t            SELECT ResourceId,'0' as Acc,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS MonthAcc,\r\n\t\t            '0'as MonthBud,'0' as Bud FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,InputDate,GetDate())=0\r\n\t\t            GROUP BY ResourceId\r\n\t\t            union\t\r\n\t\t            --本月预算\r\n\t\t            SELECT ResourceId,'0' as Acc,'0' as MonthAcc,SUM(Target) MonthBud,'0' as Bud FROM \r\n\t\t            (\r\n\t\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId\r\n\t\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))=\r\n\t\t\t            DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            ) MonBudRes GROUP BY ResourceId \r\n\t\t            union\r\n\t\t            --全部预算\r\n\t\t            SELECT ResourceId,'0' as Acc,'0' as MonthAcc,'0'as MonthBud,SUM(Target) AS Bud FROM \r\n\t\t            (\r\n\t\t\t            SELECT SUM(ResourcePrice*ResourceQuantity)AS Target,ResourceId FROM Bud_TaskResource\r\n                        WHERE PrjGuid=@prjId\r\n                        GROUP BY ResourceId\r\n                        UNION\r\n                        SELECT SUM(ResourcePrice*ResourceQuantity)AS Target,ResourceId FROM Bud_ModifyTaskRes BTS\r\n                        LEFT JOIN Bud_ModifyTask BTK\r\n                        ON BTS.ModifyTaskId=BTK.ModifyTaskId\r\n                        LEFT JOIN Bud_Modify BM\r\n                        ON BTK.ModifyId=BM.ModifyId\r\n                        WHERE BTK.PrjId2=@prjId AND BM.FlowState=1\r\n                        GROUP BY ResourceId\r\n\t\t            ) BudRes GROUP BY ResourceId \r\n\t            ) as Dir  \r\n            group by ResourceId \r\n            ),DIRInfos AS \r\n            (\r\n\t            SELECT DIRInfo.*,resType.CBSCode FROM (\r\n\t            SELECT *,dbo.ufn_GetRootResTypeId(ResourceId) RootResTypeId FROM DIR) DIRInfo \r\n\t            LEFT JOIN Res_ResourceType resType ON RootResTypeId=resType.ResourceTypeId\r\n            )\r\n\r\n            select * from (\r\n                select CBS.CBSCode as CBSCode,[Name] as CBSName,\r\n                ISNULL(MonthBud,0) AS MonthBud,ISNULL(sum(MonthAcc),0.000) as MonthAcc,ISNULL(sum(Bud),0.000) as Bud,\r\n                ISNULL(sum(Acc),0.000) Acc from (\r\n                    select CBSCode,sum(Amount) as MonthAcc,'0' as Bud,'0' as Acc from Bud_IndirectDiaryDetails BIDD \r\n                    left join Bud_IndirectDiaryCost BIDC  on BIDD.InDiaryId=BIDC.InDiaryId where ProjectId=@prjId\r\n                    and FlowState='1' and DateDiff(mm,InputDate,GetDate())=0  group by CBSCode\r\n                    union \r\n                    select CBSCode,'0' as MonthAcc,sum(AccountAmount) as Bud,'0' as Acc from Bud_IndirectBudget where ProjectId=@prjId and State='2'\r\n                    group by CBSCode\r\n                    union \r\n                    select CBSCode,'0' as MonthAcc,'0' as Bud,sum(Amount) as Acc from Bud_IndirectDiaryDetails BIDD \r\n                    left join Bud_IndirectDiaryCost BIDC  on BIDD.InDiaryId=BIDC.InDiaryId where ProjectId=@prjId\r\n                    and FlowState='1'  group by CBSCode\r\n                ) as Indir\r\n                right join Bud_CostAccounting CBS ON CBS.CBSCode=Indir.CBSCode \r\n                LEFT JOIN (\r\n\t                SELECT Amount AS MonthBud,CBSCode FROM Bud_IndirectMonthBudget AS monthBudget\r\n\t                INNER JOIN Bud_IndirectBudget AS indirectBudget ON monthBudget.IndirectBudget=indirectBudget.Id\r\n\t                WHERE YEAR = DATEPART(YY,GetDate()) AND Month= DATEPART(MM,GetDate())\r\n\t                AND projectId=@prjId\r\n                ) AS MonthIndir ON Indir.CBSCode=MonthIndir.CBSCode\r\n                where [Type]='I' and LEN(CBS.CBSCode)>6 group by CBS.CBSCode,[Name],MonthBud ");
            builder.AppendLine();
            SqlParameter parameter = new SqlParameter("@prjId", PrjId);
            for (int i = 0; i < table.Rows.Count; i++)
            {
                builder.Append("UNION");
                builder.AppendLine();
                builder.AppendFormat("SELECT '{0}' AS CBSCode,'{1}' as CBSName,ISNULL(sum(MonthBud),0.000) MonthBud,\r\n                                      ISNULL(sum(MonthAcc),0.000) MonthAcc,ISNULL(sum(Bud),0.000) Bud,ISNULL(sum(Acc),0.000) Acc FROM DIR \r\n                                        where ResourceId in (SELECT ResourceId FROM DIRInfos WHERE CBSCode='{2}')", table.Rows[i][0].ToString(), table.Rows[i][1].ToString(), table.Rows[i][0].ToString());
                builder.AppendLine();
            }
            builder.Append(") as  Total where 1=1 ");
            if (!string.IsNullOrEmpty(code))
            {
                builder.AppendFormat(" and CBSCode like '%{0}%' ", code);
            }
            if (!string.IsNullOrEmpty(name))
            {
                builder.AppendFormat(" and CBSName like '%{0}%' ", name);
            }
            builder.Append("order by CBSCode ");
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), new SqlParameter[] { parameter });
        }

        public static DataTable GetTaskReport(string prjId, string taskcode, string taskname)
        {
            if (!(BudTask.GetChildNode(prjId) != ""))
            {
                return null;
            }
            DataTable table = new DataTable();
            StringBuilder builder = new StringBuilder();
            builder.Append(" SELECT TASK.TaskId,TaskCode,TaskName,ISNULL(ResourceName,'') AS ResName,ISNULL(Specification,'') AS Specification,ISNULL(UNIT.Name,'') AS UnitName,ISNULL(CONVERT(DECIMAL(18,3),TotalBudget),0)AS TotalBudget,ISNULL(CONVERT(DECIMAL(18,3),TotalAcc),0) AS TotalAcc ,ISNULL(CONVERT(DECIMAL(18,3),TotalBudget),0)-ISNULL(CONVERT(DECIMAL(18,3),TotalAcc),0)as JieChao FROM Bud_Task AS TASK");
            builder.AppendLine();
            builder.Append("LEFT JOIN");
            builder.AppendLine();
            builder.Append("(");
            builder.AppendLine();
            builder.Append("SELECT TaskId,ResourceId,SUM(ResourcePrice)*SUM(TotalAccQuantity) AS TotalBudget,SUM(TotalAcc) AS TotalAcc FROM(");
            builder.AppendLine();
            builder.Append("SELECT TaskId,ResourceId,ResourcePrice,'0' AS TotalAcc,'0' AS TotalAccQuantity FROM Bud_TaskResource");
            builder.AppendLine();
            builder.AppendFormat("WHERE TaskId IN(SELECT TaskId FROM Bud_Task WHERE PrjId='{0}' ) ", prjId);
            builder.AppendLine();
            builder.Append("UNION");
            builder.AppendLine();
            builder.Append("SELECT TaskId,ResourceId,'0' AS ResourcePrice ,ISNULL(SUM(UnitPrice*CONSRES.AccountingQuantity),0) AS TotalAcc,");
            builder.AppendLine();
            builder.Append("ISNULL(SUM(CONSRES.AccountingQuantity),0) AS TotalAccQuantity");
            builder.AppendLine();
            builder.Append("FROM Bud_ConsTaskRes AS CONSRES");
            builder.AppendLine();
            builder.Append("LEFT JOIN Bud_ConsTask ON CONSRES.ConsTaskId = Bud_ConsTask.ConsTaskId");
            builder.AppendLine();
            builder.Append("WHERE CONSRES.ConsTaskId IN");
            builder.AppendLine();
            builder.Append("(");
            builder.AppendLine();
            builder.Append("SELECT ConsTaskId FROM Bud_ConsTask WHERE ConsReportId IN");
            builder.AppendLine();
            builder.AppendFormat("(SELECT ConsReportId FROM Bud_ConsReport WHERE PrjId ='{0}' AND State='2' )", prjId);
            builder.AppendLine();
            builder.Append(") GROUP BY TaskId,ResourceId");
            builder.AppendLine();
            builder.Append(") AS TOTAL");
            builder.AppendLine();
            builder.Append("GROUP BY TaskId,ResourceId --ORDER BY TaskId,ResourceId");
            builder.AppendLine();
            builder.Append(")");
            builder.AppendLine();
            builder.Append("AS TOTAL ON TASK.TaskId=TOTAL.TaskId");
            builder.AppendLine();
            builder.Append("INNER JOIN Res_Resource AS RES ON TOTAL.ResourceId=RES.ResourceId");
            builder.AppendLine();
            builder.Append("LEFT JOIN Res_Unit as UNIT ON RES.Unit=UNIT.UnitId");
            builder.AppendLine();
            builder.Append("WHERE TASK.TaskId IN");
            builder.AppendLine();
            builder.Append("(");
            builder.AppendLine();
            builder.AppendFormat("{0}", BudTask.GetChildNode(prjId));
            builder.AppendLine();
            builder.Append(") AND TotalBudget <>0  ORDER BY OrderNumber ASC");
            if (!string.IsNullOrEmpty(taskcode))
            {
                builder.AppendFormat(" AND TaskCode like '%{0}%' ", taskcode);
            }
            if (!string.IsNullOrEmpty(taskname))
            {
                builder.AppendFormat(" AND TaskName like '%{0}%' ", taskname);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString());
        }
    }
}

