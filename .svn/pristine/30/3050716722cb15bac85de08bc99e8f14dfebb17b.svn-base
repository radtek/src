namespace cn.justwin.Domain
{
    using cn.justwin.DAL;
    using cn.justwin.stockBLL;
    using cn.justwin.Web;
    using System;
    using System.Collections.Generic;
    using System.Data;
    using System.Data.SqlClient;
    using System.Linq;
    using System.Runtime.CompilerServices;
    using System.Text;

    public class ConstructReport
    {
        private IList<ConstructTask> constructTaskList;
        private static string ElseCBSCode = ConfigHelper.Get("ElseCBSCode");
        private static string LaborCBSCode = ConfigHelper.Get("LaborCBSCode");
        private static string LaborId = ConfigHelper.Get("Labor");
        private static string MachineCBSCode = ConfigHelper.Get("MachineCBSCode");
        private static string MajorStuff = ConfigHelper.Get("MajorStuff");
        private static string OutSourceCBSCode = ConfigHelper.Get("OutSourceCBSCode");
        private static PTDbsjBll pTDbsjBll = new PTDbsjBll();
        private static string StuffCBSCode = ConfigHelper.Get("StuffCBSCode");

        private ConstructReport()
        {
        }

        public void Add(ConstructReport consReport)
        {
            using (pm2Entities entities = new pm2Entities())
            {
                Bud_ConsReport report = new Bud_ConsReport {
                    ConsReportId = consReport.Id,
                    InputDate = consReport.InputDate,
                    InputUser = consReport.InputUser,
                    PrjId = consReport.ProjectId,
                    WorkCard = consReport.WorkCard,
                    IsValid = new bool?(consReport.IsValid),
                    State = consReport.State,
                    FlowState = consReport.FlowState
                };
                entities.AddToBud_ConsReport(report);
                entities.SaveChanges();
            }
        }

        public void AddConstructTask(ConstructTask constrctTask)
        {
            if (!this.ConstructTaskList.Contains(constrctTask))
            {
                this.ConstructTaskList.Add(constrctTask);
            }
            else
            {
                this.ConstructTaskList.Remove(constrctTask);
                this.ConstructTaskList.Add(constrctTask);
            }
        }

        public static ConstructReport Create(string Id, string prjId, string user, DateTime date, IList<ConstructTask> constructTaskList, string workCard, int flowState)
        {
            if (string.IsNullOrEmpty(Id))
            {
                throw new ArgumentNullException("Id", "Id不能为空");
            }
            if (string.IsNullOrEmpty(user))
            {
                throw new ArgumentNullException("录入人", "录入人不能为空");
            }
            return new ConstructReport { Id = Id, ProjectId = prjId, InputDate = date, InputUser = user, WorkCard = workCard, ConstructTaskList = constructTaskList, FlowState = flowState };
        }

        public static void Delete(List<string> idList)
        {
            using (pm2Entities entities = new pm2Entities())
            {
                if (idList.Count == 1)
                {
                    Delete(idList[0], entities);
                }
                else
                {
                    Delete(idList, entities);
                }
                DelInValid(entities);
                entities.SaveChanges();
            }
        }

        private static void Delete(List<string> idList, pm2Entities context)
        {
            using (List<string>.Enumerator enumerator = idList.GetEnumerator())
            {
                string id;
                while (enumerator.MoveNext())
                {
                    id = enumerator.Current;
                    Bud_ConsReport entity = (from m in context.Bud_ConsReport
                        where m.ConsReportId == id
                        select m).FirstOrDefault<Bud_ConsReport>();
                    if (entity != null)
                    {
                        context.DeleteObject(entity);
                    }
                }
            }
        }

        private static void Delete(string reportId, pm2Entities context)
        {
            Bud_ConsReport entity = (from m in context.Bud_ConsReport
                where m.ConsReportId == reportId
                select m).FirstOrDefault<Bud_ConsReport>();
            if (entity == null)
            {
                throw new Exception("已删除不存在!");
            }
            context.DeleteObject(entity);
        }

        private static void DelInValid(pm2Entities context)
        {
            foreach (Bud_ConsReport report in (from m in context.Bud_ConsReport
                where m.IsValid == false
                select m).ToList<Bud_ConsReport>())
            {
                if (report != null)
                {
                    context.DeleteObject(report);
                }
            }
        }

        public static IList<ConstructReport> GetAuditedByPrj(string prjId)
        {
            using (pm2Entities entities = new pm2Entities())
            {
                List<ConstructReport> list = new List<ConstructReport>();
                foreach (Bud_ConsReport report in from cr in entities.Bud_ConsReport
                    where ((cr.PrjId == prjId) & (cr.IsValid == true)) & (cr.FlowState == 1)
                    orderby cr.InputDate descending
                    select cr)
                {
                    ConstructReport item = new ConstructReport {
                        Id = report.ConsReportId,
                        InputUser = report.InputUser,
                        InputDate = Convert.ToDateTime(report.InputDate.ToString("yyyy-MM-dd")),
                        ProjectId = report.PrjId,
                        WorkCard = report.WorkCard,
                        State = report.State,
                        CancelAuditReason = report.CancelAuditReason,
                        CancelReportReason = report.CancelReportReason,
                        FlowState = report.FlowState
                    };
                    list.Add(item);
                }
                return list;
            }
        }

        public static ConstructReport GetById(string id)
        {
            if (string.IsNullOrEmpty(id))
            {
                throw new ArgumentNullException("Id", "Id不能为空");
            }
            using (pm2Entities entities = new pm2Entities())
            {
                return (from m in entities.Bud_ConsReport
                    where m.ConsReportId == id
                    select new ConstructReport { Id = m.ConsReportId, InputDate = m.InputDate, InputUser = m.InputUser, WorkCard = m.WorkCard, ProjectId = m.PrjId, State = m.State, FlowState = m.FlowState }).FirstOrDefault<ConstructReport>();
            }
        }

        public static IList<ConstructReport> GetByPrj(string prjId)
        {
            using (pm2Entities entities = new pm2Entities())
            {
                List<ConstructReport> list = new List<ConstructReport>();
                foreach (Bud_ConsReport report in from cr in entities.Bud_ConsReport
                    where (cr.PrjId == prjId) & (cr.IsValid == true)
                    orderby cr.InputDate descending
                    select cr)
                {
                    ConstructReport item = new ConstructReport {
                        Id = report.ConsReportId,
                        InputUser = report.InputUser,
                        InputDate = Convert.ToDateTime(report.InputDate.ToString("yyyy-MM-dd")),
                        ProjectId = report.PrjId,
                        WorkCard = report.WorkCard,
                        State = report.State,
                        CancelAuditReason = report.CancelAuditReason,
                        CancelReportReason = report.CancelReportReason,
                        FlowState = report.FlowState
                    };
                    list.Add(item);
                }
                return list;
            }
        }

        public static IList<ConstructReport> GetByPrjAudit(string prjId)
        {
            using (pm2Entities entities = new pm2Entities())
            {
                List<ConstructReport> list = new List<ConstructReport>();
                foreach (Bud_ConsReport report in from cr in entities.Bud_ConsReport
                    where ((cr.PrjId == prjId) & (cr.IsValid == true)) & (((cr.State == "1") || (cr.State == "2")) || (cr.State == "4"))
                    orderby cr.InputDate descending
                    select cr)
                {
                    ConstructReport item = new ConstructReport {
                        Id = report.ConsReportId,
                        InputUser = report.InputUser,
                        InputDate = Convert.ToDateTime(report.InputDate.ToString("yyyy-MM-dd")),
                        ProjectId = report.PrjId,
                        WorkCard = report.WorkCard,
                        State = report.State,
                        CancelAuditReason = report.CancelAuditReason,
                        CancelReportReason = report.CancelReportReason
                    };
                    list.Add(item);
                }
                return list;
            }
        }

        public static DataTable GetCBSCost(string prjId)
        {
            new StringBuilder();
            string cmdText = "    \r            --DECLARE @prjId NVARCHAR(50)\r\n            --SET @prjId='4c91f99d-2929-49dc-874b-953dc32a8776';\r\n            WITH budRes AS\r\n            (\r\n\t            --预算资源\r\n\t            SELECT SUM(ResTotal) ResTotal,ResourceTypeId FROM\r\n\t            (\r\n\t\t            SELECT SUM(ResTotal) ResTotal,ResourceId,dbo.ufn_GetRootResTypeId(ResourceId) ResourceTypeId FROM\r\n\t\t            ( \r\n\t\t\t            SELECT (SUM(Bud_TaskResource.ResourceQuantity)*Bud_TaskResource.ResourcePrice) ResTotal,\r\n\t\t\t            Bud_TaskResource.ResourceId\r\n\t\t\t            FROM Bud_TaskResource JOIN Bud_Task ON Bud_TaskResource.TaskId=Bud_Task.TaskId\r\n\t\t\t            JOIN  vGetCurBudVersion ON Bud_Task.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t            AND Bud_Task.version=vGetCurBudVersion.curversion\r\n\t\t\t            AND Bud_Task.PrjId=@prjId AND TaskType=''\r\n\t\t\t            GROUP BY Bud_TaskResource.ResourcePrice,Bud_TaskResource.ResourceId\r\n\t\t\t            UNION ALL\r\n\t\t\t            SELECT (SUM(ResourceQuantity)*ResourcePrice) ReseTotal,\r\n\t\t\t            ResourceId FROM Bud_ModifyTaskRes modifyTaskRes\r\n\t\t\t            JOIN Bud_ModifyTask modifyTask ON modifyTaskRes.ModifyTaskId=modifyTask.ModifyTaskId\r\n\t\t\t            JOIN Bud_MOdify modify ON modifyTask.modifyId=modify.modifyId\r\n\t\t\t            WHERE modify.FlowState='1' AND modify.PrjId=@prjId\r\n\t\t\t            GROUP BY ResourcePrice,ResourceId\r\n\t\t            ) allBudResInfo GROUP BY ResourceId\r\n\t            ) budResType  GROUP BY ResourceTypeId\r\n            ),directInfo AS\r\n            (\r\n\t            --直接费\t\r\n\t            SELECT budRes.ResourceTypeId,ResTotal,ISNULL(LastRealityTotal,0) LastRealityTotal,\r\n\t            ISNULL(CurrentRealityTotal,0) CurrentRealityTotal,\r\n\t            (ISNULL(LastRealityTotal,0)+ISNULL(CurrentRealityTotal,0)) RealityTotal FROM budRes \r\n\t            LEFT JOIN \r\n\t            (\r\n\t\t            --上年末实际发生额\r\n\t\t            SELECT ResourceTypeId,SUM(LastRealityTotal) LastRealityTotal FROM \r\n\t\t            (\r\n\t\t\t            SELECT dbo.ufn_GetRootResTypeId(ResourceId) ResourceTypeId,ResourceId,\r\n\t\t\t            (UnitPrice*conTaskRes.AccountingQuantity) LastRealityTotal FROM Bud_ConsTaskRes conTaskRes\r\n\t\t\t            INNER JOIN Bud_ConsTask consTask ON conTaskRes.ConsTaskId=consTask.ConsTaskId\r\n\t\t\t            INNER JOIN Bud_ConsReport consReport ON consTask.ConsReportId=consReport.ConsReportId\r\n\t\t\t            WHERE PrjId=@prjId AND DateDiff(yyyy,InputDate,GetDate())>0 AND FlowState=1\r\n\t\t            ) LastReality GROUP BY ResourceTypeId\r\n\t            ) lastReal ON budRes.ResourceTypeId=lastReal.ResourceTypeId\r\n\t            LEFT JOIN \r\n\t            (\r\n\t\t            --今年实际发生额\r\n\t\t            SELECT ResourceTypeId,SUM(CurrentRealityTotal) CurrentRealityTotal FROM \r\n\t\t            (\r\n\t\t\t            SELECT dbo.ufn_GetRootResTypeId(ResourceId) ResourceTypeId,ResourceId,\r\n\t\t\t            (UnitPrice*conTaskRes.AccountingQuantity) CurrentRealityTotal FROM Bud_ConsTaskRes conTaskRes\r\n\t\t\t            INNER JOIN Bud_ConsTask consTask ON conTaskRes.ConsTaskId=consTask.ConsTaskId\r\n\t\t\t            INNER JOIN Bud_ConsReport consReport ON consTask.ConsReportId=consReport.ConsReportId\r\n\t\t\t            WHERE PrjId=@prjId AND DateDiff(yyyy,InputDate,GetDate())=0 AND FlowState=1\r\n\t\t            ) LastReality GROUP BY ResourceTypeId\r\n\t            ) currentReal ON budRes.ResourceTypeId=currentReal.ResourceTypeId\r\n            ),directCBS AS\r\n            (\r\n\t            --直接费用与CBS挂钩\r\n\t            SELECT costAccounting.CBSCode,costAccounting.Name CBSName,Type,ISNULL(SUM(ResTotal),0) BudTotal,\r\n\t            ISNULL(SUM(LastRealityTotal),0) LastRealityTotal,ISNULL(SUM(CurrentRealityTotal),0) CurrentRealityTotal,\r\n\t            ISNULL(SUM(RealityTotal),0) RealityTotal\r\n\t            FROM directInfo INNER JOIN Res_ResourceType resType ON directInfo.ResourceTypeId=resType.ResourceTypeId\r\n\t            RIGHT JOIN Bud_CostAccounting costAccounting ON resType.CBSCode=costAccounting.CBSCode\r\n\t            WHERE Type='D' AND LEN(costAccounting.CBSCode)>6\r\n\t            GROUP BY costAccounting.CBSCode,costAccounting.Name,Type\r\n            ),indBud AS\r\n            (\r\n\t            --间接费预算\r\n\t            SELECT CBSCode,SUM(AccountAmount) BudAmount FROM Bud_IndirectBudget indirectBud\r\n\t            JOIN Bud_IndirectBudgetWF indirectBudWF ON indirectBud.ProjectId=indirectBudWF.RelatedId\r\n\t            where ProjectId=@prjId AND indirectBudWF.FlowState=1\r\n\t            GROUP BY CBSCode\r\n            ),indInfo AS\r\n            (\r\n\t            SELECT indBud.CBSCode,BudAmount BudTotal,ISNULL(lastReal.Amount,0) LastRealityTotal,\r\n\t            ISNULL(currentReal.Amount,0) CurrentRealityTotal,\r\n\t            (ISNULL(lastReal.Amount,0)+ISNULL(currentReal.Amount,0)) RealityTotal\r\n\t            FROM indBud LEFT JOIN \r\n\t            (\r\n\t\t            --去年末间接费用日记账话费的费用\r\n\t\t            SELECT SUM(Amount) Amount,CBSCode  FROM Bud_IndirectDiaryDetails IndDiaryDetails\r\n\t\t            INNER JOIN Bud_IndirectDiaryCost IndDiary ON IndDiaryDetails.IndiaryId=IndDiary.IndiaryId\r\n\t\t            WHERE ProjectId=@prjId AND DateDiff(yyyy,InputDate,GetDate())>0 AND FlowState=1\r\n\t\t            GROUP BY CBSCode\r\n\t            ) lastReal ON indBud.CBSCode=lastReal.CBSCode\r\n\t             LEFT JOIN \r\n\t            (\r\n\t\t            --今年间接费用日记账话费的费用\r\n\t\t            SELECT SUM(Amount) Amount,CBSCode FROM Bud_IndirectDiaryDetails IndDiaryDetails\r\n\t\t            INNER JOIN Bud_IndirectDiaryCost IndDiary ON IndDiaryDetails.IndiaryId=IndDiary.IndiaryId\r\n\t\t            WHERE ProjectId=@prjId AND DateDiff(yyyy,InputDate,GetDate())=0 AND FlowState=1\r\n\t\t            GROUP BY CBSCode\r\n\t            ) currentReal ON indBud.CBSCode=currentReal.CBSCode\r\n            ),indCBS AS\r\n            (\r\n\t            --间接费与CBS挂钩\r\n\t            SELECT costAccounting.CBSCode,costAccounting.Name CBSName,Type,ISNULL(BudTotal,0) BudTotal,\r\n\t            ISNULL(LastRealityTotal,0) LastRealityTotal,ISNULL(CurrentRealityTotal,0) CurrentRealityTotal,\r\n\t            ISNULL(RealityTotal,0) RealityTotal\r\n\t            FROM indInfo RIGHT JOIN Bud_CostAccounting costAccounting ON indInfo.CBSCode=costAccounting.CBSCode\r\n\t            WHERE Type='I' AND LEN(costAccounting.CBSCode)>6\r\n            )\r\n            SELECT '' Num,* FROM directCBS\r\n            UNION\r\n            SELECT '' Num,* FROM indCBS\r\n            ORDER BY CBSCode ";
            SqlParameter parameter = new SqlParameter("@prjId", prjId);
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, new SqlParameter[] { parameter });
        }

        public static DataTable GetCBSTaskAnalysis(string taskCode, string taskName, string resourceCode, string resourceName, string prjId, string CBSType, int pageSize, int pageIndex)
        {
            string laborCBSCode = LaborCBSCode;
            if (CBSType == "StuffCBSCode")
            {
                laborCBSCode = StuffCBSCode;
            }
            else if (CBSType == "MachineCBSCode")
            {
                laborCBSCode = MachineCBSCode;
            }
            if (pageSize == 0)
            {
                pageSize = GetCBSTaskCount(taskCode, taskName, resourceCode, resourceName, prjId, CBSType);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50),@PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001002';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudInfo AS\r\n            (\r\n\t            --原预算节点信息\r\n\t            SELECT budTask.TaskId,ParentId,TaskCode,TaskName,OrderNumber \r\n\t            FROM Bud_Task budTask\r\n\t            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t            AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t            UNION\r\n\t            --清单外的预算变更节点信息\r\n\t            SELECT ModifyTaskId TaskId,TaskId ParentId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber \r\n\t            FROM Bud_Modify modify\r\n\t            JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t            WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n            ),cteBudTotal AS\r\n            (\r\n\t            --全部预算人工费\r\n\t            SELECT TaskId,ResourceId,SUM(Target) AS BudCost FROM \r\n\t            (\r\n\t\t            --原预算\r\n\t\t            SELECT TaskRes.TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId=TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId \r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION\r\n\t\t            --清单外预算\r\n\t\t            SELECT modifyTask.ModifyTaskId TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=0\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION \r\n\t\t            --清单内预算\r\n\t\t            SELECT TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=1\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            ) BudRes \r\n\t            GROUP BY TaskId,ResourceId\r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量的人工费\r\n\t            select TaskId,ResourceId,sum(UnitPrice*AccountingQuantity) ConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,ResourceId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask where ResourceTypeId IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            group by TaskId,ResourceId\r\n            ),cteTaskRes AS\r\n\t\t\t(\r\n\t\t\t\t--包含预算和施工报量的任务资源\r\n\t\t\t\tSELECT TaskId,ResourceId FROM cteBudTotal\r\n\t\t\t\tUNION \r\n\t\t\t\tSELECT TaskId,ResourceId FROM cteCons\r\n\t\t\t),cteOutStock AS\r\n            (\r\n\t            --出库物资金额\r\n\t            SELECT TaskId,SUM(sprice * number) AS OutPrice\r\n\t            FROM Sm_out_Stock \r\n\t            JOIN Sm_OutReserve ON Sm_out_Stock.orcode = Sm_OutReserve.orcode\r\n\t            WHERE flowstate = 1 GROUP BY TaskId\r\n            )\r\n\t\t\tselect top(@PageSize) Convert(Nvarchar(30),Num) as Num,TaskCode,TaskName,\r\n\t\t\tResourceCode,ResourceName,Specification,TechnicalParameter,ModelNumber,Brand,\r\n\t\t\tConvert(decimal(18,3),BudCost) BudCost,Convert(decimal(18,3),ConsCost) ConsCost,\r\n\t\t\tConvert(decimal(18,3),ReductionAmount) ReductionAmount,OutPrice from \r\n\t\t\t( \r\n\t\t\t\tSELECT Row_Number()over(order by OrderNumber,ResourceCode) as Num,cteBudInfo.TaskId,TaskCode,TaskName,\r\n\t\t\t\tResourceCode,ResourceName,Specification,TechnicalParameter,ModelNumber,Brand,\r\n\t\t\t\tcteTaskRes.ResourceId,cteBudInfo.OrderNumber,ISNULL(BudCost,0) BudCost,ISNULL(ConsCost,0) ConsCost, \r\n\t\t\t\tISNULL(BudCost,0)-ISNULL(ConsCost,0) ReductionAmount,ISNULL(OutPrice,0) OutPrice FROM cteTaskRes \r\n\t\t\t\tINNER JOIN cteBudInfo ON cteTaskRes.TaskId=cteBudInfo.TaskId\r\n\t\t\t\tLEFT JOIN cteBudTotal ON cteTaskRes.TaskId=cteBudTotal.TaskId\r\n\t\t\t\tAND cteTaskRes.ResourceId=cteBudTotal.ResourceId\r\n\t\t\t\tLEFT JOIN cteCons ON cteTaskRes.TaskId=cteCons.TaskId \r\n\t\t\t\tAND cteTaskRes.ResourceId=cteCons.ResourceId\r\n\t\t\t\tINNER JOIN Res_Resource Res ON cteTaskRes.ResourceId=Res.ResourceId\r\n                LEFT JOIN cteOutStock ON cteTaskRes.TaskId = cteOutStock.TaskId\r\n\t\t\t\tWHERE cteTaskRes.TaskId not in  \r\n\t\t\t\t(\r\n\t\t\t\t\tselect distinct parentId from cteBudInfo WHERE ParentId IS not NULL\r\n\t\t\t\t) AND TaskCode LIKE '%'+@TaskCode+'%' and TaskName LIKE  '%'+@TaskName+'%'  \r\n\t\t\t\tAND ResourceCode LIKE '%'+@ResourceCode+'%' and ResourceName LIKE  '%'+@ResourceName+'%' \r\n\t\t\t) tab where Num > @PageSize * (@PageIndex - 1) \r\n\t\t\torder by orderNumber,ResourceCode ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName), new SqlParameter("@ResourceCode", resourceCode), new SqlParameter("@ResourceName", resourceName), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@CBSCode", laborCBSCode) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static int GetCBSTaskCount(string taskCode, string taskName, string resourceCode, string resourceName, string prjId, string CBSType)
        {
            string laborCBSCode = LaborCBSCode;
            if (CBSType == "StuffCBSCode")
            {
                laborCBSCode = StuffCBSCode;
            }
            else if (CBSType == "MachineCBSCode")
            {
                laborCBSCode = MachineCBSCode;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50)\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001002';\r\n            WITH cteBudInfo AS\r\n            (\r\n\t            --原预算节点信息\r\n\t            SELECT budTask.TaskId,ParentId,TaskCode,TaskName,OrderNumber \r\n\t            FROM Bud_Task budTask\r\n\t            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t            AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t            UNION\r\n\t            --清单外的预算变更节点信息\r\n\t            SELECT ModifyTaskId TaskId,TaskId ParentId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber \r\n\t            FROM Bud_Modify modify\r\n\t            JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t            WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n            ),cteBudTotal AS\r\n            (\r\n\t            --全部预算人工费\r\n\t            SELECT TaskId,ResourceId,SUM(Target) AS BudCost FROM \r\n\t            (\r\n\t\t            --原预算\r\n\t\t            SELECT TaskRes.TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId=TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId \r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION\r\n\t\t            --清单外预算\r\n\t\t            SELECT modifyTask.ModifyTaskId TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=0\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION \r\n\t\t            --清单内预算\r\n\t\t            SELECT TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=1\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            ) BudRes \r\n\t            GROUP BY TaskId,ResourceId\r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量的人工费\r\n\t            select TaskId,ResourceId,sum(UnitPrice*AccountingQuantity) ConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,ResourceId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask where ResourceTypeId IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            group by TaskId,ResourceId\r\n            ),cteTaskRes AS\r\n\t\t\t(\r\n\t\t\t\t--包含预算和施工报量的任务资源\r\n\t\t\t\tSELECT TaskId,ResourceId FROM cteBudTotal\r\n\t\t\t\tUNION \r\n\t\t\t\tSELECT TaskId,ResourceId FROM cteCons\r\n\t\t\t)\r\n\t\t\tSELECT COUNT(*) FROM cteTaskRes \r\n\t\t\tINNER JOIN cteBudInfo ON cteTaskRes.TaskId=cteBudInfo.TaskId\r\n\t\t\tLEFT JOIN cteBudTotal ON cteTaskRes.TaskId=cteBudTotal.TaskId\r\n\t\t\tAND cteTaskRes.ResourceId=cteBudTotal.ResourceId\r\n\t\t\tLEFT JOIN cteCons ON cteTaskRes.TaskId=cteCons.TaskId \r\n\t\t\tAND cteTaskRes.ResourceId=cteCons.ResourceId\r\n\t\t\tINNER JOIN Res_Resource Res ON cteTaskRes.ResourceId=Res.ResourceId\r\n\t\t\tWHERE cteTaskRes.TaskId not in  \r\n\t\t\t(\r\n\t\t\t\tselect distinct parentId from cteBudInfo WHERE ParentId IS not NULL\r\n\t\t\t) AND TaskCode LIKE '%'+@TaskCode+'%' and TaskName LIKE  '%'+@TaskName+'%'  \r\n\t\t\tAND ResourceCode LIKE '%'+@ResourceCode+'%' and ResourceName LIKE  '%'+@ResourceName+'%' ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName), new SqlParameter("@ResourceCode", resourceCode), new SqlParameter("@ResourceName", resourceName), new SqlParameter("@CBSCode", laborCBSCode) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static DataTable GetCompletedMonthlyReport(string taskId, DateTime date, string isWBSRelevance)
        {
            string cmdText = string.Empty;
            if (isWBSRelevance == "1")
            {
                cmdText = "    \r\t\t\t\tDECLARE @PrjId nvarchar(200), @Version int--,@TaskId nvarchar(50),@queryDate AS datetime\r\n\t\t\t\t--SET @TaskId='9094673a-3097-43b5-a13d-cbb0bf73e624'\r\n\t\t\t\t--SET @queryDate = '2013-10-22';\r\n\t\t\t\tSELECT @PrjId = PrjId FROM Bud_Task WHERE TaskId = @TaskId;\r\n\t\t\t\tSELECT @Version = Version FROM Bud_Task WHERE TaskId = @TaskId;\r\n\t\t\t\tWITH cteTask AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--原预算\r\n\t\t\t\t\tSELECT TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,Quantity\r\n\t\t\t\t\tFROM Bud_Task\r\n\t\t\t\t\tWHERE PrjId = @PrjId \r\n\t\t\t\t\tAND VERSION = @Version\r\n\t\t\t\t),budModifyInfo AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--针对原预算中的变更任务节点\r\n\t\t\t\t\tSELECT ModifyTaskId AS TaskId,TaskId ParentId,OrderNumber,ModifyTaskCode TaskCode,\r\n\t\t\t\t\tModifyTaskContent TaskName,Unit,Quantity \r\n\t\t\t\t\tFROM Bud_ModifyTask modifyTask\r\n\t\t\t\t\tJOIN Bud_Modify budModify ON modifyTask.modifyId=budModify.modifyId\r\n\t\t\t\t\twhere budModify.PrjId=@PrjId \r\n\t\t\t\t\tand ModifyType=0 AND FlowState=1\r\n\t\t\t\t),budModifyInfo2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--针对变更中的变更任务节点\r\n\t\t\t\t\tSELECT ModifyTaskId AS TaskId,TaskId ParentId,OrderNumber,ModifyTaskCode TaskCode,\r\n\t\t\t\t\tModifyTaskContent TaskName,Unit,Quantity \r\n\t\t\t\t\tFROM Bud_ModifyTask modifyTask\r\n\t\t\t\t\tJOIN Bud_Modify budModify ON modifyTask.modifyId=budModify.modifyId\r\n\t\t\t\t\tJOIN\r\n\t\t\t\t\t( \r\n\t\t\t\t\t\tSELECT prjId from Bud_ModifyTask \r\n\t\t\t\t\t\tJOIN Bud_Modify ON Bud_ModifyTask.ModifyId=Bud_Modify.ModifyId\r\n\t\t\t\t\t\tWHERE ModifyTaskId=@TaskId \r\n\t\t\t\t\t) prj\r\n\t\t\t\t\ton budModify.PrjId=prj.prjId \r\n\t\t\t\t\twhere ModifyType=0 AND FlowState=1\r\n\t\t\t\t),cteTask2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--全部预算\r\n\t\t\t\t\tSELECT newTask.TaskId,ParentId,OrderNumber,TaskCode,\r\n\t\t\t\t\tTaskName,Unit,(newTask.Quantity+ISNULL(inBudModifyTask.Quantity,0)) Quantity,newTask.Total FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,Quantity,\r\n\t\t\t\t\t\tdbo.fn_GetTotal(TaskId) Total FROM cteTask \r\n\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\tSELECT TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,Quantity,\r\n\t\t\t\t\t\tdbo.fn_GetModifyTotal(TaskId) Total FROM budModifyInfo  \r\n\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\tSELECT TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,Quantity,\r\n\t\t\t\t\t\tdbo.fn_GetModifyTotal(TaskId) Total FROM budModifyInfo2\t \t\t\r\n\t\t\t\t\t)newTask LEFT JOIN \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\t--清单内的变更金额\r\n\t\t\t\t\t\tSELECT modifyTask.TaskId,SUM(modifyTask.Quantity) Quantity from Bud_ModifyTask modifyTask\r\n\t\t\t\t\t\tJOIN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT Bud_Modify.* FROM Bud_Modify WHERE PrjId=@PrjId\r\n\t\t\t\t\t\t) budModify ON modifyTask.ModifyId=budModify.ModifyId \r\n\t\t\t\t\t\twhere budModify.FlowState=1 AND modifyType=1 group by modifyTask.TaskId\r\n\t\t\t\t\t) inBudModifyTask ON newTask.TaskId=inBudModifyTask.TaskId\r\n\t\t\t\t), cteBudTask AS\t\r\t\t\t\t(\r\t\t\t\t\t--根据任务节点查询所有子任务(不包含本身)\r\t\t\t\t\tSELECT TaskId, OrderNumber\r\t\t\t\t\tFROM cteTask2\r\t\t\t\t\tWHERE ParentId = @taskId\r\t\t\t\t\tUNION ALL\r\t\t\t\t\tSELECT BT2.TaskId, BT2.OrderNumber\r\t\t\t\t\tFROM cteTask2 AS BT2\r\t\t\t\t\tINNER JOIN cteBudTask ON BT2.ParentId = cteBudTask.TaskId\r\t\t\t\t), cteCurMonth AS\t\r\t\t\t\t(\r\t\t\t\t\t--本期施工报量完成金额\r\t\t\t\t\tSELECT TaskId,SUM(AccountingQuantity) AccountingQuantity,\r\t\t\t\t\tSUM(Sum) Sum FROM \r\t\t\t\t\t(\r\t\t\t\t\t\tSELECT TaskId,InputDate,AccountingQuantity,SUM(Sum) Sum FROM vConsTaskSum\r\n\t\t\t\t\t\tGROUP BY TaskId,InputDate,AccountingQuantity\r\t\t\t\t\t) Cons\r\t\t\t\t\tWHERE InputDate >= CONVERT(nvarchar(6), @queryDate, 112) + '01'\r\t\t\t\t\t\tAND InputDate  < DATEADD(ms,0,DATEADD(mm,DATEDIFF(m,0,GETDATE())+1,0))\r\t\t\t\t\tGROUP BY TaskId\r\t\t\t\t), ctePreMonth AS\t\t\r\t\t\t\t(\r\t\t\t\t\t--上期末施工报量完成金额\r\t\t\t\t\tSELECT TaskId,SUM(AccountingQuantity) AccountingQuantity, \r\t\t\t\t\tSUM(SUM) SUM FROM \r\t\t\t\t\t(\r\t\t\t\t\t\tSELECT TaskId,InputDate,AccountingQuantity,SUM(Sum) Sum FROM vConsTaskSum\r\n\t\t\t\t\t\tGROUP BY TaskId,InputDate,AccountingQuantity\r\t\t\t\t\t) Cons\r\t\t\t\t\tWHERE InputDate < CONVERT(nvarchar(6), @queryDate, 112) + '01'\r\t\t\t\t\tGROUP BY TaskId\r\t\t\t\t)\r\t\t\t\tSELECT '' AS Num,cteBudTask.*,cteTask2.TaskCode,cteTask2.TaskName,cteTask2.Unit,\r\t\t\t\t\tCONVERT(NVARCHAR(50), Cast(cteTask2.Quantity AS DECIMAL(20,3))) AS Quantity,\t\t\t\t\t--工程量\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(cteTask2.Total / NULLIF(cteTask2.Quantity,0),0) AS DECIMAL(20,3))) AS UnitPrice,\t--综合单价\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(cteTask2.Total AS DECIMAL(20,3))) AS Sum,\t\t\t\t\t\t\t\t\t--合价\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(ctePreMonth.AccountingQuantity AS DECIMAL(20,3))) AS preQuantity,\t--上期末数量\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(ctePreMonth.Sum AS DECIMAL(20,3))) AS preSum,\t\t\t\t\t\t--上期末金额\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(cteCurMonth.AccountingQuantity AS DECIMAL(20,3))) AS curQuantity,\t--本期完成数量\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(cteCurMonth.Sum AS DECIMAL(20,3))) AS curSum,\t\t\t\t\t\t--本期完成金额\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(ctePreMonth.AccountingQuantity,0) + ISNULL(cteCurMonth.AccountingQuantity,0) AS DECIMAL(20,3))) \r\t\t\t\t\t\tAS curEndQuantity,\t\t\t\t\t\t\t--本期末完成数量\r\t\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(ctePreMonth.Sum,0) + ISNULL(cteCurMonth.Sum,0) AS DECIMAL(20,3))) AS curEndSum\t--本期末完成金额\r\t\t\t\tFROM cteBudTask\r\t\t\t\tLEFT JOIN cteTask2 ON cteTask2.TaskId = cteBudTask.TaskId\r\t\t\t\tLEFT JOIN ctePreMonth ON ctePreMonth.TaskId = cteBudTask.TaskId\r\t\t\t\tLEFT JOIN cteCurMonth ON cteCurMonth.TaskId = cteBudTask.TaskId\r\t\t\t\tWHERE LEN(cteBudTask.OrderNumber)<13\r\t\t\t\tORDER BY OrderNumber";
            }
            else
            {
                cmdText = "\r\n\t\t\t\tDECLARE @PrjId nvarchar(200),@Version int--,@queryDate AS datetime,@TaskId nvarchar(50)\r\n\t\t\t\t--SET @TaskId='1f7c285f-252c-4fcb-be3d-5e353a1f3c9d'\r\n\t\t\t\t--SET @queryDate = '2013-10-22';\r\n\t\t\t\tSELECT @PrjId = PrjId FROM Bud_Task WHERE TaskId = @TaskId;\r\n\t\t\t\tSELECT @Version = Version FROM Bud_Task WHERE TaskId = @TaskId;\r\n\t\t\t\tWITH cteTask AS          --分部分项\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,ISNULL(Quantity,0) Quantity,\r\n\t\t\t\t\tISNULL(Total,0) Total FROM Bud_Task \r\n\t\t\t\t\tWHERE PrjId=@PrjId AND Version=@Version AND TaskType = ''\r\n\t\t\t\t),outBudModifyInfo AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT ModifyTaskId AS TaskId,TaskId ParentId,OrderNumber,\r\n\t\t\t\t\tModifyTaskCode TaskCode,ModifyTaskContent TaskName,Unit,\r\n\t\t\t\t\tQuantity,Total FROM Bud_ModifyTask modifyTask\r\n\t\t\t\t\tJOIN Bud_Modify budModify ON modifyTask.modifyId=budModify.modifyId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND ModifyType=0\r\n\t\t\t\t\tAND FlowState=1 \r\n\t\t\t\t),cteTask2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,Quantity,Total,\r\n\t\t\t\t\tISNULL(Total/NULLIF(Quantity,0),0) UnitPrice FROM \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT newTask.TaskId,ParentId,OrderNumber,TaskCode,TaskName,Unit,\r\n\t\t\t\t\t\t(newTask.Quantity+ISNULL(inBudModifyTask.Quantity,0)) Quantity,\r\n\t\t\t\t\t\t(newTask.Total+ISNULL(inBudModifyTask.Total,0)) Total  FROM \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT * FROM cteTask\r\n\t\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\t\tSELECT * FROM outBudModifyInfo\r\n\t\t\t\t\t\t)newTask LEFT JOIN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t--清单内的变更金额\r\n\t\t\t\t\t\t\tSELECT modifyTask.TaskId,SUM(modifyTask.Quantity) Quantity,\r\n\t\t\t\t\t\t\tSUM(modifyTask.Total) Total from Bud_ModifyTask modifyTask\r\n\t\t\t\t\t\t\tJOIN \r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\tSELECT Bud_Modify.* FROM Bud_Modify WHERE PrjId=@PrjId\r\n\t\t\t\t\t\t\t) budModify ON modifyTask.ModifyId=budModify.ModifyId \r\n\t\t\t\t\t\t\twhere budModify.FlowState=1 AND modifyType=1  group by modifyTask.TaskId\r\n\t\t\t\t\t\t) inBudModifyTask ON newTask.TaskId=inBudModifyTask.TaskId\r\n\t\t\t\t\t) tab\r\n\t\t\t\t), cteBudTask AS\t\r\t\t\t\t(\r\t\t\t\t\t--根据任务节点查询所有子任务(不包含本身)\r\t\t\t\t\tSELECT TaskId, OrderNumber\r\t\t\t\t\tFROM cteTask2\r\t\t\t\t\tWHERE ParentId = @taskId\r\t\t\t\t\tUNION ALL\r\t\t\t\t\tSELECT BT2.TaskId, BT2.OrderNumber\r\t\t\t\t\tFROM cteTask2 AS BT2\r\t\t\t\t\tINNER JOIN cteBudTask ON BT2.ParentId = cteBudTask.TaskId\r\t\t\t\t), cteCurMonth AS\t\r\t\t\t\t(    \r\t\t\t\t\tSELECT TaskId,SUM(AccountingQuantity) AccountingQuantity FROM Bud_ConsReport ConsReport\r\n\t\t\t\t\tINNER JOIN Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND InputDate >= CONVERT(nvarchar(6), @queryDate, 112) + '01'\r\t\t\t\t\tAND InputDate  < CAST(CAST((CONVERT(nvarchar(6), @queryDate, 112)) AS int) \r\t\t\t\t\t+ 1 AS nvarchar(6)) + '01' AND FlowState=1 GROUP BY TaskId\r\t\t\t\t), ctePreMonth AS\t\t\r\t\t\t\t(\r\t\t\t\t\t--上期末施工报量汇总\r\n\t\t\t\t\tSELECT TaskId,SUM(AccountingQuantity) AccountingQuantity FROM Bud_ConsReport ConsReport\r\n\t\t\t\t\tINNER JOIN Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND  InputDate < CONVERT(nvarchar(6), @queryDate, 112) + '01'\r\n\t\t\t\t\tAND FlowState=1 GROUP BY TaskId\r\t\t\t\t)\r\t\t\t\tSELECT '' AS Num,cteBudTask.*,cteTask2.TaskCode,cteTask2.TaskName,cteTask2.Unit,\r\t\t\t\tCONVERT(NVARCHAR(50), Cast(cteTask2.Quantity AS DECIMAL(20,3))) AS Quantity,\t\t\t\t\t--工程量\r\t\t\t\tCONVERT(NVARCHAR(50),UnitPrice) AS UnitPrice,\t--综合单价\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(cteTask2.Total AS DECIMAL(20,3))) AS Sum,\t\t\t\t\t\t\t\t\t--合价\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(ctePreMonth.AccountingQuantity AS DECIMAL(20,3))) AS preQuantity,\t--上期末数量\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(ctePreMonth.AccountingQuantity,0)*UnitPrice AS DECIMAL(20,3))) AS preSum,\t\t\t\t\t\t--上期末金额\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(cteCurMonth.AccountingQuantity AS DECIMAL(20,3))) AS curQuantity,\t--本期完成数量\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(cteCurMonth.AccountingQuantity ,0)*UnitPrice AS DECIMAL(20,3))) AS curSum,\t\t\t\t\t\t--本期完成金额\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(ctePreMonth.AccountingQuantity,0) + ISNULL(cteCurMonth.AccountingQuantity,0) AS DECIMAL(20,3))) \r\t\t\t\t\tAS curEndQuantity,\t\t\t\t\t\t\t--本期末完成数量\r\t\t\t\tCONVERT(NVARCHAR(50),Cast(ISNULL(ctePreMonth.AccountingQuantity,0)*UnitPrice + \r\t\t\t\tISNULL(cteCurMonth.AccountingQuantity ,0)*UnitPrice AS DECIMAL(20,3))) AS curEndSum\t--本期末完成金额\r\t\t\t\tFROM cteBudTask\r\t\t\t\tLEFT JOIN cteTask2 ON cteTask2.TaskId = cteBudTask.TaskId\r\t\t\t\tLEFT JOIN ctePreMonth ON ctePreMonth.TaskId = cteBudTask.TaskId\r\t\t\t\tLEFT JOIN cteCurMonth ON cteCurMonth.TaskId = cteBudTask.TaskId\r\t\t\t\tWHERE LEN(cteBudTask.OrderNumber)<13\r\t\t\t\tORDER BY OrderNumber\r\n\t\t\t";
            }
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@taskId", taskId), new SqlParameter("@queryDate", date) };
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, commandParameters);
        }

        public static DataTable GetConsRes(string taskCode, string taskName, string resourceCode, string resourceName, string prjId, string userName, int pageIndex, int pageSize)
        {
            if (pageSize == 0)
            {
                pageSize = GetConsResCount(taskCode, taskName, resourceCode, resourceName, prjId, userName);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat(" AND TaskCode LIKE '%{0}%' ", taskCode);
            builder.AppendFormat(" AND TaskName LIKE '%{0}%' ", taskName);
            builder.AppendFormat(" AND ResourceCode LIKE '%{0}%' ", resourceCode);
            builder.AppendFormat(" AND ResourceName LIKE '%{0}%' ", resourceName);
            StringBuilder builder2 = new StringBuilder();
            builder2.AppendLine("WITH ResInfo AS ");
            builder2.AppendLine("( ");
            builder2.AppendLine("SELECT ResourceId,ResourceCode,ResourceName,Specification,Unit,ISNULL([Name],'') UnitName FROM Res_Resource  ");
            builder2.AppendLine("LEFT JOIN Res_Unit ON Res_Resource.Unit=Res_Unit.UnitId ");
            builder2.AppendLine(") ");
            builder2.AppendFormat("SELECT TOP {0} Convert(Nvarchar(30),Num) Num,TaskId,TaskCode,TaskName,ResourceId,ResourceCode, ", pageSize).AppendLine();
            builder2.AppendLine("ResourceName,UnitName,Specification,UnitPrice,AccountingQuantity, ");
            builder2.AppendLine("cast((UnitPrice*AccountingQuantity) AS DECIMAL(20,3)) Total FROM   ");
            builder2.AppendLine("( ");
            builder2.AppendLine("SELECT  Row_Number()over(order by TaskCode,ResourceCode) as Num, TaskId,TaskCode,TaskName,ResourceId,ResourceCode, ");
            builder2.AppendLine("ResourceName,UnitName,Specification,UnitPrice,SUM(AccountingQuantity) AccountingQuantity FROM  ");
            builder2.AppendLine("(SELECT ConsReport.ConsReportId,ConsTask.TaskId,TaskCode,TaskName,ConsTaskRes.ResourceId,ConsTaskRes.UnitPrice, ");
            builder2.AppendLine("ISNULL(ConsTaskRes.AccountingQuantity,0) AccountingQuantity,ResourceCode,ResourceName,UnitName,Specification  ");
            builder2.AppendLine("FROM Bud_ConsReport ConsReport  ");
            builder2.AppendLine("INNER JOIN dbo.Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId  ");
            builder2.AppendLine("INNER JOIN Bud_Task BudTask ON ConsTask.TaskId=BudTask.TaskId ");
            builder2.AppendLine("INNER JOIN Bud_ConsTaskRes ConsTaskRes ON ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId ");
            builder2.AppendLine("INNER JOIN ResInfo ON ConsTaskRes.ResourceId=ResInfo.ResourceId ");
            builder2.AppendFormat("WHERE ConsReport.PrjId='{0}' ", prjId).AppendLine();
            builder2.AppendFormat("AND ConsReport.IsValid=1 AND FlowState=1 AND ConsReport.InputUser='{0}') Cons WHERE 1=1 ", userName).AppendLine();
            builder2.AppendFormat(" {0} ", builder).AppendLine();
            builder2.AppendLine("GROUP BY TaskId,TaskCode,TaskName,ResourceId,ResourceCode,ResourceName,UnitName,Specification,UnitPrice ");
            builder2.AppendFormat(") tabCons  WHERE Num>{0}*({1}-1) ", pageSize, pageIndex);
            return SqlHelper.ExecuteQuery(CommandType.Text, builder2.ToString(), null);
        }

        public static int GetConsResCount(string taskCode, string taskName, string resourceCode, string resourceName, string prjId, string userName)
        {
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat(" AND TaskCode LIKE '%{0}%' ", taskCode);
            builder.AppendFormat(" AND TaskName LIKE '%{0}%' ", taskName);
            builder.AppendFormat(" AND ResourceCode LIKE '%{0}%' ", resourceCode);
            builder.AppendFormat(" AND ResourceName LIKE '%{0}%' ", resourceName);
            StringBuilder builder2 = new StringBuilder();
            builder2.AppendLine("WITH ResInfo AS ");
            builder2.AppendLine("(  ");
            builder2.AppendLine("SELECT ResourceId,ResourceCode,ResourceName,Specification,Unit,ISNULL([Name],'') UnitName FROM Res_Resource  ");
            builder2.AppendLine("LEFT JOIN Res_Unit ON Res_Resource.Unit=Res_Unit.UnitId  ");
            builder2.AppendLine(") ");
            builder2.AppendLine("SELECT COUNT(*) FROM  ");
            builder2.AppendLine("(  ");
            builder2.AppendLine("SELECT  Row_Number()over(order by TaskCode,ResourceCode) as Num, TaskId,TaskCode,TaskName,ResourceId,ResourceCode,ResourceName,UnitName,Specification,UnitPrice, ");
            builder2.AppendLine("SUM(AccountingQuantity) AccountingQuantity FROM ");
            builder2.AppendLine("(SELECT ConsReport.ConsReportId,ConsTask.TaskId,TaskCode,TaskName,ConsTaskRes.ResourceId,ConsTaskRes.UnitPrice, ");
            builder2.AppendLine("ISNULL(ConsTaskRes.AccountingQuantity,0) AccountingQuantity,ResourceCode,ResourceName,UnitName,Specification  ");
            builder2.AppendLine("FROM Bud_ConsReport ConsReport ");
            builder2.AppendLine("INNER JOIN dbo.Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId   ");
            builder2.AppendLine("INNER JOIN Bud_Task BudTask ON ConsTask.TaskId=BudTask.TaskId  ");
            builder2.AppendLine("INNER JOIN Bud_ConsTaskRes ConsTaskRes ON ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId  ");
            builder2.AppendLine("INNER JOIN ResInfo ON ConsTaskRes.ResourceId=ResInfo.ResourceId  ");
            builder2.AppendFormat("WHERE ConsReport.PrjId='{0}'  ", prjId).AppendLine();
            builder2.AppendFormat("AND ConsReport.IsValid=1 AND FlowState=1 AND ConsReport.InputUser='{0}') Cons WHERE 1=1  ", userName).AppendLine();
            builder2.AppendFormat(" {0} ", builder).AppendLine();
            builder2.AppendLine(" GROUP BY TaskId,TaskCode,TaskName,ResourceId,ResourceCode,ResourceName,UnitName,Specification,UnitPrice  ");
            builder2.AppendLine(") tabCons  ");
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder2.ToString(), null));
        }

        public static DataTable GetCostSummary(string prjId, int version)
        {
            DataTable table = null;
            DataTable table2 = null;
            StringBuilder builder = new StringBuilder();
            builder.Append("select [Name],ISNULL(BudAmount,0.000) BudAmount,Cost,ISNULL(BudAmount-Cost,0.000) Disparity from");
            builder.Append("(select costList.CBSCode,[Name],ResourceType,ISNULL(Cost,0) Cost from Bud_CostAccounting costList left join  --获得审核后的成本费用  ").AppendLine();
            builder.Append("(select sum(UnitPrice*AccountingQuantity) Cost,CBSCode from bud_ConsTaskRes where ConsTaskId in(select ConsTaskId ");
            builder.Append("from Bud_ConsTask where ConsReportId in (select ConsReportId from Bud_ConsReport where PrjId= ");
            builder.AppendFormat("'{0}' and IsValid=1 and State='2')) and (CBSCode is not null and CBSCode!='') ", prjId);
            builder.Append(" group by CBSCode) cost on costList.CBSCode=cost.CBSCode");
            builder.Append(" where [Type]='D' ) Cost left join ");
            builder.Append(" (select dbo.GetResourceType(ResourceId) ResType, sum(BudAmount) BudAmount from       --获得预算费用").AppendLine();
            builder.Append("(select ResourceId, sum(ResourceQuantity*ResourcePrice) BudAmount from bud_TaskResource where TaskId in ");
            builder.AppendFormat("(select TaskId from bud_Task where PrjId='{0}' and version={1}) group by ResourceId) ", prjId, version);
            builder.Append("BudRes group by dbo.GetResourceType(ResourceId)) Bud on Cost.ResourceType=Bud.ResType order by Cost.CBSCode");
            table = SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), null);
            StringBuilder builder2 = new StringBuilder();
            builder2.Append(" select [Name],ISNULL(BudgetAmount,0) BudAmount,ISNULL(AccountAmount,0) Cost,");
            builder2.Append("ISNULL(BudgetAmount-AccountAmount,0.000) Disparity from Bud_CostAccounting costList left join ");
            builder2.AppendFormat("(select CBSCode,BudgetAmount,AccountAmount from Bud_IndirectBudget where ProjectId='{0}'", prjId);
            builder2.Append(" and State='2') IndirectCost");
            builder2.Append(" on costList.CBSCode=IndirectCost.CBSCode");
            builder2.Append(" where [Type]='I'  order by costList.CBSCode");
            table2 = SqlHelper.ExecuteQuery(CommandType.Text, builder2.ToString(), null);
            table.Merge(table2, true);
            return table;
        }

        public static DataTable GetEvenAnalysis(string prjCode, string prjName, int pageSize, int pageIndex, string userCode, string isWBSRelevance)
        {
            if (pageSize == 0)
            {
                pageSize = GetEvenAnalysisCount(prjCode, prjName, userCode);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            string str = ConfigHelper.Get("IsIncomeContractApprove");
            StringBuilder builder = new StringBuilder();
            if (isWBSRelevance == "1")
            {
                builder.AppendFormat("\r\n                WITH PrjInfo AS\r\n                (\r\n                    --项目信息\r\n\t                SELECT PRJ.PrjGuid,PrjCode,PrjName,StartDate FROM PT_PrjInfo AS PRJ  \r\n\t                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n\t                WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{0}',Podepom)>0)  \r\n\t                AND PrjCode LIKE '%{1}%' AND PrjName LIKE '%{2}%' AND SetUpFlowState=1 AND PrjState<>17 \r\n\t                GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n                )\r\n                select top({3}) Convert(Nvarchar(30),Num) as Num,prjGuid,prjCode,prjName,ContractBud,DirectCost,\r\n                IndirectCost,GainLoss,RatioGainLoss from \r\n                (\r\n\t                select Row_Number()over(order by StartDate desc) as Num,prjGuid,prjCode,prjName,\r\n\t                ISNULL(ContractBud,0) ContractBud,ISNULL(DirectCost,0) DirectCost,ISNULL(IndirectCost,0) IndirectCost,\r\n\t                ISNULL(ContractBud,0)-(ISNULL(DirectCost,0)+ISNULL(IndirectCost,0)) GainLoss, \r\n\t                Convert(Nvarchar(30), cast(ISNULL((ISNULL(ContractBud,0)-(ISNULL(DirectCost,0)+ISNULL(IndirectCost,0)))/NULLIF(ISNULL(ContractBud,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss  \r\n\t                from PrjInfo pt \r\n\t                left join\r\n\t                (\r\n\t\t                --收入合同金额\r\n\t\t                select sum((ISNULL(ChangePrice,0)+ISNULL(ContractPrice,0))) ContractBud,Project from \r\n\t\t                (\r\n\t\t\t                select ContractId,ContractPrice,Project from Con_Incomet_Contract where Project in \r\n\t\t\t                (\r\n\t\t\t\t                SELECT prjGuid FROM PrjInfo ", new object[] { userCode, prjCode, prjName, pageSize });
                if (str == "0")
                {
                    builder.Append(" ) and conState!=4 ");
                }
                else
                {
                    builder.Append(" ) and conState!=4 AND Flowstate=1 ");
                }
                builder.AppendFormat("  ) ic \r\n\t\t                left join \r\n\t\t                (\r\n\t\t\t                --收入合同变更金额\r\n\t\t\t                select ContractId,ISNULL(sum(ChangePrice),0) ChangePrice from Con_Incomet_Modify where ContractId in \r\n\t\t\t                (\r\n\t\t\t\t                select ContractId from Con_Incomet_Contract where Project in \r\n\t\t\t\t                (\r\n\t\t\t\t\t                SELECT prjGuid FROM PrjInfo \r\n\t\t\t\t                )\r\n\t\t\t                ) group by ContractId\r\n\t\t                ) im on ic.ContractId=im.ContractId group by Project\r\n\t                ) bud on prjGuid=bud.Project \r\n\t                left join \r\n\t                (\r\n\t\t                --施工报量金额\r\n\t\t                select prjId,sum(ISNULL(UnitPrice,0)*ISNULL(AccountingQuantity,0)) DirectCost from Bud_ConsTaskRes ctr \r\n\t\t                right join\r\n\t\t                (\r\n\t\t\t                select cr.ConsReportId,ConsTaskId,prjId from Bud_ConsReport cr \r\n\t\t\t                left join Bud_ConsTask ct on cr.ConsReportId=ct.ConsReportId\r\n\t\t\t                where prjId in \r\n\t\t\t                (\r\n\t\t\t\t                SELECT prjGuid FROM PrjInfo \r\n\t\t\t                ) and IsValid=1 and FlowState=1\r\n\t\t                ) Ct1 on ctr.ConsTaskId=ct1.ConsTaskId group by prjId\r\n\t                ) Direct on prjGuid=Direct.prjId \r\n\t                left join \r\n\t                (\r\n\t\t                --间接成本实际金额\r\n\t\t                select ProjectId,sum(Amount) IndirectCost from\r\n\t\t                (\r\n\t\t\t                select IndirCost.InDiaryId,ProjectId,Amount from Bud_IndirectDiaryCost IndirCost  \r\n\t\t\t                left join Bud_IndirectDiaryDetails IndirDetails on IndirCost.InDiaryId=IndirDetails.InDiaryId  \r\n\t\t\t                where CostType = 'P' AND ProjectId in \r\n\t\t\t                (\r\n\t\t\t\t                SELECT prjGuid FROM PrjInfo \r\n\t\t\t                ) and FlowState=1 \r\n\t\t                ) IndirectCost  group by ProjectId\r\n\t                ) Indirect on  prjGuid=Indirect.ProjectId\r\n                ) tab1 where Num > {0} * ({1}-1)", pageSize, pageIndex);
            }
            else
            {
                builder.AppendFormat("\r\n                WITH PrjInfo AS\r\n                (\r\n                    --项目信息\r\n\t                SELECT PRJ.PrjGuid,PrjCode,PrjName,StartDate FROM PT_PrjInfo AS PRJ  \r\n\t                LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n\t                WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{0}',Podepom)>0)  \r\n\t                AND PrjCode LIKE '%{1}%' AND PrjName LIKE '%{2}%' AND SetUpFlowState=1 AND PrjState<>17 \r\n\t                GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n                ),BudTask AS\r\n                (\r\n\t                --预算\r\n\t                SELECT PrjId,TaskId,ISNULL(Total/NULLIF(Quantity,0),0) UnitPrice FROM \r\n\t                (\r\n\t\t                SELECT budInfo.PrjId,budInfo.TaskId,(budInfo.Total+ISNULL(modifyInfo.Total,0)) Total,\r\n\t\t                (budInfo.Quantity+ISNULL(modifyInfo.Quantity,0)) Quantity FROM \r\n\t\t                (\r\n\t\t\t                --完整的预算\r\n\t\t\t                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,ISNULL(Quantity,0) Quantity\r\n\t\t\t                FROM Bud_Task AS BudTask \r\n\t\t\t                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t                AND BudTask.Version=vGetCurBudVersion.CurVersion \r\n\t\t\t                UNION\r\n\t\t\t                SELECT PrjId,ModifyTaskId TaskId,Total,Quantity FROM Bud_Modify modify\r\n\t\t\t                JOIN Bud_ModifyTask modifyTask ON modify.modifyId=modifyTask.modifyId\r\n\t\t\t                WHERE flowState=1 AND ModifyType=0 \r\n\t\t                ) budInfo\r\n\t\t                LEFT JOIN \r\n\t\t                (\r\n\t\t\t                --清单内的预算变更\r\n\t\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t\t                WHERE FlowState=1 AND ModifyType=1\r\n\t\t\t                GROUP BY TaskId,PrjId\r\n\t\t                ) modifyInfo ON budInfo.TaskId=modifyInfo.TaskId\r\n\t                ) bud\r\n                )\r\n                select top({3}) Convert(Nvarchar(30),Num) as Num,prjGuid,prjCode,prjName,ContractBud,DirectCost,\r\n                IndirectCost,GainLoss,RatioGainLoss,StartDate from \r\n                (\r\n\t                select Row_Number()over(order by StartDate desc) as Num,prjGuid,prjCode,prjName,ISNULL(ContractBud,0) ContractBud,\r\n\t                Convert(decimal(18,3),ISNULL(DirectCost,0)) DirectCost,ISNULL(IndirectCost,0) IndirectCost,\r\n\t                ISNULL(ContractBud,0)-(ISNULL(DirectCost,0)+ISNULL(IndirectCost,0)) GainLoss,\r\n\t                Convert(Nvarchar(30), cast(ISNULL((ISNULL(ContractBud,0)-(ISNULL(DirectCost,0)+ISNULL(IndirectCost,0)))/NULLIF(ISNULL(ContractBud,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss,StartDate  \r\n\t                from  PrjInfo pt left join\r\n\t                (\r\n\t\t                --收入合同金额\r\n\t\t                select sum((ISNULL(ChangePrice,0)+ISNULL(ContractPrice,0))) ContractBud,Project from \r\n\t\t                (\r\n\t\t\t                select ContractId,ContractPrice,Project from Con_Incomet_Contract where Project in \r\n\t\t\t                (\r\n\t\t\t\t                SELECT prjGuid FROM PrjInfo  ", new object[] { userCode, prjCode, prjName, pageSize });
                if (str == "0")
                {
                    builder.Append(" ) and conState!=4 ");
                }
                else
                {
                    builder.Append(" ) and conState!=4 AND Flowstate=1 ");
                }
                builder.AppendFormat(" ) ic left join  \r\n\t\t                (\r\n\t\t\t                --收入合同变更金额\r\n\t\t\t                select ContractId,ISNULL(sum(ChangePrice),0) ChangePrice from Con_Incomet_Modify where ContractId in \r\n\t\t\t                (\r\n\t\t\t\t                select ContractId from Con_Incomet_Contract where Project in \r\n\t\t\t\t                (\r\n\t\t\t\t\t                SELECT prjGuid FROM PrjInfo \r\n\t\t\t\t                )\r\n\t\t\t                ) group by ContractId\r\n\t\t                ) im on ic.ContractId=im.ContractId group by Project\r\n\t                ) bud on prjGuid=bud.Project left join \r\n\t                (\r\n\t\t                --施工报量金额\r\n\t\t                select consReport.PrjId,SUM(ISNULL(AccountingQuantity,0)*ISNULL(UnitPrice,0)) DirectCost \r\n\t\t                from Bud_ConsReport consReport LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId \r\n\t\t                INNER JOIN budTask ON consTask.TaskId=budTask.TaskId where consReport.prjId in \r\n\t\t                ( \r\n\t\t\t                SELECT prjGuid FROM PrjInfo \r\n\t\t                )AND consReport.IsValid=1 AND FlowState=1 GROUP BY consReport.prjId\r\n\t                ) Direct on prjGuid=Direct.prjId \r\n\t                left join \r\n\t                (\r\n\t\t                --间接成本实际金额\r\n\t\t                select ProjectId,sum(Amount) IndirectCost from \r\n\t\t                (\r\n\t\t\t                select IndirCost.InDiaryId,ProjectId,Amount from Bud_IndirectDiaryCost IndirCost  \r\n\t\t\t                left join Bud_IndirectDiaryDetails IndirDetails on IndirCost.InDiaryId=IndirDetails.InDiaryId  \r\n\t\t\t                where CostType = 'P' AND  ProjectId in \r\n\t\t\t                (\r\n\t\t\t\t                SELECT prjGuid FROM PrjInfo \r\n\t\t\t                ) and FlowState=1 \r\n\t\t                ) IndirectCost group by ProjectId\r\n\t                ) Indirect on  prjGuid=Indirect.ProjectId\r\n                ) tab1 where Num > {0} * ({1}-1)", pageSize, pageIndex);
            }
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), null);
        }

        public static int GetEvenAnalysisCount(string prjCode, string prjName, string userCode)
        {
            string str = ConfigHelper.Get("IsIncomeContractApprove");
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat("\r\n            WITH PrjInfo AS\r\n            (\r\n                --项目信息\r\n\t            SELECT PRJ.PrjGuid,PrjCode,PrjName,StartDate FROM PT_PrjInfo AS PRJ  \r\n\t            LEFT JOIN Pt_PrjInfo_ZTB_Detail detail ON  PRJ.PrjGuid=detail.PrjGuid \r\n\t            WHERE IsValid=1 AND (CHARINDEX('{0}',PrjManager)>0  OR CHARINDEX('{0}',Podepom)>0)  \r\n\t            AND PrjCode LIKE '%{1}%' AND PrjName LIKE '%{2}%' AND SetUpFlowState=1 AND PrjState<>17 \r\n\t            GROUP BY PRJ.PrjGuid,PrjCode,PrjName,PRJ.StartDate,PRJ.EndDate\r\n            )\r\n            ", userCode, prjCode, prjName);
            builder.Append("\r\n            select count(*) from (\r\n\t            select Row_Number()over(order by StartDate desc) as Num,prjGuid,prjCode,prjName,\r\n\t            ISNULL(ContractBud,0) ContractBud,ISNULL(DirectCost,0) DirectCost,ISNULL(IndirectCost,0) IndirectCost,\r\n\t            ISNULL(ContractBud,0)-(ISNULL(DirectCost,0)+ISNULL(IndirectCost,0)) GainLoss, \r\n\t            Convert(Nvarchar(30), cast(ISNULL((ISNULL(ContractBud,0)-(ISNULL(DirectCost,0)+ISNULL(IndirectCost,0)))/NULLIF(ISNULL(ContractBud,0),0),0)*100 as decimal(20,2)))+'%' RatioGainLoss  \r\n\t            from PrjInfo pt \r\n\t            left join\r\n\t            (\r\n\t\t            --收入合同金额\r\n\t\t            select sum((ISNULL(ChangePrice,0)+ISNULL(ContractPrice,0))) ContractBud,Project from \r\n\t\t            (\r\n\t\t\t            select ContractId,ContractPrice,Project from Con_Incomet_Contract where Project in \r\n\t\t\t            (\r\n\t\t\t\t            SELECT prjGuid FROM PrjInfo \r\n               ");
            if (str == "0")
            {
                builder.Append(" ) and conState!=4 ");
            }
            else
            {
                builder.Append(" ) and conState!=4 AND Flowstate=1 ");
            }
            builder.Append("      ) ic \r\n\t\t            left join \r\n\t\t            (\r\n\t\t\t            --收入合同变更金额\r\n\t\t\t            select ContractId,ISNULL(sum(ChangePrice),0) ChangePrice from Con_Incomet_Modify where ContractId in \r\n\t\t\t            (\r\n\t\t\t\t            select ContractId from Con_Incomet_Contract where Project in \r\n\t\t\t\t            (\r\n\t\t\t\t\t            SELECT prjGuid FROM PrjInfo \r\n\t\t\t\t            )\r\n\t\t\t            ) group by ContractId\r\n\t\t            ) im on ic.ContractId=im.ContractId group by Project\r\n\t            ) bud on prjGuid=bud.Project \r\n\t            left join \r\n\t            (\r\n\t\t            --施工报量金额\r\n\t\t            select prjId,sum(ISNULL(UnitPrice,0)*ISNULL(AccountingQuantity,0)) DirectCost from Bud_ConsTaskRes ctr \r\n\t\t            right join\r\n\t\t            (\r\n\t\t\t            select cr.ConsReportId,ConsTaskId,prjId from Bud_ConsReport cr \r\n\t\t\t            left join Bud_ConsTask ct on cr.ConsReportId=ct.ConsReportId\r\n\t\t\t            where prjId in \r\n\t\t\t            (\r\n\t\t\t\t            SELECT prjGuid FROM PrjInfo \r\n\t\t\t            ) and IsValid=1 and FlowState=1\r\n\t\t            ) Ct1 on ctr.ConsTaskId=ct1.ConsTaskId group by prjId\r\n\t            ) Direct on prjGuid=Direct.prjId \r\n\t            left join \r\n\t            (\r\n\t\t            --间接成本实际金额\r\n\t\t            select ProjectId,sum(Amount) IndirectCost from\r\n\t\t            (\r\n\t\t\t            select IndirCost.InDiaryId,ProjectId,Amount from Bud_IndirectDiaryCost IndirCost  \r\n\t\t\t            left join Bud_IndirectDiaryDetails IndirDetails on IndirCost.InDiaryId=IndirDetails.InDiaryId  \r\n\t\t\t            where CostType = 'P' AND ProjectId in \r\n\t\t\t            (\r\n\t\t\t\t            SELECT prjGuid FROM PrjInfo \r\n\t\t\t            ) and FlowState=1 \r\n\t\t            ) IndirectCost  group by ProjectId\r\n\t            ) Indirect on  prjGuid=Indirect.ProjectId\r\n            ) tab1\r\n            ");
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), null));
        }

        public static DataTable GetEvenAnalysisDetail(string taskCode, string taskName, string prjId, int pageSize, int pageIndex, string isWBSRelevance)
        {
            if (pageSize == 0)
            {
                pageSize = GetEvenAnalysisDetailCount(taskCode, taskName, prjId);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            if (isWBSRelevance == "1")
            {
                builder.Append("\r\n                --DECLARE @PrjId nvarchar(50),@PrjCode nvarchar(50),@PrjName nvarchar(50),@PageSize int,@pageIndex int\r\n                --set @PrjId='a25fdb14-8841-4193-9017-80d1da6c6e10';\r\n                --set @PrjCode='';\r\n                --set @PrjName='';\r\n                --set @PageSize=1000;\r\n                --set @pageIndex=1;\r\n                WITH task AS\r\n                (\r\n                    --总预算\r\n                    SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,budTaskInfo.PrjId,\r\n                    (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n                    (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) TargetTotal FROM \r\n                    (\r\n                        --原预算\r\n                        SELECT task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity,\r\n                        ISNULL(SUM(ResourceQuantity*ResourcePrice),0) Total FROM\r\n                        (\r\n                            SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n                            Bud_Task budTask\r\n                            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                            AND budTask.PrjId=@PrjId AND TaskType=''\r\n                        ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n                        GROUP BY task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity\r\n                        UNION\r\n                        --清单外的预算变更\r\n                        SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n                        PrjId,Quantity,Total FROM Bud_Modify modify\r\n                        JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n                    ) budTaskInfo\r\n                    LEFT JOIN\r\n                    (\r\n                        --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t\t                GROUP BY TaskId,PrjId\r\n                    ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n\t                where TaskCode like '%'+@TaskCode+'%' and TaskName like  '%'+@TaskName+'%'\r\n                ),contrTask AS\r\n                (\r\n                    --中标预算\r\n                    SELECT (ConBudTask.ContTotal+ISNULL(ModifyTask.ContTotal,0)) Total,TenderPrice,OrderNumber FROM \r\n                    (\r\n                        --原中标预算\r\n                        SELECT TaskId,Total AS ContTotal,UnitPrice AS TenderPrice,OrderNumber FROM Bud_ContractTask \r\n                        INNER JOIN Bud_ContractTaskAudit ON Bud_ContractTask.PrjId=Bud_ContractTaskAudit.PrjId \r\n                        WHERE Bud_ContractTask.PrjId=@PrjId AND FlowState=1 AND TaskType=''\r\n                        UNION\r\n                        --清单外的中标预算变更\r\n                        SELECT TaskId,Total ContTotal,UnitPrice TenderPrice, OrderNumber FROM Bud_ConModify modify\r\n                        JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n                    ) ConBudTask\r\n                    LEFT JOIN \r\n                    (\r\n                        --清单内的中标预算变更\r\n                        SELECT Total ContTotal,TaskId FROM Bud_ConModify modify\r\n                        JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n                    ) ModifyTask ON ConBudTask.TaskId=ModifyTask.TaskId\r\n                ),ctr AS\r\n                (\r\n\t                select SUM(ISNULL(UnitPrice,0)*ISNULL(AccountingQuantity,0)) ConsTaskRes,TaskId from Bud_ConsTaskRes consTasRes \r\n\t                right join \r\n\t                (\r\n\t\t                --直接成本\r\n\t\t                select ConsTaskId,consTask.TaskId from Bud_ConsTask consTask \r\n\t\t                left join Bud_ConsReport consRep on consTask.ConsReportId=consRep.ConsReportId \r\n\t\t                where taskId in \r\n\t\t                (\r\n\t\t\t                select TaskId from Task \r\n\t\t                ) \r\n\t\t                and FlowState=1\r\n\t                ) ct on consTasRes.ConsTaskId=ct.ConsTaskId group by TaskId\r\n                )\r\n                select top(@PageSize) Convert(Nvarchar(30),Num) as Num,TaskCode,TaskName,ContractCost,ConstructCost,GainLoss,RatioGainLoss from \r\n                ( \r\n\t                select Row_Number()over(order by OrderNumber) as Num,TaskCode,TaskName,OrderNumber,ContractCost,\r\n\t                Convert(decimal(18,3),ConstructCost) ConstructCost,Convert(decimal(18,3),(ContractCost-ConstructCost)) GainLoss,\r\n\t                Convert(Nvarchar(30), cast(ISNULL((ContractCost-ConstructCost)/NULLIF(ContractCost,0),0)*100 as decimal(20,2)))+'%' RatioGainLoss  \r\n\t                from \r\n\t                (\r\n\t\t                select task.TaskId,task.TaskCode,task.TaskName,task.OrderNumber,ISNULL(contrTask.Total,0) ContractCost,\r\n\t\t                ISNULL(ConsTaskRes,0) ConstructCost from task\t\t\t--目标成本\r\n\t\t                left join contrTask on task.orderNumber=contrTask.orderNumber\t--中标预算\r\n\t\t                left join ctr on task.taskId=ctr.TaskId\t\t\t\t\t--直接成本\r\n\t                ) GainLoss \r\n                ) tab1 where Num > @PageSize * (@PageIndex-1) order by orderNumber ");
            }
            else
            {
                builder.Append("\r\n                --DECLARE @PrjId nvarchar(50),@PrjCode nvarchar(50),@PrjName nvarchar(50),@PageSize int,@pageIndex int\r\n                --set @PrjId='a25fdb14-8841-4193-9017-80d1da6c6e10';\r\n                --set @PrjCode='';\r\n                --set @PrjName='';\r\n                --set @PageSize=1000;\r\n                --set @pageIndex=1;\r\n                WITH task AS\r\n                (\r\n                    --总预算\r\n                    SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,budTaskInfo.PrjId,\r\n                    (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n                    (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) TargetTotal,TaskType FROM \r\n                    (\r\n                        --原预算\r\n                        SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity,ISNULL(Total,0) Total,TaskType FROM \r\n                        Bud_Task budTask\r\n                        JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        AND budTask.PrjId=@PrjId\r\n                        UNION\r\n                        --清单外的预算变更\r\n                        SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n                        PrjId,Quantity,Total,'' TaskType FROM Bud_Modify modify\r\n                        JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n                    ) budTaskInfo\r\n                    LEFT JOIN\r\n                    (\r\n                        --清单内的预算变更\r\n\t\t                SELECT TaskId,PrjId,SUM(Quantity) Quantity,SUM(Total) Total FROM Bud_Modify modify\r\n\t\t                JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t                WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n\t\t                GROUP BY TaskId,PrjId\r\n                    ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n\t                where TaskCode like '%'+@TaskCode+'%' and TaskName like  '%'+@TaskName+'%'\r\n                ),contrTask AS\r\n                (\r\n                    --中标预算\r\n                    SELECT (ConBudTask.ContTotal+ISNULL(ModifyTask.ContTotal,0)) Total,TenderPrice,OrderNumber FROM \r\n                    (\r\n                        --原中标预算\r\n                        SELECT TaskId,Total AS ContTotal,UnitPrice AS TenderPrice,OrderNumber FROM Bud_ContractTask \r\n                        INNER JOIN Bud_ContractTaskAudit ON Bud_ContractTask.PrjId=Bud_ContractTaskAudit.PrjId \r\n                        WHERE Bud_ContractTask.PrjId=@PrjId AND FlowState=1 AND TaskType=''\r\n                        UNION\r\n                        --清单外的中标预算变更\r\n                        SELECT TaskId,Total ContTotal,UnitPrice TenderPrice, OrderNumber FROM Bud_ConModify modify\r\n                        JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n                    ) ConBudTask\r\n                    LEFT JOIN \r\n                    (\r\n                        --清单内的中标预算变更\r\n                        SELECT Total ContTotal,TaskId FROM Bud_ConModify modify\r\n                        JOIN Bud_ConModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n                    ) ModifyTask ON ConBudTask.TaskId=ModifyTask.TaskId\r\n                ),ctr AS\r\n                (\r\n\t                --施工报量\r\n\t                SELECT TaskId,AccTotalQuantity, (AccTotalQuantity*unitPrice) RealityTotal FROM \r\n\t                (\r\n\t\t                SELECT ConsInfo.TaskId,AccTotalQuantity,ISNULL(TargetTotal/NULLIF(Quantity,0),0) unitPrice FROM \r\n\t\t                (\r\n\t\t\t                SELECT TaskId,SUM(AccountingQuantity) AccTotalQuantity FROM Bud_ConsReport consReport \r\n\t\t\t                LEFT JOIN Bud_ConsTask consTask ON consReport.ConsReportId=consTask.ConsReportId\r\n\t\t\t                WHERE PrjId=@PrjId AND FlowState=1 GROUP BY TaskId\r\n\t\t                )ConsInfo LEFT JOIN Task ON ConsInfo.TaskId=Task.TaskId\r\n\t                ) Con\r\n                )\r\n                select top(@PageSize) Convert(Nvarchar(30),Num) as Num,TaskCode,TaskName,ContractCost,ConstructCost,GainLoss,RatioGainLoss from \r\n                ( \r\n\t                select Row_Number()over(order by OrderNumber) as Num,TaskCode,TaskName,OrderNumber,ContractCost,\r\n\t                Convert(decimal(18,3),ConstructCost) ConstructCost,Convert(decimal(18,3),(ContractCost-ConstructCost)) GainLoss,\r\n\t                Convert(Nvarchar(30), cast(ISNULL((ContractCost-ConstructCost)/NULLIF(ContractCost,0),0)*100 as decimal(20,2)))+'%' RatioGainLoss \r\n\t                from \r\n\t                (\r\n\t\t                select task.TaskId,task.TaskCode,task.TaskName,task.OrderNumber,ISNULL(contrTask.Total,0) ContractCost,\r\n\t\t                ISNULL(RealityTotal,0) ConstructCost from task\t\t--目标成本\r\n\t\t                left join \r\n\t\t                contrTask on task.orderNumber=contrTask.orderNumber --投标预算\r\n\t\t                left join \r\n\t\t                ctr on task.taskId=ctr.TaskId  --直接成本\r\n\t\t                where TaskType=''                    \r\n\t                ) GainLoss \r\n                ) tab1 where Num > @PageSize * (@PageIndex-1) order by orderNumber ");
            }
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static int GetEvenAnalysisDetailCount(string taskCode, string taskName, string prjId)
        {
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat("\r\n            --DECLARE @PrjId nvarchar(50),@Version int \r\n            --set @PrjId='a25fdb14-8841-4193-9017-80d1da6c6e10';\r\n            WITH Task AS\r\n            (\r\n                --总预算\r\n                SELECT budTaskInfo.TaskId,TaskCode,TaskName,OrderNumber,budTaskInfo.PrjId,\r\n                (budTaskInfo.Quantity+ISNULL(ModifyInfo.Quantity,0)) Quantity,\r\n                (budTaskInfo.Total+ISNULL(ModifyInfo.Total,0)) TargetTotal FROM \r\n                (\r\n                    --原预算\r\n                    SELECT task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity,\r\n                    ISNULL(SUM(ResourceQuantity*ResourcePrice),0) Total FROM\r\n                    (\r\n                        SELECT budTask.TaskId,TaskCode,TaskName,OrderNumber,budTask.PrjId,Quantity FROM \r\n                        Bud_Task budTask\r\n                        JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        AND budTask.PrjId=@PrjId AND TaskType=''\r\n                    ) task LEFT JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId \r\n                    GROUP BY task.TaskId,TaskCode,TaskName,OrderNumber,PrjId,Quantity\r\n                    UNION\r\n                    --清单外的预算变更\r\n                    SELECT ModifyTaskId TaskId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber,\r\n                    PrjId,Quantity,Total FROM Bud_Modify modify\r\n                    JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                    WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n                ) budTaskInfo\r\n                LEFT JOIN\r\n                (\r\n                    --清单内的预算变更\r\n                    SELECT TaskId,PrjId,Quantity,Total FROM Bud_Modify modify\r\n                    JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                    WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=1\r\n                ) ModifyInfo ON budTaskInfo.TaskId=ModifyInfo.TaskId\r\n                where TaskCode like '%'+@TaskCode+'%' and TaskName like  '%'+@TaskName+'%'\r\n            )\r\n            select count(*) from \r\n            (  \r\n\t            select Row_Number()over(order by OrderNumber) as Num,TaskCode,TaskName,ContractCost,ConstructCost,(ContractCost-ConstructCost) GainLoss, \r\n\t            Convert(Nvarchar(30), cast(ISNULL((ContractCost-ConstructCost)/NULLIF(ContractCost,0),0)*100 as decimal(20,2)))+'%' RatioGainLoss  \r\n\t            from  \r\n\t            (\r\n\t\t            select task.TaskId,task.TaskCode,task.TaskName,task.OrderNumber,ISNULL(contrTask.Total,0) ContractCost,\r\n\t\t            ISNULL(ConsTaskRes,0) ConstructCost from task \r\n\t\t            left join --投标预算\r\n\t\t            (\r\n\t\t\t            select Total,OrderNumber from Bud_ContractTask \r\n\t\t\t            INNER JOIN Bud_ContractTaskAudit ON Bud_ContractTask.PrjId=Bud_ContractTaskAudit.PrjId  \r\n\t\t\t            WHERE Bud_ContractTask.prjId=@PrjId AND FlowState=1 AND TaskType=''\r\n\t\t            ) contrTask on task.orderNumber=contrTask.orderNumber \r\n\t\t            left join  \r\n\t\t            (\r\n\t\t\t            select SUM(ISNULL(UnitPrice,0)*ISNULL(AccountingQuantity,0)) ConsTaskRes,TaskId \r\n\t\t\t            from Bud_ConsTaskRes consTasRes \r\n\t\t\t            right join --直接成本\r\n\t\t\t            (\r\n\t\t\t\t            select ConsTaskId,consTask.TaskId from Bud_ConsTask consTask \r\n\t\t\t\t            left join  Bud_ConsReport consRep  on consTask.ConsReportId=consRep.ConsReportId \r\n\t\t\t\t            where taskId in  \r\n\t\t\t\t            (\r\n\t\t\t\t\t            select TaskId from Task\r\n\t\t\t\t            ) and FlowState=1\r\n\t\t\t            ) ct on consTasRes.ConsTaskId=ct.ConsTaskId group by TaskId\r\n\t\t            ) ctr on task.taskId=ctr.TaskId  \r\n\t            )  GainLoss \r\n            ) tab1\r\n            ", new object[0]);
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static DataTable GetLaborAnalysis(string taskCode, string taskName, string prjId, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = GetLaborAnalysisCount(taskCode, taskName, prjId);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50),@PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001001';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudInfo AS\r\n            (\r\n\t            --原预算节点信息\r\n\t            SELECT budTask.TaskId,ParentId,TaskCode,TaskName,OrderNumber \r\n\t            FROM Bud_Task budTask\r\n\t            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t            AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t            UNION\r\n\t            --清单外的预算变更节点信息\r\n\t            SELECT ModifyTaskId TaskId,TaskId ParentId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber \r\n\t            FROM Bud_Modify modify\r\n\t            JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t            WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n            ),cteBudTotal AS\r\n            (\r\n\t            --全部预算人工费\r\n\t            SELECT TaskId,SUM(Target) AS LaborBudCost FROM \r\n\t            (\r\n\t\t            --原预算\r\n\t\t            SELECT TaskRes.TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId=TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId \r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION\r\n\t\t            --清单外预算\r\n\t\t            SELECT modifyTask.ModifyTaskId TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=0\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION \r\n\t\t            --清单内预算\r\n\t\t            SELECT TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=1\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            ) BudRes \r\n\t            GROUP BY TaskId \r\n            ),cteMonthTotal AS\r\n            (\r\n\t            --本月预算人工费\r\n\t            SELECT TaskId,SUM(Target) CurrentLaborBudCost FROM \r\n\t            (\r\n\t\t            SELECT Task.TaskId,Task.OrderNumber,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            ) MonBudRes GROUP BY TaskId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量的人工费\r\n\t            select TaskId,sum(UnitPrice*AccountingQuantity) LaborConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask where ResourceTypeId IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            group by TaskId\r\n            ),cteMonthCons AS\r\n            (\r\n\t            --本月施工报量的人工费\r\n\t            select TaskId,sum(UnitPrice*AccountingQuantity) CurrentLaborConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1 and datediff(month,InputDate,getdate())=0\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask where ResourceTypeId IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            group by TaskId\r\n            )\r\n            select top(@PageSize) Convert(Nvarchar(30),Num) as Num,TaskCode,TaskName,Convert(decimal(18,3),CurrentLaborBudCost) CurrentLaborBudCost,\r\n            Convert(decimal(18,3),CurrentLaborConsCost) CurrentLaborConsCost,\r\n            Convert(decimal(18,3),CurrentReductionAmount) CurrentReductionAmount,CurrentReductionRate,\r\n            Convert(decimal(18,3),LaborBudCost) LaborBudCost,Convert(decimal(18,3),LaborConsCost) LaborConsCost,\r\n            Convert(decimal(18,3),ReductionAmount) ReductionAmount,ReductionRate from \r\n            ( \r\n\t            SELECT  Row_Number()over(order by OrderNumber) as Num,TaskCode,TaskName,OrderNumber,\r\n\t            CurrentLaborBudCost,CurrentLaborConsCost,(CurrentLaborBudCost-CurrentLaborConsCost) CurrentReductionAmount, \r\n\t            Convert(Nvarchar(30),cast(ISNULL(CurrentLaborBudCost/\r\n\t            NULLIF(CurrentLaborBudCost-CurrentLaborConsCost,0),0)*100 as decimal(20,2)))+'%' CurrentReductionRate,\r\n\t            LaborBudCost,LaborConsCost,(LaborBudCost-LaborConsCost) ReductionAmount,\r\n\t            Convert(Nvarchar(30), cast(ISNULL((LaborBudCost-LaborConsCost)/NULLIF(LaborBudCost,0),0)*100 as decimal(20,2)))+'%' ReductionRate \r\n\t            FROM \r\n\t            (\r\n\t\t            SELECT cteBudInfo.TaskId,TaskCode,TaskName,cteBudInfo.OrderNumber,ISNULL(CurrentLaborBudCost,0) CurrentLaborBudCost,\r\n\t\t            ISNULL(CurrentLaborConsCost,0) CurrentLaborConsCost,ISNULL(LaborBudCost,0) LaborBudCost,\r\n\t\t            ISNULL(LaborConsCost,0) LaborConsCost FROM cteBudInfo\r\n\t\t            LEFT JOIN cteMonthTotal \r\n\t\t            ON SUBSTRING(cteBudInfo.TaskId,8,LEN(cteBudInfo.TaskId))=SUBSTRING(cteMonthTotal.TaskId,8,LEN(cteMonthTotal.TaskId))\r\n\t\t            LEFT JOIN cteMonthCons ON cteBudInfo.TaskId=cteMonthCons.TaskId\r\n\t\t            LEFT JOIN cteBudTotal ON cteBudInfo.TaskId=cteBudTotal.TaskId\r\n\t\t            LEFT JOIN cteCons ON cteBudInfo.TaskId=cteCons.TaskId\r\n\t\t            WHERE cteBudInfo.TaskId not in  \r\n\t\t            (\r\n\t\t\t            select distinct parentId from cteBudInfo WHERE ParentId IS not NULL\r\n\t\t            ) AND TaskCode like '%'+@TaskCode+'%' and TaskName like  '%'+@TaskName+'%'\r\n\t            ) LaborCost\r\n            ) tab where Num > @PageSize * (@PageIndex - 1) order by orderNumber ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@CBSCode", LaborCBSCode) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static int GetLaborAnalysisCount(string taskCode, string taskName, string prjId)
        {
            StringBuilder builder = new StringBuilder();
            builder.AppendFormat("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50);\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001001';\r\n            WITH cteBudInfo AS\r\n            (\r\n\t            --原预算节点信息\r\n\t            SELECT budTask.TaskId,ParentId,TaskCode,TaskName,OrderNumber \r\n\t            FROM Bud_Task budTask\r\n\t            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t            AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t            UNION\r\n\t            --清单外的预算变更节点信息\r\n\t            SELECT ModifyTaskId TaskId,TaskId ParentId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber \r\n\t            FROM Bud_Modify modify\r\n\t            JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t            WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n            ),cteBudTotal AS\r\n            (\r\n\t            --全部预算人工费\r\n\t            SELECT TaskId,SUM(Target) AS LaborBudCost FROM \r\n\t            (\r\n\t\t            --原预算\r\n\t\t            SELECT TaskRes.TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId=TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId \r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION\r\n\t\t            --清单外预算\r\n\t\t            SELECT modifyTask.ModifyTaskId TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=0\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t\t            UNION \r\n\t\t            --清单内预算\r\n\t\t            SELECT TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=1\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            ) BudRes \r\n\t            GROUP BY TaskId \r\n            ),cteMonthTotal AS\r\n            (\r\n\t            --本月预算人工费\r\n\t            SELECT TaskId,SUM(Target) CurrentLaborBudCost FROM \r\n\t            (\r\n\t\t            SELECT Task.TaskId,Task.OrderNumber,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            ) MonBudRes GROUP BY TaskId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量的人工费\r\n\t            select TaskId,sum(UnitPrice*AccountingQuantity) LaborConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask where ResourceTypeId IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            group by TaskId\r\n            ),cteMonthCons AS\r\n            (\r\n\t            --本月施工报量的人工费\r\n\t            select TaskId,sum(UnitPrice*AccountingQuantity) CurrentLaborConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1 and datediff(month,InputDate,getdate())=0\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask where ResourceTypeId IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode) \r\n\t            group by TaskId\r\n            )\r\n            select count(*) from \r\n            ( \r\n\t            SELECT  Row_Number()over(order by OrderNumber) as Num,TaskCode,TaskName,OrderNumber,\r\n\t            CurrentLaborBudCost,CurrentLaborConsCost,(CurrentLaborBudCost-CurrentLaborConsCost) CurrentReductionAmount, \r\n\t            Convert(Nvarchar(30),cast(ISNULL(CurrentLaborBudCost/\r\n\t            NULLIF(CurrentLaborBudCost-CurrentLaborConsCost,0),0)*100 as decimal(20,2)))+'%' CurrentReductionRate,\r\n\t            LaborBudCost,LaborConsCost,(LaborBudCost-LaborConsCost) ReductionAmount,\r\n\t            Convert(Nvarchar(30), cast(ISNULL((LaborBudCost-LaborConsCost)/NULLIF(LaborBudCost,0),0)*100 as decimal(20,2)))+'%' ReductionRate \r\n\t            FROM \r\n\t            (\r\n\t\t            SELECT cteBudInfo.TaskId,TaskCode,TaskName,cteBudInfo.OrderNumber,ISNULL(CurrentLaborBudCost,0) CurrentLaborBudCost,\r\n\t\t            ISNULL(CurrentLaborConsCost,0) CurrentLaborConsCost,ISNULL(LaborBudCost,0) LaborBudCost,\r\n\t\t            ISNULL(LaborConsCost,0) LaborConsCost FROM cteBudInfo\r\n\t\t            LEFT JOIN cteMonthTotal \r\n\t\t            ON SUBSTRING(cteBudInfo.TaskId,8,LEN(cteBudInfo.TaskId))=SUBSTRING(cteMonthTotal.TaskId,8,LEN(cteMonthTotal.TaskId))\r\n\t\t            LEFT JOIN cteMonthCons ON cteBudInfo.TaskId=cteMonthCons.TaskId\r\n\t\t            LEFT JOIN cteBudTotal ON cteBudInfo.TaskId=cteBudTotal.TaskId\r\n\t\t            LEFT JOIN cteCons ON cteBudInfo.TaskId=cteCons.TaskId\r\n\t\t            WHERE cteBudInfo.TaskId not in  \r\n\t\t            (\r\n\t\t\t            select distinct parentId from cteBudInfo WHERE ParentId IS not NULL\r\n\t\t            ) AND TaskCode like '%'+@TaskCode+'%' and TaskName like  '%'+@TaskName+'%'\r\n\t            ) LaborCost \r\n            ) tab ", new object[0]);
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName), new SqlParameter("@CBSCode", LaborCBSCode) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static DataTable GetLaborCostAnalysis(string ResourceCode, string ResourceName, string prjId, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = GetLaborCostCount(ResourceCode, ResourceName, prjId);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50),@PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001001';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudTask AS\r\n            (\r\n\t            --全部预算\r\n\t            SELECT ResourceId,SUM(Target) AS BudCost,SUM(ResourceQuantity) BudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT ResourceId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) AS Target,\r\n                    SUM(ISNULL(ResourceQuantity,0)) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n                    INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n                    INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n                    WHERE TaskType='' AND Task.PrjId=@prjId \r\n                    AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n                    GROUP BY  ResourceId\r\n\t\t            UNION\r\n\t\t            SELECT ResourceId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) Target, \r\n                    SUM(ISNULL(ResourceQuantity,0)) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n                    INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n                    INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n                    WHERE FlowState=1 AND PrjId=@prjId \r\n                    AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n                    GROUP BY  ResourceId\r\n\t            ) BudTaskRes \r\n\t            GROUP BY ResourceId \r\n            ),cteMonthBud AS\r\n            (\r\n\t            --本月预算\r\n\t            SELECT ResourceId,SUM(Target) AS CurrentBudCost,SUM(ResourceQuantity) CurrentBudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            ) MonthBudTaskRes GROUP BY ResourceId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量\r\n\t            SELECT ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS ConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) ConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            ),cteMonthCons AS\r\n            (\r\n \t            --本月施工报量\r\n\t            SELECT ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS CurrentConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) CurrentConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,CONSREP.InputDate,GetDate())=0\r\n\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            )\r\n            select top(@PageSize)Convert(Nvarchar(30),Num) as Num,ResourceCode,ResourceName,CurrentBudQuantity,\r\n            Convert(decimal(18,3),CurrentBudCost) CurrentBudCost,\r\n            CurrentConsQuantity,Convert(decimal(18,3),CurrentConsCost) CurrentConsCost,\r\n            Convert(decimal(18,3),CurrentReductionAmount) CurrentReductionAmount,CurrentReductionRate, \r\n            BudQuantity,Convert(decimal(18,3),BudCost) BudCost,ConsQuantity,Convert(decimal(18,3),ConsCost) ConsCost,\r\n            Convert(decimal(18,3),ReductionAmount) ReductionAmount,ReductionRate from \r\n            ( \r\n\t            select Row_Number()over(order by ResourceCode) as Num,ResourceCode,ResourceName,CurrentBudQuantity,CurrentBudCost, \r\n\t            CurrentConsQuantity,CurrentConsCost,(CurrentBudCost-CurrentConsCost) CurrentReductionAmount, \r\n\t            Convert(Nvarchar(30),Cast(ISNULL((CurrentBudCost-CurrentConsCost)/NULLIF(CurrentBudCost,0),0)*100 as decimal(20,2)))+'%'  \r\n\t            CurrentReductionRate,BudQuantity,BudCost,ConsQuantity,ConsCost,(BudCost-ConsCost) ReductionAmount, \r\n\t            Convert(Nvarchar(30),Cast(ISNULL((BudCost-ConsCost)/NULLIF(BudCost,0),0)*100 as decimal(20,2)))+'%' ReductionRate \r\n\t            from  \r\n\t            ( \r\n\t\t            SELECT resIds.ResourceId,ResourceCode,ResourceName,\r\n\t\t            ISNULL(CurrentBudCost,0) CurrentBudCost,ISNULL(CurrentBudQuantity,0) CurrentBudQuantity,\r\n\t\t            ISNULL(CurrentConsCost,0) CurrentConsCost, ISNULL(CurrentConsQuantity,0) CurrentConsQuantity,\r\n\t\t            ISNULL(BudQuantity,0) BudQuantity,ISNULL(BudCost,0) BudCost,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t\t            ISNULL(ConsCost,0) ConsCost FROM\r\n\t\t            (\r\n\t\t\t            SELECT ResourceId FROM cteBudTask\r\n\t\t\t            UNION\r\n\t\t\t            SELECT ResourceId FROM cteCons\r\n\t\t            ) resIds \r\n\t\t            INNER JOIN Res_Resource res ON resIds.ResourceId=res.ResourceId\r\n\t\t            LEFT JOIN cteMonthBud ON resIds.ResourceId=cteMonthBud.ResourceId\r\n\t\t            LEFT JOIN cteMonthCons ON resIds.ResourceId=cteMonthCons.ResourceId\r\n\t\t            LEFT JOIN cteBudTask ON resIds.ResourceId=cteBudTask.ResourceId\r\n\t\t            LEFT JOIN cteCons ON resIds.ResourceId=cteCons.ResourceId\r\n\t\t            WHERE ResourceCode like '%'+@ResourceCode+'%' and ResourceName like  '%'+@ResourceName+'%'  \r\n\t            ) dt\r\n            ) tab WHERE Num>@PageSize*(@PageIndex-1) ORDER BY ResourceCode \r\n            ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@ResourceCode", ResourceCode), new SqlParameter("@ResourceName", ResourceName), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@CBSCode", LaborCBSCode) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static int GetLaborCostCount(string ResourceCode, string ResourceName, string prjId)
        {
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@CBSCode NVARCHAR(50),@PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @CBSCode='001001001';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudTask AS\r\n            (\r\n\t            --全部预算\r\n\t            SELECT ResourceId,SUM(Target) AS BudCost,SUM(ResourceQuantity) BudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId \r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t\t            UNION\r\n\t\t            SELECT ResourceId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) Target, \r\n                    SUM(ISNULL(ResourceQuantity,0)) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n                    INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n                    INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n                    WHERE FlowState=1 AND PrjId=@prjId \r\n                    AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n                    GROUP BY  ResourceId\r\n\t            ) BudTaskRes \r\n\t            GROUP BY ResourceId \r\n            ),cteMonthBud AS\r\n            (\r\n\t            --本月预算\r\n\t            SELECT ResourceId,SUM(Target) AS CurrentBudCost,SUM(ResourceQuantity) CurrentBudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            ) MonthBudTaskRes GROUP BY ResourceId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量\r\n\t            SELECT ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS ConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) ConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            ),cteMonthCons AS\r\n            (\r\n \t            --本月施工报量\r\n\t            SELECT ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS CurrentConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) CurrentConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,CONSREP.InputDate,GetDate())=0\r\n\t            AND dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@CBSCode)\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            )\r\n            select count(*) from  \r\n            ( \r\n\t            SELECT resIds.ResourceId,ResourceCode,ResourceName,\r\n\t            ISNULL(CurrentBudCost,0) CurrentBudCost,ISNULL(CurrentBudQuantity,0) CurrentBudQuantity,\r\n\t            ISNULL(CurrentConsCost,0) CurrentConsCost, ISNULL(CurrentConsQuantity,0) CurrentConsQuantity,\r\n\t            ISNULL(BudQuantity,0) BudQuantity,ISNULL(BudCost,0) BudCost,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t            ISNULL(ConsCost,0) ConsCost FROM\r\n\t            (\r\n\t\t            SELECT ResourceId FROM cteBudTask\r\n\t\t            UNION\r\n\t\t            SELECT ResourceId FROM cteCons\r\n\t            ) resIds \r\n\t            INNER JOIN Res_Resource res ON resIds.ResourceId=res.ResourceId\r\n\t            LEFT JOIN cteMonthBud ON resIds.ResourceId=cteMonthBud.ResourceId\r\n\t            LEFT JOIN cteMonthCons ON resIds.ResourceId=cteMonthCons.ResourceId\r\n\t            LEFT JOIN cteBudTask ON resIds.ResourceId=cteBudTask.ResourceId\r\n\t            LEFT JOIN cteCons ON resIds.ResourceId=cteCons.ResourceId\r\n\t            WHERE ResourceCode like '%'+@ResourceCode+'%' and ResourceName like  '%'+@ResourceName+'%'  \r\n            ) dt ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@ResourceCode", ResourceCode), new SqlParameter("@ResourceName", ResourceName), new SqlParameter("@CBSCode", LaborCBSCode) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static DataTable GetLSMTaskAnalysis(string taskCode, string taskName, string prjId, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = GetLSMTaskCount(taskCode, taskName, prjId);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@LaborCBSCode NVARCHAR(50),@StuffCBSCode NVARCHAR(50),@MachineCBSCode NVARCHAR(50),\r\n            --@TaskCode NVARCHAR(50),@TaskName NVARCHAR(50),@PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @LaborCBSCode='001001001';\r\n            --SET @StuffCBSCode='001001002'\r\n            --SET @MachineCBSCode='001001003'\r\n            --SET @TaskCode='';\r\n            --SET @TaskName='';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudInfo AS\r\n            (\r\n\t            --原预算节点信息\r\n\t            SELECT budTask.TaskId,ParentId,TaskCode,TaskName,OrderNumber \r\n\t            FROM Bud_Task budTask\r\n\t            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t            AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t            UNION\r\n\t            --清单外的预算变更节点信息\r\n\t            SELECT ModifyTaskId TaskId,TaskId ParentId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber \r\n\t            FROM Bud_Modify modify\r\n\t            JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t            WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n            ),cteBudTotal AS\r\n            (\r\n\t            --全部预算费用\r\n\t            SELECT TaskId,ResourceId,SUM(Target) AS BudCost FROM \r\n\t            (\r\n\t\t            --原预算\r\n\t\t            SELECT TaskRes.TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target \r\n\t\t            FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId=TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId \r\n\t\t            UNION\r\n\t\t            --清单外预算\r\n\t\t            SELECT modifyTask.ModifyTaskId TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=0\r\n\t\t            UNION \r\n\t\t            --清单内预算\r\n\t\t            SELECT TaskId,ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTask.ModifyId \r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND ModifyType=1\r\n\t            ) BudRes \r\n\t            GROUP BY TaskId,ResourceId\r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量的费用\r\n\t            select TaskId,ResourceId,sum(UnitPrice*AccountingQuantity) ConsCost from   \r\n\t            (\r\n\t\t            select ConsTask.ConsTaskId,ResourceId,dbo.GetResourceType(ResourceId) ResourceTypeId,TaskId,\r\n\t\t            ISNULL(UnitPrice,0) UnitPrice,ISNULL(AccountingQuantity,0) AccountingQuantity from \r\n\t\t            (\r\n\t\t\t            select ConsTaskId,TaskId from Bud_ConsTask where ConsReportId in \r\n\t\t\t            (\r\n\t\t\t\t            select ConsReportId from Bud_ConsReport where prjId=@prjId\r\n\t\t\t\t            and IsValid=1 and FlowState=1\r\n\t\t\t            )\r\n\t\t            ) ConsTask \r\n\t\t            inner join Bud_ConsTaskRes ConsTaskRes on ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t            ) ConsTask \r\n\t            group by TaskId,ResourceId\r\n            ),cteLaborCBS AS\r\n            (\r\n\t            --人工费\r\n\t            SELECT TaskId,SUM(BudCost) LaborBudCost, SUM(ConsCost) LaborConsCost FROM \r\n\t            (\r\n\t\t            SELECT cteBudTotal.TaskId,cteBudTotal.ResourceId,BudCost,\r\n\t\t            ISNULL(ConsCost,0) ConsCost FROM cteBudTotal\r\n\t\t            LEFT JOIN cteCons ON cteBudTotal.TaskId=cteCons.TaskId AND cteBudTotal.ResourceId=cteCons.ResourceId\r\n\t\t            WHERE dbo.GetResourceType(cteBudTotal.ResourceId) IN \r\n\t\t            (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@LaborCBSCode)\r\n\t            ) laborTask GROUP BY TaskId\r\n            ),cteStuffCBS AS\r\n            (\r\n\t            --材料费\r\n\t            SELECT TaskId,SUM(BudCost) StuffBudCost, SUM(ConsCost) StuffConsCost FROM \r\n\t            (\r\n\t\t            SELECT cteBudTotal.TaskId,cteBudTotal.ResourceId,BudCost,\r\n\t\t            ISNULL(ConsCost,0) ConsCost FROM cteBudTotal\r\n\t\t            LEFT JOIN cteCons ON cteBudTotal.TaskId=cteCons.TaskId AND cteBudTotal.ResourceId=cteCons.ResourceId\r\n\t\t            WHERE dbo.GetResourceType(cteBudTotal.ResourceId) IN \r\n\t\t            (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t            ) stuffTask GROUP BY TaskId\t\r\n            ),cteMachineCBS AS\r\n            (\r\n\t            --机械费\r\n\t            SELECT TaskId,SUM(BudCost) MachineBudCost, SUM(ConsCost) MachineConsCost FROM \r\n\t            (\r\n\t\t            SELECT cteBudTotal.TaskId,cteBudTotal.ResourceId,BudCost,\r\n\t\t            ISNULL(ConsCost,0) ConsCost FROM cteBudTotal\r\n\t\t            LEFT JOIN cteCons ON cteBudTotal.TaskId=cteCons.TaskId AND cteBudTotal.ResourceId=cteCons.ResourceId\r\n\t\t            WHERE dbo.GetResourceType(cteBudTotal.ResourceId) IN \r\n\t\t            (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@MachineCBSCode)\r\n\t            ) MachineTask GROUP BY TaskId\r\n            )\r\n            select top(@PageSize) Convert(Nvarchar(30),Num) as Num,TaskCode,TaskName,\r\n            Convert(decimal(18,3),LaborBudCost) LaborBudCost,Convert(decimal(18,3),StuffBudCost) StuffBudCost,\r\n            Convert(decimal(18,3),MachineBudCost) MachineBudCost,Convert(decimal(18,3),BudTotal) BudTotal,\r\n            Convert(decimal(18,3),LaborConsCost) LaborConsCost,Convert(decimal(18,3),StuffConsCost) StuffConsCost,\r\n            Convert(decimal(18,3),MachineConsCost) MachineConsCost,Convert(decimal(18,3),ConsTotal) ConsTotal,\r\n            Convert(decimal(18,3),BudTotal-ConsTotal) DiffTotal\r\n            from \r\n            ( \r\n\t            SELECT  Row_Number()over(order by OrderNumber) as Num,cteBudInfo.TaskId,TaskCode,TaskName,\r\n\t            cteBudInfo.OrderNumber,ISNULL(LaborBudCost,0) LaborBudCost,ISNULL(StuffBudCost,0) StuffBudCost,\r\n\t            ISNULL(MachineBudCost,0) MachineBudCost,(ISNULL(LaborBudCost,0)+ISNULL(StuffBudCost,0)+ISNULL(MachineBudCost,0)) BudTotal,\r\n\t            ISNULL(LaborConsCost,0) LaborConsCost,ISNULL(StuffConsCost,0) StuffConsCost,ISNULL(MachineConsCost,0) MachineConsCost,\r\n\t            (ISNULL(LaborConsCost,0)+ISNULL(StuffConsCost,0)+ISNULL(MachineConsCost,0)) ConsTotal\r\n\t            FROM cteBudInfo\r\n\t            LEFT JOIN cteLaborCBS ON cteBudInfo.TaskId=cteLaborCBS.TaskId\r\n\t            LEFT JOIN cteStuffCBS ON cteBudInfo.TaskId=cteStuffCBS.TaskId \r\n\t            LEFT JOIN cteMachineCBS ON cteBudInfo.TaskId=cteMachineCBS.TaskId \r\n\t            WHERE cteBudInfo.TaskId not in  \r\n\t            (\r\n\t\t            select distinct parentId from cteBudInfo WHERE ParentId IS not NULL\r\n\t            ) AND TaskCode LIKE '%'+@TaskCode+'%' and TaskName LIKE  '%'+@TaskName+'%'  \r\n            ) tab where Num > @PageSize * (@PageIndex - 1) order by orderNumber\r\n            ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName), new SqlParameter("@LaborCBSCode", LaborCBSCode), new SqlParameter("@StuffCBSCode", StuffCBSCode), new SqlParameter("@MachineCBSCode", MachineCBSCode), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static int GetLSMTaskCount(string taskCode, string taskName, string prjId)
        {
            string laborCBSCode = LaborCBSCode;
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@TaskCode NVARCHAR(50),@TaskName NVARCHAR(50)\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @TaskCode='';\r\n            --SET @TaskName='';\r\n            WITH cteBudInfo AS\r\n            (\r\n\t            --原预算节点信息\r\n\t            SELECT budTask.TaskId,ParentId,TaskCode,TaskName,OrderNumber \r\n\t            FROM Bud_Task budTask\r\n\t            JOIN vGetCurBudVersion ON budTask.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t            AND budTask.PrjId=@PrjId AND TaskType=''\r\n\t            UNION\r\n\t            --清单外的预算变更节点信息\r\n\t            SELECT ModifyTaskId TaskId,TaskId ParentId,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,OrderNumber \r\n\t            FROM Bud_Modify modify\r\n\t            JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t            WHERE PrjId=@PrjId AND FlowState=1 AND ModifyType=0\r\n            )\r\n            SELECT COUNT(*) FROM cteBudInfo \r\n            WHERE cteBudInfo.TaskId not in  \r\n            (\r\n\t            select distinct parentId from cteBudInfo WHERE ParentId IS not NULL\r\n            ) AND TaskCode LIKE '%'+@TaskCode+'%' and TaskName LIKE  '%'+@TaskName+'%'  \r\n             ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@TaskCode", taskCode), new SqlParameter("@TaskName", taskName) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static DataTable GetMajorStuffAnalysis(string ResourceCode, string ResourceName, string specification, string brand, string prjId, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = GetStuffCount(ResourceCode, ResourceName, specification, brand, prjId);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@attribute NVARCHAR(50),@specification NVARCHAR(50),@brand NVARCHAR(50);\r\n            --DECLARE @PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @attribute='FF747819-77DE-4670-A4F5-8FED9A509A70';\r\n            --SET @specification='';\r\n            --SET @brand='';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudTask AS\r\n            (\r\n\t            --全部预算\r\n\t            SELECT ResourceId,SUM(Target) AS BudCost,SUM(ResourceQuantity) BudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId AND Attribute=@attribute\r\n\t\t            UNION\r\n\t\t            SELECT modifyTaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount, \r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t            INNER JOIN Res_Resource Res ON modifyTaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND Attribute=@attribute\r\n\t            ) BudTaskRes \r\n\t            GROUP BY ResourceId \r\n            ),cteMonthBud AS\r\n            (\r\n\t            --本月预算\r\n\t            SELECT ResourceId,SUM(Target) AS CurrentBudCost,SUM(ResourceQuantity) CurrentBudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\t\t\r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND Attribute=@attribute\r\n\t            ) MonthBudTaskRes GROUP BY ResourceId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS ConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) ConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t            AND Attribute=@attribute\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            ),cteMonthCons AS\r\n            (\r\n \t            --本月施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS CurrentConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) CurrentConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,CONSREP.InputDate,GetDate())=0\r\n\t            AND Attribute=@attribute \r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            )\r\n            select top(@PageSize)Convert(Nvarchar(30),Num) as Num,ResourceCode,ResourceName,Specification,\r\n            TechnicalParameter,ModelNumber,Brand,CurrentBudQuantity,Convert(decimal(18,3),CurrentBudCost) CurrentBudCost,\r\n            CurrentConsQuantity,Convert(decimal(18,3),CurrentConsCost) CurrentConsCost,\r\n            Convert(decimal(18,3),CurrentReductionAmount) CurrentReductionAmount,CurrentReductionRate, \r\n            BudQuantity,Convert(decimal(18,3),BudCost) BudCost,ConsQuantity,Convert(decimal(18,3),ConsCost) ConsCost,\r\n            Convert(decimal(18,3),ReductionAmount) ReductionAmount,ReductionRate from \r\n            ( \r\n\t            select Row_Number()over(order by ResourceCode) as Num,ResourceCode,ResourceName,\r\n\t            Specification,TechnicalParameter,ModelNumber,Brand,CurrentBudQuantity,CurrentBudCost, \r\n\t            CurrentConsQuantity,CurrentConsCost,(CurrentBudCost-CurrentConsCost) CurrentReductionAmount, \r\n\t            Convert(Nvarchar(30),Cast(ISNULL((CurrentBudCost-CurrentConsCost)/NULLIF(CurrentBudCost,0),0)*100 as decimal(20,2)))+'%'  \r\n\t            CurrentReductionRate,BudQuantity,BudCost,ConsQuantity,ConsCost,(BudCost-ConsCost) ReductionAmount, \r\n\t            Convert(Nvarchar(30),Cast(ISNULL((BudCost-ConsCost)/NULLIF(BudCost,0),0)*100 as decimal(20,2)))+'%' ReductionRate \r\n\t            from  \r\n\t            ( \r\n\t\t            SELECT resIds.ResourceId,ResourceCode,ResourceName,Specification,TechnicalParameter,\r\n\t\t            ModelNumber,Brand,ISNULL(CurrentBudCost,0) CurrentBudCost,ISNULL(CurrentBudQuantity,0) CurrentBudQuantity,\r\n\t\t            ISNULL(CurrentConsCost,0) CurrentConsCost, ISNULL(CurrentConsQuantity,0) CurrentConsQuantity,\r\n\t\t            ISNULL(BudQuantity,0) BudQuantity,ISNULL(BudCost,0) BudCost,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t\t            ISNULL(ConsCost,0) ConsCost FROM\r\n\t\t            (\r\n\t\t\t            SELECT ResourceId FROM cteBudTask\r\n\t\t\t            UNION\r\n\t\t\t            SELECT ResourceId FROM cteCons\r\n\t\t            ) resIds \r\n\t\t            INNER JOIN Res_Resource res ON resIds.ResourceId=res.ResourceId\r\n\t\t            LEFT JOIN cteMonthBud ON resIds.ResourceId=cteMonthBud.ResourceId\r\n\t\t            LEFT JOIN cteMonthCons ON resIds.ResourceId=cteMonthCons.ResourceId\r\n\t\t            LEFT JOIN cteBudTask ON resIds.ResourceId=cteBudTask.ResourceId\r\n\t\t            LEFT JOIN cteCons ON resIds.ResourceId=cteCons.ResourceId\r\n\t\t            WHERE ResourceCode like '%'+@ResourceCode+'%' and ResourceName like  '%'+@ResourceName+'%'\r\n                          and Specification like '%'+@specification+'%' and Brand like '%'+@brand+'%'\r\n\t            ) dt\r\n            ) tab WHERE Num>@PageSize*(@PageIndex-1) ORDER BY ResourceCode \r\n            ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@ResourceCode", ResourceCode), new SqlParameter("@ResourceName", ResourceName), new SqlParameter("@specification", specification), new SqlParameter("@brand", brand), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@attribute", MajorStuff) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static DataTable GetMajorStuffDiffAnalysis(string ResourceCode, string ResourceName, string prjId, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = GetStuffCount(ResourceCode, ResourceName, string.Empty, string.Empty, prjId);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@attribute NVARCHAR(50),@PageSize int,@PageIndex int;\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @attribute='FF747819-77DE-4670-A4F5-8FED9A509A70';\r\n            --set @PageSize=100;\r\n            --set @PageIndex=1;\r\n            WITH cteBudTask AS\r\n            (\r\n\t            --全部预算\r\n\t            SELECT ResourceId,SUM(Target) AS BudCost,SUM(ResourceQuantity) BudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId AND Attribute=@attribute\r\n\t\t            UNION\r\n\t\t            SELECT modifyTaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount, \r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t            INNER JOIN Res_Resource Res ON modifyTaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND Attribute=@attribute\r\n\t            ) BudTaskRes \r\n\t            GROUP BY ResourceId \r\n            ),cteMonthBud AS\r\n            (\r\n\t            --本月预算\r\n\t            SELECT ResourceId,SUM(Target) AS CurrentBudCost,SUM(ResourceQuantity) CurrentBudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\t\t\r\n\t\t            WHERE TaskType='M' AND Task.PrjId=@prjId \r\n\t\t            AND SUBSTRING(Task.TaskId,2,LEN(DateName(Year,GetDate())+DateName(Month,GetDate())))\r\n\t\t            =DateName(Year,GetDate())+DateName(Month,GetDate())\r\n\t\t            AND Attribute=@attribute\r\n\t            ) MonthBudTaskRes GROUP BY ResourceId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS ConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) ConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t            AND Attribute=@attribute\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            ),cteMonthCons AS\r\n            (\r\n \t            --本月施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS CurrentConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) CurrentConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 and DateDiff(mm,CONSREP.InputDate,GetDate())=0\r\n\t            AND Attribute=@attribute \r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            )\r\n            SELECT TOP (@PageSize) Convert(Nvarchar(30),Num) Num,ResourceId,ResourceCode,ResourceName,Specification,\r\n            TechnicalParameter,ModelNumber,Brand,Convert(decimal(18,3),CurrentBudCost) CurrentBudCost,\r\n            Convert(decimal(18,3),CurrentConsCost) CurrentConsCost,Convert(decimal(18,3),CurrentDiffPrice) CurrentDiffPrice,\r\n            Convert(decimal(18,3),CurrentReductionAmount) CurrentReductionAmount,Convert(decimal(18,3),BudCost) BudCost,\r\n            Convert(decimal(18,3),ConsCost) ConsCost,Convert(decimal(18,3),DiffQuantity) DiffQuantity,\r\n            Convert(decimal(18,3),DiffPrice) DiffPrice,Convert(decimal(18,3),ReductionAmount) ReductionAmount FROM\r\n            (\r\n\t            SELECT Row_Number()over(order by ResourceCode) Num,ResourceId,ResourceCode,ResourceName,\r\n\t            Specification,TechnicalParameter,ModelNumber,Brand,CurrentBudCost,CurrentConsCost,\r\n\t            (ISNULL(CurrentBudCost/NULLIF(CurrentBudQuantity,0),0)-\r\n\t            ISNULL(CurrentConsCost/NULLIF(CurrentConsQuantity,0),0)) CurrentDiffPrice,\r\n\t            (CurrentBudCost-CurrentConsCost) CurrentReductionAmount,\r\n\t            BudCost,ConsCost,(BudQuantity-ConsQuantity) DiffQuantity,(ISNULL(BudCost/NULLIF(BudQuantity,0),0)-\r\n\t            ISNULL(ConsCost/NULLIF(ConsQuantity,0),0)) DiffPrice,(BudCost-ConsCost) ReductionAmount\r\n\t            FROM\r\n\t            (\r\n\t\t            SELECT resIds.ResourceId,ResourceCode,ResourceName,Specification,TechnicalParameter,\r\n\t\t            ModelNumber,Brand,ISNULL(CurrentBudCost,0) CurrentBudCost,ISNULL(CurrentBudQuantity,0) CurrentBudQuantity,\r\n\t\t            ISNULL(CurrentConsCost,0) CurrentConsCost, ISNULL(CurrentConsQuantity,0) CurrentConsQuantity,\r\n\t\t            ISNULL(BudQuantity,0) BudQuantity,ISNULL(BudCost,0) BudCost,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t\t            ISNULL(ConsCost,0) ConsCost FROM\r\n\t\t            (\r\n\t\t\t            SELECT ResourceId FROM cteBudTask\r\n\t\t\t            UNION\r\n\t\t\t            SELECT ResourceId FROM cteCons\r\n\t\t            ) resIds \r\n\t\t            INNER JOIN Res_Resource res ON resIds.ResourceId=res.ResourceId\r\n\t\t            LEFT JOIN cteMonthBud ON resIds.ResourceId=cteMonthBud.ResourceId\r\n\t\t            LEFT JOIN cteMonthCons ON resIds.ResourceId=cteMonthCons.ResourceId\r\n\t\t            LEFT JOIN cteBudTask ON resIds.ResourceId=cteBudTask.ResourceId\r\n\t\t            LEFT JOIN cteCons ON resIds.ResourceId=cteCons.ResourceId\r\n\t\t            WHERE ResourceCode like '%'+@ResourceCode+'%' and ResourceName like  '%'+@ResourceName+'%'  \r\n\t            ) dt \r\n            ) tab WHERE Num>@PageSize*(@PageIndex-1) ORDER BY ResourceCode \r\n            ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@ResourceCode", ResourceCode), new SqlParameter("@ResourceName", ResourceName), new SqlParameter("@PageSize", pageSize), new SqlParameter("@PageIndex", pageIndex), new SqlParameter("@attribute", MajorStuff) };
            return SqlHelper.ExecuteQuery(CommandType.Text, builder.ToString(), commandParameters);
        }

        public static DataTable GetPrjSummary(string prjId, int version, string date, string isWBSRelevance)
        {
            string cmdText = string.Empty;
            if (isWBSRelevance == "1")
            {
                cmdText = "\r\n\t\t\t\t--DECLARE @PrjId nvarchar(200), @Version int ,@date nvarchar(20)\r\n\t\t\t\t--SET @PrjId = '4c91f99d-2929-49dc-874b-953dc32a8776';\r\n\t\t\t\t--SET @Version = 1;\r\n\t\t\t\t--set @date='2013-10-22';\r\n\t\t\t\t--查询前两级节点\r\n\t\t\t\tWITH cteBudTask AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--原预算\r\n\t\t\t\t\tSELECT TaskId,OrderNumber,TaskCode,TaskName \r\n\t\t\t\t\tFROM Bud_Task\r\n\t\t\t\t\tWHERE PrjId = @PrjId \r\n\t\t\t\t\tAND VERSION = @Version AND TaskType = ''\r\n\t\t\t\t),budModifyInfo AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--预算变更\r\n\t\t\t\t\tSELECT ModifyTaskId AS TaskId,OrderNumber,ModifyTaskCode TaskCode,ModifyTaskContent TaskName\r\n\t\t\t\t\tFROM Bud_ModifyTask modifyTask\r\n\t\t\t\t\tJOIN Bud_Modify budModify ON modifyTask.modifyId=budModify.modifyId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND ModifyType=0\r\n\t\t\t\t\tAND FlowState=1 \r\n\t\t\t\t),cteBudTask2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT newTask.TaskId,OrderNumber,TaskCode,TaskName,newTask.Total Total  FROM \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT TaskId,OrderNumber,TaskCode,TaskName,dbo.fn_GetTotal(TaskId) AS Total\r\n\t\t\t\t\t\t\tFROM cteBudTask \r\n\t\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\t\tSELECT TaskId,OrderNumber,TaskCode,TaskName,dbo.fn_GetModifyTotal(TaskId) AS Total\r\n\t\t\t\t\t\t\tFROM budModifyInfo\r\n\t\t\t\t\t\t)newTask \r\n\t\t\t\t\t) tab \r\n\t\t\t\t),LastMonthCons AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--上期施工报量汇总\r\n\t\t\t\t\tSELECT TaskId,SUM(UnitPrice*ConsTaskRes.AccountingQuantity) Total FROM Bud_ConsReport ConsReport\r\n\t\t\t\t\tINNER JOIN Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId\r\n\t\t\t\t\tLeft JOIN Bud_ConsTaskRes ConsTaskRes ON ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND \r\n\t\t\t\t\tDATEDIFF(DD,InputDate,Convert(DATETIME,substring(@date,0,8)+'-01'))>0\r\n\t\t\t\t\tAND FlowState=1 GROUP BY TaskId\r\n\t\t\t\t),CurrentMonthCons AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--本期施工报量汇总\r\n\t\t\t\t\tSELECT TaskId,SUM(UnitPrice*ConsTaskRes.AccountingQuantity) Total FROM Bud_ConsReport ConsReport\r\n\t\t\t\t\tINNER JOIN Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId\r\n\t\t\t\t\tLeft JOIN Bud_ConsTaskRes ConsTaskRes ON ConsTask.ConsTaskId=ConsTaskRes.ConsTaskId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND DATEDIFF(MONTH,InputDate,CONVERT(DATETIME,@date))=0\r\n\t\t\t\t\tAND FlowState=1 GROUP BY TaskId\r\n\t\t\t\t),cteTask AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT cteBudTask2.TaskId,OrderNumber,TaskCode,TaskName,cteBudTask2.Total,\r\n\t\t\t\t\tLastMonthCons.Total LastMonthConsTotal,CurrentMonthCons.Total CurrentMonthConsTotal FROM cteBudTask2\r\n\t\t\t\t\tLEFT JOIN LastMonthCons ON cteBudTask2.TaskId=LastMonthCons.TaskId\r\n\t\t\t\t\tLEFT JOIN CurrentMonthCons ON cteBudTask2.TaskId=CurrentMonthCons.TaskId\r\n\t\t\t\t),cteTask2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT t2.TaskId, t2.OrderNumber, t2.TaskCode,t2.TaskName,Total,\r\n\t\t\t\t\t(SELECT SUM(cteTask.LastMonthConsTotal) FROM cteTask\r\n\t\t\t\t\t\tWHERE cteTask.OrderNumber LIKE t2.OrderNumber + '%' \r\n\t\t\t\t\t\t) AS LastMonthConsTotal,--上月的施工报量汇总小计\r\n\t\t\t\t\t(SELECT SUM(cteTask.CurrentMonthConsTotal) FROM cteTask\r\n\t\t\t\t\t\tWHERE cteTask.OrderNumber LIKE t2.OrderNumber + '%' \r\n\t\t\t\t\t\t) AS CurrentMonthConsTotal--本月的施工报量汇总小计\r\n\t\t\t\t\tFROM cteTask AS t2 \r\n\t\t\t\t),topLevel AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--查询单位工程的内容\r\n\t\t\t\t\tSELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY cteTask2.OrderNumber)) as Num, \r\n\t\t\t\t\tcteTask2.TaskId,cteTask2.OrderNumber, cteTask2.TaskCode,cteTask2.TaskName, \r\n\t\t\t\t\tISNULL(cteTask2.Total, 0) AS Total,'1' AS BudLevel,\r\n\t\t\t\t\tISNULL(LastMonthConsTotal,0) AS LastMonthConsTotal,\r\n\t\t\t\t\tISNULL(CurrentMonthConsTotal,0) AS CurrentMonthConsTotal,\r\n\t\t\t\t\t(ISNULL(LastMonthConsTotal,0)+ISNULL(CurrentMonthConsTotal,0)) SumCons\r\n\t\t\t\t\tFROM cteTask2 \r\n\t\t\t\t\tWHERE LEN(OrderNumber)/3 = 1 \r\n\t\t\t\t),secondLevel AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--查询分部工程的内容\r\n\t\t\t\t\tSELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY cteTask2.OrderNumber)) as Num,\r\n\t\t\t\t\tcteTask2.TaskId,cteTask2.OrderNumber, cteTask2.TaskCode,cteTask2.TaskName, \r\n\t\t\t\t\tISNULL(cteTask2.Total, 0) AS Total,'2' AS BudLevel,\r\n\t\t\t\t\tISNULL(LastMonthConsTotal,0) AS LastMonthConsTotal,\r\n\t\t\t\t\tISNULL(CurrentMonthConsTotal,0) AS CurrentMonthConsTotal,\r\n\t\t\t\t\t(ISNULL(LastMonthConsTotal,0)+ISNULL(CurrentMonthConsTotal,0)) SumCons\r\n\t\t\t\t\tFROM cteTask2\r\n\t\t\t\t\tWHERE LEN(OrderNumber)/3 = 2\r\n\t\t\t\t)\r\n\t\t\t\tSELECT * FROM topLevel\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT * FROM secondLevel\r\n\t\t\t\tORDER BY OrderNumber";
            }
            else
            {
                cmdText = "\r\n\t\t\t\t--DECLARE @PrjId nvarchar(200), @Version int ,@date nvarchar(20)\r\n\t\t\t\t--SET @PrjId = '939e9005-c796-492f-bb5a-0fe039dcbdd5';\r\n\t\t\t\t--SET @Version = 1;\r\n\t\t\t\t--set @date='2013-10-22';\r\n\t\t\t\t--查询前两级节点\r\n\t\t\t\tWITH cteBudTask AS          --分部分项\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT TaskId,OrderNumber,TaskCode,TaskName,ISNULL(Quantity,0) Quantity,\r\n\t\t\t\t\tISNULL(UnitPrice,0) UnitPrice,ISNULL(Total,0) Total FROM Bud_Task \r\n\t\t\t\t\tWHERE PrjId=@PrjId AND Version=@Version AND TaskType = ''\r\n\t\t\t\t),outBudModifyInfo AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT ModifyTaskId AS TaskId,OrderNumber,ModifyTaskCode TaskCode,ModifyTaskContent TaskName,\r\n\t\t\t\t\tQuantity,ISNULL(UnitPrice,0) UnitPrice,Total FROM Bud_ModifyTask modifyTask\r\n\t\t\t\t\tJOIN Bud_Modify budModify ON modifyTask.modifyId=budModify.modifyId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND ModifyType=0\r\n\t\t\t\t\tAND FlowState=1 \r\n\t\t\t\t),cteBudTask2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT TaskId,OrderNumber,TaskCode,TaskName,Quantity,Total,\r\n\t\t\t\t\tISNULL(Total/NULLIF(Quantity,0),0) UnitPrice FROM \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT newTask.TaskId,OrderNumber,TaskCode,TaskName,\r\n\t\t\t\t\t\t(newTask.Quantity+ISNULL(inBudModifyTask.Quantity,0)) Quantity,\r\n\t\t\t\t\t\t(newTask.Total+ISNULL(inBudModifyTask.Total,0)) Total  FROM \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT * FROM cteBudTask\r\n\t\t\t\t\t\t\tUNION\r\n\t\t\t\t\t\t\tSELECT * FROM outBudModifyInfo\r\n\t\t\t\t\t\t)newTask LEFT JOIN \r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t--清单内的变更金额\r\n\t\t\t\t\t\t\tSELECT modifyTask.TaskId,SUM(modifyTask.Quantity) Quantity,SUM(modifyTask.Total) Total from Bud_ModifyTask modifyTask\r\n\t\t\t\t\t\t\tJOIN \r\n\t\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\t\tSELECT Bud_Modify.* FROM Bud_Modify WHERE PrjId=@PrjId\r\n\t\t\t\t\t\t\t) budModify ON modifyTask.ModifyId=budModify.ModifyId \r\n\t\t\t\t\t\t\twhere budModify.FlowState=1 AND modifyType=1  group by modifyTask.TaskId\r\n\t\t\t\t\t\t) inBudModifyTask ON newTask.TaskId=inBudModifyTask.TaskId\r\n\t\t\t\t\t) tab\r\n\t\t\t\t),LastMonthCons AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--上期施工报量汇总\r\n\t\t\t\t\tSELECT TaskId,SUM(AccountingQuantity) Quantity FROM Bud_ConsReport ConsReport\r\n\t\t\t\t\tINNER JOIN Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND DATEDIFF(DD,InputDate,Convert(DATETIME,substring(@date,0,8)+'-01'))>0\r\n\t\t\t\t\tAND FlowState=1 GROUP BY TaskId\r\n\t\t\t\t),CurrentMonthCons AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--本期施工报量汇总\r\n\t\t\t\t\tSELECT TaskId,SUM(AccountingQuantity) Quantity FROM Bud_ConsReport ConsReport\r\n\t\t\t\t\tINNER JOIN Bud_ConsTask ConsTask ON ConsReport.ConsReportId=ConsTask.ConsReportId\r\n\t\t\t\t\tWHERE PrjId=@PrjId AND DATEDIFF(MONTH,InputDate,CONVERT(DATETIME,@date))=0\r\n\t\t\t\t\tAND FlowState=1 GROUP BY TaskId\r\n\t\t\t\t)\r\n\t\t\t\t,cteTask AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT cteBudTask2.TaskId,OrderNumber,TaskCode,TaskName,cteBudTask2.Total,\r\n\t\t\t\t\tCONVERT(DECIMAL(18,3),ISNULL(LastMonthCons.Quantity,0)*UnitPrice) LastMonthConsTotal,\r\n\t\t\t\t\tCONVERT(DECIMAL(18,3),ISNULL(CurrentMonthCons.Quantity,0)*UnitPrice) CurrentMonthConsTotal \r\n\t\t\t\t\tFROM cteBudTask2\r\n\t\t\t\t\tLEFT JOIN LastMonthCons ON cteBudTask2.TaskId=LastMonthCons.TaskId\r\n\t\t\t\t\tLEFT JOIN CurrentMonthCons ON cteBudTask2.TaskId=CurrentMonthCons.TaskId\r\n\t\t\t\t),cteTask2 AS\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT t2.TaskId, t2.OrderNumber, t2.TaskCode,t2.TaskName,Total,\r\n\t\t\t\t\t(SELECT SUM(cteTask.LastMonthConsTotal) FROM cteTask\r\n\t\t\t\t\t\tWHERE cteTask.OrderNumber LIKE t2.OrderNumber + '%' \r\n\t\t\t\t\t\t) AS LastMonthConsTotal,--上月的施工报量汇总小计\r\n\t\t\t\t\t(SELECT SUM(cteTask.CurrentMonthConsTotal) FROM cteTask\r\n\t\t\t\t\t\tWHERE cteTask.OrderNumber LIKE t2.OrderNumber + '%' \r\n\t\t\t\t\t\t) AS CurrentMonthConsTotal--本月的施工报量汇总小计\r\n\t\t\t\t\tFROM cteTask AS t2 \r\n\t\t\t\t),topLevel AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--查询单位工程的内容\r\n\t\t\t\t\tSELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY cteTask2.OrderNumber)) as Num, \r\n\t\t\t\t\tcteTask2.TaskId,cteTask2.OrderNumber, cteTask2.TaskCode,cteTask2.TaskName, \r\n\t\t\t\t\tISNULL(cteTask2.Total, 0) AS Total,'1' AS BudLevel,\r\n\t\t\t\t\tISNULL(LastMonthConsTotal,0) AS LastMonthConsTotal,\r\n\t\t\t\t\tISNULL(CurrentMonthConsTotal,0) AS CurrentMonthConsTotal,\r\n\t\t\t\t\t(ISNULL(LastMonthConsTotal,0)+ISNULL(CurrentMonthConsTotal,0)) SumCons\r\n\t\t\t\t\tFROM cteTask2 \r\n\t\t\t\t\tWHERE LEN(OrderNumber)/3 = 1 \r\n\t\t\t\t),secondLevel AS\r\n\t\t\t\t(\r\n\t\t\t\t\t--查询分部工程的内容\r\n\t\t\t\t\tSELECT Convert(Nvarchar(30),ROW_NUMBER() OVER(ORDER BY cteTask2.OrderNumber)) as Num,\r\n\t\t\t\t\tcteTask2.TaskId,cteTask2.OrderNumber, cteTask2.TaskCode,cteTask2.TaskName, \r\n\t\t\t\t\tISNULL(cteTask2.Total, 0) AS Total,'2' AS BudLevel,\r\n\t\t\t\t\tISNULL(LastMonthConsTotal,0) AS LastMonthConsTotal,\r\n\t\t\t\t\tISNULL(CurrentMonthConsTotal,0) AS CurrentMonthConsTotal,\r\n\t\t\t\t\t(ISNULL(LastMonthConsTotal,0)+ISNULL(CurrentMonthConsTotal,0)) SumCons\r\n\t\t\t\t\tFROM cteTask2\r\n\t\t\t\t\tWHERE LEN(OrderNumber)/3 = 2\r\n\t\t\t\t)\r\n\t\t\t\tSELECT * FROM topLevel\r\n\t\t\t\tUNION\r\n\t\t\t\tSELECT * FROM secondLevel\r\n\t\t\t\tORDER BY OrderNumber";
            }
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@Version", version), new SqlParameter("@date", date) };
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, commandParameters);
        }

        public static int GetProfitCount(string prjCode, string prjName, string userName, string prjState, string prjPeopleName, string prjStartDate, string prjEndDate)
        {
            StringBuilder builder = new StringBuilder();
            List<SqlParameter> list = new List<SqlParameter>();
            if (!string.IsNullOrEmpty(prjCode))
            {
                builder.AppendFormat(" AND prjCode LIKE '%'+@prjCode+'%' ", new object[0]);
                list.Add(new SqlParameter("@prjCode", prjCode));
            }
            if (!string.IsNullOrEmpty(prjName))
            {
                builder.AppendFormat(" AND prjName LIKE '%'+@prjName+'%' ", new object[0]);
                list.Add(new SqlParameter("@prjName", prjName));
            }
            if (!string.IsNullOrEmpty(prjState))
            {
                builder.AppendFormat(" AND PrjState = @prjState", new object[0]);
                list.Add(new SqlParameter("@prjState", prjState));
            }
            if (!string.IsNullOrEmpty(prjPeopleName))
            {
                builder.AppendFormat(" AND ProjPeopleName LIKE '%'+@prjPeopleName+'%' ", new object[0]);
                list.Add(new SqlParameter("@prjPeopleName", prjPeopleName));
            }
            if (!string.IsNullOrEmpty(prjStartDate))
            {
                builder.AppendFormat(" AND StartDate >= @prjStartDate", new object[0]);
                list.Add(new SqlParameter("@prjStartDate", prjStartDate));
            }
            if (!string.IsNullOrEmpty(prjEndDate))
            {
                builder.AppendFormat(" AND EndDate <= @prjEndDate", new object[0]);
                list.Add(new SqlParameter("@prjEndDate", prjEndDate));
            }
            string cmdText = "    \r                WITH LimitsPrj AS\t\t\t\t\t--有权限的项目\r\n                (\r\n\t                SELECT * FROM Pt_PrjInfo WHERE IsValid=1 AND \r\n\t                (PrjManager like '%'+@userName+'%' Or Podepom like '%'+@userName+'%')\r\n                ),IncometContract AS\t\t\t\t--未解除的合同信息\r\n                (\r\n\t                SELECT IncometContract.* FROM Con_Incomet_Contract IncometContract INNER JOIN LimitsPrj \r\n\t                ON IncometContract.Project=LimitsPrj.PrjGuid WHERE ConState!=4  \r\n                ),ModifyPrice AS\t\t\t\t\t--变更金额\r\n                (\r\n\t                SELECT ContractId,SUM(ChangePrice) ChangePrice FROM\r\n\t                (\r\n\t\t                SELECT IncometModifyDetail.* FROM Con_Incomet_Modify IncometModifyDetail INNER JOIN IncometContract \r\n\t\t                ON IncometModifyDetail.ContractId=IncometContract.ContractId\r\n\t                ) IncometModify GROUP BY ContractId\r\n                ),ContractInfo AS\t\t\t\t\t--项目的合同费用\r\n                (\r\n\t                SELECT Project,SUM(ContractPrice) ContractCost FROM \r\n\t                (\r\n\t\t                SELECT Project,IncometContract.ContractId,(ContractPrice+ISNULL(ChangePrice,0)) ContractPrice FROM IncometContract \r\n\t\t                LEFT JOIN ModifyPrice ON IncometContract.ContractId=ModifyPrice.ContractId \r\n\t                ) ContractInfo GROUP BY Project\r\n                ), BudTask AS\t\t\t\t\t\t--目标成本\r\n                ( \r\n                    SELECT Target.PrjId,(Target+ISNULL(ModifyAmount,0)) ResTotal  FROM (\r\n                        --原预算\r\n                        SELECT Task.PrjId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) AS Target \r\n                        FROM Bud_Task AS Task \r\n                        INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        LEFT JOIN Bud_TaskResource AS TaskRES ON Task.TaskId =TaskRES.TaskId\r\n                        WHERE TaskType=''\r\n                        GROUP BY Task.PrjId\r\n                    )AS Target \r\n                    LEFT JOIN \r\n                    (\r\n                        --预算变更\r\n                        SELECT PrjId,SUM(ResourceQuantity*ResourcePrice) ModifyAmount FROM Bud_Modify modify\r\n                        INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        INNER JOIN Bud_ModifyTaskRes modifyTaskRes ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId\r\n                        WHERE FlowState=1 Group By PrjId\t\t\t\r\n                    ) ModifyAmount ON Target.PrjId=ModifyAmount.PrjId\r\n                ),ConsInfo AS\t\t\t\t\t\t--报量成本\r\n                ( \r\n\t                SELECT PrjId,SUM(Total) ConsTotal FROM(\r\n\t\t                SELECT PrjId,CONVERT(decimal(18,3),(UnitPrice*ConsTaskRes.AccountingQuantity)) Total FROM Bud_ConsTaskRes ConsTaskRes \r\n\t\t                LEFT JOIN Bud_ConsTask ConsTask ON ConsTaskRes.ConsTaskId=ConsTask.ConsTaskId\r\n\t\t                LEFT JOIN Bud_ConsReport ConsReport ON ConsReport.ConsReportId=ConsTask.ConsReportId \r\n\t\t                WHERE FlowState=1\r\n\t                ) as ConsCost GROUP BY PrjId\r\n                ),LaborInfo AS\t\t\t\t\t\t--合同类型成本归集于人工的未解除的合同信息\r\n                    (\r\n\t                    SELECT PrjGuid,SUM(ModifiedMoney) LaborCost FROM Con_Payout_Contract payoutCon \r\n\t                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@LaborCBSCode GROUP BY PrjGuid\r\n                    ),MachineInfo AS\t\t\t\t\t--合同类型成本归集于机械的未解除的合同信息\r\n                    (\r\n\t                    SELECT PrjGuid,SUM(ModifiedMoney) MachineCost FROM Con_Payout_Contract payoutCon \r\n\t                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@MachineCBSCode GROUP BY PrjGuid\r\n                    ),OutSourceInfo AS\t\t\t\t\t--合同类型成本归集于分保费用的未解除的合同信息\r\n                    (\r\n\t                    SELECT PrjGuid,SUM(ModifiedMoney) OutSourceCost FROM Con_Payout_Contract payoutCon \r\n\t                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@OutSourceCBSCode GROUP BY PrjGuid\r\n                    ),OutInfo AS\t\t\t\t\t\t--出库信息\r\n                    (\r\n\t                    SELECT ProCode,Convert(decimal(18,3),SUM(Sprice*Number)) OutCost FROM Sm_OutReserve OutReserve \r\n\t                    INNER JOIN Sm_out_Stock outStock on OutReserve.OrCode=outStock.OrCode\r\n\t                    WHERE FlowState=1 AND IsOut=1 GROUP BY ProCode\r\n                    ),RefundingInfo AS\t\t\t\t\t--退库信息\r\n                    (\r\n\t                    SELECT ProCode,Convert(decimal(18,3),SUM(Sprice*Number)) RefundingCost FROM Sm_Refunding Refunding\r\n\t                    INNER JOIN Sm_back_Stock backStock ON Refunding.RCode=backStock.RCode\r\n\t                    WHERE flowState=1 AND IsIn=1 GROUP BY ProCode\r\n                    ),Indirect AS\r\n                    (\r\n\t                    select ProjectId,sum(Amount) IndirectCost from (\r\n\t\t                    select IndirCost.InDiaryId,ProjectId,Amount from Bud_IndirectDiaryCost IndirCost  \r\n\t\t                    left join Bud_IndirectDiaryDetails IndirDetails on  \r\n\t\t                    IndirCost.InDiaryId=IndirDetails.InDiaryId where  FlowState=1 AND CostType='P'\r\n\t                    )IndirectCost group by ProjectId\r\n                    ) \r\n                    SELECT COUNT(*) FROM \r\n                    (\r\n\t                    SELECT StartDate,EndDate,PrjState,ProjPeopleName,LimitsPrj.PrjGuid,PrjCode,PrjName,\r\n                        ISNULL(ContractCost,0) ContractCost,ISNULL(ConsTotal,0) ConsTotal,\r\n\t                    ISNULL(LaborCost,0) LaborCost,ISNULL(MachineCost,0) MachineCost,ISNULL(OutSourceCost,0)OutSourceCost,\r\n\t                    ISNULL(OutCost,0) OutCost,ISNULL(RefundingCost,0) RefundingCost,ISNULL(IndirectCost,0) IndirectCost FROM LimitsPrj \r\n\t                    LEFT JOIN ContractInfo ON LimitsPrj.PrjGuid=ContractInfo.Project \r\n\t                    LEFT JOIN ConsInfo ON LimitsPrj.PrjGuid=ConsInfo.PrjId \r\n\t                    LEFT JOIN LaborInfo ON LimitsPrj.PrjGuid=LaborInfo.PrjGuid \r\n\t                    LEFT JOIN MachineInfo ON LimitsPrj.PrjGuid=MachineInfo.PrjGuid \r\n\t                    LEFT JOIN OutSourceInfo ON LimitsPrj.PrjGuid=OutSourceInfo.PrjGuid \r\n\t                    LEFT JOIN OutInfo ON LimitsPrj.PrjGuid=OutInfo.ProCode\r\n\t                    LEFT JOIN RefundingInfo ON LimitsPrj.PrjGuid=RefundingInfo.ProCode\r\n\t                    LEFT JOIN Indirect ON LimitsPrj.PrjGuid=Indirect.ProjectId\r\n                        LEFT JOIN PT_PrjInfo_ZTB_Detail ON LimitsPrj.PrjGuid = PT_PrjInfo_ZTB_Detail.PrjGuid\r\n\t                    WHERE 1=1";
            cmdText = cmdText + builder.ToString() + " ) Data ";
            list.Add(new SqlParameter("@userName", userName));
            list.Add(new SqlParameter("@LaborCBSCode", LaborCBSCode));
            list.Add(new SqlParameter("@MachineCBSCode", MachineCBSCode));
            list.Add(new SqlParameter("@OutSourceCBSCode", OutSourceCBSCode));
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, cmdText, list.ToArray()));
        }

        public static DataTable GetProfitInfo(string prjCode, string prjName, string userName, string prjState, string prjPeopleName, string prjStartDate, string prjEndDate, int pageIndex, int pageSize, string isWBSRelevance)
        {
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            if (pageSize == 0)
            {
                pageSize = GetProfitCount(prjCode, prjName, userName, prjState, prjPeopleName, prjStartDate, prjEndDate);
            }
            string str = ConfigHelper.Get("IsIncomeContractApprove");
            List<SqlParameter> list = new List<SqlParameter>();
            string cmdText = string.Empty;
            string str3 = SetWhereCondition(prjCode, prjName, prjState, prjPeopleName, prjStartDate, prjEndDate);
            if (isWBSRelevance == "1")
            {
                cmdText = "\r\n                --DECLARE @userName nvarchar(50),@LaborCBSCode nvarchar(50),@MachineCBSCode nvarchar(50);\r\n                --DECLARE @OutSourceCBSCode nvarchar(50),@ElseCBSCode nvarchar(50),@pageSize int,@pageIndex int;\r\n                --DECLARE @prjCode nvarchar(50),@prjName nvarchar(50),@prjState nvarchar(50),@prjPeopleName nvarchar(50);\r\n                --DECLARE @prjStartDate nvarchar(50),@prjEndDate nvarchar(50)\r\n                --set @userName='00000000';\r\n                --set @LaborCBSCode='001001001';\r\n                --set @MachineCBSCode='001001003';\r\n                --set @OutSourceCBSCode='001001000';\r\n                --set @ElseCBSCode='001001999';\r\n                --set @prjCode='';\r\n                --set @prjName='';\r\n                --set @prjState='';\r\n                --set @prjPeopleName='';\r\n                --set @prjStartDate = '';\r\n                --set @prjEndDate = '';\r\n                --set @pageSize=10000;\r\n                --set @pageIndex=1;\r                WITH LimitsPrj AS\t\t\t\t\t--有权限的项目\r\n                (\r\n\t                SELECT * FROM Pt_PrjInfo WHERE IsValid=1 AND \r\n\t                (PrjManager like '%'+@userName+'%' Or Podepom like '%'+@userName+'%')\r\n                ),IncometContract AS\t\t\t\t--未解除的合同信息\r\n                (\r\n\t                SELECT IncometContract.* FROM Con_Incomet_Contract IncometContract INNER JOIN LimitsPrj \r\n\t                ON IncometContract.Project=LimitsPrj.PrjGuid WHERE ConState!=4  ";
                if (str == "1")
                {
                    cmdText = cmdText + " AND FlowState=1 ";
                }
                cmdText = cmdText + " \r\n                ),ModifyPrice AS\t\t\t\t\t--变更金额\r\n                (\r\n\t                SELECT ContractId,SUM(ChangePrice) ChangePrice FROM\r\n\t                (\r\n\t\t                SELECT IncometModifyDetail.* FROM Con_Incomet_Modify IncometModifyDetail INNER JOIN IncometContract \r\n\t\t                ON IncometModifyDetail.ContractId=IncometContract.ContractId\r\n\t                ) IncometModify GROUP BY ContractId\r\n                ),ContractInfo AS\t\t\t\t\t--项目的合同费用\r\n                (\r\n\t                SELECT Project,SUM(ContractPrice) ContractCost FROM \r\n\t                (\r\n\t\t                SELECT Project,IncometContract.ContractId,(ContractPrice+ISNULL(ChangePrice,0)) ContractPrice FROM IncometContract \r\n\t\t                LEFT JOIN ModifyPrice ON IncometContract.ContractId=ModifyPrice.ContractId \r\n\t                ) ContractInfo GROUP BY Project\r\n                ), BudTask AS\t\t\t\t\t\t--目标成本\r\n                ( \r\n                    SELECT Target.PrjId,(Target+ISNULL(ModifyAmount,0)) ResTotal  FROM (\r\n                        --原预算\r\n                        SELECT Task.PrjId,SUM(ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0)) AS Target \r\n                        FROM Bud_Task AS Task \r\n                        INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n                        LEFT JOIN Bud_TaskResource AS TaskRES ON Task.TaskId =TaskRES.TaskId\r\n                        WHERE TaskType=''\r\n                        GROUP BY Task.PrjId\r\n                    )AS Target \r\n                    LEFT JOIN \r\n                    (\r\n                        --预算变更\r\n                        SELECT PrjId,SUM(ResourceQuantity*ResourcePrice) ModifyAmount FROM Bud_Modify modify\r\n                        INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n                        INNER JOIN Bud_ModifyTaskRes modifyTaskRes ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId\r\n                        WHERE FlowState=1 Group By PrjId\t\t\t\r\n                    ) ModifyAmount ON Target.PrjId=ModifyAmount.PrjId\r\n                ),ConsInfo AS\t\t\t\t\t\t--报量成本\r\n                ( \r\n\t                SELECT PrjId,SUM(Total) ConsTotal FROM(\r\n\t\t                SELECT PrjId,CONVERT(decimal(18,3),(UnitPrice*ConsTaskRes.AccountingQuantity)) Total FROM Bud_ConsTaskRes ConsTaskRes \r\n\t\t                LEFT JOIN Bud_ConsTask ConsTask ON ConsTaskRes.ConsTaskId=ConsTask.ConsTaskId\r\n\t\t                LEFT JOIN Bud_ConsReport ConsReport ON ConsReport.ConsReportId=ConsTask.ConsReportId \r\n\t\t                WHERE FlowState=1\r\n\t                ) as ConsCost GROUP BY PrjId\r\n                ),LaborInfo AS\t\t\t\t\t\t--合同类型成本归集于人工的未解除的合同信息\r\n                (\r\n\t                SELECT PrjGuid,SUM(ModifiedMoney) LaborCost FROM Con_Payout_Contract payoutCon \r\n\t                INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                WHERE ConState!=4 AND FlowState=1 AND CBSCode=@LaborCBSCode GROUP BY PrjGuid\r\n                ),MachineInfo AS\t\t\t\t\t--合同类型成本归集于机械的未解除的合同信息\r\n                (\r\n\t                SELECT PrjGuid,SUM(ModifiedMoney) MachineCost FROM Con_Payout_Contract payoutCon \r\n\t                INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                WHERE ConState!=4 AND FlowState=1 AND CBSCode=@MachineCBSCode GROUP BY PrjGuid\r\n                ),OutSourceInfo AS\t\t\t\t\t--合同类型成本归集于分保费用的未解除的合同信息\r\n                (\r\n\t                SELECT PrjGuid,SUM(ModifiedMoney) OutSourceCost FROM Con_Payout_Contract payoutCon \r\n\t                INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                WHERE ConState!=4 AND FlowState=1 AND CBSCode=@OutSourceCBSCode GROUP BY PrjGuid\r\n                ),ElseCBSInfo AS\t\t\t\t\t--合同类型成本归集于其他的未解除的合同信息\r\n                (\r\n\t                SELECT PrjGuid,SUM(ModifiedMoney) ElseCBSCost FROM Con_Payout_Contract payoutCon \r\n\t                INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n\t                WHERE ConState!=4 AND FlowState=1 AND CBSCode=@ElseCBSCode GROUP BY PrjGuid\r\n                ),OutInfo AS\t\t\t\t\t\t--出库信息\r\n                (\r\n\t                SELECT ProCode,Convert(decimal(18,3),SUM(Sprice*Number)) OutCost FROM Sm_OutReserve OutReserve \r\n\t                INNER JOIN Sm_out_Stock outStock on OutReserve.OrCode=outStock.OrCode\r\n\t                WHERE FlowState=1 AND IsOut=1 GROUP BY ProCode\r\n                ),RefundingInfo AS\t\t\t\t\t--退库信息\r\n                (\r\n\t                SELECT ProCode,Convert(decimal(18,3),SUM(Sprice*Number)) RefundingCost FROM Sm_Refunding Refunding\r\n\t                INNER JOIN Sm_back_Stock backStock ON Refunding.RCode=backStock.RCode\r\n\t                WHERE flowState=1 AND IsIn=1 GROUP BY ProCode\r\n                ),Indirect AS\r\n                (\r\n\t                select ProjectId,sum(Amount) IndirectCost from (\r\n\t\t                select IndirCost.InDiaryId,ProjectId,Amount from Bud_IndirectDiaryCost IndirCost  \r\n\t\t                left join Bud_IndirectDiaryDetails IndirDetails on  \r\n\t\t                IndirCost.InDiaryId=IndirDetails.InDiaryId where  FlowState=1 AND CostType='P'\r\n\t                )IndirectCost group by ProjectId\r\n                )\r\n                SELECT TOP (@pageSize) Convert(Nvarchar(30),Num) Num,PrjGuid,PrjCode,PrjName,\r\n                StartDate,EndDate,PrjState,ProjPeopleName,\r\n                ContractCost,BudCost,ConsTotal,StuffCost,LaborCost,MachineCost,OutSourceCost,ElseCBSCost,DirectCost,IndirectCost,\r\n                (ContractCost-BudCost) TargetProfit,(ContractCost-(DirectCost+IndirectCost)) RealityProfit FROM \r\n                (\r\n\t                SELECT Row_Number()over(order by StartDate desc) as Num,PrjGuid,PrjCode,PrjName,ContractCost,BudCost,ConsTotal,\r\n\t                (OutCost-RefundingCost) StuffCost,LaborCost,MachineCost,OutSourceCost,ElseCBSCost,\r\n\t                ((OutCost-RefundingCost)+LaborCost+MachineCost+OutSourceCost+ElseCBSCost) DirectCost,\r\n                     IndirectCost,StartDate,EndDate,PrjState,ProjPeopleName FROM \r\n\t                (\r\n\t\t                SELECT StartDate,EndDate,PrjState,ProjPeopleName,LimitsPrj.PrjGuid,PrjCode,PrjName,\r\n                        ISNULL(ContractCost,0) ContractCost,ISNULL(ResTotal,0) BudCost,\r\n\t\t                ISNULL(ConsTotal,0) ConsTotal,ISNULL(LaborCost,0) LaborCost,ISNULL(MachineCost,0) MachineCost,\r\n\t\t                ISNULL(OutSourceCost,0)OutSourceCost,ISNULL(ElseCBSCost,0) ElseCBSCost,ISNULL(OutCost,0) OutCost,\r\n\t\t                ISNULL(RefundingCost,0) RefundingCost,ISNULL(IndirectCost,0) IndirectCost FROM LimitsPrj \r\n\t\t                LEFT JOIN ContractInfo ON LimitsPrj.PrjGuid=ContractInfo.Project \r\n\t\t                LEFT JOIN ConsInfo ON LimitsPrj.PrjGuid=ConsInfo.PrjId \r\n\t\t                LEFT JOIN LaborInfo ON LimitsPrj.PrjGuid=LaborInfo.PrjGuid \r\n\t\t                LEFT JOIN MachineInfo ON LimitsPrj.PrjGuid=MachineInfo.PrjGuid \r\n\t\t                LEFT JOIN OutSourceInfo ON LimitsPrj.PrjGuid=OutSourceInfo.PrjGuid \r\n\t\t                LEFT JOIN ElseCBSInfo ON LimitsPrj.PrjGuid=ElseCBSInfo.PrjGuid \r\n\t\t                LEFT JOIN OutInfo ON LimitsPrj.PrjGuid=OutInfo.ProCode\r\n\t\t                LEFT JOIN RefundingInfo ON LimitsPrj.PrjGuid=RefundingInfo.ProCode\r\n\t\t                LEFT JOIN Indirect ON LimitsPrj.PrjGuid=Indirect.ProjectId\r\n\t\t                LEFT JOIN BudTask ON LimitsPrj.PrjGuid=BudTask.PrjId\r\n                        LEFT JOIN PT_PrjInfo_ZTB_Detail ON LimitsPrj.PrjGuid = PT_PrjInfo_ZTB_Detail.PrjGuid\r\n\t\t                WHERE 1 = 1" + str3 + "\r\n\t                )DataDetailInfo\r\n                ) Data WHERE Num>@pageSize* (@pageIndex-1)\r\n                ";
            }
            else
            {
                cmdText = "\r\n                --DECLARE @userName nvarchar(50),@LaborCBSCode nvarchar(50),@MachineCBSCode nvarchar(50);\r\n                --DECLARE @OutSourceCBSCode nvarchar(50),@ElseCBSCode nvarchar(50),@pageSize int,@pageIndex int;\r\n                --DECLARE @prjCode nvarchar(50),@prjName nvarchar(50),@prjState nvarchar(50),@prjPeopleName nvarchar(50);\r\n                --DECLARE @prjStartDate nvarchar(50),@prjEndDate nvarchar(50);\r\n                --set @userName='00000000';\r\n                --set @LaborCBSCode='001001001';\r\n                --set @MachineCBSCode='001001003';\r\n                --set @OutSourceCBSCode='001001000';\r\n                --set @ElseCBSCode='001001999';\r\n                --set @prjCode='';\r\n                --set @prjName='';\r\n                --set @prjState='';\r\n                --set @prjPeopleName='';\r\n                --set @prjStartDate = '';\r\n                --set @prjEndDate = '';\r\n                --set @pageSize=10000;\r\n                --set @pageIndex=1;\r                WITH LimitsPrj AS\t\t\t\t\t--有权限的项目\r\n                (\r\n                    SELECT * FROM Pt_PrjInfo WHERE IsValid=1 AND (PrjManager like '%'+@userName+'%' Or Podepom like '%'+@userName+'%')\r\n                ),IncometContract AS\t\t\t\t--未解除的合同信息\r\n                (\r\n                    SELECT IncometContract.* FROM Con_Incomet_Contract IncometContract INNER JOIN LimitsPrj \r\n                    ON IncometContract.Project=LimitsPrj.PrjGuid WHERE ConState!=4   ";
                if (str == "1")
                {
                    cmdText = cmdText + " AND FlowState=1 ";
                }
                cmdText = cmdText + " \r\n                ),ModifyPrice AS\t\t\t\t\t--变更金额\r\n                (\r\n                    SELECT ContractId,SUM(ChangePrice) ChangePrice FROM\r\n                    (\r\n                        SELECT IncometModifyDetail.* FROM Con_Incomet_Modify IncometModifyDetail INNER JOIN IncometContract \r\n                        ON IncometModifyDetail.ContractId=IncometContract.ContractId\r\n                    ) IncometModify GROUP BY ContractId\r\n                ),ContractInfo AS\t\t\t\t\t--项目的合同费用\r\n                (\r\n                    SELECT Project,SUM(ContractPrice) ContractCost FROM \r\n                    (\r\n                        SELECT Project,IncometContract.ContractId,(ContractPrice+ISNULL(ChangePrice,0)) ContractPrice FROM IncometContract \r\n                        LEFT JOIN ModifyPrice ON IncometContract.ContractId=ModifyPrice.ContractId \r\n                    ) ContractInfo GROUP BY Project\r\n                ), BudTask AS\t\t\t\t\t\t--目标成本\r\n                ( \r\n\t                SELECT PrjId,SUM(BudTotal) ResTotal FROM\r\n\t                (\r\n\t\t                SELECT BudInfo.PrjId,BudInfo.TaskId,(Total+ISNUll(ModifyAmount,0)) BudTotal FROM \r\n\t\t                (\r\n\t\t\t                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,Version FROM Bud_Task AS BudTask\r\n\t\t\t                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n\t\t\t                AND BudTask.Version=vGetCurBudVersion.CurVersion \r\n\t\t\t                WHERE len(OrderNumber)=3 AND TaskType=''\r\n\t\t                ) BudInfo \r\n\t\t                LEFT JOIN \r\n\t\t                (\r\n\t\t\t                --预算变更\r\n\t\t\t                SELECT PrjId,SUM(Total) ModifyAmount,modifyTask.TaskId FROM Bud_Modify modify\r\n\t\t\t                INNER JOIN Bud_ModifyTask modifyTask ON modify.ModifyId=modifyTask.ModifyId\r\n\t\t\t                WHERE FlowState=1 AND ModifyType=1 Group By PrjId,modifyTask.TaskId  \r\n\t\t                ) modifyInfo ON BudInfo.TaskId=modifyInfo.TaskId\r\n\t                ) Bud GROUP BY PrjId\r\n                ),ConsInfo AS\t\t\t\t\t\t--报量成本\r\n                ( \r\n                  --施工报量的工程量*目标成本的综合单价\r\n                    SELECT ConsRep.PrjId,CONVERT(decimal(18,3),SUM(ISNULL(AccountingQuantity,0)*ISNULL(UnitPrice,0))) AS ConsTotal \r\n                    FROM Bud_ConsTask AS ConsTask\r\n                    LEFT JOIN Bud_ConsReport AS ConsRep ON ConsTask.ConsReportId=ConsRep.ConsReportId\r\n                    LEFT JOIN \r\n                    (\r\n                        --预算\r\n                        SELECT PrjId,TaskId,ISNULL(Total/NULLIF(Quantity,0),0) UnitPrice FROM \r\n                        (\r\n                            SELECT budInfo.PrjId,budInfo.TaskId,(budInfo.Total+ISNULL(modifyInfo.Total,0)) Total,\r\n                            (budInfo.Quantity+ISNULL(modifyInfo.Quantity,0)) Quantity FROM \r\n                            (\r\n                                --完整的预算\r\n                                SELECT BudTask.PrjId,TaskId,ISNULL(BudTask.Total,0) Total,ISNULL(Quantity,0) Quantity\r\n                                FROM Bud_Task AS BudTask \r\n                                INNER JOIN vGetCurBudVersion on BudTask.PrjId=vGetCurBudVersion.PrjId \r\n                                AND BudTask.Version=vGetCurBudVersion.CurVersion AND TaskType=''\r\n                                UNION\r\n                                SELECT PrjId,ModifyTaskId TaskId,Total,Quantity FROM Bud_Modify modify\r\n                                JOIN Bud_ModifyTask modifyTask ON modify.modifyId=modifyTask.modifyId\r\n                                WHERE flowState=1 AND ModifyType=0 \r\n                            ) budInfo\r\n                            LEFT JOIN \r\n                            (\r\n                                --清单内的预算变更\r\n                                SELECT PrjId,TaskId,Total,Quantity FROM Bud_Modify modify\r\n                                JOIN Bud_ModifyTask modifyTask ON modify.modifyId=modifyTask.modifyId\r\n                                WHERE flowState=1 AND ModifyType=1 \r\n                            ) modifyInfo ON budInfo.TaskId=modifyInfo.TaskId\r\n                        ) Bud \r\n                    ) AS BudTask ON ConsTask.TaskId=BudTask.TaskId\r\n                    WHERE flowState=1 GROUP BY ConsRep.PrjId\r\n                ),LaborInfo AS\t\t\t\t\t\t--合同类型成本归集于人工的未解除的合同信息\r\n                (\r\n                    SELECT PrjGuid,SUM(ModifiedMoney) LaborCost FROM Con_Payout_Contract payoutCon \r\n                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@LaborCBSCode GROUP BY PrjGuid\r\n                ),MachineInfo AS\t\t\t\t\t--合同类型成本归集于机械的未解除的合同信息\r\n                (\r\n                    SELECT PrjGuid,SUM(ModifiedMoney) MachineCost FROM Con_Payout_Contract payoutCon \r\n                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@MachineCBSCode GROUP BY PrjGuid\r\n                ),OutSourceInfo AS\t\t\t\t\t--合同类型成本归集于分保费用的未解除的合同信息\r\n                (\r\n                    SELECT PrjGuid,SUM(ModifiedMoney) OutSourceCost FROM Con_Payout_Contract payoutCon \r\n                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@OutSourceCBSCode GROUP BY PrjGuid\r\n                ),ElseCBSInfo AS\t\t\t\t\t--合同类型成本归集于其他的未解除的合同信息\r\n                (\r\n                    SELECT PrjGuid,SUM(ModifiedMoney) ElseCBSCost FROM Con_Payout_Contract payoutCon \r\n                    INNER JOIN Con_ContractType ConType ON payoutCon.TypeId=ConType.TypeId  \r\n                    WHERE ConState!=4 AND FlowState=1 AND CBSCode=@ElseCBSCode GROUP BY PrjGuid\r\n                ),OutInfo AS\t\t\t\t\t\t--出库信息\r\n                (\r\n                    SELECT ProCode,Convert(decimal(18,3),SUM(Sprice*Number)) OutCost FROM Sm_OutReserve OutReserve \r\n                    INNER JOIN Sm_out_Stock outStock on OutReserve.OrCode=outStock.OrCode\r\n                    WHERE FlowState=1 AND IsOut=1 GROUP BY ProCode\r\n                ),RefundingInfo AS\t\t\t\t\t--退库信息\r\n                (\r\n                    SELECT ProCode,Convert(decimal(18,3),SUM(Sprice*Number)) RefundingCost FROM Sm_Refunding Refunding\r\n                    INNER JOIN Sm_back_Stock backStock ON Refunding.RCode=backStock.RCode\r\n                    WHERE flowState=1 AND IsIn=1 GROUP BY ProCode\r\n                ),Indirect AS\r\n                (\r\n                    select ProjectId,sum(Amount) IndirectCost from (\r\n                        select IndirCost.InDiaryId,ProjectId,Amount from Bud_IndirectDiaryCost IndirCost  \r\n                        left join Bud_IndirectDiaryDetails IndirDetails on  \r\n                        IndirCost.InDiaryId=IndirDetails.InDiaryId where  FlowState=1 AND CostType='P'\r\n                    )IndirectCost group by ProjectId\r\n                )\r\n                SELECT TOP (@pageSize) Convert(Nvarchar(30),Num) Num,PrjGuid,PrjCode,PrjName,\r\n                StartDate,EndDate,PrjState,ProjPeopleName,\r\n                ContractCost,BudCost,ConsTotal,\r\n                StuffCost,LaborCost,MachineCost,OutSourceCost,ElseCBSCost,DirectCost,IndirectCost,\r\n                (ContractCost-BudCost) TargetProfit,(ContractCost-(DirectCost+IndirectCost)) RealityProfit FROM \r\n                (\r\n\t                SELECT Row_Number()over(order by StartDate desc) as Num,PrjGuid,PrjCode,PrjName,ContractCost,BudCost,ConsTotal,\r\n\t                (OutCost-RefundingCost) StuffCost,LaborCost,MachineCost,OutSourceCost,ElseCBSCost,\r\n\t                ((OutCost-RefundingCost)+LaborCost+MachineCost+OutSourceCost+ElseCBSCost) DirectCost,\r\n                    IndirectCost,StartDate,EndDate,PrjState,ProjPeopleName FROM (\r\n\t\t                SELECT StartDate,EndDate,PrjState,ProjPeopleName,LimitsPrj.PrjGuid,PrjCode,PrjName,\r\n                        ISNULL(ContractCost,0) ContractCost,ISNULL(ResTotal,0) BudCost,\r\n\t\t                ISNULL(ConsTotal,0) ConsTotal,ISNULL(LaborCost,0) LaborCost,ISNULL(MachineCost,0) MachineCost,\r\n\t\t                ISNULL(OutSourceCost,0)OutSourceCost,ISNULL(ElseCBSCost,0) ElseCBSCost,ISNULL(OutCost,0) OutCost,\r\n\t\t                ISNULL(RefundingCost,0) RefundingCost,ISNULL(IndirectCost,0) IndirectCost FROM LimitsPrj \r\n\t\t                LEFT JOIN ContractInfo ON LimitsPrj.PrjGuid=ContractInfo.Project \r\n\t\t                LEFT JOIN ConsInfo ON LimitsPrj.PrjGuid=ConsInfo.PrjId \r\n\t\t                LEFT JOIN LaborInfo ON LimitsPrj.PrjGuid=LaborInfo.PrjGuid \r\n\t\t                LEFT JOIN MachineInfo ON LimitsPrj.PrjGuid=MachineInfo.PrjGuid \r\n\t\t                LEFT JOIN OutSourceInfo ON LimitsPrj.PrjGuid=OutSourceInfo.PrjGuid \r\n\t\t                LEFT JOIN ElseCBSInfo ON LimitsPrj.PrjGuid=ElseCBSInfo.PrjGuid \r\n\t\t                LEFT JOIN OutInfo ON LimitsPrj.PrjGuid=OutInfo.ProCode\r\n\t\t                LEFT JOIN RefundingInfo ON LimitsPrj.PrjGuid=RefundingInfo.ProCode\r\n\t\t                LEFT JOIN Indirect ON LimitsPrj.PrjGuid=Indirect.ProjectId\r\n\t\t                LEFT JOIN BudTask ON LimitsPrj.PrjGuid=BudTask.PrjId\r\n                        LEFT JOIN PT_PrjInfo_ZTB_Detail ON LimitsPrj.PrjGuid = PT_PrjInfo_ZTB_Detail.PrjGuid\r\n\t\t                WHERE 1 = 1" + str3 + "\r\n\t                )DataDetailInfo\r\n                ) Data WHERE Num>@pageSize* (@pageIndex-1) ";
            }
            list.Add(new SqlParameter("@userName", userName));
            list.Add(new SqlParameter("@LaborCBSCode", LaborCBSCode));
            list.Add(new SqlParameter("@MachineCBSCode", MachineCBSCode));
            list.Add(new SqlParameter("@OutSourceCBSCode", OutSourceCBSCode));
            list.Add(new SqlParameter("@ElseCBSCode", ElseCBSCode));
            list.Add(new SqlParameter("@prjCode", prjCode));
            list.Add(new SqlParameter("@prjName", prjName));
            list.Add(new SqlParameter("@prjState", prjState));
            list.Add(new SqlParameter("@prjPeopleName", prjPeopleName));
            list.Add(new SqlParameter("@prjStartDate", prjStartDate));
            list.Add(new SqlParameter("@prjEndDate", prjEndDate));
            list.Add(new SqlParameter("@pageIndex", pageIndex));
            list.Add(new SqlParameter("@pageSize", pageSize));
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, list.ToArray());
        }

        public static string GetStateById(string id)
        {
            string state = "0";
            if (string.IsNullOrEmpty(id))
            {
                throw new ArgumentNullException("Id", "Id不能为空");
            }
            using (pm2Entities entities = new pm2Entities())
            {
                var type = (from m in entities.Bud_ConsReport
                    where m.ConsReportId == id
                    select new { State = m.State }).FirstOrDefault();
                if (type != null)
                {
                    state = type.State;
                }
                return state;
            }
        }

        public static int GetStuffCount(string ResourceCode, string ResourceName, string specification, string brand, string prjId)
        {
            StringBuilder builder = new StringBuilder();
            builder.Append("\r\n            --DECLARE @prjId NVARCHAR(50),@attribute NVARCHAR(50),@specification NVARCHAR(50),@brand NVARCHAR(50)\r\n            --SET @prjId='A25FDB14-8841-4193-9017-80D1DA6C6E10';\r\n            --SET @attribute='FF747819-77DE-4670-A4F5-8FED9A509A70';\r\n            --SET @specification='';\r\n            --SET @brand='';\r\n            WITH cteBudTask AS\r\n            (\r\n\t            --全部预算\r\n\t            SELECT ResourceId,SUM(Target) AS BudCost,SUM(ResourceQuantity) BudQuantity  FROM \r\n\t            (\r\n\t\t            SELECT TaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t            INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t            INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t            INNER JOIN Res_Resource Res ON TaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE TaskType='' AND Task.PrjId=@prjId AND Attribute=@attribute\r\n\t\t            UNION\r\n\t\t            SELECT modifyTaskRes.ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount, \r\n\t\t            ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t            INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t            INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t            INNER JOIN Res_Resource Res ON modifyTaskRes.ResourceId = Res.ResourceId\r\n\t\t            WHERE FlowState=1 AND PrjId=@prjId AND Attribute=@attribute\r\n\t            ) BudTaskRes \r\n\t            GROUP BY ResourceId \r\n            ),cteCons AS\r\n            (\r\n\t            --施工报量\r\n\t            SELECT CONSTASKRES.ResourceId,Sum(UnitPrice*CONSTASKRES.AccountingQuantity) AS ConsCost,\r\n\t            SUM(CONSTASKRES.AccountingQuantity) ConsQuantity FROM Bud_ConsTaskRes AS CONSTASKRES\r\n\t            LEFT JOIN Bud_ConsTask AS CONSTASK  ON CONSTASKRES.ConsTaskId=CONSTASK.ConsTaskId\r\n\t            LEFT JOIN Bud_ConsReport AS CONSREP ON CONSTASK.ConsReportId=CONSREP.ConsReportId\r\n\t            INNER JOIN Res_Resource Res ON CONSTASKRES.ResourceId = Res.ResourceId\t\t\r\n\t            WHERE PrjId=@prjId AND FlowState=1 \r\n\t            AND Attribute=@attribute\r\n\t            GROUP BY CONSTASKRES.ResourceId\r\n            )\r\n            SELECT COUNT(resIds.ResourceId) FROM\r\n            (\r\n\t            SELECT ResourceId FROM cteBudTask\r\n\t            UNION\r\n\t            SELECT ResourceId FROM cteCons\r\n            ) resIds\r\n            INNER JOIN Res_Resource res ON resIds.ResourceId=res.ResourceId\r\n            WHERE ResourceCode like '%'+@ResourceCode+'%' and ResourceName like '%'+@ResourceName+'%'\r\n                  and Specification like '%'+@specification+'%' and Brand like '%'+@brand+'%'\r\n            ");
            SqlParameter[] commandParameters = new SqlParameter[] { new SqlParameter("@PrjId", prjId), new SqlParameter("@ResourceCode", ResourceCode), new SqlParameter("@ResourceName", ResourceName), new SqlParameter("@specification", specification), new SqlParameter("@brand", brand), new SqlParameter("@attribute", MajorStuff) };
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, builder.ToString(), commandParameters));
        }

        public static int GetStuffCount(string resourceCode, string resourceName, string specification, string brand, string unitName, string prjId, string isWBSRelevance)
        {
            StringBuilder builder = new StringBuilder();
            List<SqlParameter> list = new List<SqlParameter>();
            if (!string.IsNullOrEmpty(resourceCode))
            {
                builder.AppendFormat(" AND ResourceCode LIKE '%'+@resourceCode+'%' ", new object[0]);
                list.Add(new SqlParameter("@resourceCode", resourceCode));
            }
            if (!string.IsNullOrEmpty(resourceName))
            {
                builder.AppendFormat(" AND ResourceName LIKE '%'+@resourceName+'%' ", new object[0]);
                list.Add(new SqlParameter("@resourceName", resourceName));
            }
            if (!string.IsNullOrEmpty(specification))
            {
                builder.AppendFormat(" AND Specification LIKE '%'+@specification+'%' ", new object[0]);
                list.Add(new SqlParameter("@specification", specification));
            }
            if (!string.IsNullOrEmpty(brand))
            {
                builder.AppendFormat(" AND Brand LIKE '%'+@brand+'%' ", new object[0]);
                list.Add(new SqlParameter("@brand", brand));
            }
            if (!string.IsNullOrEmpty(unitName))
            {
                builder.AppendFormat(" AND unit.Name LIKE '%'+@unitName+'%' ", new object[0]);
                list.Add(new SqlParameter("@unitName", unitName));
            }
            string cmdText = "    \r            --DECLARE @prjId NVARCHAR(50),@StuffCBSCode NVARCHAR(50),@specification NVARCHAR(50);\r\n            --DECLARE @brand NVARCHAR(50),@unitName NVARCHAR(50),@pageSize int,@pageIndex int\r\n            --SET @prjId='520f9cdd-f649-4e44-827d-e11a6baaaaad';\r\n            --SET @StuffCBSCode='001001002';\r\n            --SET @specification='';\r\n            --SET @brand='';\r\n            --SET @unitName='';\r\n            --SET @pageSize=1000;\r\n            --SET @pageIndex=1;\r\n            WITH BudTask AS\t\t\t\t\t\t--目标成本的用量,价格和小计\r\n            ( ";
            if (isWBSRelevance == "1")
            {
                cmdText = cmdText + "    \r\n\t                SELECT ResourceId,Convert(decimal(18,3),SUM(Target)) Total,Convert(decimal(18,3),SUM(ResourceQuantity)) ResourceQuantity,\r\n\t                Convert(decimal(18,3),ISNULL(SUM(Target)/NULLIF(SUM(ResourceQuantity),0),0)) ResourcePrice  FROM \r\n\t                (\r\n\t\t                SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t                ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t                INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t                INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t                WHERE TaskType='' AND Task.PrjId=@prjId AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t\t                UNION\r\n\t\t                SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount, \r\n\t\t                ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t                INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t                INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t                WHERE FlowState=1 AND PrjId=@prjId AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t                ) BudTaskRes \r\n\t                GROUP BY ResourceId ";
            }
            else
            {
                cmdText = cmdText + "    \r\n\t                SELECT ResourceId,SUM(ResourceQuantity) ResourceQuantity,SUM(Total) Total,\r\n\t                ISNULL(SUM(Total)/NULLIF(SUM(ResourceQuantity),0),0) ResourcePrice FROM \r\n\t                (\r\n\t\t                SELECT budTaskRes.ResourceId,ISNULL(ResourceQuantity,0) ResourceQuantity,\r\n\t\t                ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) Total \r\n\t\t                from Bud_TaskResource budTaskRes  \r\n\t\t                INNER JOIN vGetCurBudVersion ON PrjGuid=vGetCurBudVersion.PrjId AND Versions=CurVersion \r\n\t\t                where prjGuid=@prjId  AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t\t                UNION ALL\r\n\t\t                SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) Total, \r\n\t\t                ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t                INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTaskRes.ModifyId \r\n\t\t                WHERE FlowState=1 AND PrjId=@prjId AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t                ) BudTaskRes GROUP BY ResourceId ";
            }
            cmdText = (cmdText + "\r\n            ),ConsInfo AS\t\t\t\t\t\t--报量成本的用量,单价和小计\r\n            ( \r\n\t            SELECT ResourceId,ConsDetail.ResourceTypeId,ConsQuantity,UnitPrice,ConsCost,resType.CBSCode FROM (\r\n\t\t            select consTaskRes.ResourceId,dbo.ufn_GetRootResTypeId(consTaskRes.ResourceId) ResourceTypeId,\r\n\t\t            sum(consTaskRes.AccountingQuantity) ConsQuantity,UnitPrice,sum(UnitPrice*consTaskRes.AccountingQuantity) \r\n\t\t            ConsCost  from Bud_ConsTask consTask  \r\n\t\t            inner join Bud_ConsTaskRes consTaskRes on consTask.ConsTaskId=consTaskRes.ConsTaskId inner join Res_Resource resource  \r\n\t\t            on consTaskRes.ResourceId=resource.ResourceId where ConsReportId in (select ConsReportId from Bud_ConsReport where  \r\n\t\t            prjId=@prjId and IsValid=1 and FlowState=1)\r\n\t\t            group by consTaskRes.ResourceId,UnitPrice\r\n\t            ) ConsDetail INNER JOIN Res_ResourceType resType ON ConsDetail.ResourceTypeId=resType.ResourceTypeId\r\n\t            WHERE CBSCode=@StuffCBSCode\r\n            ),OutInfo AS\t\t\t\t\t\t--出库信息\r\n            (\r\n\t            SELECT SCode,Sprice,SUM(Number) Number,Convert(decimal(18,3),SUM(Sprice*Number)) OutCost\r\n\t            FROM Sm_OutReserve OutReserve \r\n\t            INNER JOIN Sm_out_Stock outStock on OutReserve.OrCode=outStock.OrCode\r\n\t            WHERE ProCode=@prjId AND FlowState=1 AND IsOut=1\r\n\t            GROUP BY SCode,Sprice\r\n            ),RefundingInfo AS\t\t\t\t\t--退库信息\r\n            (\r\n\t            SELECT SCode,Sprice,SUM(Number) Number,Convert(decimal(18,3),SUM(Sprice*Number)) RefundingCost \r\n\t            FROM Sm_Refunding Refunding\r\n\t            INNER JOIN Sm_back_Stock backStock ON Refunding.RCode=backStock.RCode\r\n\t            WHERE ProCode=@prjId AND flowState=1 AND IsIn=1 \r\n\t            GROUP BY SCode,Sprice    \r\n            ),RealityInfo AS\t\t\t\t\t--实际用量信息\r\n            (\r\n\t            SELECT ResourceId,SCode,Sprice,Number,RealityCost,RealityDetail.ResourceTypeId,CBSCode FROM \r\n\t            (\r\n\t\t            SELECT SCode,Sprice,Number,RealityCost,res.ResourceId,dbo.ufn_GetRootResTypeId(res.ResourceId) ResourceTypeId \r\n\t\t            FROM (\r\n\t\t\t            SELECT OutInfo.SCode,OutInfo.Sprice,(OutInfo.Number-ISNULL(RefundingInfo.Number,0)) Number,\r\n\t\t\t            (OutCost-ISNULL(RefundingCost,0)) RealityCost\r\n\t\t\t            FROM OutInfo LEFT JOIN RefundingInfo ON OutInfo.SCode=RefundingInfo.SCode\r\n\t\t\t            ) RealityCost \tINNER JOIN Res_Resource res ON RealityCost.SCode=res.ResourceCode \r\n\t            ) RealityDetail INNER JOIN Res_ResourceType resType ON RealityDetail.ResourceTypeId=resType.ResourceTypeId\r\n\t            WHERE CBSCode=@StuffCBSCode \r\n            ),AllRes AS\r\n            (\r\n\t            SELECT ResourceId,ResourcePrice sprice FROM BudTask \r\n\t            UNION\r\n\t            SELECT ResourceId,UnitPrice sprice FROM ConsInfo\r\n\t            UNION \r\n\t            SELECT ResourceId,Sprice  FROM RealityInfo\r\n            )\r\n            SELECT COUNT(*) FROM \r\n            (\r\n\t            SELECT AllRes.ResourceId,ResourceCode,ResourceName,Specification,Brand,unit.Name as UnitName,\r\n                ISNULL(ResourceQuantity,0) BudQuantity,\r\n\t            ISNULL(ResourcePrice,0) BudPrice,ISNULL(total,0) BudTotal,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t            ISNULL(UnitPrice,0) ConsPrice,ISNULL(ConsCost,0) ConsTotal,ISNULL(RealityInfo.Sprice,0)RealityPrice,\r\n\t            ISNULL(Number,0) RealityNumber,ISNULL(RealityCost,0) RealityTotal FROM AllRes \r\n\t            LEFT JOIN BudTask ON AllRes.ResourceId=BudTask.ResourceId AND AllRes.sprice=BudTask.ResourcePrice\r\n\t            LEFT JOIN ConsInfo ON AllRes.ResourceId=ConsInfo.ResourceId AND  AllRes.sprice=ConsInfo.UnitPrice\r\n\t            LEFT JOIN RealityInfo ON AllRes.ResourceId=RealityInfo.ResourceId AND AllRes.sprice=RealityInfo.Sprice\r\n\t            INNER JOIN Res_Resource res ON AllRes.ResourceId=res.ResourceId\r\n                LEFT JOIN Res_Unit unit ON res.Unit=unit.UnitId\r\n                WHERE 1=1 ") + builder.ToString() + " ) ResInfo ";
            list.Add(new SqlParameter("@prjId", prjId));
            list.Add(new SqlParameter("@StuffCBSCode", StuffCBSCode));
            return DBHelper.GetInt(SqlHelper.ExecuteScalar(CommandType.Text, cmdText, list.ToArray()));
        }

        public static DataTable GetStuffInfo(string resourceCode, string resourceName, string specification, string brand, string unitName, string prjId, int pageIndex, int pageSize, string isWBSRelevance)
        {
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            if (pageSize == 0)
            {
                pageSize = GetStuffCount(resourceCode, resourceName, specification, brand, unitName, prjId, isWBSRelevance);
            }
            StringBuilder builder = new StringBuilder();
            List<SqlParameter> list = new List<SqlParameter>();
            if (!string.IsNullOrEmpty(resourceCode))
            {
                builder.AppendFormat(" AND ResourceCode LIKE '%'+@resourceCode+'%' ", new object[0]);
                list.Add(new SqlParameter("@resourceCode", resourceCode));
            }
            if (!string.IsNullOrEmpty(resourceName))
            {
                builder.AppendFormat(" AND ResourceName LIKE '%'+@resourceName+'%' ", new object[0]);
                list.Add(new SqlParameter("@resourceName", resourceName));
            }
            if (!string.IsNullOrEmpty(specification))
            {
                builder.AppendFormat(" AND Specification LIKE '%'+@specification+'%' ", new object[0]);
                list.Add(new SqlParameter("@specification", specification));
            }
            if (!string.IsNullOrEmpty(brand))
            {
                builder.AppendFormat(" AND Brand LIKE '%'+@brand+'%' ", new object[0]);
                list.Add(new SqlParameter("@brand", brand));
            }
            if (!string.IsNullOrEmpty(unitName))
            {
                builder.AppendFormat(" AND unit.Name LIKE '%'+@unitName+'%' ", new object[0]);
                list.Add(new SqlParameter("@unitName", unitName));
            }
            string cmdText = "    \r            --DECLARE @prjId NVARCHAR(50),@StuffCBSCode NVARCHAR(50),@specification NVARCHAR(50);\r\n            --DECLARE @brand NVARCHAR(50),@unitName NVARCHAR(50),@pageSize int,@pageIndex int\r\n            --SET @prjId='520f9cdd-f649-4e44-827d-e11a6baaaaad';\r\n            --SET @StuffCBSCode='001001002';\r\n            --SET @specification='';\r\n            --SET @brand='';\r\n            --SET @unitName='';\r\n            --SET @pageSize=1000;\r\n            --SET @pageIndex=1;\r\n            WITH BudTask AS\t\t\t\t\t\t--目标成本的用量,价格和小计\r\n            ( ";
            if (isWBSRelevance == "1")
            {
                cmdText = cmdText + "    \r\n\t                SELECT ResourceId,Convert(decimal(18,3),SUM(Target)) Total,Convert(decimal(18,3),SUM(ResourceQuantity)) ResourceQuantity,\r\n\t                Convert(decimal(18,3),ISNULL(SUM(Target)/NULLIF(SUM(ResourceQuantity),0),0)) ResourcePrice  FROM \r\n\t                (\r\n\t\t                SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) AS Target,\r\n\t\t                ISNULL(ResourceQuantity,0) ResourceQuantity\tFROM Bud_TaskResource TaskRes \r\n\t\t                INNER JOIN Bud_Task AS Task ON Task.TaskId =TaskRes.TaskId \r\n\t\t                INNER JOIN vGetCurBudVersion ON Task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion \r\n\t\t                WHERE TaskType='' AND Task.PrjId=@prjId AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t\t                UNION\r\n\t\t                SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) ModifyAmount, \r\n\t\t                ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t                INNER JOIN Bud_ModifyTask modifyTask ON modifyTask.ModifyTaskId=modifyTaskRes.ModifyTaskId \r\n\t\t                INNER JOIN Bud_Modify modify ON  modify.ModifyId=modifyTask.ModifyId \r\n\t\t                WHERE FlowState=1 AND PrjId=@prjId AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t                ) BudTaskRes \r\n\t                GROUP BY ResourceId ";
            }
            else
            {
                cmdText = cmdText + "    \r\n\t                SELECT ResourceId,SUM(ResourceQuantity) ResourceQuantity,SUM(Total) Total,\r\n\t                ISNULL(SUM(Total)/NULLIF(SUM(ResourceQuantity),0),0) ResourcePrice FROM \r\n\t                (\r\n\t\t                SELECT budTaskRes.ResourceId,ISNULL(ResourceQuantity,0) ResourceQuantity,\r\n\t\t                ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) Total \r\n\t\t                from Bud_TaskResource budTaskRes  \r\n\t\t                INNER JOIN vGetCurBudVersion ON PrjGuid=vGetCurBudVersion.PrjId AND Versions=CurVersion \r\n\t\t                where prjGuid=@prjId  AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t\t                UNION ALL\r\n\t\t                SELECT ResourceId,ISNULL(ResourceQuantity,0)*ISNULL(ResourcePrice,0) Total, \r\n\t\t                ISNULL(ResourceQuantity,0) ResourceQuantity FROM Bud_ModifyTaskRes modifyTaskRes \r\n\t\t                INNER JOIN Bud_Modify modify ON modify.ModifyId=modifyTaskRes.ModifyId \r\n\t\t                WHERE FlowState=1 AND PrjId=@prjId AND \r\n\t\t                dbo.GetResourceType(ResourceId) IN (SELECT ResourceTypeId FROM Res_ResourceType WHERE CBSCode=@StuffCBSCode)\r\n\t                ) BudTaskRes GROUP BY ResourceId ";
            }
            cmdText = (cmdText + "    \r\n            ),ConsInfo AS\t\t\t\t\t\t--报量成本的用量,单价和小计\r\n            ( \r\n\t            SELECT ResourceId,ConsDetail.ResourceTypeId,ConsQuantity,UnitPrice,ConsCost,resType.CBSCode FROM (\r\n\t\t            select consTaskRes.ResourceId,dbo.ufn_GetRootResTypeId(consTaskRes.ResourceId) ResourceTypeId,\r\n\t\t            sum(consTaskRes.AccountingQuantity) ConsQuantity,UnitPrice,Convert(decimal(18,3),sum(UnitPrice*consTaskRes.AccountingQuantity))\r\n\t\t            ConsCost  from Bud_ConsTask consTask  \r\n\t\t            inner join Bud_ConsTaskRes consTaskRes on consTask.ConsTaskId=consTaskRes.ConsTaskId inner join Res_Resource resource  \r\n\t\t            on consTaskRes.ResourceId=resource.ResourceId where ConsReportId in (select ConsReportId from Bud_ConsReport where  \r\n\t\t            prjId=@prjId and IsValid=1 and FlowState=1)\r\n\t\t            group by consTaskRes.ResourceId,UnitPrice\r\n\t            ) ConsDetail INNER JOIN Res_ResourceType resType ON ConsDetail.ResourceTypeId=resType.ResourceTypeId\r\n\t            WHERE CBSCode=@StuffCBSCode\r\n            ),OutInfo AS\t\t\t\t\t\t--出库信息\r\n            (\r\n\t            SELECT SCode,Sprice,SUM(Number) Number,Convert(decimal(18,3),SUM(Sprice*Number)) OutCost\r\n\t            FROM Sm_OutReserve OutReserve \r\n\t            INNER JOIN Sm_out_Stock outStock on OutReserve.OrCode=outStock.OrCode\r\n\t            WHERE ProCode=@prjId AND FlowState=1 AND IsOut=1\r\n\t            GROUP BY SCode,Sprice\r\n            ),RefundingInfo AS\t\t\t\t\t--退库信息\r\n            (\r\n\t            SELECT SCode,Sprice,SUM(Number) Number,Convert(decimal(18,3),SUM(Sprice*Number)) RefundingCost \r\n\t            FROM Sm_Refunding Refunding\r\n\t            INNER JOIN Sm_back_Stock backStock ON Refunding.RCode=backStock.RCode\r\n\t            WHERE ProCode=@prjId AND flowState=1 AND IsIn=1 \r\n\t            GROUP BY SCode,Sprice    \r\n            ),RealityInfo AS\t\t\t\t\t--实际用量信息\r\n            (\r\n\t            SELECT ResourceId,SCode,Sprice,Number,RealityCost,RealityDetail.ResourceTypeId,CBSCode FROM \r\n\t            (\r\n\t\t            SELECT SCode,Sprice,Number,RealityCost,res.ResourceId,dbo.ufn_GetRootResTypeId(res.ResourceId) ResourceTypeId \r\n\t\t            FROM (\r\n\t\t\t            SELECT OutInfo.SCode,OutInfo.Sprice,(OutInfo.Number-ISNULL(RefundingInfo.Number,0)) Number,\r\n\t\t\t            (OutCost-ISNULL(RefundingCost,0)) RealityCost\r\n\t\t\t            FROM OutInfo LEFT JOIN RefundingInfo ON OutInfo.SCode=RefundingInfo.SCode  AND OutInfo.Sprice=RefundingInfo.Sprice \r\n\t\t\t            ) RealityCost \tINNER JOIN Res_Resource res ON RealityCost.SCode=res.ResourceCode \r\n\t            ) RealityDetail INNER JOIN Res_ResourceType resType ON RealityDetail.ResourceTypeId=resType.ResourceTypeId\r\n\t            WHERE CBSCode=@StuffCBSCode \r\n            ),AllRes AS\r\n            (\r\n\t            SELECT ResourceId,ResourcePrice sprice FROM BudTask \r\n\t            UNION\r\n\t            SELECT ResourceId,UnitPrice sprice FROM ConsInfo\r\n\t            UNION \r\n\t            SELECT ResourceId,Sprice  FROM RealityInfo\r\n            )\r\n            SELECT TOP(@pageSize)CONVERT(NVARCHAR(30),Num) Num,ResourceId,ResourceCode,ResourceName,Specification,Brand,UnitName,\r\n            BudQuantity,ConsQuantity,RealityNumber,BudPrice,ConsPrice,RealityPrice,BudTotal,ConsTotal,RealityTotal FROM (\r\n             SELECT Row_Number()over(order by ResourceCode) as Num,ResInfo.* FROM\r\n            (\r\n\t            SELECT AllRes.ResourceId,ResourceCode,ResourceName,Specification,Brand,unit.Name as UnitName,\r\n                ISNULL(ResourceQuantity,0) BudQuantity,\r\n\t            ISNULL(ResourcePrice,0) BudPrice,ISNULL(total,0) BudTotal,ISNULL(ConsQuantity,0) ConsQuantity,\r\n\t            ISNULL(UnitPrice,0) ConsPrice,ISNULL(ConsCost,0) ConsTotal,ISNULL(RealityInfo.Sprice,0)RealityPrice,\r\n\t            ISNULL(Number,0) RealityNumber,ISNULL(RealityCost,0) RealityTotal FROM AllRes \r\n\t            LEFT JOIN BudTask ON AllRes.ResourceId=BudTask.ResourceId AND AllRes.sprice=BudTask.ResourcePrice\r\n\t            LEFT JOIN ConsInfo ON AllRes.ResourceId=ConsInfo.ResourceId AND  AllRes.sprice=ConsInfo.UnitPrice\r\n\t            LEFT JOIN RealityInfo ON AllRes.ResourceId=RealityInfo.ResourceId AND AllRes.sprice=RealityInfo.Sprice\r\n\t            INNER JOIN Res_Resource res ON AllRes.ResourceId=res.ResourceId\r\n                LEFT JOIN Res_Unit unit ON res.Unit=unit.UnitId\r\n                WHERE 1=1 ") + builder.ToString() + " ) ResInfo) DATA WHERE Num>@pageSize*(@pageIndex-1) ";
            list.Add(new SqlParameter("@prjId", prjId));
            list.Add(new SqlParameter("@StuffCBSCode", StuffCBSCode));
            list.Add(new SqlParameter("@pageSize", pageSize));
            list.Add(new SqlParameter("@pageIndex", pageIndex));
            return SqlHelper.ExecuteQuery(CommandType.Text, cmdText, list.ToArray());
        }

        private static string SetWhereCondition(string prjCode, string prjName, string prjState, string prjPeopleName, string prjStartDate, string prjEndDate)
        {
            StringBuilder builder = new StringBuilder();
            if (!string.IsNullOrEmpty(prjCode))
            {
                builder.AppendFormat(" AND prjCode LIKE '%'+@prjCode+'%' ", new object[0]);
            }
            if (!string.IsNullOrEmpty(prjName))
            {
                builder.AppendFormat(" AND prjName LIKE '%'+@prjName+'%' ", new object[0]);
            }
            if (!string.IsNullOrEmpty(prjState))
            {
                builder.AppendFormat(" AND PrjState = @prjState ", new object[0]);
            }
            if (!string.IsNullOrEmpty(prjPeopleName))
            {
                builder.AppendFormat(" AND ProjPeopleName LIKE '%'+@prjPeopleName+'%' ", new object[0]);
            }
            if (!string.IsNullOrEmpty(prjStartDate))
            {
                builder.AppendFormat(" AND StartDate >= @prjStartDate ", new object[0]);
            }
            if (!string.IsNullOrEmpty(prjEndDate))
            {
                builder.AppendFormat(" AND EndDate <= @prjEndDate ", new object[0]);
            }
            return builder.ToString();
        }

        public void Update(ConstructReport consReport)
        {
            using (pm2Entities entities = new pm2Entities())
            {
                Bud_ConsReport report = (from m in entities.Bud_ConsReport
                    where m.ConsReportId == consReport.Id
                    select m).FirstOrDefault<Bud_ConsReport>();
                if (report != null)
                {
                    report.WorkCard = consReport.WorkCard;
                    report.InputUser = consReport.InputUser;
                    report.InputDate = consReport.InputDate;
                    report.IsValid = new bool?(consReport.IsValid);
                    entities.SaveChanges();
                }
                else
                {
                    this.Add(consReport);
                }
            }
        }

        public string CancelAuditReason { get; set; }

        public string CancelReportReason { get; set; }

        public IList<ConstructTask> ConstructTaskList
        {
            get
            {
                if (this.constructTaskList == null)
                {
                    this.constructTaskList = ConstructTask.GetyByReportId(this.Id);
                }
                return this.constructTaskList;
            }
            set
            {
                this.constructTaskList = value;
            }
        }

        public int FlowState { get; set; }

        public string Id { get; set; }

        public DateTime InputDate { get; set; }

        public string InputUser { get; set; }

        public bool IsValid { get; set; }

        public string ProjectId { get; set; }

        public string State { get; set; }

        public string WorkCard { get; set; }
    }
}

