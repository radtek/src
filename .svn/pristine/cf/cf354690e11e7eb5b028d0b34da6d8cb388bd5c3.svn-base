namespace cn.justwin.Domain.Services
{
    using cn.justwin.Domain.Entities;
    using cn.justwin.Domain.Repositories;
    using System;
    using System.Data;
    using System.Data.SqlClient;
    using System.Linq;
    using System.Text;

    public class EquEquipmentService : Repository<EquEquipment>
    {
        public EquEquipment GetById(string id)
        {
            return (from e in this
                where e.Id == id
                select e).FirstOrDefault<EquEquipment>();
        }

        public DataTable GetEquEquipmentInfo(string equTypeId, string state, string property, string equCode, string equName)
        {
            StringBuilder builder = new StringBuilder();
            if (!string.IsNullOrEmpty(equTypeId))
            {
                builder.AppendFormat(" AND Equ_Type.Id = '{0}'", equTypeId);
            }
            if (!string.IsNullOrEmpty(state))
            {
                builder.AppendFormat(" AND Equ.State = {0}", Convert.ToInt32(state));
            }
            if (!string.IsNullOrEmpty(property))
            {
                builder.AppendFormat(" AND Equ.EquProperty = {0}", Convert.ToInt32(property));
            }
            if (!string.IsNullOrEmpty(equCode))
            {
                builder.AppendFormat(" AND EquCode LIKE '%{0}%'", equCode);
            }
            if (!string.IsNullOrEmpty(equName))
            {
                builder.AppendFormat(" AND EquName LIKE '%{0}%'", equName);
            }
            string str = "WITH Equ_State AS (\r\n                            SELECT ItemCode, ItemName FROM Basic_CodeList WHERE TypeCode = 'EquState'\r\n                           ),Equ_Property AS (\r\n                            SELECT ItemCode, ItemName FROM Basic_CodeList WHERE TypeCode = 'EquProperty'\r\n                           )\r\n                           SELECT ROW_NUMBER() OVER (ORDER BY InputDate DESC) AS Num, Equ.Id, EquCode, EquName,\r\n                                  Equ_Type.Name AS TypeName, Equ_State.ItemName AS StateName, Equ_Property.ItemName AS PropertyName,\r\n                                  ReceiptNo, Equ.SupplierId, State, EquProperty, Equ.Note\r\n                           FROM  Equ_Equipment AS Equ LEFT JOIN Equ_EquipmentType AS Equ_Type ON Equ.TypeId = Equ_Type.ID\r\n                                 LEFT JOIN Equ_State ON Equ.State = Equ_State.ItemCode\r\n                                 LEFT JOIN Equ_Property ON Equ.EquProperty =  Equ_Property.ItemCode\r\n                           WHERE 1 = 1";
            return base.ExecuteQuery(str + builder.ToString(), new SqlParameter[0]);
        }

        public DataTable GetRoadReport(string equCode, string equName, string date, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = this.GetShipReportCount(equCode, equName, date);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            string cmdText = "\r\n\t\t\t--DECLARE @equipmentCode nvarchar(50),@equipmentName nvarchar(50),@date nvarchar(50),\r\n\t\t\t--@SalaryItemId nvarchar(50),@pageSize int,@pageIndex int\r\n\t\t\t--SET @equipmentCode=''\r\n\t\t\t--SET @equipmentName=''\r\n\t\t\t--SET @date='2013-9-01'\r\n\t\t\t--SET @SalaryItemId='F397D994-993E-40BE-B0C3-B10156AF4183'\r\n\t\t\t--SET @pageSize=50\r\n\t\t\t--SET @pageIndex=1;\r\n\t\t\tWITH cteTeamReport AS\r\n\t\t\t(\r\n\t\t\t\t--陆上设备按台班上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,TeamQty Qty\r\n\t\t\t\tFROM Equ_RoadTeamReport WHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t),cteDumpReport AS\r\n\t\t\t(\r\n\t\t\t\t--自卸车上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,CubeQty Qty FROM Equ_RoadDumpReport\r\n\t\t\t\tWHERE FlowState=1  AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteDrillReport AS\r\n\t\t\t(\r\n\t\t\t\t--钻孔机上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,TotalLength Qty FROM Equ_RoadDrillReport\r\n\t\t\t\tWHERE FlowState=1  AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteMixerReport AS\r\n\t\t\t(\r\n\t\t\t\t--搅拌机上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,AffirmCubeQty Qty FROM Equ_RoadMixerReport\r\n\t\t\t\tWHERE FlowState=1  AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteDrainReport AS\r\n\t\t\t(\r\n\t\t\t\t--排水板设备上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,ConstructionQty Qty FROM Equ_RoadDrainReport\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteInterlockReport AS\r\n\t\t\t(\r\n\t\t\t\t--预制联锁块上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,Qty FROM Equ_RoadInterlockReport\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteElseReport AS\r\n\t\t\t(\r\n\t\t\t\t--其他设备上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,Qty from Equ_RoadElseReport\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteTeamSumQty AS\r\n\t\t\t(\r\n\t\t\t\tSELECT EquipmentId,SUM(Qty) Qty FROM cteTeamReport\r\n\t\t\t\tGROUP BY EquipmentId\r\n\t\t\t),cteSumQty AS\r\n\t\t\t(\r\n\t\t\t\tSELECT EquipmentId,SUM(Qty) Qty FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM cteDumpReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteDrillReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteMixerReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteDrainReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteInterlockReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t) reportSumQty GROUP BY EquipmentId\r\n\t\t\t),cteAllEqu AS\r\n\t\t\t(\r\n\t\t\t\t\t--陆上设备引用的项目ID及产量上报总和\r\n\t\t\t\t\tSELECT PrjId,EquipmentId,ResourceId,SUM(Qty) Qty FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT * FROM cteTeamReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDumpReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrillReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteMixerReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrainReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteInterlockReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t\t) allEqu \r\n\t\t\t\t\tINNER JOIN Equ_Equipment equipment ON allEqu.EquipmentId=equipment.Id\r\n\t\t\t\t\tGROUP BY PrjId,EquipmentId,ResourceId\r\n\t\t\t),cteBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--原目标成本\r\n\t\t\t\tSELECT task.PrjId,taskRes.ResourceId,ResourceQuantity,ResourcePrice FROM Bud_Task task \r\n\t\t\t\tINNER JOIN vGetCurBudVersion ON task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t\tINNER JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON task.PrjId=prjIds.PrjId AND taskRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE TaskType='' \r\n\t\t\t),cteBudModifyRes AS\r\n\t\t\t(\r\n\t\t\t\t--预算变更的资源\r\n\t\t\t\tSELECT budModify.PrjId,budModifyRes.ResourceId,ResourceQuantity,ResourcePrice \r\n\t\t\t\tFROM Bud_Modify budModify\r\n\t\t\t\tINNER JOIN Bud_ModifyTaskRes budModifyRes ON budModify.ModifyId=budModifyRes.ModifyId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\t--产量上报中的项目\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON budModify.PrjId=prjIds.PrjId AND budModifyRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t),cteAllBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--报量中涉及到的项目预算中,此资源的工程量及小计和\r\n\t\t\t\tSELECT PrjId,ResourceId,SUM(ResourceQuantity) BudResQty, \r\n \t\t\t\tSUM(ResourceQuantity*ResourcePrice) BudResTotal FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM cteBudRes\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteBudModifyRes\r\n\t\t\t\t) budRes GROUP BY PrjId,ResourceId\r\n\t\t\t),cteEquPrjBuds AS\r\n\t\t\t(\r\n\t\t\t\t--陆上设备引用的上报产量、项目名称及预算\r\n\t\t\t\tSELECT cteAllEqu.EquipmentId,SUM(Qty) Qty,SUM(BudResQty) BudResQty,\r\n\t\t\t\tSUM(BudResTotal) BudResTotal,STUFF((SELECT ','+PrjName FROM cteAllEqu allEqu\r\n\t\t\t\tLEFT JOIN Pt_PrjInfo ON allEqu.PrjId = CONVERT(NVARCHAR(50),Pt_PrjInfo.PrjGuid) \r\n\t\t\t\tWHERE allEqu.EquipmentId=cteAllEqu.EquipmentId  FOR XML PATH('')),1,1,'') PrjNames\r\n\t\t\t\tFROM cteAllEqu  \r\n\t\t\t\tLEFT JOIN cteAllBudRes ON cteAllEqu.PrjId=cteAllBudRes.PrjId \r\n\t\t\t\tAND cteAllEqu.ResourceId=cteAllBudRes.ResourceId\r\n\t\t\t\tGROUP BY cteAllEqu.EquipmentId\r\n\t\t\t),cteEquSalary AS\r\n\t\t\t(\r\n\t\t\t\t--设备需用的员工工资\r\n\t\t\t\tSELECT EquipmentId,SUM(Cost) SalaryCost FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,equUser.UserCode,ISNULL(Cost,0) Cost \r\n\t\t\t\t\tFROM Equ_EquipmentUser equUser\r\n\t\t\t\t\tLEFT JOIN \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT UserCode,Cost FROM\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT monthSalary.UserCode,Cost,Convert(NVARCHAR(50),monthSalary.Year)\r\n\t\t\t\t\t\t\t+'-'+Convert(NVARCHAR(50),monthSalary.Month)+'-1' SalaryDate\r\n\t\t\t\t\t\t\tFROM SA_MonthSalary monthSalary\r\n\t\t\t\t\t\t\tINNER JOIN SA_Payoff payoff ON monthSalary.UserCode=payoff.UserCode \r\n\t\t\t\t\t\t\tAND monthSalary.Year=payoff.Year AND monthSalary.Month=payoff.Month\r\n\t\t\t\t\t\t\tWHERE ItemId=@SalaryItemId AND IsPayoff=1\r\n\t\t\t\t\t\t) userSalary WHERE DATEDIFF(MM,SalaryDate,@date)=0\r\n\t\t\t\t\t) salary ON equUser.UserCode=salary.UserCode\r\n\t\t\t\t) equSalary GROUP BY EquipmentId\r\n\t\t\t),cteEquUser AS\r\n\t\t\t(\r\n\t\t\t\t--设备人员\r\n\t\t\t\tSELECT EquipmentId,STUFF((SELECT ','+v_xm FROM  Equ_EquipmentUser equUser\r\n\t\t\t\tLEFT JOIN PT_yhmc yhmc ON equUser.UserCode=v_yhdm \r\n\t\t\t\tWHERE equUser.EquipmentId=EquipmentUser.EquipmentId FOR XML PATH('')),1,1,'') UserNames\r\n\t\t\t\tFROM Equ_EquipmentUser EquipmentUser GROUP BY EquipmentId\r\n\t\t\t),cteConstructionDates AS\r\n\t\t\t(\r\n\t\t\t\t--设备月实做天数\r\n\t\t\t\tSELECT EquipmentId,COUNT(*) ConstructionDates FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,ConstructionDate,SUM(Qty) Qty FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT * FROM cteTeamReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDumpReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrillReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteMixerReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrainReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteInterlockReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t\t) equConstructionDate WHERE ConstructionDate IS NOT NULL\r\n\t\t\t\t\tGROUP BY EquipmentId,ConstructionDate\r\n\t\t\t\t) constructionDates GROUP BY EquipmentId \r\n\t\t\t),cteEquRepairDates AS\r\n\t\t\t(\r\n\t\t\t\t--陆上设备维修时间\r\n\t\t\t\tSELECT EquipmentId,SUM(RepairDates) RepairDates FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,(CASE \r\n\t\t\t\t\t--当维修开始时间，结束时间都在本月内时，维修时间=结束时间-开始时间\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)=0 and DATEDIFF(MM,RepairEndDate,@date)=0 \r\n\t\t\t\t\tTHEN (DATEDIFF(dd,RepairStartDate,RepairEndDate))+1\r\n\t\t\t\t\t--当维修开始时间小于本月时间，结束时间在本月内时，维修时间=结束时间-本月第一天\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)>0 AND DATEDIFF(MM,RepairEndDate,@date)=0 \r\n\t\t\t\t\tTHEN (DATEDIFF(dd,@date,RepairEndDate))+1\r\n\t\t\t\t\t--当维修开始时间在本月内，结束时间大于本月时间时，维修时间=下月第一天-维修开始时间\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)=0 AND DATEDIFF(MM,RepairEndDate,@date)<0 \r\n\t\t\t\t\tTHEN (DATEDIFF(dd,RepairStartDate, DATEADD(MM,1,@date)))\r\n\t\t\t\t\t--当维修开始时间小于本月时间，结束时间大于本月时间时，维修时间=当月天数\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)>0 AND DATEDIFF(MM,RepairEndDate,@date)<0 \r\n\t\t\t\t\tTHEN DATEDIFF(dd,@date, DATEADD(MM,1,@date))\r\n\t\t\t\t\tELSE 0\t\t--其余的条件，维修时间=0\r\n\t\t\t\t\tend) RepairDates\r\n\t\t\t\t\tFROM Equ_RepairReport repairReport\r\n\t\t\t\t\tLEFT JOIN Equ_RepairApply repairApply ON repairReport.ApplyId=repairApply.Id \r\n\t\t\t\t\tWHERE repairReport.FlowState=1 AND repairReport.EquipmentType=1\r\n\t\t\t\t\tAND DATEDIFF(MM,RepairStartDate,@date)>=0 AND DATEDIFF(MM,RepairEndDate,@date)<=0\r\n\t\t\t\t) equRepairDates GROUP BY EquipmentId\r\n\t\t\t),cteRefuelInfo AS\r\n\t\t\t(\r\n\t\t\t\t--当月陆上设备出库登记记录\r\n\t\t\t\tSELECT EquipmentId,SUM(Quantity) RefuelQty, SUM(Quantity*UnitPrice) RefuelAmount FROM Equ_OilOut\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,OutDate,@date)=0 \r\n\t\t\t\tGROUP BY EquipmentId\r\n\t\t\t)\r\n\t\t\tSELECT TOP(@pageSize) CONVERT(NVARCHAR(20),Num) Num,EquipmentCode,ResourceName,Specification,PrjNames,\r\n\t\t\tUserNames,PurchasePrice,UnitName,BudPrice,SumQty,TeamQty,Amount,TotalCost,\r\n\t\t\tConstructionDates,ConstructionDatesRate,InGoodDays,MonthTotalDates,InGoodDaysRate,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(RefuelQty/NULLIF(Qty,0),0)) UnitRefuelQty,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(RefuelAmount/NULLIF(Qty,0),0)) UnitRefuelAmount,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(TotalCost/NULLIF(Qty,0),0)) UnitTotalCost,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(VariableCost/NULLIF(Qty,0),0)) UnitVariableCost,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(SalaryCost/NULLIF(TotalCost,0),0)*100))+'%' SalaryCostRate,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(FixedCost/NULLIF(TotalCost,0),0)*100))+'%' FixedRate,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(VariableCost/NULLIF(TotalCost,0),0)*100))+'%' VariableRate,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(InterestExpense/NULLIF(TotalCost,0),0)*100))+'%' InterestCostRate,\r\n\t\t\tAmount-TotalCost Profitloss,CONVERT(DECIMAL(18,3),ISNULL(FixedCost/\r\n\t\t\tNULLIF((BudPrice-ISNULL(VariableCost/NULLIF(Qty,0),0)),0),0)) EquilibriumPoint\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT ROW_NUMBER() OVER(ORDER BY EquipmentCode) Num,EquipmentCode,ResourceName,\r\n\t\t\t\tSpecification,PrjNames,UserNames,PurchasePrice,UnitName,TeamQty,SumQty,Qty,\r\n\t\t\t\tCONVERT(DECIMAL(18,3),Qty*BudPrice) Amount,CONVERT(DECIMAL(18,3),BudPrice) BudPrice,\r\n\t\t\t\tConstructionDates,CONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),CONVERT(DECIMAL(18,3),\r\n\t\t\t\tConstructionDates)/CONVERT(DECIMAL(18,3),MonthTotalDates))*100)+'%' ConstructionDatesRate,\r\n\t\t\t\tMonthTotalDates-RepairDates InGoodDays,MonthTotalDates,CONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\t\tCONVERT(DECIMAL(18,3),MonthTotalDates-RepairDates)/CONVERT(DECIMAL(18,3),MonthTotalDates))*100)+'%' InGoodDaysRate,\r\n\t\t\t\tRefuelAmount,RefuelQty,SalaryCost,\r\n\t\t\t\tCONVERT(DECIMAL(18,3),InterestExpense)InterestExpense,\r\n\t\t\t\t(InterestExpense+SalaryCost) FixedCost,RefuelAmount VariableCost,\r\n\t\t\t\t(InterestExpense+SalaryCost+RefuelAmount) TotalCost\r\n\t\t\t\tFROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT cteEquPrjBuds.EquipmentId,EquipmentCode,ResourceName,Specification,\r\n\t\t\t\t\tPrjNames,UserNames,PurchasePrice,Name UnitName,ISNULL(cteTeamSumQty.Qty,0) TeamQty,\r\n\t\t\t\t\tISNULL(cteSumQty.Qty,0) SumQty,cteEquPrjBuds.Qty,\r\n\t\t\t\t\tISNULL(BudResTotal/NULLIF(BudResQty,0),0) BudPrice, \r\n\t\t\t\t\tISNULL(RefuelQty,0) RefuelQty,ISNULL(RefuelAmount,0) RefuelAmount,\r\n\t\t\t\t\tISNULL(SalaryCost,0) SalaryCost,(PurchasePrice*0.15) InterestExpense,\r\n\t\t\t\t\tCONVERT(INT,DATEDIFF(dd,@date, DATEADD(MM,1,@date))) MonthTotalDates,\r\n\t\t\t\t\tISNULL(ConstructionDates,0) ConstructionDates,\r\n\t\t\t\t\tISNULL(RepairDates,0) RepairDates\r\n\t\t\t\t\tFROM cteEquPrjBuds \r\n\t\t\t\t\tINNER JOIN Equ_Equipment equipment ON cteEquPrjBuds.EquipmentId=equipment.Id\r\n\t\t\t\t\tINNER JOIN Res_Resource res ON equipment.ResourceId=res.ResourceId\r\n\t\t\t\t\tLEFT JOIN Res_Unit unit ON res.Unit=unit.UnitId\r\n\t\t\t\t\tLEFT JOIN cteEquUser ON cteEquPrjBuds.EquipmentId=cteEquUser.EquipmentId \r\n\t\t\t\t\tLEFT JOIN cteTeamSumQty on cteEquPrjBuds.EquipmentId=cteTeamSumQty.EquipmentId\r\n\t\t\t\t\tLEFT JOIN cteSumQty on cteEquPrjBuds.EquipmentId=cteSumQty.EquipmentId\r\n\t\t\t\t\tLEFT JOIN cteRefuelInfo ON cteEquPrjBuds.EquipmentId=cteRefuelInfo.EquipmentId\r\n\t\t\t\t\tLEFT JOIN cteEquSalary ON cteEquPrjBuds.EquipmentId=cteEquSalary.EquipmentId\r\n\t\t\t\t\tLEFT JOIN cteConstructionDates ON cteEquPrjBuds.EquipmentId=cteConstructionDates.EquipmentId\r\n\t\t\t\t\tLEFT JOIN cteEquRepairDates ON cteEquPrjBuds.EquipmentId=cteEquRepairDates.EquipmentId\r\n\t\t\t\t\tWHERE EquipmentCode LIKE '%'+@equCode+'%' AND ResourceName LIKE '%'+@equName+'%'\r\n\t\t\t\t) equReport\r\n\t\t\t) report WHERE Num>@pageSize*(@pageIndex-1) ";
            SqlParameter[] parameters = new SqlParameter[] { new SqlParameter("@equCode", equCode), new SqlParameter("@equName", equName), new SqlParameter("@date", date), new SqlParameter("@SalaryItemId", "F397D994-993E-40BE-B0C3-B10156AF4183"), new SqlParameter("@pageSize", pageSize), new SqlParameter("@pageIndex", pageIndex) };
            return base.ExecuteQuery(cmdText, parameters);
        }

        public int GetRoadReportCount(string equCode, string equName, string date)
        {
            int num = 0;
            string cmdText = "\r\n\t\t\t--DECLARE @equipmentCode nvarchar(50),@equipmentName nvarchar(50),@date nvarchar(50),\r\n\t\t\t--@SalaryItemId nvarchar(50)\r\n\t\t\t--SET @equipmentCode=''\r\n\t\t\t--SET @equipmentName=''\r\n\t\t\t--SET @date='2013-9-01'\r\n\t\t\t--SET @SalaryItemId='F397D994-993E-40BE-B0C3-B10156AF4183';\r\n\t\t\tWITH cteTeamReport AS\r\n\t\t\t(\r\n\t\t\t\t--陆上设备按台班上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,TeamQty Qty\r\n\t\t\t\tFROM Equ_RoadTeamReport WHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t),cteDumpReport AS\r\n\t\t\t(\r\n\t\t\t\t--自卸车上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,CubeQty Qty FROM Equ_RoadDumpReport\r\n\t\t\t\tWHERE FlowState=1  AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteDrillReport AS\r\n\t\t\t(\r\n\t\t\t\t--钻孔机上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,TotalLength Qty FROM Equ_RoadDrillReport\r\n\t\t\t\tWHERE FlowState=1  AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteMixerReport AS\r\n\t\t\t(\r\n\t\t\t\t--搅拌机上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,AffirmCubeQty Qty FROM Equ_RoadMixerReport\r\n\t\t\t\tWHERE FlowState=1  AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteDrainReport AS\r\n\t\t\t(\r\n\t\t\t\t--排水板设备上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,ConstructionQty Qty FROM Equ_RoadDrainReport\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteInterlockReport AS\r\n\t\t\t(\r\n\t\t\t\t--预制联锁块上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,Qty FROM Equ_RoadInterlockReport\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteElseReport AS\r\n\t\t\t(\r\n\t\t\t\t--其他设备上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,ConstructionDate,Qty from Equ_RoadElseReport\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,ReportDate,@date)=0\r\n\t\t\t),cteTeamSumQty AS\r\n\t\t\t(\r\n\t\t\t\tSELECT EquipmentId,SUM(Qty) Qty FROM cteTeamReport\r\n\t\t\t\tGROUP BY EquipmentId\r\n\t\t\t),cteSumQty AS\r\n\t\t\t(\r\n\t\t\t\tSELECT EquipmentId,SUM(Qty) Qty FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM cteDumpReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteDrillReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteMixerReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteDrainReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteInterlockReport\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t) reportSumQty GROUP BY EquipmentId\r\n\t\t\t),cteAllEqu AS\r\n\t\t\t(\r\n\t\t\t\t\t--陆上设备引用的项目ID及产量上报总和\r\n\t\t\t\t\tSELECT PrjId,EquipmentId,ResourceId,SUM(Qty) Qty FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT * FROM cteTeamReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDumpReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrillReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteMixerReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrainReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteInterlockReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t\t) allEqu \r\n\t\t\t\t\tINNER JOIN Equ_Equipment equipment ON allEqu.EquipmentId=equipment.Id\r\n\t\t\t\t\tGROUP BY PrjId,EquipmentId,ResourceId\r\n\t\t\t),cteBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--原目标成本\r\n\t\t\t\tSELECT task.PrjId,taskRes.ResourceId,ResourceQuantity,ResourcePrice FROM Bud_Task task \r\n\t\t\t\tINNER JOIN vGetCurBudVersion ON task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t\tINNER JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON task.PrjId=prjIds.PrjId AND taskRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE TaskType='' \r\n\t\t\t),cteBudModifyRes AS\r\n\t\t\t(\r\n\t\t\t\t--预算变更的资源\r\n\t\t\t\tSELECT budModify.PrjId,budModifyRes.ResourceId,ResourceQuantity,ResourcePrice \r\n\t\t\t\tFROM Bud_Modify budModify\r\n\t\t\t\tINNER JOIN Bud_ModifyTaskRes budModifyRes ON budModify.ModifyId=budModifyRes.ModifyId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\t--产量上报中的项目\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON budModify.PrjId=prjIds.PrjId AND budModifyRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t),cteAllBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--报量中涉及到的项目预算中,此资源的工程量及小计和\r\n\t\t\t\tSELECT PrjId,ResourceId,SUM(ResourceQuantity) BudResQty, \r\n \t\t\t\tSUM(ResourceQuantity*ResourcePrice) BudResTotal FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM cteBudRes\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteBudModifyRes\r\n\t\t\t\t) budRes GROUP BY PrjId,ResourceId\r\n\t\t\t),cteEquPrjBuds AS\r\n\t\t\t(\r\n\t\t\t\t--陆上设备引用的上报产量、项目名称及预算\r\n\t\t\t\tSELECT cteAllEqu.EquipmentId,SUM(Qty) Qty,SUM(BudResQty) BudResQty,\r\n\t\t\t\tSUM(BudResTotal) BudResTotal,STUFF((SELECT ','+PrjName FROM cteAllEqu allEqu\r\n\t\t\t\tLEFT JOIN Pt_PrjInfo ON allEqu.PrjId = CONVERT(NVARCHAR(50),Pt_PrjInfo.PrjGuid) \r\n\t\t\t\tWHERE allEqu.EquipmentId=cteAllEqu.EquipmentId  FOR XML PATH('')),1,1,'') PrjNames\r\n\t\t\t\tFROM cteAllEqu  \r\n\t\t\t\tLEFT JOIN cteAllBudRes ON cteAllEqu.PrjId=cteAllBudRes.PrjId \r\n\t\t\t\tAND cteAllEqu.ResourceId=cteAllBudRes.ResourceId\r\n\t\t\t\tGROUP BY cteAllEqu.EquipmentId\r\n\t\t\t),cteEquSalary AS\r\n\t\t\t(\r\n\t\t\t\t--设备需用的员工工资\r\n\t\t\t\tSELECT EquipmentId,SUM(Cost) SalaryCost FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,equUser.UserCode,ISNULL(Cost,0) Cost \r\n\t\t\t\t\tFROM Equ_EquipmentUser equUser\r\n\t\t\t\t\tLEFT JOIN \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT UserCode,Cost FROM\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT monthSalary.UserCode,Cost,Convert(NVARCHAR(50),monthSalary.Year)\r\n\t\t\t\t\t\t\t+'-'+Convert(NVARCHAR(50),monthSalary.Month)+'-1' SalaryDate\r\n\t\t\t\t\t\t\tFROM SA_MonthSalary monthSalary\r\n\t\t\t\t\t\t\tINNER JOIN SA_Payoff payoff ON monthSalary.UserCode=payoff.UserCode \r\n\t\t\t\t\t\t\tAND monthSalary.Year=payoff.Year AND monthSalary.Month=payoff.Month\r\n\t\t\t\t\t\t\tWHERE ItemId=@SalaryItemId AND IsPayoff=1\r\n\t\t\t\t\t\t) userSalary WHERE DATEDIFF(MM,SalaryDate,@date)=0\r\n\t\t\t\t\t) salary ON equUser.UserCode=salary.UserCode\r\n\t\t\t\t) equSalary GROUP BY EquipmentId\r\n\t\t\t),cteEquUser AS\r\n\t\t\t(\r\n\t\t\t\t--设备人员\r\n\t\t\t\tSELECT EquipmentId,STUFF((SELECT ','+v_xm FROM  Equ_EquipmentUser equUser\r\n\t\t\t\tLEFT JOIN PT_yhmc yhmc ON equUser.UserCode=v_yhdm \r\n\t\t\t\tWHERE equUser.EquipmentId=EquipmentUser.EquipmentId FOR XML PATH('')),1,1,'') UserNames\r\n\t\t\t\tFROM Equ_EquipmentUser EquipmentUser GROUP BY EquipmentId\r\n\t\t\t),cteConstructionDates AS\r\n\t\t\t(\r\n\t\t\t\t--设备月实做天数\r\n\t\t\t\tSELECT EquipmentId,COUNT(*) ConstructionDates FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,ConstructionDate,SUM(Qty) Qty FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT * FROM cteTeamReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDumpReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrillReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteMixerReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteDrainReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteInterlockReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t\t) equConstructionDate WHERE ConstructionDate IS NOT NULL\r\n\t\t\t\t\tGROUP BY EquipmentId,ConstructionDate\r\n\t\t\t\t) constructionDates GROUP BY EquipmentId \r\n\t\t\t),cteEquRepairDates AS\r\n\t\t\t(\r\n\t\t\t\t--陆上设备维修时间\r\n\t\t\t\tSELECT EquipmentId,SUM(RepairDates) RepairDates FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,(CASE \r\n\t\t\t\t\t--当维修开始时间，结束时间都在本月内时，维修时间=结束时间-开始时间\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)=0 and DATEDIFF(MM,RepairEndDate,@date)=0 \r\n\t\t\t\t\tTHEN (DATEDIFF(dd,RepairStartDate,RepairEndDate))+1\r\n\t\t\t\t\t--当维修开始时间小于本月时间，结束时间在本月内时，维修时间=结束时间-本月第一天\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)>0 AND DATEDIFF(MM,RepairEndDate,@date)=0 \r\n\t\t\t\t\tTHEN (DATEDIFF(dd,@date,RepairEndDate))+1\r\n\t\t\t\t\t--当维修开始时间在本月内，结束时间大于本月时间时，维修时间=下月第一天-维修开始时间\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)=0 AND DATEDIFF(MM,RepairEndDate,@date)<0 \r\n\t\t\t\t\tTHEN (DATEDIFF(dd,RepairStartDate, DATEADD(MM,1,@date)))\r\n\t\t\t\t\t--当维修开始时间小于本月时间，结束时间大于本月时间时，维修时间=当月天数\r\n\t\t\t\t\tWHEN DATEDIFF(MM,RepairStartDate,@date)>0 AND DATEDIFF(MM,RepairEndDate,@date)<0 \r\n\t\t\t\t\tTHEN DATEDIFF(dd,@date, DATEADD(MM,1,@date))\r\n\t\t\t\t\tELSE 0\t\t--其余的条件，维修时间=0\r\n\t\t\t\t\tend) RepairDates\r\n\t\t\t\t\tFROM Equ_RepairReport repairReport\r\n\t\t\t\t\tLEFT JOIN Equ_RepairApply repairApply ON repairReport.ApplyId=repairApply.Id \r\n\t\t\t\t\tWHERE repairReport.FlowState=1 AND repairReport.EquipmentType=1\r\n\t\t\t\t\tAND DATEDIFF(MM,RepairStartDate,@date)>=0 AND DATEDIFF(MM,RepairEndDate,@date)<=0\r\n\t\t\t\t) equRepairDates GROUP BY EquipmentId\r\n\t\t\t),cteRefuelInfo AS\r\n\t\t\t(\r\n\t\t\t\t--当月陆上设备出库登记记录\r\n\t\t\t\tSELECT EquipmentId,SUM(Quantity) RefuelQty, SUM(Quantity*UnitPrice) RefuelAmount FROM Equ_OilOut\r\n\t\t\t\tWHERE FlowState=1 AND DATEDIFF(MM,OutDate,@date)=0 \r\n\t\t\t\tGROUP BY EquipmentId\r\n\t\t\t)\r\n\t\t\tSELECT COUNT(*) FROM\r\n\t\t\t(\r\n\t\t\t\tSELECT cteEquPrjBuds.EquipmentId,EquipmentCode,ResourceName,Specification,\r\n\t\t\t\tPrjNames,UserNames,PurchasePrice,ISNULL(cteTeamSumQty.Qty,0) TeamQty,\r\n\t\t\t\tISNULL(cteSumQty.Qty,0) SumQty,cteEquPrjBuds.Qty,\r\n\t\t\t\tISNULL(BudResTotal/NULLIF(BudResQty,0),0) BudPrice, \r\n\t\t\t\tISNULL(RefuelQty,0) RefuelQty,ISNULL(RefuelAmount,0) RefuelAmount,\r\n\t\t\t\tISNULL(SalaryCost,0) SalaryCost,(PurchasePrice*0.15) InterestExpense,\r\n\t\t\t\tDATEDIFF(dd,@date, DATEADD(MM,1,@date)) MonthTotalDates,\r\n\t\t\t\tISNULL(ConstructionDates,0) ConstructionDates,\r\n\t\t\t\tISNULL(RepairDates,0) RepairDates\r\n\t\t\t\tFROM cteEquPrjBuds \r\n\t\t\t\tINNER JOIN Equ_Equipment equipment ON cteEquPrjBuds.EquipmentId=equipment.Id\r\n\t\t\t\tINNER JOIN Res_Resource res ON equipment.ResourceId=res.ResourceId\r\n\t\t\t\tLEFT JOIN cteEquUser ON cteEquPrjBuds.EquipmentId=cteEquUser.EquipmentId \r\n\t\t\t\tLEFT JOIN cteTeamSumQty on cteEquPrjBuds.EquipmentId=cteTeamSumQty.EquipmentId\r\n\t\t\t\tLEFT JOIN cteSumQty on cteEquPrjBuds.EquipmentId=cteSumQty.EquipmentId\r\n\t\t\t\tLEFT JOIN cteRefuelInfo ON cteEquPrjBuds.EquipmentId=cteRefuelInfo.EquipmentId\r\n\t\t\t\tLEFT JOIN cteEquSalary ON cteEquPrjBuds.EquipmentId=cteEquSalary.EquipmentId\r\n\t\t\t\tLEFT JOIN cteConstructionDates ON cteEquPrjBuds.EquipmentId=cteConstructionDates.EquipmentId\r\n\t\t\t\tLEFT JOIN cteEquRepairDates ON cteEquPrjBuds.EquipmentId=cteEquRepairDates.EquipmentId\r\n\t\t\t\tWHERE EquipmentCode LIKE '%'+@equCode+'%' AND ResourceName LIKE '%'+@equName+'%'\r\n\t\t\t) equReport ";
            SqlParameter[] parameters = new SqlParameter[] { new SqlParameter("@equCode", equCode), new SqlParameter("@equName", equName), new SqlParameter("@date", date), new SqlParameter("@SalaryItemId", "F397D994-993E-40BE-B0C3-B10156AF4183") };
            DataTable table = base.ExecuteQuery(cmdText, parameters);
            if (table != null)
            {
                num = Convert.ToInt32(table.Rows[0][0]);
            }
            return num;
        }

        public DataTable GetShipReport(string equCode, string equName, string date, int pageSize, int pageIndex)
        {
            if (pageSize == 0)
            {
                pageSize = this.GetShipReportCount(equCode, equName, date);
            }
            if (pageIndex == 0)
            {
                pageIndex = 1;
            }
            string cmdText = "\r\n\t\t\t--DECLARE @equCode nvarchar(50),@equName nvarchar(50),@date nvarchar(50),\r\n\t\t\t--@SalaryItemId nvarchar(50),@pageSize int,@pageIndex int\r\n\t\t\t--SET @equCode=''\r\n\t\t\t--SET @equName=''\r\n\t\t\t--SET @date='2013-09-01'\r\n\t\t\t--SET @SalaryItemId='F397D994-993E-40BE-B0C3-B10156AF4183'\r\n\t\t\t--SET @pageSize=15\r\n\t\t\t--SET @pageIndex=1;\r\n\t\t\tWITH cteTeamReport AS\r\n\t\t\t(\r\n\t\t\t\t--按台班上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Quantity Qty FROM Equ_ShipTeamReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteGrapReport AS\r\n\t\t\t(\r\n\t\t\t\t--抓斗船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Qty  FROM Equ_ShipGrapReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteMudReport AS\r\n\t\t\t(\r\n\t\t\t\t--泥驳船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,MudTotalQty Qty FROM Equ_ShipMudReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteFlatReport AS\r\n\t\t\t(\r\n\t\t\t\t--平板船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Quantity Qty FROM Equ_ShipFlatReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t),cteElseReport AS\r\n\t\t\t(\r\n\t\t\t\t--平板船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Qty FROM Equ_ShipElseReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteAllEqu AS\r\n\t\t\t(\r\n\t\t\t\t\t--船机引用的项目ID及产量上报总和\r\n\t\t\t\t\tSELECT PrjId,EquipmentId,ResourceId,SUM(Qty) Qty FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT * FROM cteTeamReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteGrapReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteMudReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteFlatReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t\t) allEqu \r\n\t\t\t\t\tINNER JOIN Equ_Equipment equipment ON allEqu.EquipmentId=equipment.Id\r\n\t\t\t\t\tGROUP BY PrjId,EquipmentId,ResourceId\r\n\t\t\t),cteBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--原目标成本\r\n\t\t\t\tSELECT task.PrjId,taskRes.ResourceId,ResourceQuantity,ResourcePrice FROM Bud_Task task \r\n\t\t\t\tINNER JOIN vGetCurBudVersion ON task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t\tINNER JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON task.PrjId=prjIds.PrjId AND taskRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE TaskType='' \r\n\t\t\t),cteBudModifyRes AS\r\n\t\t\t(\r\n\t\t\t\t--预算变更的资源\r\n\t\t\t\tSELECT budModify.PrjId,budModifyRes.ResourceId,ResourceQuantity,ResourcePrice \r\n\t\t\t\tFROM Bud_Modify budModify\r\n\t\t\t\tINNER JOIN Bud_ModifyTaskRes budModifyRes ON budModify.ModifyId=budModifyRes.ModifyId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\t--产量上报中的项目\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON budModify.PrjId=prjIds.PrjId AND budModifyRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t),cteAllBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--报量中涉及到的项目预算中,此资源的工程量及小计和\r\n\t\t\t\tSELECT PrjId,ResourceId,SUM(ResourceQuantity) BudResQty, \r\n \t\t\t\tSUM(ResourceQuantity*ResourcePrice) BudResTotal FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM cteBudRes\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteBudModifyRes\r\n\t\t\t\t) budRes GROUP BY PrjId,ResourceId\r\n\t\t\t),cteRefuelInfo AS\r\n\t\t\t(\r\n\t\t\t\t--设备的加油量，加油金额\r\n\t\t\t\tSELECT EquipmentId,CONVERT(DECIMAL(18,3),refuelAmount) RefuelAmount,\r\n\t\t\t\tCONVERT(DECIMAL(18,3),refuelQty) RefuelQty FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,SUM(BudOilPrice*(ApplyQuantity*1000)) RefuelAmount,\r\n\t\t\t\t\tSUM(ApplyQuantity)*1000 RefuelQty\r\n\t\t\t\t\tFROM Equ_Ship_RefuelApply refuelApply\r\n\t\t\t\t\tJOIN Equ_Ship_BudOilWear budOilWear ON BudOilWearId=budOilWear.Id\r\n\t\t\t\t\tWHERE refuelApply.FlowState=1 GROUP BY EquipmentId\r\n\t\t\t\t) refuelInfo\r\n\t\t\t),cteEquSalary AS\r\n\t\t\t(\r\n\t\t\t\t--设备需用的员工工资\r\n\t\t\t\tSELECT EquipmentId,SUM(Cost) SalaryCost FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,equUser.UserCode,ISNULL(Cost,0) Cost \r\n\t\t\t\t\tFROM Equ_EquipmentUser equUser\r\n\t\t\t\t\tLEFT JOIN \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT UserCode,Cost FROM\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT monthSalary.UserCode,Cost,Convert(NVARCHAR(50),monthSalary.Year)\r\n\t\t\t\t\t\t\t+'-'+Convert(NVARCHAR(50),monthSalary.Month)+'-1' SalaryDate\r\n\t\t\t\t\t\t\tFROM SA_MonthSalary monthSalary\r\n\t\t\t\t\t\t\tINNER JOIN SA_Payoff payoff ON monthSalary.UserCode=payoff.UserCode \r\n\t\t\t\t\t\t\tAND monthSalary.Year=payoff.Year AND monthSalary.Month=payoff.Month\r\n\t\t\t\t\t\t\tWHERE ItemId=@SalaryItemId AND IsPayoff=1\r\n\t\t\t\t\t\t) userSalary WHERE DATEDIFF(MM,SalaryDate,@date)=0\r\n\t\t\t\t\t) salary ON equUser.UserCode=salary.UserCode\r\n\t\t\t\t) equSalary GROUP BY EquipmentId\r\n\t\t\t),cteEquPrjBuds AS\r\n\t\t\t(\r\n\t\t\t\t--船机引用的上报产量、项目名称及预算\r\n\t\t\t\tSELECT cteAllEqu.EquipmentId,SUM(Qty) Qty,SUM(BudResQty) BudResQty,\r\n\t\t\t\tSUM(BudResTotal) BudResTotal,STUFF((SELECT ','+PrjName FROM cteAllEqu allEqu\r\n\t\t\t\tLEFT JOIN Pt_PrjInfo ON allEqu.PrjId = CONVERT(NVARCHAR(50),Pt_PrjInfo.PrjGuid) \r\n\t\t\t\tWHERE allEqu.EquipmentId=cteAllEqu.EquipmentId  FOR XML PATH('')),1,1,'') PrjNames\r\n\t\t\t\tFROM cteAllEqu  \r\n\t\t\t\tLEFT JOIN cteAllBudRes ON cteAllEqu.PrjId=cteAllBudRes.PrjId \r\n\t\t\t\tAND cteAllEqu.ResourceId=cteAllBudRes.ResourceId\r\n\t\t\t\tGROUP BY cteAllEqu.EquipmentId\r\n\t\t\t)\r\n\t\t\tSELECT TOP(@pageSize) CONVERT(NVARCHAR(20),Num) Num,EquipmentCode,ResourceName,PrjNames,\r\n\t\t\tQty,Amount,BudPrice,TotalCost,FixedCost,\r\n\t\t\tRefuelQty,RefuelAmount,SalaryCost,InterestExpense,VariableCost,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(FixedCost/NULLIF(TotalCost,0),0)*100))+'%' FixedRate,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(SalaryCost/NULLIF(TotalCost,0),0)*100))+'%' SalaryCostRate,\r\n\t\t\tCONVERT(NVARCHAR(20),CONVERT(DECIMAL(18,3),\r\n\t\t\tISNULL(InterestExpense/NULLIF(TotalCost,0),0)*100))+'%' InterestCostRate,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(VariableCost/NULLIF(Qty,0),0)) UnitVariableCost,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(RefuelAmount/NULLIF(Qty,0),0)) UnitRefuelAmount,\r\n\t\t\tCONVERT(DECIMAL(18,3),ISNULL(TotalCost/NULLIF(Qty,0),0)) UnitTotalCost,\r\n\t\t\tAmount-TotalCost Profitloss,CONVERT(DECIMAL(18,3),ISNULL(FixedCost/\r\n\t\t\tNULLIF((BudPrice-ISNULL(VariableCost/NULLIF(Qty,0),0)),0),0)) EquilibriumPoint\r\n\t\t\tFROM\r\n\t\t\t(\r\n\t\t\t\tSELECT ROW_NUMBER() OVER(ORDER BY EquipmentCode) Num,EquipmentCode,ResourceName,\r\n\t\t\t\tPrjNames,Qty,CONVERT(DECIMAL(18,3),Qty*BudPrice) Amount,\r\n\t\t\t\tCONVERT(DECIMAL(18,3),BudPrice) BudPrice,RefuelAmount,RefuelQty,SalaryCost,\r\n\t\t\t\tCONVERT(DECIMAL(18,3),InterestExpense)InterestExpense,\r\n\t\t\t\t(InterestExpense+SalaryCost) FixedCost,RefuelAmount VariableCost,\r\n\t\t\t\t(InterestExpense+SalaryCost+RefuelAmount) TotalCost\r\n\t\t\t\tFROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT cteEquPrjBuds.EquipmentId,EquipmentCode,ResourceName,Qty,\r\n\t\t\t\t\tISNULL(BudResTotal/NULLIF(BudResQty,0),0) BudPrice, \r\n\t\t\t\t\tPrjNames,ISNULL(RefuelQty,0) RefuelQty,ISNULL(RefuelAmount,0) RefuelAmount,\r\n\t\t\t\t\tISNULL(SalaryCost,0) SalaryCost,(PurchasePrice*0.15) InterestExpense\r\n\t\t\t\t\tFROM cteEquPrjBuds\r\n\t\t\t\t\tINNER JOIN Equ_Equipment equipment ON cteEquPrjBuds.EquipmentId=equipment.Id\r\n\t\t\t\t\tINNER JOIN Res_Resource res ON equipment.ResourceId=res.ResourceId\r\n\t\t\t\t\tLEFT JOIN cteRefuelInfo ON cteEquPrjBuds.EquipmentId=cteRefuelInfo.EquipmentId\r\n\t\t\t\t\tLEFT JOIN cteEquSalary ON cteEquPrjBuds.EquipmentId=cteEquSalary.EquipmentId\r\n\t\t\t\t\tWHERE EquipmentCode LIKE '%'+@equCode+'%' AND ResourceName LIKE '%'+@equName+'%'\r\n\t\t\t\t) equReport\r\n\t\t\t) report WHERE Num>@pageSize*(@pageIndex-1)";
            SqlParameter[] parameters = new SqlParameter[] { new SqlParameter("@equCode", equCode), new SqlParameter("@equName", equName), new SqlParameter("@date", date), new SqlParameter("@SalaryItemId", "F397D994-993E-40BE-B0C3-B10156AF4183"), new SqlParameter("@pageSize", pageSize), new SqlParameter("@pageIndex", pageIndex) };
            return base.ExecuteQuery(cmdText, parameters);
        }

        public int GetShipReportCount(string equCode, string equName, string date)
        {
            int num = 0;
            string cmdText = "\r\n\t\t\t--DECLARE @equCode nvarchar(50),@equName nvarchar(50),@date nvarchar(50),\r\n\t\t\t--@SalaryItemId nvarchar(50)\r\n\t\t\t--SET @equCode=''\r\n\t\t\t--SET @equName=''\r\n\t\t\t--SET @date='2013-09-01'\r\n\t\t\t--SET @SalaryItemId='F397D994-993E-40BE-B0C3-B10156AF4183';\r\n\t\t\tWITH cteTeamReport AS\r\n\t\t\t(\r\n\t\t\t\t--按台班上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Quantity Qty FROM Equ_ShipTeamReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteGrapReport AS\r\n\t\t\t(\r\n\t\t\t\t--抓斗船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Qty  FROM Equ_ShipGrapReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteMudReport AS\r\n\t\t\t(\r\n\t\t\t\t--泥驳船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,MudTotalQty Qty FROM Equ_ShipMudReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteFlatReport AS\r\n\t\t\t(\r\n\t\t\t\t--平板船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Quantity Qty FROM Equ_ShipFlatReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t),cteElseReport AS\r\n\t\t\t(\r\n\t\t\t\t--平板船上报\r\n\t\t\t\tSELECT PrjId,EquipmentId,Qty FROM Equ_ShipElseReport\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t\tAND DATEDIFF(MM,ReportDate,@date)=0 \r\n\t\t\t), cteAllEqu AS\r\n\t\t\t(\r\n\t\t\t\t\t--船机引用的项目ID及产量上报总和\r\n\t\t\t\t\tSELECT PrjId,EquipmentId,ResourceId,SUM(Qty) Qty FROM\r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT * FROM cteTeamReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteGrapReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteMudReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteFlatReport\r\n\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\tSELECT * FROM cteElseReport\r\n\t\t\t\t\t) allEqu \r\n\t\t\t\t\tINNER JOIN Equ_Equipment equipment ON allEqu.EquipmentId=equipment.Id\r\n\t\t\t\t\tGROUP BY PrjId,EquipmentId,ResourceId\r\n\t\t\t),cteBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--原目标成本\r\n\t\t\t\tSELECT task.PrjId,taskRes.ResourceId,ResourceQuantity,ResourcePrice FROM Bud_Task task \r\n\t\t\t\tINNER JOIN vGetCurBudVersion ON task.PrjId=vGetCurBudVersion.PrjId AND Version=CurVersion\r\n\t\t\t\tINNER JOIN Bud_TaskResource taskRes ON task.TaskId=taskRes.TaskId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON task.PrjId=prjIds.PrjId AND taskRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE TaskType='' \r\n\t\t\t),cteBudModifyRes AS\r\n\t\t\t(\r\n\t\t\t\t--预算变更的资源\r\n\t\t\t\tSELECT budModify.PrjId,budModifyRes.ResourceId,ResourceQuantity,ResourcePrice \r\n\t\t\t\tFROM Bud_Modify budModify\r\n\t\t\t\tINNER JOIN Bud_ModifyTaskRes budModifyRes ON budModify.ModifyId=budModifyRes.ModifyId\r\n\t\t\t\tINNER JOIN \r\n\t\t\t\t(\r\n\t\t\t\t\t--产量上报中的项目\r\n\t\t\t\t\tSELECT PrjId,ResourceId FROM cteAllEqu \r\n\t\t\t\t\tWHERE PrjId IS NOT NULL \r\n\t\t\t\t\tGROUP BY PrjId,ResourceId\t\t\r\n\t\t\t\t) prjIds ON budModify.PrjId=prjIds.PrjId AND budModifyRes.ResourceId=prjIds.ResourceId\r\n\t\t\t\tWHERE FlowState=1 \r\n\t\t\t),cteAllBudRes AS\r\n\t\t\t(\r\n\t\t\t\t--报量中涉及到的项目预算中,此资源的工程量及小计和\r\n\t\t\t\tSELECT PrjId,ResourceId,SUM(ResourceQuantity) BudResQty, \r\n \t\t\t\tSUM(ResourceQuantity*ResourcePrice) BudResTotal FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT * FROM cteBudRes\r\n\t\t\t\t\tUNION ALL\r\n\t\t\t\t\tSELECT * FROM cteBudModifyRes\r\n\t\t\t\t) budRes GROUP BY PrjId,ResourceId\r\n\t\t\t),cteRefuelInfo AS\r\n\t\t\t(\r\n\t\t\t\t--设备的加油量，加油金额\r\n\t\t\t\tSELECT EquipmentId,CONVERT(DECIMAL(18,3),refuelAmount) RefuelAmount,\r\n\t\t\t\tCONVERT(DECIMAL(18,3),refuelQty) RefuelQty FROM \r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,SUM(BudOilPrice*(ApplyQuantity*1000)) RefuelAmount,\r\n\t\t\t\t\tSUM(ApplyQuantity)*1000 RefuelQty\r\n\t\t\t\t\tFROM Equ_Ship_RefuelApply refuelApply\r\n\t\t\t\t\tJOIN Equ_Ship_BudOilWear budOilWear ON BudOilWearId=budOilWear.Id\r\n\t\t\t\t\tWHERE refuelApply.FlowState=1 GROUP BY EquipmentId\r\n\t\t\t\t) refuelInfo\r\n\t\t\t),cteEquSalary AS\r\n\t\t\t(\r\n\t\t\t\t--设备需用的员工工资(员工工资取应发工资)\r\n\t\t\t\tSELECT EquipmentId,SUM(Cost) SalaryCost FROM\r\n\t\t\t\t(\r\n\t\t\t\t\tSELECT EquipmentId,equUser.UserCode,ISNULL(Cost,0) Cost \r\n\t\t\t\t\tFROM Equ_EquipmentUser equUser\r\n\t\t\t\t\tLEFT JOIN \r\n\t\t\t\t\t(\r\n\t\t\t\t\t\tSELECT UserCode,Cost FROM\r\n\t\t\t\t\t\t(\r\n\t\t\t\t\t\t\tSELECT monthSalary.UserCode,Cost,Convert(NVARCHAR(50),monthSalary.Year)\r\n\t\t\t\t\t\t\t+'-'+Convert(NVARCHAR(50),monthSalary.Month)+'-1' SalaryDate\r\n\t\t\t\t\t\t\tFROM SA_MonthSalary monthSalary\r\n\t\t\t\t\t\t\tINNER JOIN SA_Payoff payoff ON monthSalary.UserCode=payoff.UserCode \r\n\t\t\t\t\t\t\tAND monthSalary.Year=payoff.Year AND monthSalary.Month=payoff.Month\r\n\t\t\t\t\t\t\tWHERE ItemId=@SalaryItemId AND IsPayoff=1\r\n\t\t\t\t\t\t) userSalary WHERE DATEDIFF(MM,SalaryDate,@date)=0\r\n\t\t\t\t\t) salary ON equUser.UserCode=salary.UserCode\r\n\t\t\t\t) equSalary GROUP BY EquipmentId\r\n\t\t\t),cteEquPrjBuds AS\r\n\t\t\t(\r\n\t\t\t\t--船机引用的上报产量、项目名称及预算\r\n\t\t\t\tSELECT cteAllEqu.EquipmentId,SUM(Qty) Qty,SUM(BudResQty) BudResQty,\r\n\t\t\t\tSUM(BudResTotal) BudResTotal,STUFF((SELECT ','+PrjName FROM cteAllEqu allEqu\r\n\t\t\t\tLEFT JOIN Pt_PrjInfo ON allEqu.PrjId = CONVERT(NVARCHAR(50),Pt_PrjInfo.PrjGuid) \r\n\t\t\t\tWHERE allEqu.EquipmentId=cteAllEqu.EquipmentId  FOR XML PATH('')),1,1,'') PrjNames\r\n\t\t\t\tFROM cteAllEqu  \r\n\t\t\t\tLEFT JOIN cteAllBudRes ON cteAllEqu.PrjId=cteAllBudRes.PrjId \r\n\t\t\t\tAND cteAllEqu.ResourceId=cteAllBudRes.ResourceId\r\n\t\t\t\tGROUP BY cteAllEqu.EquipmentId\r\n\t\t\t)\r\n\t\t\tSELECT COUNT(*)\tFROM \r\n\t\t\t(\r\n\t\t\t\tSELECT cteEquPrjBuds.EquipmentId,EquipmentCode,ResourceName,Qty,\r\n\t\t\t\tISNULL(BudResTotal/NULLIF(BudResQty,0),0) BudPrice, \r\n\t\t\t\tPrjNames,ISNULL(RefuelQty,0) RefuelQty,ISNULL(RefuelAmount,0) RefuelAmount,\r\n\t\t\t\tISNULL(SalaryCost,0) SalaryCost,(PurchasePrice*0.15) InterestExpense\r\n\t\t\t\tFROM cteEquPrjBuds\r\n\t\t\t\tINNER JOIN Equ_Equipment equipment ON cteEquPrjBuds.EquipmentId=equipment.Id\r\n\t\t\t\tINNER JOIN Res_Resource res ON equipment.ResourceId=res.ResourceId\r\n\t\t\t\tLEFT JOIN cteRefuelInfo ON cteEquPrjBuds.EquipmentId=cteRefuelInfo.EquipmentId\r\n\t\t\t\tLEFT JOIN cteEquSalary ON cteEquPrjBuds.EquipmentId=cteEquSalary.EquipmentId\r\n\t\t\t\tWHERE EquipmentCode LIKE '%'+@equCode+'%' AND ResourceName LIKE '%'+@equName+'%'\r\n\t\t\t) equReport ";
            SqlParameter[] parameters = new SqlParameter[] { new SqlParameter("@equCode", equCode), new SqlParameter("@equName", equName), new SqlParameter("@date", date), new SqlParameter("@SalaryItemId", "F397D994-993E-40BE-B0C3-B10156AF4183") };
            DataTable table = base.ExecuteQuery(cmdText, parameters);
            if (table != null)
            {
                num = Convert.ToInt32(table.Rows[0][0]);
            }
            return num;
        }
    }
}

